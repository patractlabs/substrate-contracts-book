(window.webpackJsonp=window.webpackJsonp||[]).push([[79],{645:function(t,e,a){"use strict";a.r(e);var r=a(6),s=Object(r.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"europa-s-wasm-backtrace"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#europa-s-wasm-backtrace"}},[t._v("#")]),t._v(" Europa's Wasm Backtrace")]),t._v(" "),a("h2",{attrs:{id:"background-information"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#background-information"}},[t._v("#")]),t._v(" Background Information")]),t._v(" "),a("p",[t._v("The execution of "),a("code",[t._v("pallet-contracts")]),t._v(" includes execution in the contract model and execution in Wasm. The execution process in the contract model is transferred to the pallet-contracts module through Wasm's host_function. If panic or incorrect positioning occurs, the runtime of the node can be positioned in the form of native operation. Since the execution process in Wasm is in the Wasm virtual machine, it is a black box to the outside world. If the internal execution process crashes abnormally, it can only be displayed by the Wasm executor.")]),t._v(" "),a("p",[t._v("Europa's pallet-contracts module currently supports the following two types of actuators:")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("wasmi")]),t._v(": Wasm interpreter developed by the Parity. When Wasm executes panic, it will only return an error without Backtrace. Patract forks the official wasmi, and adds tracking and printing of the execution stack on top of the original. When a panic occurs during Wasm's execution, the current execution stack and corresponding information will be returned with an error.")]),t._v(" "),a("li",[a("code",[t._v("wasmtime")]),t._v(": Wasm's JIT executor, which comes with Backtrace when it crashes.")])]),t._v(" "),a("h2",{attrs:{id:"the-conditins-of-europa-can-print-out-wasm-backtrace"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#the-conditins-of-europa-can-print-out-wasm-backtrace"}},[t._v("#")]),t._v(" The conditins of Europa can print out Wasm Backtrace")]),t._v(" "),a("p",[t._v("Wasm can print Backtrace, requiring the "),a("code",[t._v("name section")]),t._v(" in the Wasm file compiled by the contract. Since the cargo-contract provided by Parity has encapsulated many operations, the current default operation is to compile the contract in the best optimized way, and the "),a("code",[t._v("name section")]),t._v(" section will be removed in this process. On the other hand, cargo-contract does not provide corresponding interfaces or options that allow you to adjust the optimization conditions used in contract compilation and whether to retain some debugging information. Therefore, Patract can only provide a modified version of cargo-contract, and you can use this modified version of cargo-contract to compile a contract Wasm file with a name section.")]),t._v(" "),a("p",[t._v("On the other hand, the original code will be optimized during the compilation of the release, and it may be disturbed to locate the problem through the optimized Backtrace. Therefore, it is best to reduce the optimization level so that the Backtrace at the time of a crash will most likely match the original code.")]),t._v(" "),a("h2",{attrs:{id:"install-cargo-contract-under-patract-repository"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#install-cargo-contract-under-patract-repository"}},[t._v("#")]),t._v(" Install "),a("code",[t._v("cargo-contract")]),t._v(" under Patract repository")]),t._v(" "),a("ul",[a("li",[t._v("Install "),a("a",{attrs:{href:"https://github.com/patractlabs/cargo-contract",target:"_blank",rel:"noopener noreferrer"}},[t._v("cargo-contract"),a("OutboundLink")],1),t._v(" under Patract repository."),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ cargo "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" cargo-contract --git https://github.com/patractlabs/cargo-contract --branch"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("v0.12.1 --force\n")])])])])]),t._v(" "),a("p",[a("strong",[t._v("Note")]),t._v(" Since the current version of Parity's "),a("code",[t._v("cargo-contract")]),t._v(" is "),a("code",[t._v("v0.12.1")]),t._v(" , our Patract has added features based on this version. If "),a("code",[t._v("cargo-contract")]),t._v(" continues to be upgraded in the future, Patract will continue to be maintained.")]),t._v(" "),a("p",[t._v("The "),a("code",[t._v("cargo-contract")]),t._v(" installed in this way will overwrite the installed "),a("code",[t._v("cargo-contract")]),t._v(". Therefore, please pay attention to which repository the "),a("code",[t._v("cargo-contract")]),t._v(" in the current environment comes from to prevent interference when locating problems.")]),t._v(" "),a("p",[t._v("Execute the following commandï¼ŒThe results listed can be used to judge what source the "),a("code",[t._v("cargo-contract")]),t._v(" installation in the current environment comes from. For example, the following result is from Patract. If there is no parenthesis and the content in it, it means it is from "),a("code",[t._v("crates.io")]),t._v(".")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ cargo "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" --list "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" cargo-contract\ncargo-contract v0.12.1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("https://github.com/patractlabs/cargo-contract.git?branch"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("tag-v0.12.1"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0d682762):")]),t._v("\ncargo-contract\n")])])]),a("ul",[a("li",[t._v("If you have installed the official "),a("code",[t._v("cargo-contract")]),t._v("and does not want to overwrite the installation, you can use manual compilation."),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone https://github.com/patractlabs/cargo-contract --branch"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("tag-v0.12.1\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" cargo-contract\n$ cargo build --release\n")])])])])]),t._v(" "),a("p",[t._v("After compilation, you can move the compiled product to any path that can be accessed globally, and rename it ,in case it conflicts with the installed cargo-contract.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" target/release/cargo-contract "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("to any path"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("/patract-cargo-contract\n")])])]),a("p",[t._v("In the subsequent compilation of the ink! contract, use "),a("code",[t._v("patract-cargo-contract xxx")]),t._v(" instead of "),a("code",[t._v("cargo +nighlty contract xxx")]),t._v(" to execute the corresponding commands,but  this method requires the default toolchain to be nightly)")]),t._v(" "),a("h2",{attrs:{id:"use-patract-s-cargo-contract-to-generate-wasm-contractfiles-withname-sectionsection"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#use-patract-s-cargo-contract-to-generate-wasm-contractfiles-withname-sectionsection"}},[t._v("#")]),t._v(" Use Patract's cargo-contract to generate"),a("code",[t._v("*.wasm/*.contract")]),t._v("files with"),a("code",[t._v("name section")]),t._v("section")]),t._v(" "),a("p",[t._v("Patract's "),a("code",[t._v("cargo-contract")]),t._v(" provides "),a("code",[t._v("-d/--debug")]),t._v(" options. When the following command is executed,The generated "),a("code",[t._v("*.wasm/*.contract")]),t._v(" file is consistent with parity's official "),a("code",[t._v("cargo-contract")]),t._v(" execution result.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ cargo +nightly contract build\n")])])]),a("p",[t._v("When the following command is executed,The generated "),a("code",[t._v("*.wasm/*.contract")]),t._v(" file is the "),a("code",[t._v("*.wasm/*.contract")]),t._v(" file that is not optimized and carries the "),a("code",[t._v("name section")]),t._v(" section. It is equivalent to the files generated in this way replace the files generated by the original generation logic.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ cargo +nightly contract build --debug\n")])])]),a("p",[a("strong",[t._v("Note")]),t._v(" The size of the compiled product generated by this way is generally several hundred times the size of the original product. Therefore, the developer can pay attention to the size of the generated product to roughly determine the compiled product generated by which compilation method.")]),t._v(" "),a("p",[t._v("The example is as follows.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" target/ink\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v(" -h\n-rw-rw-r-- "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".5M "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("æœˆ  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(":01 flipper.contract\n-rw-rw-r-- "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(".1K "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("æœˆ  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v(":34 flipper.contract.old\n-rw-rw-r-- "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root 732K "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("æœˆ  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(":00 flipper.wasm\n-rw-rw-r-- "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(".5K "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("æœˆ  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v(":34 flipper.wasm.old\n-rw-rw-r-- "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(".1K "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("æœˆ  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(":01 metadata.json\n")])])]),a("p",[t._v("The file with "),a("code",[t._v("*.old")]),t._v(" means it was generated by the parity version of "),a("code",[t._v("cargo-contract")]),t._v("( renamed after the first compilation), on the contrary, the file with the same name is from Patract's "),a("code",[t._v("cargo-contract")]),t._v(" with the addition of "),a("code",[t._v("-- The debug")]),t._v(" command is generated. You can see that the new file is many times larger than the old file. And "),a("code",[t._v("metadata.json")]),t._v(" is unchanged.")]),t._v(" "),a("h2",{attrs:{id:"wasm-backtrace-description"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#wasm-backtrace-description"}},[t._v("#")]),t._v(" Wasm Backtrace description")]),t._v(" "),a("p",[t._v("To be completed.")]),t._v(" "),a("h2",{attrs:{id:"experimental-functions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#experimental-functions"}},[t._v("#")]),t._v(" Experimental functions")]),t._v(" "),a("h3",{attrs:{id:"wasm-backtrace-print-line-number-only-wasmtime-is-supported"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#wasm-backtrace-print-line-number-only-wasmtime-is-supported"}},[t._v("#")]),t._v(" Wasm Backtrace print line number (only Wasmtime is supported)")]),t._v(" "),a("p",[t._v("TODO: This part is not completed")]),t._v(" "),a("p",[t._v("Add "),a("code",[t._v("WASMTIME_BACKTRACE_DETAILS=1")]),t._v(" when starting Europa or set this variable as an environment variable")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("WASMTIME_BACKTRACE_DETAILS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" europa --tmp\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# or use")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("WASMTIME_BACKTRACE_DETAILS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\neuropa --tmp "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# run europa in normal way")]),t._v("\n")])])]),a("p",[t._v("Then in the "),a("code",[t._v("wasm_error")]),t._v(" section of Europa's log, the line number in the original code corresponding to the crash stack will appear.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("wasm_error: Error::Trap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    Trap "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        code: TrapCode::UnreachableCodeReached,\n        trace: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wasm trap: unreachable"')]),t._v(",\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wasm backtrace:"')]),t._v(",\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"    0: 0x31b2 - <unknown>!core::panicking::panic::he000af669cfcac01"')]),t._v(",\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"    1: 0x3c8c - <unknown>!flipper::flippter::_::<impl flipper::flippter::Flippter>::flip::h12b84979a77ae484"')]),t._v(",\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"    2: 0x10fa - core::result::Result<T,E>::map_err::h576871030fe833d4"')]),t._v(",\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"                    at /home/clearloop/.cargo/registry/src/github.com-1ecc6299db9ec823/å®˜æ–¹-scale-codec-2.0.1/src/codec.rs:1199:31"')]),t._v(",\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"    3: 0x10d6 - core::result::Result<T,E>::map_err::h576871030fe833d4"')]),t._v(",\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"                    at /home/clearloop/.cargo/registry/src/github.com-1ecc6299db9ec823/å®˜æ–¹-scale-codec-2.0.1/src/codec.rs:1198"')]),t._v(",\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"    4: 0x3966 - <unknown>!<flipper::flippter::_::_::__ink_MessageDispatchEnum as ink_lang::dispatcher::Execute>::execute::{{closure}}::hf35b139aaf5fba3b"')]),t._v(",\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"    5: 0x3941 - <unknown>!ink_lang::dispatcher::execute_message_mut::hf62eb790d230d371"')]),t._v(",\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"    6: 0x3c12 - <unknown>!<flipper::flippter::_::_::__ink_MessageDispatchEnum as ink_lang::dispatcher::Execute>::execute::heae3e5bbfc02afa0"')]),t._v(",\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"    7: 0x3a7a - <unknown>!flipper::flippter::_::<impl ink_lang::contract::DispatchUsingMode for flipper::flippter::Flippter>::dispatch_using_mode::h8e0c4495e09cd910"')]),t._v(",\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"    8: 0x3ba3 - <unknown>!call"')]),t._v(",\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"    9: 0xf704 - <unknown>!<wasm function 638>"')]),t._v(",\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(",\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(",\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(",\n")])])]),a("p",[t._v("In this backtrace log, some parts that can parse the line number will be appended with the line number corresponding to the function in the error stack at the end of that line,The example is as follows.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2: 0x10fa - core::result::Result<T,E>::map_err::h576871030fe833d4"')]),t._v(",\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"                    at /home/clearloop/.cargo/registry/src/github.com-1ecc6299db9ec823/parity-scale-codec-2.0.1/src/codec.rs:1199:31"')]),t._v("\n")])])]),a("p",[t._v("The "),a("code",[t._v("codec.rs:1199:31")]),t._v(" part means that this frame in the error stack corresponds to "),a("code",[t._v("codec.rs")]),t._v(". The line number of the file is 1199 and the column number is 31. The remaining lines do not have line numbers due to insufficient parsing or because the code is generated by macros.")])])}),[],!1,null,null,null);e.default=s.exports}}]);