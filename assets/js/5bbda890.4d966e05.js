"use strict";(self.webpackChunksubstrate_contracts_book=self.webpackChunksubstrate_contracts_book||[]).push([[4464],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return d}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function p(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),s=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):p(p({},t),e)),n},c=function(e){var t=s(e.components);return a.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},k=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),k=s(n),d=r,u=k["".concat(l,".").concat(d)]||k[d]||m[d]||i;return n?a.createElement(u,p(p({ref:t},c),{},{components:n})):a.createElement(u,p({ref:t},c))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,p=new Array(i);p[0]=k;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:r,p[1]=o;for(var s=2;s<i;s++)p[s]=n[s];return a.createElement.apply(null,p)}return a.createElement.apply(null,n)}k.displayName="MDXCreateElement"},9359:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return o},contentTitle:function(){return l},metadata:function(){return s},toc:function(){return c},default:function(){return k}});var a=n(7462),r=n(3366),i=(n(7294),n(3905)),p=["components"],o={},l="Europa v0.2 \u62a5\u544a",s={unversionedId:"europa/reports/v0.2Report",id:"europa/reports/v0.2Report",isDocsHomePage:!1,title:"Europa v0.2 \u62a5\u544a",description:"Patract Hub's treasury report for Europa v0.2",source:"@site/docs/europa/reports/v0.2Report.md",sourceDirName:"europa/reports",slug:"/europa/reports/v0.2Report",permalink:"/substrate-contracts-book/europa/reports/v0.2Report",editUrl:"https://github.com/patractlabs/substrate-contracts-book/docs/europa/reports/v0.2Report.md",version:"current",frontMatter:{},sidebar:"docs",previous:{title:"Europa v0.1 \u62a5\u544a",permalink:"/substrate-contracts-book/europa/reports/v0.1Report"},next:{title:"Europa v0.3\u62a5\u544a",permalink:"/substrate-contracts-book/europa/reports/v0.3Report"}},c=[{value:"Introduction",id:"introduction",children:[{value:"Summary of Europa&#39;s v0.2 plan:",id:"summary-of-europas-v02-plan",children:[]}]},{value:"Design",id:"design",children:[{value:"<code>pallet-contracts</code>\u5c42",id:"pallet-contracts\u5c42",children:[]},{value:"<code>wasmi</code>\u5c42",id:"wasmi\u5c42",children:[]},{value:"\u5408\u7ea6\u65e5\u5fd7\u529f\u80fd",id:"\u5408\u7ea6\u65e5\u5fd7\u529f\u80fd",children:[]}]},{value:"What Europa can do in this version",id:"what-europa-can-do-in-this-version",children:[{value:"Build",id:"build",children:[]},{value:"example",id:"example",children:[]}]},{value:"What we have implemented for v0.2",id:"what-we-have-implemented-for-v02",children:[]}],m={toc:c};function k(e){var t=e.components,n=(0,r.Z)(e,p);return(0,i.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"europa-v02-\u62a5\u544a"},"Europa v0.2 \u62a5\u544a"),(0,i.kt)("p",null,"Patract Hub's treasury report for Europa v0.2"),(0,i.kt)("p",null,"Patract Hub (",(0,i.kt)("a",{parentName:"p",href:"https://patract.io"},"https://patract.io"),") develops local open source toolkits and one-stop cloud smart IDE, committed to provide free development toolkits and infrastructure services for the entire smart contract ecosystem. Six weeks ago, we applied a ",(0,i.kt)("a",{parentName:"p",href:"https://polkadot.polkassembly.io/motion/48"},"treasury proposal")," for Europa v0.2 , and now we have finished the development (",(0,i.kt)("a",{parentName:"p",href:"https://github.com/patractlabs/europa"},"https://github.com/patractlabs/europa"),") . This repost shows what Europa v0.2 completion."),(0,i.kt)("h2",{id:"introduction"},"Introduction"),(0,i.kt)("p",null,"Europa is kind of another implementation for ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/substrate/tree/master/client"},"Substrate client"),' in our design. We know that the runtime of a blockchain is the business logic that defines its behavior, and the Substrate runtime need to run by an executor and environment. So that we design the executor and environment more like a "sandbox" to run a Substrate runtime.'),(0,i.kt)("p",null,"In v0.2, the primary target is to modify ",(0,i.kt)("inlineCode",{parentName:"p"},"FRAME Contracts pallet")," in runtime to provide more detailed debugging information, including contract execution process information (in ",(0,i.kt)("inlineCode",{parentName:"p"},"FRAME Contracts")," layer) and WASM execution information (in WASMI execution layer)."),(0,i.kt)("h3",{id:"summary-of-europas-v02-plan"},"Summary of Europa's v0.2 plan:"),(0,i.kt)("blockquote",null,(0,i.kt)("ol",{parentName:"blockquote"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("em",{parentName:"li"},"Modify at ",(0,i.kt)("inlineCode",{parentName:"em"},"FRAME Contracts pallet")," level to provide more information."))),(0,i.kt)("h3",{parentName:"blockquote",id:"how-to-verify-v02--github-source"},"How to verify v0.2:  Github source"),(0,i.kt)("ul",{parentName:"blockquote"},(0,i.kt)("li",{parentName:"ul"},"Construct incorrect contracts and execute logs printing to determine whether it meets expectations"),(0,i.kt)("li",{parentName:"ul"},"Display the call statistics of the ",(0,i.kt)("inlineCode",{parentName:"li"},"define_env!")," interface during contract execution"),(0,i.kt)("li",{parentName:"ul"},"Execute the log printing function, provide formatted printing examples of different data, and judge whether it meets expectations"),(0,i.kt)("li",{parentName:"ul"},"Construct a contract that crashes under different conditions and record the log after execution. Then judge whether the backtrace information of the contract execution is completely printed, and check whether it matches the actual execution of the collapsed contract."))),(0,i.kt)("p",null,"\u540e\u6587\u7edf\u4e00\u79f0",(0,i.kt)("inlineCode",{parentName:"p"},"FRAME Contracts pallet"),"\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u3002"),(0,i.kt)("h2",{id:"design"},"Design"),(0,i.kt)("p",null,"\u57280.2\u4e2d\uff0c\u5bf9\u4e8e\u5408\u7ea6\u6a21\u5757\u7684\u8c03\u8bd5\u4fe1\u606f\u529f\u80fd\u7684\u63d0\u5347\u5206\u4e3a\u4e09\u4e2a\u90e8\u5206\u7684\u4fee\u6539\uff1a"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"pallet-contracts"),"\u5c42\u7684\u4fee\u6539\uff1a\u5728",(0,i.kt)("inlineCode",{parentName:"li"},"pallet-contracts"),"\u7684\u6267\u884c\u5408\u7ea6\u7684\u8fc7\u7a0b\u4e2d\u6dfb\u52a0trace\u8bb0\u5f55\u5728\u5408\u7ea6\u5c42\u4e2d\u7684\u4fe1\u606f\uff0c\u5e76\u4e14\u8bb0\u5f55\u5408\u7ea6\u7684\u8c03\u7528\u5c42\u7ea7\u3002\u53e6\u4e00\u65b9\u9762\u5b8c\u5584\u4e86\u8c03\u7528wasm\u6267\u884c\u7684\u9519\u8bef\u4fe1\u606f\u3002"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"wasmi"),"\u5c42\u7684\u4fee\u6539\uff1a\u7ed9\u4e88",(0,i.kt)("inlineCode",{parentName:"li"},"wasmi"),"\u63d0\u4f9b\u4e86\u8bb0\u5f55wasm\u6267\u884c\u4e2d\u7684backtrace\u529f\u80fd\uff0c\u5e76\u4e14\u7ed9",(0,i.kt)("inlineCode",{parentName:"li"},"parity-wasm"),"\uff0c",(0,i.kt)("inlineCode",{parentName:"li"},"pwasm-utils"),"\uff0c",(0,i.kt)("inlineCode",{parentName:"li"},"cargo-contract"),"\u63d0\u4f9b\u4e86\u652f\u6301\u5728\u5408\u7ea6\u7684wasm\u5904\u7406\u4e2d\u5305\u542bname section\u7684\u529f\u80fd\u3002"),(0,i.kt)("li",{parentName:"ul"},"\u5408\u7ea6\u65e5\u5fd7\u529f\u80fd\uff1a\u4f7f\u7528",(0,i.kt)("inlineCode",{parentName:"li"},"ChainExtensions"),"\u7684\u529f\u80fd\u5b9e\u73b0\u4e86\u5408\u7ea6\u4e2d\u6253\u5370",(0,i.kt)("inlineCode",{parentName:"li"},"log"),"\u65e5\u5fd7\u7684\u5e93\u3002")),(0,i.kt)("p",null,"\u5f53\u524d\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u4e2d\uff0c\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"wasmi"),"\u4e2d\u6267\u884c\u51fa\u73b0\u9519\u8bef\u4ee5\u53cawasmi\u6267\u884c\u8fc7\u7a0b\u4e2d\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u7684",(0,i.kt)("a",{parentName:"p",href:"https://webassembly.github.io/spec/core/exec/runtime.html#function-instances"},"host_function"),"\u51fa\u73b0\u9519\u8bef\u7684\u65f6\u5019\uff0c\u5bf9\u5916\u90fd\u8868\u73b0\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"ContractTrap"),"\u3002\u8fd9\u4e2a\u60c5\u51b5\u5bf9\u4e8e\u5f00\u53d1\u8005\u5f88\u96be\u5b9a\u4f4d\u9519\u8bef\u51fa\u73b0\u7684\u539f\u56e0\uff0c\u4ec5\u4ece\u8fd9\u4e2a\u4fe1\u606f\u65e0\u6cd5\u5206\u8fa8\u51fa\u51fa\u73b0\u95ee\u9898\u7684\u5730\u65b9\u662f\u5408\u7ea6\u81ea\u8eab\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"ink!"),"\uff0c\u8fd8\u662f",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u3002\u56e0\u6b64\u8fd9\u4e2a\u7248\u672c\u7684europa\u63d0\u4f9b\u7684\u4e30\u5bcc\u7684\u4fe1\u606f\uff0c\u80fd\u8ba9\u5f00\u53d1\u8005\u76f4\u63a5\u5b9a\u4f4d\u5230\u51fa\u73b0\u95ee\u9898\u7684\u539f\u56e0\u4e0a\u3002"),(0,i.kt)("h3",{id:"pallet-contracts\u5c42"},(0,i.kt)("inlineCode",{parentName:"h3"},"pallet-contracts"),"\u5c42"),(0,i.kt)("p",null,"europa\u8ba4\u4e3a\u5728\u5408\u7ea6\u8c03\u8bd5\u8fc7\u7a0b\u9700\u8981\uff1a"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"\u4e30\u5bcc\u9519\u8bef\u4fe1\u606f\uff1awasm\u8bb0\u5f55\u6574\u4e2a\u6267\u884c\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u9519\u8bef\u4fe1\u606f\u7684\u60c5\u51b5\uff0c\u5305\u542bwasm\u6267\u884c\u5668\u7684\u9519\u8bef\u4ee5\u53cahost_function\u7684\u9519\u8bef\u3002wasmi\u7684backtrace\u4fe1\u606f\u4f1a\u548c\u8fd9\u91cc\u7684\u9519\u8bef\u4fe1\u606f\u7edf\u4e00\u8d77\u6765\u3002"),(0,i.kt)("li",{parentName:"ol"},"\u8c03\u8bd5\u8fc7\u7a0b\u4e2d\u7684\u6267\u884c\u60c5\u51b5\uff1a",(0,i.kt)("inlineCode",{parentName:"li"},"pallet-contracts"),"\u7684\u4e3b\u8981\u4fee\u6539\u4fe1\u606f\uff0c\u4ee5\u201c\u5408\u7ea6\u6808\u201d\u4e3a\u8bb0\u5f55\u5408\u7ea6\u8c03\u7528\u5408\u7ea6\u7684\u8fc7\u7a0b\uff0c\u4ee5\u53ca\u5f53\u524d\u8fd9\u4e00\u5c42\u5408\u7ea6\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u4efb\u4f55\u80fd\u8f85\u52a9\u8c03\u8bd5\u7684\u4fe1\u606f\uff0c\u4f8b\u5982\u8c03\u7528host_function\u7684\u60c5\u51b5\uff0cselector\uff0c\u8c03\u7528\u5408\u7ea6\u7684\u53c2\u6570\u7b49\u7b49\u3002")),(0,i.kt)("p",null,"\u56e0\u6b64\u9488\u5bf9\u8fd9\u6837\u7684\u9700\u6c42\uff0ceuropa\u505a\u4e86\u5982\u4e0b\u8bbe\u8ba1\u4e0e\u4fee\u6539\uff1a"),(0,i.kt)("h4",{id:"\u4e30\u5bcc\u9519\u8bef\u4fe1\u606f"},"\u4e30\u5bcc\u9519\u8bef\u4fe1\u606f"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"wasm\u6267\u884c\u5668\u5c42\u7684\u9519\u8bef\uff1a"),(0,i.kt)("p",{parentName:"li"},"europa\u8bbe\u8ba1\u4e86\u81ea\u5df1\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"ep-sandbox"),"\u66ff\u6362\u4e86\u539f\u672c",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u4f7f\u7528\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"sp-sandbox"),"\uff0c\u5e76\u4fee\u6539",(0,i.kt)("inlineCode",{parentName:"p"},"ep_sandbox::Error")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-rust"},"use patract_wasmi::Error as WasmiError;\npub enum Error {\n    Module(WasmiError),\n    OutOfBounds,\n    Execution,\n    WasmiExecution(WasmiError),\n}\n")),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"Module(WasmiError)"),"\u643a\u5e26wasm\u5c42\u7684\u539f\u59cb\u9519\u8bef\u4fe1\u606f\uff0c\u5e76\u4e14\u5728 ",(0,i.kt)("inlineCode",{parentName:"p"},"frame/contracts/src/wasm/runtime.rs "),"\u4e2d\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"to_execution_result"),"\u8f6c\u6362\u4e3a ",(0,i.kt)("inlineCode",{parentName:"p"},"String"),"\u629b\u51fa\u9519\u8bef\u4fe1\u606f\u3002"),(0,i.kt)("p",{parentName:"li"},"europa\u81ea\u5df1\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"ep-sandbox"),"\u53ea\u6709",(0,i.kt)("inlineCode",{parentName:"p"},"std"),"\u7248\u672c\uff08\u56e0\u4e3aeuropa\u5df2\u7ecf\u79fb\u9664\u4e86\u6240\u6709\u7684WASM\u7684\u90e8\u5206\uff0c\u4e0d\u9700\u8981",(0,i.kt)("inlineCode",{parentName:"p"},"ep-sandbox"),"\u652f\u6301",(0,i.kt)("inlineCode",{parentName:"p"},"no-std"),"\uff09\uff0c\u56e0\u6b64\u5728\u5c06\u6765\uff0c",(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("inlineCode",{parentName:"strong"},"ep-sandbox"),"\u53ef\u4ee5\u66ff\u6362\u4e3a\u4e0d\u540c\u7684wasm\u6267\u884c\u5668\uff0c\u4ee5\u652f\u6301\u4e0d\u540cwasm\u6267\u884c\u5668\u7684\u8fd0\u884c\u6d4b\u8bd5\u53ca\u66ff\u6362\u4e3a\u652f\u6301debug\u7684wasm\u6267\u884c\u5668\u7b49\u7279\u6027\u3002")),(0,i.kt)("p",{parentName:"li"},"\u5f53\u524d",(0,i.kt)("inlineCode",{parentName:"p"},"ep-sandbox"),"\u4f7f\u7528\u7684\u662f\u4e00\u4e2aforked\u7248\u672c\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"wasmi"),"\u4f5c\u4e3a\u6267\u884c\u5668\uff0c\u56e0\u6b64\u5176\u629b\u51fa\u7684\u9519\u8bef\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"WasmiError"),"\u3002\u5bf9\u4e8e",(0,i.kt)("inlineCode",{parentName:"p"},"wasmi"),"\u7684\u9519\u8bef\u6539\u52a8\u89c1\u4e0b\u4e00\u4e2a\u7ae0\u8282\u3002")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"host_function\u7684\u9519\u8bef"),(0,i.kt)("p",{parentName:"li"},"host\u51fd\u6570\u6267\u884c\u9519\u8bef\u4f1a\u5f15\u8d77Trap\uff0c\u5e76\u4e14\u4f1a\u8bb0\u5f55",(0,i.kt)("inlineCode",{parentName:"p"},"TrapReason"),"\u3002\u5bf9\u6570\u636e\u7ed3\u6784\u4e0d\u8fdb\u884c\u4fee\u6539\uff0c\u53ea\u9700\u8981\u8bb0\u5f55\u5373\u53ef\u3002"))),(0,i.kt)("h4",{id:"\u8c03\u8bd5\u8fc7\u7a0b\u4e2d\u7684\u6267\u884c\u60c5\u51b5"},"\u8c03\u8bd5\u8fc7\u7a0b\u4e2d\u7684\u6267\u884c\u60c5\u51b5"),(0,i.kt)("p",null,"europa forked \u7248\u672c\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u8bbe\u8ba1\u4e86\u4e00\u4e2a\u5bf9\u8c61\u8bb0\u5f55\u5408\u7ea6\u6267\u884c\u4e2d\u4efb\u4f55\u53ef\u4ee5\u5e2e\u52a9\u8c03\u8bd5\u7684\u4fe1\u606f\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-rust"},"/// Record the contract execution context.\npub struct NestedRuntime {\n    /// Current depth\n    depth: usize,\n    /// The current contract execute result\n    ext_result: ExecResult,\n    /// The value in sandbox successful result\n    sandbox_result_ok: Option<ReturnValue>,\n    /// Who call the current contract\n    caller: AccountId32,\n    /// The account of the current contract\n    self_account: Option<AccountId32>,\n    /// The input selector\n    selector: Option<HexVec>,\n    /// The input arguments\n    args: Option<HexVec>,\n    /// The value in call or the endowment in instantiate\n    value: u128,\n    /// The gas limit when this contract is called\n    gas_limit: Gas,\n    /// The gas left when this contract return\n    gas_left: Gas,\n    /// The host function call stack\n    env_trace: EnvTraceList,\n    /// The error in wasm\n    wasm_error: Option<WasmErrorWrapper>,\n    /// The trap in host function execution\n    trap_reason: Option<TrapReason>,\n    /// Nested contract execution context\n    nest: Vec<NestedRuntime>,\n}\n")),(0,i.kt)("p",null,"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u7684\u6a21\u578b\u4e2d\uff0c\u5408\u7ea6\u8c03\u7528\u5408\u7ea6\u662f\u4ee5\u201c\u5408\u7ea6\u6808\u201d\u7684\u6a21\u578b\u8c03\u7528\uff0c\u56e0\u6b64",(0,i.kt)("inlineCode",{parentName:"p"},"NestedRuntime"),"\u4f1a\u8ddf\u8e2a\u6574\u4e2a\u5408\u7ea6\u6808\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u5e76\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"nest"),"\u8fd9\u4e2a\u5c5e\u6027\u4fdd\u5b58\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"NestedRuntime"),"\u5217\u8868\u8868\u793a\u5f53\u524d\u5408\u7ea6\u4e2d\u8c03\u7528\u8fc7\u7684\u5176\u4ed6\u5408\u7ea6\u3002"),(0,i.kt)("p",null,"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u6267\u884c\u4e00\u4e2a\u5408\u7ea6\u7684\u8fc7\u7a0b\u4e2d\uff0ceuropa\u4ee5\u65c1\u8def\u7684\u5f62\u6001\u5c06\u6267\u884c\u8fc7\u7a0b\u4e2d\u7684\u76f8\u5173\u4fe1\u606f\u8bb0\u5f55\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"NestedRuntime"),"\u8fd9\u4e2a\u7ed3\u6784\u4f53\u4e2d\uff0c\u5e76\u5728\u5408\u7ea6\u8c03\u7528\u7ed3\u675f\u540e\u5c06",(0,i.kt)("inlineCode",{parentName:"p"},"NestedRuntime"),"\u4ee5\u4e00\u5b9a\u683c\u5f0f\u5316\u7684\u5f62\u5f0f\u6253\u5370\u5230\u65e5\u5fd7\u4e2d\uff08\u5c06\u540e\u6587\u6848\u4f8b\u7684\u5c55\u793a\uff09\u3002\u5408\u7ea6\u7684\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u901a\u8fc7\u5206\u6790",(0,i.kt)("inlineCode",{parentName:"p"},"NestedRuntime"),"\u6253\u5370\u7684\u4fe1\u606f\uff0c\u5f97\u5230\u6b64\u6b21\u5408\u7ea6\u6267\u884c\u8fc7\u7a0b\u4e2d\u7684\u5404\u79cd\u8be6\u7ec6\u4fe1\u606f\uff0c\u53ef\u4ee5\u7528\u4e8e\u591a\u79cd\u60c5\u51b5\uff1a"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"\u8f85\u52a9\u5b9a\u4f4d\u9519\u8bef\u51fa\u73b0\u7684\u5177\u4f53\u4f4d\u7f6e\uff0c\u5305\u62ec\u4ee5\u4e0b\u60c5\u51b5\uff1a",(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"pallet-contracts"),"\u5c42\uff0c"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"ink!"),"\u5c42"),(0,i.kt)("li",{parentName:"ol"},"\u5408\u7ea6\u5c42\u4e2d\u7684\u5177\u4f53\u4f4d\u7f6e"),(0,i.kt)("li",{parentName:"ol"},"\u5728\u5408\u7ea6\u8c03\u7528\u5408\u7ea6\u7684\u60c5\u51b5\u4e0b\u5b9a\u4f4d\u5408\u7ea6\u51fa\u73b0\u5728\u54ea\u4e00\u7ea7\u5408\u7ea6\u4e2d"))),(0,i.kt)("li",{parentName:"ol"},"\u5206\u6790\u6b64\u65f6\u5408\u7ea6\u6267\u884c\u8fc7\u7a0b\u4e2d\u4fe1\u606f\uff1a",(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},"\u5206\u6790gas\u6267\u884c\u7684\u6d88\u8017\u60c5\u51b5"),(0,i.kt)("li",{parentName:"ol"},"\u5206\u6790",(0,i.kt)("inlineCode",{parentName:"li"},"get_storage"),"\uff0c",(0,i.kt)("inlineCode",{parentName:"li"},"set_storage"),"\u8c03\u7528\u7684\u60c5\u51b5\uff0c\u5e2e\u52a9\u91cd\u6784\u5408\u7ea6\u4ee3\u7801\u4ee5\u53ca\u5206\u6790",(0,i.kt)("inlineCode",{parentName:"li"},"rent"),"\u7684\u9700\u6c42\u60c5\u51b5"),(0,i.kt)("li",{parentName:"ol"},"\u6839\u636e",(0,i.kt)("inlineCode",{parentName:"li"},"selector"),"\uff0c",(0,i.kt)("inlineCode",{parentName:"li"},"args"),"\u548c",(0,i.kt)("inlineCode",{parentName:"li"},"value"),"\u5206\u6790\u5b9a\u4f4d\u7b2c\u4e09\u65b9sdk\u7ec4\u5efa\u4ea4\u6613\u53c2\u6570\u662f\u5426\u5408\u6cd5\u3002"),(0,i.kt)("li",{parentName:"ol"},"\u6839\u636e",(0,i.kt)("inlineCode",{parentName:"li"},"nest"),"\u4fe1\u606f\u5e76\u7ed3\u5408",(0,i.kt)("inlineCode",{parentName:"li"},"seal_call"),"\u4fe1\u606f\u5206\u6790\u5408\u7ea6\u8c03\u5408\u7ea6\u7684\u6267\u884c\u8def\u5f84\u3002"),(0,i.kt)("li",{parentName:"ol"},"\u7b49\u7b49...")))),(0,i.kt)("p",null,"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u6a21\u5757\u4e2d\u8bb0\u5f55\u5230",(0,i.kt)("inlineCode",{parentName:"p"},"NestEdRuntime"),"\u4e2d\u7684\u8fc7\u7a0b\u662f\u6bd4\u8f83\u7ec6\u7c92\u5ea6\u7684\uff0c\u4ee5",(0,i.kt)("inlineCode",{parentName:"p"},"define_env!"),"\u4e2d\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"seal_call"),"\u4e3a\u4f8b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-rust"},"pub struct SealCall {\n    callee: Option<HexVec>,\n    gas: u64,\n    value: Option<u128>,\n    input: Option<HexVec>,\n    output: Option<HexVec>,\n}\n")),(0,i.kt)("p",null,"\u5176\u4e2d\u7684\u5c5e\u6027\u57fa\u672c\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"Option<>"),"\uff0c\u6bd4\u5982\u5f53\u8c03\u7528\u5408\u7ea6\u524d\u65f6\u4f1a\u8bbe\u7f6e",(0,i.kt)("inlineCode",{parentName:"p"},"input"),"\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"Some"),"\uff0c\u8c03\u7528\u5408\u7ea6\u6b63\u5e38\u540e\u6709\u8fd4\u56de\u503c\uff0c\u5219\u4f1a\u8bbe\u7f6e",(0,i.kt)("inlineCode",{parentName:"p"},"output"),"\uff0c\u5982\u8c03\u7528\u5408\u7ea6\u51fa\u73b0\u9519\u8bef\u540e\uff0c\u5219",(0,i.kt)("inlineCode",{parentName:"p"},"output"),"\u4f1a\u4fdd\u6301",(0,i.kt)("inlineCode",{parentName:"p"},"None"),"\u3002\u56e0\u6b64\u82e5\u51fa\u73b0\u4e86",(0,i.kt)("inlineCode",{parentName:"p"},"input"),"\u662f",(0,i.kt)("inlineCode",{parentName:"p"},"Some"),"\u800c",(0,i.kt)("inlineCode",{parentName:"p"},"output"),"\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"None"),"\u7684\u60c5\u51b5\uff0c\u5219\u8bf4\u660e\u5728\u5408\u7ea6\u8c03\u7528\u5408\u7ea6\u7684\u8fc7\u7a0b\u4e2d\uff0c\u88ab\u8c03\u7528\u7684\u5408\u7ea6\u51fa\u73b0\u4e86\u95ee\u9898\u3002"),(0,i.kt)("p",null,"\u5f53\u524d",(0,i.kt)("inlineCode",{parentName:"p"},"NestedRuntime"),"\u7684\u4fe1\u606f\u53ea\u5728\u65e5\u5fd7\u4e2d\u6253\u5370\uff0c",(0,i.kt)("strong",{parentName:"p"},"\u5c06\u6765",(0,i.kt)("inlineCode",{parentName:"strong"},"NestedRuntime"),"\u5c06\u4f1a\u505a\u672c\u5730\u5316\u5b58\u50a8\u5e76\u63d0\u4f9b\u76f8\u5e94\u7684rpc\u4f9b\u5916\u90e8\u8bbf\u95ee\u83b7\u53d6"),"\u3002\u56e0\u6b64\u5728\u5c06\u6765\u7b2c\u4e09\u65b9\u5e94\u7528\u53ef\u4ee5\u83b7\u53d6",(0,i.kt)("inlineCode",{parentName:"p"},"NestedRuntime"),"\u505a\u8fdb\u4e00\u6b65\u7684\u5904\u7406\uff0c\u4f8b\u5982\u5728Redspot\u4e2d\u53ef\u4ee5\u8bbe\u8ba1\u4e00\u4e2a\u63d2\u4ef6\u6839\u636e",(0,i.kt)("inlineCode",{parentName:"p"},"NestedRuntime"),"\u7684\u4fe1\u606f\u751f\u6210\u4e00\u4e2a\u5408\u7ea6\u8c03\u7528\u5408\u7ea6\u7684\u62d3\u6251\u56fe\uff0c\u5728web\u94b1\u5305\u754c\u9762\u53ef\u4ee5\u751f\u6210\u53ef\u89c6\u5316\u5408\u7ea6\u8c03\u7528\u8def\u5f84\u7b49\u7b49\u3002"),(0,i.kt)("h3",{id:"wasmi\u5c42"},(0,i.kt)("inlineCode",{parentName:"h3"},"wasmi"),"\u5c42"),(0,i.kt)("p",null,"\u6211\u4eecfork\u4e86wasmi\uff0c\u5e76\u5c06\u8fd9\u4e2aforked\u7248\u672c\u7684wasmi\u96c6\u6210\u5230\u4e86",(0,i.kt)("inlineCode",{parentName:"p"},"ep-sandbox"),"\u4e2d\u3002\u800cforked ",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u53ef\u4ee5\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"ep-sandbox"),"\u83b7\u53d6\u5230forked ",(0,i.kt)("inlineCode",{parentName:"p"},"wasmi"),"\u7684\u9519\u8bef\u4fe1\u606f\uff0c\u5305\u542b",(0,i.kt)("inlineCode",{parentName:"p"},"wasmi"),"\u7684backtrace\u4fe1\u606f\u3002"),(0,i.kt)("p",null,"\u5982\u679c\u9700\u8981\u8ba9",(0,i.kt)("inlineCode",{parentName:"p"},"wasmi"),"\u5177\u5907\u80fd\u591f\u4fdd\u7559\u6267\u884c\u7684backtrace\u7684\u4fe1\u606f\uff0c\u9700\u8981\u5177\u5907\u4ee5\u4e0b\u51e0\u70b9\uff1a"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},'WASM\u6e90\u6587\u4ef6\u4e2d\u9700\u8981\u6709"name section"\u6bb5 \uff08name section \u7684\u89c4\u8303\u89c1 ',(0,i.kt)("a",{parentName:"li",href:"https://webassembly.github.io/spec/core/appendix/custom.html#name-section"},"\u201cName Section\u201d"),"\uff09"),(0,i.kt)("li",{parentName:"ol"},"\u5728",(0,i.kt)("inlineCode",{parentName:"li"},"pallet-contracts"),"\u68c0\u67e5\u5408\u7ea6\u7684\u8fc7\u7a0b\u4e2d\u4fdd\u7559\u201cname section\u201d\u4fe1\u606f\u4e14\u5728\u5904\u7406\u8fc7\u7a0b\u540e\u4ecd\u548cwasm\u6e90\u6587\u4ef6\u5177\u5907\u5bf9\u5e94\u5173\u7cfb\u3002"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"wasmi"),'\u7684\u6267\u884c\u8fc7\u7a0b\u4e2d\u9700\u8981\u628a\u6267\u884c\u6808\u4fdd\u7559\u4e0b\u6765\u5e76\u9644\u5e26\u51fd\u6570\u7684\u5173\u952e\u4fe1\u606f\uff0c\u540c\u65f6"name section"\u9700\u8981\u88ab\u89e3\u6790\uff0c\u4e14\u548c',(0,i.kt)("inlineCode",{parentName:"li"},"wasmi"),"\u6267\u884c\u6808\u4fdd\u7559\u7684\u51fd\u6570\u4fe1\u606f\u5bf9\u5e94\u8d77\u6765\u3002")),(0,i.kt)("p",null,"\u5bf9\u4e8e2\u7684\u6539\u52a8\uff0c\u6d89\u53ca",(0,i.kt)("inlineCode",{parentName:"p"},"cargo-build"),"\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"parity-wasm"),"\uff0c\u800c\u5bf9\u4e8e1\uff0c3\u7684\u6539\u52a8\u4e3b\u8981\u4f4d\u4e8eforked \u7684",(0,i.kt)("inlineCode",{parentName:"p"},"wasmi"),"\u4e2d\uff0c\u5c11\u90e8\u5206\u6d89\u53ca",(0,i.kt)("inlineCode",{parentName:"p"},"pwasm-utils"),"\u3002"),(0,i.kt)("h4",{id:"1-submitted-wasm-files-contains-debug-info-\u63d0\u4ea4\u7684wasm\u6e90\u6587\u4ef6\u4e2d\u6709name-section\u63d0\u4f9bdebug-info"},"1. Submitted WASM files contains debug info \u63d0\u4ea4\u7684WASM\u6e90\u6587\u4ef6\u4e2d\u6709\u201cname section\u201d\u63d0\u4f9bdebug info"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"PR: ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/paritytech/cargo-contract/pull/131"},"paritytech/cargo-contract#131")),(0,i.kt)("li",{parentName:"ul"},"Source: ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/patractlabs/cargo-contract"},"patractlabs/cargo-contract"))),(0,i.kt)("p",null,"Frist of all, we have to submit ",(0,i.kt)("strong",{parentName:"p"},"wasm files which contain the debug info")," that the on-chain side can parse and get the panic errors."),(0,i.kt)("p",null,"Currently, ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/patractlabs/cargo-contract"},"parity/cargo-contract")," trims debug info while building contracts, we can get them back with the following steps."),(0,i.kt)("h5",{id:"11-keep-name-section-from-striping"},"1.1 Keep name section from striping"),(0,i.kt)("p",null,"The name section has been striped at ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/cargo-contract/blob/71525f9ec5f21e6113a614c2fb4d1eb5e62ebf8b/src/cmd/build.rs#L247"},"cargo-contract/cmd/build.rs#L247"),"."),(0,i.kt)("h5",{id:"12-keep-debug-info-from-wasm-opt"},"1.2 Keep debug info from ",(0,i.kt)("inlineCode",{parentName:"h5"},"wasm-opt")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"cargo-contract")," passes ",(0,i.kt)("inlineCode",{parentName:"p"},"debug_info: false")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"wasm-opt"),", so the debug-info will be always optimized when we run ",(0,i.kt)("inlineCode",{parentName:"p"},"wasm-opt"),", the code is here: ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/cargo-contract/blob/71525f9ec5f21e6113a614c2fb4d1eb5e62ebf8b/src/cmd/build.rs#L267"},"cargo-contract/cmd/build.rs#L267"),"."),(0,i.kt)("h5",{id:"13-keep-debug-info-from-rustc"},"1.3 Keep debug info from ",(0,i.kt)("inlineCode",{parentName:"h5"},"rustc")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"cargo-contract")," executes realease build by default, here we can enable debug build or modify the opt-level flag of ",(0,i.kt)("inlineCode",{parentName:"p"},"rustc")," to keep debug infos at ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/cargo-contract/blob/71525f9ec5f21e6113a614c2fb4d1eb5e62ebf8b/src/cmd/build.rs#L137"},"cargo-contract/cmd/build.rs#L137"),"."),(0,i.kt)("h4",{id:"2-save-debug-info-from-the-scraper-of-pallet-contracts"},"2. Save debug info from the scraper of ",(0,i.kt)("inlineCode",{parentName:"h4"},"pallet-contracts")),(0,i.kt)("p",null,"What happends to the ",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts")," while we calling a contract?"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Get the WASM binary from storage")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Inject gas meter to the contract")),(0,i.kt)("li",{parentName:"ul"},"Inject stack height to the contract"),(0,i.kt)("li",{parentName:"ul"},"Put the contract into ",(0,i.kt)("inlineCode",{parentName:"li"},"sp-sandbox")," and execute it"),(0,i.kt)("li",{parentName:"ul"},"Get the result from ",(0,i.kt)("inlineCode",{parentName:"li"},"sp-sandbox")," and return the result to us")),(0,i.kt)("h5",{id:"21-store-name-section-while-building-wasm-module"},"2.1 Store name section while building WASM module"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"PR: ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/paritytech/parity-wasm/pull/300"},"https://github.com/paritytech/parity-wasm/pull/300"))),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts")," builds WASM modules from storage and drops custom sections by default, here we should get them back."),(0,i.kt)("h5",{id:"22-update-function-indices-in-name-section-while-injecting-gas-meter"},"2.2 Update function indices in name section while injecting gas meter"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"PR: ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/paritytech/wasm-utils/pull/146"},"paritytech/wasm-utils#146")),(0,i.kt)("li",{parentName:"ul"},"Source: ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/patractlabs/wasm-utils"},"patractlabs/wasm-utils#146"))),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts")," reorders the indcies of functions in our WASM contracts after injecting gas memter to the WASM contracts at ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/wasm-utils/blob/d9432bafa9321f8e0e5b8a143f1ed858dbbbe272/src/gas/mod.rs#L467"},"paritytech/wasm-utils/gas/mod.rs#L467"),", this will mess up the function indecies in name section that we can not get the correct backtraces."),(0,i.kt)("h4",{id:"3-impelment-wasm-backtrace-to-wasmi"},"3. Impelment WASM backtrace to WASMI"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Source: ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/patractlabs/wasmi"},"patractlabs/wasmi"))),(0,i.kt)("p",null,"Remember the last two steps in chapter 2, the core part of enabling WASM backtrace to pallet-contract is making ",(0,i.kt)("inlineCode",{parentName:"p"},"wasmi")," support backtrace."),(0,i.kt)("p",null,"The process of executing a function in the interpreter of wasmi is like:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Invoke the target function"),(0,i.kt)("li",{parentName:"ul"},"call and call and call over again",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Panic if the process breaks.")))),(0,i.kt)("h5",{id:"31-add-function-info-field-to-funcref"},"3.1 Add function info field to ",(0,i.kt)("inlineCode",{parentName:"h5"},"FuncRef")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"FuncRef")," is the 'function' wasmi interpreter calling directly, so we need to embed the debug info into the ",(0,i.kt)("inlineCode",{parentName:"p"},"FuncRef")," as the first time, source at ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/patractlabs/wasmi/blob/v0.6.2/src/func.rs#L26"},"wasmi/func.rs#L26"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"//! patractlabs/wasmi/src/func.rs#L26\n/// ...\npub struct FuncRef {\n    /// ...\n    /// Function name and index for debug\n    info: Option<(usize, String)>,\n}\n")),(0,i.kt)("h5",{id:"32-set-function-info-using-name-section-while-parsing-wasm-modules"},"3.2 Set function info using name section while parsing WASM modules"),(0,i.kt)("p",null,"We alread have the ",(0,i.kt)("inlineCode",{parentName:"p"},"info")," field in ",(0,i.kt)("inlineCode",{parentName:"p"},"FuncRef"),", now we need to fill this field using name setciton while parsing WASM modules, source at ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/patractlabs/wasmi/blob/7a6feaea70f47aa6e62f097fb0d9a4ea0ce7d1fc/src/runner.rs#L1491"},"wasmi/module#L343"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'//! wasmi/src/module.rs#L343\n// ...\nif has_name_section {\n     if let Some(name) = function_names.get((index + import_count) as u32) {\n         func_instance = func_instance.set_info(index, name.to_string());\n     } else {\n         func_instance = func_instance.set_info(index, "<unknown>".to_string());\n     }\n}\n// ...\n')),(0,i.kt)("h5",{id:"33-make-the-interpreter-support-trace"},"3.3 Make the interpreter support ",(0,i.kt)("inlineCode",{parentName:"h5"},"trace")),(0,i.kt)("p",null,"However, we don't need to get infos of every functions but the panicked series in the stack of the interpreter, source at ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/patractlabs/wasmi/blob/7a6feaea70f47aa6e62f097fb0d9a4ea0ce7d1fc/src/runner.rs#L1491"},"wasmi/runner.rs#L1491"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"//! wasmi/src/runner.rs#L1491\n/// Get the functions of current the stack\npub fn trace(&self) -> Vec<Option<&(usize, String)>> {\n    self.buf.iter().map(|f| f.info()).collect::<Vec<_>>()\n}\n")),(0,i.kt)("h5",{id:"34-gather-debug-infos-when-program-breaks"},"3.4 Gather debug infos when program breaks"),(0,i.kt)("p",null,"Just gather backtraces when we invoke function failed, source at ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/patractlabs/wasmi/blob/7a6feaea70f47aa6e62f097fb0d9a4ea0ce7d1fc/src/func.rs#L170"},"wasmi/func.rs#L170"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'//! wasmi/src/func.rs#L170\n// ...\n\nlet res = interpreter.start_execution(externals);\nif let Err(trap) = res {\nlet mut stack = interpreter\n    .trace()\n    .iter()\n    .map(|n| {\n        if let Some(info) = n {\n            format!("{:#}[{}]", rustc_demangle::demangle(&info.1), info.0)\n        } else {\n            "<unknown>".to_string()\n        }\n    })\n    .collect::<Vec<_>>();\n\n// Append the panicing trap\nstack.append(&mut trap.wasm_trace().clone());\nstack.reverse();\n\n// Embed this info into the trap\nErr(trap.set_wasm_trace(stack))\n\n// ...\n')),(0,i.kt)("h3",{id:"\u5408\u7ea6\u65e5\u5fd7\u529f\u80fd"},"\u5408\u7ea6\u65e5\u5fd7\u529f\u80fd"),(0,i.kt)("p",null,"\u5728\u5408\u7ea6\u8c03\u8bd5\u7684\u8fc7\u7a0b\u4e2d\u9700\u8981\u77e5\u9053\u5408\u7ea6\u6267\u884c\u5185\u90e8\u7684\u6267\u884c\u60c5\u51b5\u4ee5\u53ca\u4e2d\u95f4\u6570\u636e\uff0c\u5728\u5f53\u524d\u7f3a\u4e4fdebug \u8c03\u8bd5\u6761\u4ef6\u7684\u60c5\u51b5\u4e0b\uff08\u4f8b\u5982\u4f7f\u7528gdb\u8fdb\u884c\u8c03\u8bd5\uff09\uff0c\u901a\u8fc7\u65e5\u5fd7\u6253\u5370\u662f\u6700\u65b9\u4fbf\u7684\u65b9\u5f0f\u3002\u6b63\u5982\u5728europa v0.2 proposal\u4e2d\u63d0\u5230\u7684\uff0c\u5f53\u524d",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u4e0e",(0,i.kt)("inlineCode",{parentName:"p"},"ink!"),"\u5df2\u7ecf\u652f\u6301\u4e86",(0,i.kt)("inlineCode",{parentName:"p"},"format!"),"+",(0,i.kt)("inlineCode",{parentName:"p"},"seal_println"),"\u7684\u65b9\u5f0f\u683c\u5f0f\u5316\u6253\u5370\u5b57\u7b26\u4e32\uff0c\u4f46\u662f\u901a\u8fc7\u8fd9\u79cd\u6a21\u5f0f\u67092\u4e2a\u7f3a\u9677\uff1a"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"seal_println"),"\u7684\u6240\u6709\u6253\u5370\u5728\u8282\u70b9\u7aef\u4e3a",(0,i.kt)("inlineCode",{parentName:"li"},"target: runtime"),"\u4e14\u7ea7\u522b",(0,i.kt)("inlineCode",{parentName:"li"},"DEBUG"),"\u7684\u65e5\u5fd7\uff0c\u4f46\u662f\u4f46\u5f00\u53d1\u590d\u6742\u5408\u7ea6\u7684\u65f6\u5019\u5c06\u4f1a\u6253\u5370\u5f88\u591a\u7684\u65e5\u5fd7\uff0c\u5982\u679c\u4e0d\u80fd\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"li"},"target"),"\u4ee5\u53ca\u65e5\u5fd7\u7ea7\u522b\u6765\u8fc7\u6ee4\u65f6\uff0c\u90a3\u4e48\u5f00\u53d1\u7684\u8fc7\u7a0b\u4e2d\u5c06\u4f1a\u5145\u65a5\u7740\u65e0\u5173\u4fe1\u606f\u7684\u5e72\u6270\u3002"),(0,i.kt)("li",{parentName:"ol"},"\u5408\u7ea6\u5f00\u53d1\u8005\u5728\u5f00\u53d1\u7684\u8fc7\u7a0b\u4e2d\u5728\u9700\u8981\u7684\u65f6\u5019\u7f16\u5199\u4e86",(0,i.kt)("inlineCode",{parentName:"li"},"seal_println"),"\uff0c\u4f46\u662f\u5728\u5408\u7ea6\u53d1\u5e03\u7684\u65f6\u5019\u9700\u8981\u628a",(0,i.kt)("inlineCode",{parentName:"li"},"seal_println"),"\u5168\u90e8\u5220\u9664\u3002\u867d\u7136\u5408\u7ea6\u5f00\u53d1\u8005\u53ef\u4ee5\u81ea\u5df1\u5c01\u88c5\u4e00\u4e2a\u6761\u4ef6\u7f16\u8bd1\u7684\u51fd\u6570\u6765\u63a7\u5236\uff0c\u4f46\u662f\u82e5\u6709\u5de5\u5177\u5e93\u5df2\u7ecf\u63d0\u4f9b\u4e86\u8fd9\u6837\u7684\u529f\u80fd\u5219\u66f4\u52a0\u65b9\u4fbf\u3002")),(0,i.kt)("p",null,"\u56e0\u6b64europa\u63d0\u4f9b\u4e86\u4e00\u4e2a\u6a21\u4effrust\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"log")," crete\u7684\u65e5\u5fd7\u5e93",(0,i.kt)("a",{parentName:"p",href:"https://github.com/patractlabs/ink-log"},(0,i.kt)("inlineCode",{parentName:"a"},"ink-log")),"\u6765\u89e3\u51b3\u4ee5\u4e0a\u95ee\u9898\uff0c\u5176\u4f7f\u7528\u65b9\u5f0f\u4e0erust\u4e2d\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"log"),"\u5b8c\u5168\u4e00\u81f4\uff0c\u51cf\u5c11\u4e86\u5f00\u53d1\u8005\u7684\u5b66\u4e60\u6210\u672c\u3002"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"ink-log"),"\u603b\u4f53\u4e0a\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"ChainExtension"),"\u5b9e\u73b0\uff0c\u7ea6\u5b9a\u7684\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"function_id"),"\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"0xfeffff00"),"\uff0c\u901a\u8fc7\u7ed3\u6784\u4f53",(0,i.kt)("inlineCode",{parentName:"p"},"LoggerExt"),"\u5728wasm\u7684memory\u4e2d\u4f20\u9012\u6d88\u606f\u3002\u56e0\u6b64\u8fd9\u4e2a\u5e93\u5206\u4e3a\u4ee5\u4e0b\u4e24\u90e8\u5206\uff1a"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"ink_log"),"\uff1a \u5728",(0,i.kt)("inlineCode",{parentName:"p"},"ink-log/contracts"),"\u76ee\u5f55\u4e0b\uff0c\u7ed9\u5408\u7ea6\u7684\u7f16\u5199\u63d0\u4f9b",(0,i.kt)("inlineCode",{parentName:"p"},"info!"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"debug!"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"warn!"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"error!"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"trace!"),"\u8fd9\u51e0\u4e2a\u4e0erust \u7684",(0,i.kt)("inlineCode",{parentName:"p"},"log"),"\u5e93\u4e00\u6837\u7684\u5b8f\uff0c\u4e14\u5b8f\u7684\u8c03\u7528\u65b9\u5f0f\u4e5f\u4e0e",(0,i.kt)("inlineCode",{parentName:"p"},"log"),"\u5b8c\u5168\u4e00\u81f4\u3002\u8fd9\u4e9b\u5b8f\u662f\u5bf9ink\u7aef\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"seal_chain_extensions"),"\u7684\u5305\u88c5\u5b9e\u73b0\uff0c\u662f",(0,i.kt)("strong",{parentName:"p"},"\u7ed9\u5408\u7ea6\u5f00\u53d1\u8005\u4f7f\u7528\u7684\u5de5\u5177\u5e93"),"\u3002\u4f8b\u5982\u5728\u5408\u7ea6\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"Cargo.toml"),"\u5f15\u5165\u4e86\u8fd9\u4e2a\u5e93\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u65b9\u5f0f\u6253\u5370\u65e5\u5fd7\uff1a"),(0,i.kt)("p",{parentName:"li"},"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"Cargo.toml"),"\u4e2d:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-cargo"},'[dependencies]\nink_log = { version = "0.1", git = "https://github.com/patractlabs/ink-log", default-features = false, features = ["ink-log-chain-extensions"] }\n\n[features]\ndefault = ["std"]\nstd = [\n    # ...\n    "ink_log/std"\n]\n')),(0,i.kt)("p",{parentName:"li"},"\u5728\u5408\u7ea6\u4e2d\u5219\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u65b9\u5f0f\u5728\u8282\u70b9\u4e2d\u6253\u5370\u65e5\u5fd7\uff1a"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-rust"},'ink_log::info!(target: "flipper-contract", "latest value is: {}", self.value);\n'))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"runtime_log"),"\uff1a\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"ink-log/runtime"),"\u76ee\u5f55\u4e0b\uff0c\u8fd9\u4e2a\u5e93\u662f\u6839\u636e\u4ece",(0,i.kt)("inlineCode",{parentName:"p"},"ChainExtensions"),"\u4f20\u9012\u8fc7\u6765\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"function_id"),"\u548c",(0,i.kt)("inlineCode",{parentName:"p"},"LoggerExt"),"\u7ed3\u6784\u4f53\u7684\u5185\u5bb9\uff0c\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"frame_support"),"\u91cc\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"debug"),"\u4e0b\u7684\u76f8\u5e94\u65e5\u5fd7\u8fdb\u884c\u6253\u5370\u3002\u662f",(0,i.kt)("strong",{parentName:"p"},"\u7ed9\u94fe\u7684\u5f00\u53d1\u8005\u51c6\u5907\u7684",(0,i.kt)("inlineCode",{parentName:"strong"},"ink_log"),"\u7684\u5b9e\u73b0\u5e93\u3002"),"\u4f8b\u5982\u94fe\u7684\u5f00\u53d1\u8005\u53ef\u4ee5\u5728\u81ea\u5df1\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"ChainExtensions"),"\u4e2d\u4f7f\u7528\uff1a"),(0,i.kt)("p",{parentName:"li"},"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"Cargo.toml"),"\u4e2d\uff1a"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-rust"},'[dependencies]\nruntime_log = { version = "0.1", git = "https://github.com/patractlabs/ink-log", default-features = false }\n\n[features]\ndefault = ["std"]\nstd = [\n    # ...\n    "runtime_log/std"\n]\n')),(0,i.kt)("p",{parentName:"li"},"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"ChainExtensions"),"\u7684\u5b9e\u73b0\u4f53\u4e2d\uff1a"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-rust"},"pub struct CustomExt;\nimpl ChainExtension for CustomExt {\n    fn call<E: Ext>(func_id: u32, env: Environment<E, InitState>) -> Result<RetVal, DispatchError>\n    where\n        <E::T as SysConfig>::AccountId: UncheckedFrom<<E::T as SysConfig>::Hash> + AsRef<[u8]>,\n    {\n        match func_id {\n            ... => {/* other ChainExtension */ }\n            0xfeffff00 => {\n                // TODO add other libs\n                runtime_log::logger_ext!(func_id, env);\n                // or use\n                // LoggerExt::call::<E>(func_id, env)\n                Ok(RetVal::Converging(0))\n            }\n        }   \n    }\n}\n")))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("inlineCode",{parentName:"strong"},"ink_log"),"\u4e0e",(0,i.kt)("inlineCode",{parentName:"strong"},"runtime_log"),"\u76f8\u5bf9\u5e94\uff0c\u56e0\u6b64\u82e5\u5408\u7ea6\u5f00\u53d1\u8005\u9700\u8981\u4f7f\u7528",(0,i.kt)("inlineCode",{parentName:"strong"},"ink_log"),"\u7684\u65f6\u5019\uff0c\u9700\u8981\u6ce8\u610f\u8c03\u8bd5\u5408\u7ea6\u5bf9\u5e94\u7684\u94fe\u9700\u8981\u5b9e\u73b0\u4e86",(0,i.kt)("inlineCode",{parentName:"strong"},"runtime_log"),"\u3002")),(0,i.kt)("p",null,"\u53e6\u4e00\u65b9\u9762\u5408\u7ea6\u5f00\u53d1\u8005\u5f15\u5165",(0,i.kt)("inlineCode",{parentName:"p"},"ink_log"),"\u540e\uff0c\u9700\u8981\u6ce8\u610f",(0,i.kt)("inlineCode",{parentName:"p"},'features = ["ink-log-chain-extensions"]'),"\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"ink_log"),"\u53ea\u6709\u5f00\u542f\u4e86\u8fd9\u4e2afeature\u624d\u4f1a\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"seal_chain_extensions"),"\u4e0e\u94fe\u8fdb\u884c\u4ea4\u4e92\u3002\u82e5\u6ca1\u6709\u8fd9\u4e2afeatures\u5219\u4f1a\u4f7f\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"noop"),"\u8df3\u8fc7\u5408\u7ea6\u6253\u5370\u7684\u8fc7\u7a0b\u3002"),(0,i.kt)("p",null,"\u56e0\u6b64\u5408\u7ea6\u5f00\u53d1\u8005\u53ef\u4ee5\u901a\u8fc7features\u63a7\u5236\u5408\u7ea6\u5728\u8c03\u8bd5\u73af\u5883\u548c\u751f\u4ea7\u73af\u5883\u4e2d\u6253\u5370\u65e5\u5fd7\uff0c\u5728\u8c03\u8bd5\u73af\u5883\u4e2d\u7f16\u8bd1\u7684\u5408\u7ea6\u5f00\u542f",(0,i.kt)("inlineCode",{parentName:"p"},'"ink-log-chain-extensions"'),"feature\uff0c\u800c\u5728\u751f\u4ea7\u73af\u5883\u7f16\u8bd1\u7684\u5408\u7ea6\u53bb\u6389\u8fd9\u4e2afeature\u3002"),(0,i.kt)("h2",{id:"what-europa-can-do-in-this-version"},"What Europa can do in this version"),(0,i.kt)("h3",{id:"build"},"Build"),(0,i.kt)("p",null,"\u5bf9\u4e8e\u5408\u7ea6\u7684\u5f00\u53d1\u8005\u800c\u8a00\uff0c\u9700\u8981\u51c6\u5907",(0,i.kt)("inlineCode",{parentName:"p"},"europa"),"\u548c",(0,i.kt)("inlineCode",{parentName:"p"},"cargo-contract"),"\u5de5\u5177\u3002"),(0,i.kt)("h4",{id:"europa"},"europa"),(0,i.kt)("p",null,"The building process for this project is as same as ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/substrate/"},"Substrate"),"."),(0,i.kt)("p",null,"When building finished, current executable file in ",(0,i.kt)("inlineCode",{parentName:"p"},"target")," directory is named ",(0,i.kt)("inlineCode",{parentName:"p"},"europa"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"git clone --recurse-submodules https://github.com/patractlabs/europa.git\n")),(0,i.kt)("h4",{id:"cargo-contract"},"cargo-contract"),(0,i.kt)("p",null,"\u82e5\u5e0c\u671b\u5728europa\u7684\u8fd0\u884c\u4e2d\u770b\u5230WASM\u6267\u884c\u7684backtrace\uff0c\u5fc5\u987b\u4f7f\u7528\u6211\u4eec\u63d0\u4f9b\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"cargo-contract"),"\u7248\u672c\u3002\u56e0\u4e3a\u5f53\u524dparitytech \u4ed3\u5e93\u4e0b ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/cargo-contract"},"cargo-contract"),"\u7f16\u8bd1\u5408\u7ea6\u65f6\u4f7f\u7528\u4e86\u6700\u9ad8\u7ea7\u522b\u7684\u4f18\u5316\u7b49\u7ea7\uff0c\u4e14\u4e22\u5f03\u4e86WASM\u4e2d\u7684\u201cname section\u201d\u90e8\u5206\u3002\u4e0a\u6587\u63d0\u5230\u82e5\u9700\u8981\u6253\u5370wasmi\u6267\u884c\u5408\u7ea6\u4e2d\u7684\u8c03\u7528\u6808\u4fe1\u606f\u5fc5\u987b\u8981\u6c42\u5408\u7ea6\u6587\u4ef6\u5177\u5907\u201cname section\u201d\u7684\u90e8\u5206\uff0c\u56e0\u6b64\u4f7f\u7528paritytech\u63d0\u4f9b\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"cargo-contract"),"\u4e0d\u80fd\u6ee1\u8db3\u8981\u6c42\u3002\u6211\u4eec\u5728\u81ea\u5df1\u7684fork\u7684\u4ed3\u5e93\u91cc\u5b8c\u6210\u7684\u8fd9\u4e2a\u529f\u80fd\uff0c\u800c\u53e6\u4e00\u65b9\u9762\u6211\u4eec\u8ba4\u4e3a\u8ba9WASM\u5177\u5907\u201cname section\u201d\u7684\u529f\u80fd\u6216\u8bb8\u4e0d\u4f1a\u53ea\u6709europa\u9700\u8981\uff0c\u56e0\u6b64\u6211\u4eec\u5411\u6e90\u4ed3\u5e93\u63d0\u4ea4\u4e86",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/cargo-contract/pull/131"},"pr#131[Enable debug info with flag in command build] "),"\u63d0\u4f9b\u4e86\u8fd9\u4e2a\u529f\u80fd\u3002"),(0,i.kt)("p",null,"\u5728\u8fd9\u4e2apr\u672a\u5408\u5e76\u524d\uff0c\u5f53\u524d\u53ea\u80fd\u4f7f\u7528\u6211\u4eec\uff08Patract Labs\uff09\u63d0\u4f9b\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"cargo-contract"),"\u7248\u672c\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cargo install --git https://github.com/patractlabs/cargo-contract --branch cmd/debug --force\n")),(0,i.kt)("p",null,"\u5982\u679c\u4e0d\u5e0c\u671b\u8fd9\u4e2a\u7248\u672c\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"cargo-contract"),"\u8986\u76d6paritytech\u53d1\u5e03\u7684\u7248\u672c\uff0c\u90a3\u4e48\u5efa\u8bae\u672c\u5730\u7f16\u8bd1\uff0c\u5e76\u76f4\u63a5\u4f7f\u7528\u7f16\u8bd1\u4ea7\u7269",(0,i.kt)("inlineCode",{parentName:"p"},"cargo-contract"),"\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/patractlabs/cargo-contract --branch cmd/debug\ncd cargo-contract\ncargo build --release\n")),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"\u6ce8\uff1a\u6267\u884c",(0,i.kt)("inlineCode",{parentName:"p"},"cargo-contract build "),"\u547d\u4ee4\u9700\u8981rust\u7f16\u8bd1\u94fe\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"default toolchain"),"\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"nightly"),"\uff0c\u5426\u5219\u53ea\u80fd\u4f7f\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"cargo +nightly contract build"),"\uff0c\u4f46\u662f\u4f7f\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"cargo"),"\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"cargo-contract"),"\u9700\u8981\u6267\u884c",(0,i.kt)("inlineCode",{parentName:"p"},"cargo install"),"\u5b89\u88c5\u6216\u8005\u5c06\u7f16\u8bd1\u4ea7\u7269\u8986\u76d6\u5230",(0,i.kt)("inlineCode",{parentName:"p"},"~/.cargo/bin"),"\u76ee\u5f55\u4e0b\uff0c\u4e0d\u80fd\u548cparitytech\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"cargo-contract"),"\u5171\u5b58")),(0,i.kt)("p",null,"\u6267\u884c"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cargo-contract build --help\n# or\ncargo +nightly contract build --help\n")),(0,i.kt)("p",null,"\u82e5\u80fd\u770b\u5230"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"FLAGS:\n    -d, --debug      \n            Emits debug info into wasm file\n")),(0,i.kt)("p",null,"\u5219\u8868\u793a\u6b63\u5728\u4f7f\u7528Patract Labs\u63d0\u4f9b\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"cargo-contract"),"\uff0c\u82e5\u5e0c\u671b\u4f7f\u7528europa\u7684\u8fc7\u7a0b\u4e2d\u80fd\u770b\u5230WASM\u5408\u7ea6\u6267\u884c\u5d29\u6e83\u7684backtrace\uff0c\u9700\u8981\u7f16\u8bd1\u5408\u7ea6\u7684\u65f6\u5019\u52a0\u4e0a",(0,i.kt)("inlineCode",{parentName:"p"},"--debug"),"\u547d\u4ee4\u3002"),(0,i.kt)("p",null,"\u4f7f\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"--debug"),"\u547d\u4ee4\u5c06\u4f1a\u5728\u539f\u672c\u7f16\u8bd1\u5408\u7ea6\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"target/ink"),"\u76ee\u5f55\u4e2d\uff0c\u751f\u6210\u9664\u4e86\u6b63\u5e38\u6587\u4ef6\u4ee5\u5916\u7684\u53e6\u4e00\u4e2a\u6587\u4ef6\uff0c\u4ee5 ",(0,i.kt)("inlineCode",{parentName:"p"},"*.src.wasm"),"\u7ed3\u5c3e\u3002\u8fd9\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"*.src.wasm"),'\u6587\u4ef6\u5c31\u662f\u542b\u6709"name section"\u90e8\u5206\u7684WASM\u5408\u7ea6\u6587\u4ef6\u3002'),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"\u82e5\u9700\u8981\u4f7f\u7528europa\u505a\u6d4b\u8bd5\uff0c\u5219\u90e8\u7f72\u5230europa\u7684\u5408\u7ea6\u9700\u8981\u4f7f\u7528\u8fd9\u4e2a",(0,i.kt)("inlineCode",{parentName:"strong"},"*.src.wasm"),"\u6587\u4ef6\uff0c\u800c\u4e0d\u662f\u539f\u672c\u751f\u6210\u7684",(0,i.kt)("inlineCode",{parentName:"strong"},"*.wasm"),"\u6587\u4ef6\u3002")),(0,i.kt)("h3",{id:"example"},"example"),(0,i.kt)("p",null,"\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u6848\u4f8b\u548c\u5176\u4ed6\u5df2\u7ecf\u9047\u5230\u8fc7\u7684\u6848\u4f8b\u6765\u9a8c\u8bc1europa\u5b9a\u4f4d\u95ee\u9898\u7684\u53ef\u9760\u6027\u3002"),(0,i.kt)("p",null,"\u5728\u540e\u6587\u4e2d\u542f\u52a8europa\u7684\u65b9\u5f0f\u5747\u4f7f\u7528"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ europa --tmp -lruntime=debug\n")),(0,i.kt)("p",null,"\u8fd9\u79cd\u65b9\u5f0f\u6bcf\u6b21\u542f\u52a8\u7684 europa \u90fd\u5168\u65b0\u7684\u6570\u636e\u3002\u82e5\u60f3\u4fdd\u7559europa\u6267\u884c\u7684\u6570\u636e\uff0c\u8bf7\u53c2\u8003europa \u7684",(0,i.kt)("a",{parentName:"p",href:"https://github.com/patractlabs/europa"},"README"),"\u6216\u8005europa v0.1\u7684",(0,i.kt)("a",{parentName:"p",href:"https://polkadot.polkassembly.io/post/166"},"\u62a5\u544a"),"\uff0c\u53ef\u4ee5\u83b7\u5f97\u66f4\u591a\u7684\u547d\u4ee4\u4ecb\u7ecd\u3002"),(0,i.kt)("h4",{id:"\u6848\u4f8b1\uff1a\u7b80\u5355\u6848\u4f8b"},"\u6848\u4f8b1\uff1a\u7b80\u5355\u6848\u4f8b"),(0,i.kt)("p",null,"\u4f8b\u5982\u6211\u4eec\u4fee\u6539",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/ink"},"ink!"),"\u9879\u76ee\u4e2d\u7684\u6848\u4f8b\u5408\u7ea6",(0,i.kt)("inlineCode",{parentName:"p"},"ink/example/erc20"),"\u5982\u4e0b\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-rust"},'#[ink(message)]\npub fn transfer(&mut self, to: AccountId, value: Balance) -> Result<()> {\n    let from = self.env().caller();\n    self.transfer_from_to(from, to, value)?;\n    panic!("123");\n    Ok(())\n}\n')),(0,i.kt)("p",null,"\u7531\u4e8e\u5408\u7ea6\u7f16\u8bd1\u6210WASM\u540e\u5bf9\u5e94\u7684\u662f\u539f\u6587\u4ef6\u5c06\u5b8f\u5c55\u5f00\u540e\u7684\u4ee3\u7801\uff0c\u56e0\u6b64\u82e5\u60f3\u8981\u5bf9\u6bd4\u8c03\u7528\u6808\u7684\u9519\u8bef\uff0c\u9700\u8981\u5c06\u539f\u5408\u7ea6\u7684\u5b8f\u5c55\u5f00\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cargo install expand\ncd ink/example/erc20\ncargo expand > tmp.rs\n")),(0,i.kt)("p",null,"\u901a\u8fc7\u9605\u8bfb",(0,i.kt)("inlineCode",{parentName:"p"},"tmp.rs"),"\u6587\u4ef6\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u77e5\u9053WASM\u6267\u884c\u5230",(0,i.kt)("inlineCode",{parentName:"p"},"transfer"),"\u51fd\u6570\u65f6\u9700\u8981\u7ecf\u8fc7\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"fn call() -> u32 \n-> <Erc20 as ::ink_lang::DispatchUsingMode>::dispatch_using_mode(...)\n-> <<Erc20 as ::ink_lang::ConstructorDispatcher>::Type as ::ink_lang::Execute>::execute(..)  # compile selector at here\n-> ::ink_lang::execute_message_mut\n-> move |state: &mut Erc20| { ... } # a closure\n-> <__ink_Msg<[(); 2644567034usize]> as ::ink_lang::MessageMut>::CALLABLE\n-> transfer\n")),(0,i.kt)("p",null,"\u56e0\u6b64\u82e5\u5408\u7ea6\u8c03\u7528\u8fc7\u7a0b\u4e2d\u9047\u5230\u4e86",(0,i.kt)("inlineCode",{parentName:"p"},"transfer"),"\u4e2d\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"panic"),"\u65f6\uff0cWASM\u7684backtrace\u5e94\u8be5\u548c\u8fd9\u4e2a\u76f8\u8fd1\u3002"),(0,i.kt)("p",null,"\u9996\u5148\u6211\u4eec\u542f\u52a8europa:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ europa --tmp -lruntime=debug\n")),(0,i.kt)("p",null,"\u7136\u540e\u6211\u4eec\u90e8\u7f72\u8fd9\u4e2aerc20\u5e76\u8c03\u7528transfer\u6267\u884c\u3002"),(0,i.kt)("p",null,"\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528",(0,i.kt)("a",{parentName:"p",href:"https://polkadot.js.org/apps"},(0,i.kt)("inlineCode",{parentName:"a"},"Polkadot/Substrate Portal")),"\u6216\u8005\u4f7f\u7528",(0,i.kt)("a",{parentName:"p",href:"https://redspot.patract.io/en/tutorial/"},"RedSpot"),"\u6765\u9a8c\u8bc1\u8fd9\u4e2a\u8fc7\u7a0b\u3002\u5047\u8bbe\u6211\u4eec\u4f7f\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"RedSpot"),"\u6765\u6267\u884c\u4e00\u6b21\u8fd9\u4e2a\u9519\u8bef\u7684ERC20\u5408\u7ea6\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"transfer"),"\u8c03\u7528\uff0c\u8bf7\u6ce8\u610f\u5728\u7f16\u8bd1\u5408\u7ea6\u7684\u8fc7\u7a0b\u4e2d\u4e00\u5b9a\u9700\u8981\u52a0\u4e0a",(0,i.kt)("inlineCode",{parentName:"p"},"--debug"),"\u5b50\u547d\u4ee4\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ npx redspot-new erc20\n$ cd erc20/contracts\n# add panic in `transfer` function as abrove\n$ vim lib.rs \n# notice must add --debug when compile contract\n# due current cargo-contract is not paritytech, we need to copy compile product into `artifacts` directory. RedSpot would support europa and PatractLabs's cargo-contract in next version.\n$ cargo +nightly contract build --debug \n$ mkdir ../artifacts\n# notice must cp erc20.src.wasm, not erc20.wasm\n$ cp ./target/ink/erc20.src.wasm ../artifacts  \n# notice must rename metadata.json to erc20.json\n$ cp ./target/ink/metadata.json ../artifacts/erc20.json \n$ cd ../\n# enter redspot console, use `--no-compile` to deny recompile contract\n$ npx redspot console --no-compile  \n# in redspot console\nWelcome to Node.js v12.16.1.Type \".help\" for more information.\n> \n> var factory = await patract.getContractFactory('erc20')\n# do following command could deploy the erc20 contract\n> var contract = await factory.deployed('new', '1000000', {value: 20000000000, salt:1})\n# do a transfer call directly\n> await contract.transfer(\"5GcTYx4dPTQfi4udKPvE4VKmbooV7zY6hNYVF9JXHJL4knNF\", 100)\n")),(0,i.kt)("p",null,"\u7136\u540e\u5728europa\u7684\u65e5\u5fd7\u4e2d\uff0c\u53ef\u4ee5\u770b\u5230\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'1: NestedRuntime {\n    ext_result: [failed] ExecError { error: DispatchError::Module {index:5, error:17, message: Some("ContractTrapped"), orign: ErrorOrigin::Caller }}\n    caller: d43593c715fdd31c61141abd04a99fd6822...(5GrwvaEF...),\n    self_account: b6484f58b7b939e93fff7dc10a654af7e.... (5GBi41bY...),\n    selector: 0xfae3a09d,\n    args: 0x1cbd2d43530a44705ad088af313e18f80b5....,\n    value: 0,\n    gas_limit: 409568000000,\n    gas_left: 369902872067,\n    env_trace: [\n        seal_value_transferred(Some(0x00000000000000000000000000000000)),\n        seal_input(Some(0xfae3a09d1cbd.....)),\n        seal_get_storage((Some(0x0100000000000....), Some(0x010000000100000001000000))),\n        # ...\n        seal_caller(Some(0xd43593c715fdd31c61141abd...)),\n        seal_hash_blake256((Some(0x696e6b20686173....), Some(0x0873b31b7a3cf....))),\n        # ...  \n        seal_deposit_event((Some([0x45726332303a....00000000000]), Some(0x000..))),\n    ],\n    trap_reason: TrapReason::SupervisorError(DispatchError::Module { index: 5, error: 17, message: Some("ContractTrapped") }),\n    wasm_error: Error::WasmiExecution(Trap(Trap { kind: Unreachable }))\n        wasm backtrace: \n        |  core::panicking::panic[28]\n        |  erc20::erc20::_::<impl erc20::erc20::Erc20>::transfer[1697]\n        |  <erc20::erc20::_::__ink_Msg<[(); 2644567034]> as ink_lang::traits::MessageMut>::CALLABLE::{{closure}}[611]\n        |  core::ops::function::FnOnce::call_once[610]\n        |  <erc20::erc20::_::_::__ink_MessageDispatchEnum as ink_lang::dispatcher::Execute>::execute::{{closure}}[1675]\n        |  ink_lang::dispatcher::execute_message_mut[1674]\n        |  <erc20::erc20::_::_::__ink_MessageDispatchEnum as ink_lang::dispatcher::Execute>::execute[1692]\n        |  erc20::erc20::_::<impl ink_lang::contract::DispatchUsingMode for erc20::erc20::Erc20>::dispatch_using_mode[1690]\n        |  call[1691]\n        \u2570\u2500><unknown>[2387]\n    ,\n    nest: [],\n}\n')),(0,i.kt)("p",null,"\u6211\u4eec\u89e3\u91ca\u4e00\u4e0b\u4ee5\u4e0a\u6253\u5370\u7684\u4fe1\u606f\uff1a"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"ext_result"),"\uff1a\u8868\u793a\u8fd9\u4e00\u6b21\u5408\u7ea6\u8c03\u7528\u5bf9\u5916\u663e\u793a\u4e3a\u6267\u884c\u6210\u529f\u6216\u662f\u5931\u8d25\uff1a"),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"[success]"),"\uff1a\u8868\u793a\u8fd9\u6b21\u5408\u7ea6\u6267\u884c\u6210\u529f\uff08",(0,i.kt)("em",{parentName:"li"},"\u6ce8\u610f\uff1a\u5408\u7ea6\u6267\u884c\u6210\u529f\u4e0d\u4ee3\u8868\u7740\u5408\u7ea6\u81ea\u8eab\u7684\u4e1a\u52a1\u903b\u8f91\u6267\u884c\u6210\u529f\uff0c\u53ef\u80fd\u5728",(0,i.kt)("inlineCode",{parentName:"em"},"ink!"),"\u4e2d\u6216\u8005\u5408\u7ea6\u81ea\u8eab\u4e1a\u52a1\u903b\u8f91\u4e2d\u5b58\u5728\u9519\u8bef\u7684\u8fd4\u56de\uff0c\u5982\u540e\u6587\u4e2d\u7684\u6848\u4f8b3\u3002"),"\uff09\u800c",(0,i.kt)("inlineCode",{parentName:"li"},"[success]"),"\u540e\u9762\u8ddf\u968f\u7684",(0,i.kt)("inlineCode",{parentName:"li"},"ExecResultValue { flag:0, data: 0x...}"),"\u8868\u793a\u8fd9\u6b21\u5408\u7ea6\u6267\u884c\u540e\u7684\u8fd4\u56de\u503c\u3002"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"[failed]"),"\uff1a\u8868\u793a\u8fd9\u6b21\u5408\u7ea6\u6267\u884c\u5931\u8d25\uff0c",(0,i.kt)("inlineCode",{parentName:"li"},"[failed]"),"\u540e\u9762\u8ddf\u968f\u7684",(0,i.kt)("inlineCode",{parentName:"li"},"ExecError { .. }")," \u8868\u793a\u8fd9\u6b21\u9519\u8bef\u7684\u539f\u56e0\u3002\u8fd9\u4e2a\u539f\u56e0\u662f\u94fe\u4e0a\u8bb0\u5f55\u5230",(0,i.kt)("inlineCode",{parentName:"li"},"event"),"\u91cc\u9762\u7684\u503c\uff0c\u4e5f\u5c31\u662f",(0,i.kt)("inlineCode",{parentName:"li"},"pallet-contracts"),"\u7684",(0,i.kt)("inlineCode",{parentName:"li"},"decl_error!"),"\u4e2d\u5b9a\u4e49\u7684\u503c\u3002"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"1: NestedRuntime "),"&",(0,i.kt)("inlineCode",{parentName:"p"},"nest"),"\uff1a\u8868\u793a\u5f53\u524d\u6253\u5370\u4fe1\u606f\u7684\u8fd9\u4e2a\u5408\u7ea6\u4fe1\u606f\u4f4d\u4e8e\u5408\u7ea6\u8c03\u7528\u6808\u7684\u7b2c\u4e00\u5c42\uff0c\u82e5\u5f53\u524d\u5408\u7ea6\u8c03\u7528\u4e86\u53e6\u4e00\u4e2a\u5408\u7ea6\uff0c\u5219\u4f1a\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"nest"),"\u5b57\u6bb5\u7684\u6570\u7ec4\u91cc\u51fa\u73b0",(0,i.kt)("inlineCode",{parentName:"p"},"2\uff1a NestedRuntime"),"\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"1: NestedRuntime "),"\u91cc\u7684\u7ed3\u6784\u4e00\u81f4\u3002\u5176\u4e2d",(0,i.kt)("inlineCode",{parentName:"p"},"2"),"\u6807\u793a\u8fd9\u4e2a\u88ab\u8c03\u7528\u7684\u5408\u7ea6\u4f4d\u4e8e\u5408\u7ea6\u8c03\u7528\u6808\u7684\u7b2c\u4e8c\u5c42\u3002\u5728\u5f53\u524d\u5408\u7ea6\u4e2d\u8de8\u5408\u7ea6\u8c03\u7528\u4e86\u51e0\u4e2a\u5408\u7ea6\uff0c\u90a3\u4e48\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"nest"),"\u7684\u6570\u7ec4\u4e2d\u5c31\u4f1a\u51fa\u73b0\u51e0\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"NestedRuntime"),"\u3002\u82e5\u5728\u7b2c\u4e8c\u5c42\u5408\u7ea6\u4e2d\u6709\u5176\u4ed6\u7684\u5408\u7ea6\u8c03\u7528\uff0c\u5219\u4ee5\u6b64\u7c7b\u63a8\u3002"),(0,i.kt)("p",{parentName:"li"},"\u4f8b\u5982\u5982\u679c\u6709\u5408\u7ea6A\uff0cB\uff0cC\uff0c\u5982\u679c\u662f\u5982\u4e0b\u60c5\u51b5\uff1a"),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"A\u8c03\u7528\u4e86B\u540e\uff0c\u8fd4\u56de\u5230A\u7ee7\u7eed\u6267\u884c\uff0c\u7136\u540e\u53c8\u8c03\u7528\u4e86\u5408\u7ea6C"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-text"},"|A|\n| |->|B|\n| |<-\n| |->|C|\n| |<-\n")),(0,i.kt)("p",{parentName:"li"},"\u90a3\u4e48\u5c31\u4f1a\u4ea7\u751f\u7c7b\u4f3c\u5982\u4e0b\u7684\u65e5\u5fd7\u6253\u5370\uff1a"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-text"},"1: NestedRuntime {\n self_account: A,\n nest:[\n     2: NestedRuntime {\n         self_account: B,\n         nest:[],\n     },\n     2: NestedRuntime {\n         self_account: C,\n         nest:[],\n     }\n ]\n}\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"A\u8c03\u7528\u4e86B\u540e\uff0cB\u53c8\u8c03\u7528\u4e86\u5408\u7ea6C\uff0c\u6700\u540e\u56de\u5230A\u4e2d"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-text"},"|A|\n| |->|B|\n| |  | |->|C|\n| |  | |<-\n| |<-\n")),(0,i.kt)("p",{parentName:"li"},"\u90a3\u4e48\u5c31\u4f1a\u4ea7\u751f\u7c7b\u4f3c\u5982\u4e0b\u7684\u65e5\u5fd7\u6253\u5370\uff1a"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-text"},"1: NestedRuntime {\n self_account: A,\n nest:[\n     2: NestedRuntime {\n         self_account: B,\n         nest:[\n            3: NestedRuntime {\n                self_account: C,\n                nest:[],\n            }\n         ],\n     }  \n ]\n}\n"))))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"caller"),"\uff1a\u4ee3\u8868\u5f53\u524d\u5408\u7ea6\u7684\u8c03\u7528\u8005\u662f\u8c01\u3002\u5982\u679c\u662f\u5408\u7ea6\u8c03\u7528\u5408\u7ea6\u7684\u60c5\u51b5\u4e0b\uff0c\u88ab\u8c03\u7528\u7684\u5408\u7ea6\u7684\u8fd9\u4e2a\u503c\u662f\u4e0a\u4e00\u7ea7\u5408\u7ea6\u7684\u5730\u5740\u3002")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"self_account"),"\uff1a\u4ee3\u8868\u5f53\u524d\u5408\u7ea6\u81ea\u8eab\u7684\u5730\u5740\u662f\u591a\u5c11\u3002")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"selector")," & ",(0,i.kt)("inlineCode",{parentName:"p"},"args"),"&",(0,i.kt)("inlineCode",{parentName:"p"},"value")," \uff1a\u4ee3\u8868\u8c03\u7528\u5f53\u524d\u5408\u7ea6\u7684\u65f6\u5019\u4f20\u5165\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"selector"),"\u548c\u53c2\u6570\uff0c",(0,i.kt)("strong",{parentName:"p"},"\u8fd9\u4e9b\u4fe1\u606f\u53ef\u4ee5\u5feb\u901f\u5b9a\u4f4d\u8c03\u7528\u5408\u7ea6\u65b9\u5f0f\u662f\u5426\u6b63\u786e"),"\u3002")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"gas_limit")," & ",(0,i.kt)("inlineCode",{parentName:"p"},"gas_left"),"\uff1a\u8868\u793a\u5f53\u524d\u8c03\u7528\u5408\u7ea6\u7684\u65f6\u5019\u4f20\u5165\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"gas_limit"),"\u548c",(0,i.kt)("strong",{parentName:"p"},"\u6267\u884c\u5b8c\u8fd9\u4e00\u5c42"),"\u540e\u5269\u4f59\u7684gas\u3002\u8fd9\u91cc\u6ce8\u610f",(0,i.kt)("inlineCode",{parentName:"p"},"gas_left"),"\u6307\u4ee3\u7684\u662f\u6267\u884c\u5b8c\u8fd9\u4e00\u5c42\u5408\u7ea6\u65f6\u5269\u4f59\u7684gas\uff0c\u56e0\u6b64",(0,i.kt)("strong",{parentName:"p"},"\u5728\u5408\u7ea6\u8c03\u7528\u5408\u7ea6\u4e2d\uff0c\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"strong"},"gas_left"),"\u53ef\u4ee5\u5224\u65ad\u51fa\u6bcf\u4e00\u5c42\u5408\u7ea6\u6d88\u8017\u7684gas"),"\uff0c\u800c\u4e0d\u662f\u53ea\u80fd\u83b7\u53d6\u5230\u6574\u4e2a\u5408\u7ea6\u6267\u884c\u6267\u884c\u540e\u7684\u6d88\u8017\u3002")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"env_trace"),"\uff1a\u8868\u793a\u5f53\u524d\u8fd9\u4e00\u5c42\u5408\u7ea6\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u5408\u7ea6WASM\u6267\u884c\u6bcf\u6b21\u8c03\u7528host_function\uff0c\u5c31\u4f1a\u5728\u8fd9\u91cc\u7684\u6570\u7ec4\u91cc\u9762\u6dfb\u52a0\u4e00\u6761\u8bb0\u5f55\u3002\u6240\u6709\u7684host_function\u4e0e",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u6a21\u5757\u4e2d\u7684",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/substrate/blob/master/frame/contracts/src/wasm/runtime.rs#L610"},(0,i.kt)("inlineCode",{parentName:"a"},"define_env!"),"\u4e2d\u7684\u5b9a\u4e49"),"\u76f8\u5bf9\u5e94\uff0c\u56e0\u6b64\u8ddf\u8e2a",(0,i.kt)("inlineCode",{parentName:"p"},"env_trace"),"\u53ef\u4ee5\u8ddf\u8e2a\u5f53\u524dWASM\u5408\u7ea6\u6267\u884c\u8fc7\u7a0b\u4e2d\u4e0e",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u4ea4\u4e92\u7684\u8fc7\u7a0b\u3002\u4f8b\u5982\u5982\u679c\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"env_trace"),"\u4e2d\u51fa\u73b0\u4e86:"),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"seal_call"),"\uff1a\u4ee3\u8868\u5f53\u524d\u5408\u7ea6\u4e2d\u51fa\u73b0\u4e86\u5408\u7ea6\u8c03\u7528\u5408\u7ea6\u7684\u60c5\u51b5\u3002\u6309\u7167",(0,i.kt)("inlineCode",{parentName:"p"},"seal_call"),"\u51fa\u73b0\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"env_trace"),"\u7684\u987a\u5e8f\uff0c\u53ef\u4ee5\u548c",(0,i.kt)("inlineCode",{parentName:"p"},"nest"),"\u5bf9\u5e94\u8d77\u6765\uff0c\u63a8\u7b97\u51fa\u5408\u7ea6\u8c03\u7528\u5408\u7ea6\u7684\u524d\u540e\u72b6\u6001\u3002")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"seal_get_storage"),"&",(0,i.kt)("inlineCode",{parentName:"p"},"seal_set_storage"),"\uff1a\u4ee3\u8868\u5408\u7ea6\u4e2d\u51fa\u73b0\u4e86\u6570\u636e\u8bfb\u5199\u7684\u60c5\u51b5\u3002\u901a\u8fc7\u8fd9\u4e24\u4e2a\u63a5\u53e3\uff0c\u53ef\u4ee5\u622a\u83b7\u5e76\u7edf\u8ba1\u5f53\u524d\u5408\u7ea6\u6267\u884c\u8fc7\u7a0b\u4e2d\u8bfb\u5199\u6570\u636e\uff0c\u800c",(0,i.kt)("strong",{parentName:"p"},"\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"strong"},"seal_set_storage"),"\u7edf\u8ba1\u51fa\u6765\u7684\u6570\u636e\u5927\u5c0f\uff0c\u4e5f\u53ef\u4ee5\u7528\u6765\u63a8\u6d4b",(0,i.kt)("inlineCode",{parentName:"strong"},"rent"),"\u6240\u9700\u8981\u7684\u5b58\u50a8\u5927\u5c0f\u3002"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"seal_deposit_event"),"\uff1a\u4ee3\u8868\u5408\u7ea6\u4e2d\u51fa\u73b0\u4e86\u6253\u5370event\u7684\u60c5\u51b5\u3002\u8fd9\u91cc\u53ef\u4ee5\u5206\u522b\u622a\u83b7\u6bcf\u6b21event\u7684\u5185\u5bb9\uff0c\u800c\u4e0d\u662f\u6700\u540e\u5f97\u5230\u4e00\u4e2a\u7edf\u4e00\u7684event\u3002\u5e76\u4e14\u540e\u6587\u4f1a\u901a\u8fc7\u4e00\u4e2a\u4f8b\u5b50\u8868\u9762\u901a\u8fc7europa\u53ef\u4ee5\u5feb\u901f\u5b9a\u4f4d",(0,i.kt)("inlineCode",{parentName:"p"},"host_function"),"\u4e2d\u51fa\u73b0bug\u7684\u60c5\u51b5\u3002"))),(0,i.kt)("p",{parentName:"li"},"\u53e6\u4e00\u65b9\u9762",(0,i.kt)("inlineCode",{parentName:"p"},"env_trace"),"\u7684\u7edf\u8ba1\u662f\u6bd4\u8f83",(0,i.kt)("strong",{parentName:"p"},"\u7ec6\u7c92\u5ea6"),"\u7684\uff0c\u4f8b\u5982\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"host_function"),"\u4e2d\u4f1a\u51fa\u73b0\u591a\u4e2a\u9519\u8bef\u53ef\u80fd\u7684\u60c5\u51b5\uff0c\u5219\u51fa\u73b0\u9519\u8bef\u65f6\uff0c\u4f1a\u5c06\u9519\u8bef\u4e4b\u524d\u7684\u4fe1\u606f\u5168\u90e8\u4fdd\u7559\uff0c\u56e0\u6b64\u53ef\u4ee5\u5b9a\u4f4d\u5230",(0,i.kt)("inlineCode",{parentName:"p"},"host_function"),"\u6267\u884c\u4e2d\u51fa\u73b0\u95ee\u9898\u7684\u5730\u70b9\u3002"),(0,i.kt)("p",{parentName:"li"},"\u800c\u4e14\u82e5",(0,i.kt)("inlineCode",{parentName:"p"},"host_function"),"\u4e2d\u51fa\u73b0\u9519\u8bef\u5bfc\u81f4\u5408\u7ea6\u7ed3\u675f\u6267\u884c\u65f6\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"env_trace"),"\u8bb0\u5f55\u5230\u7684\u662f\u6700\u540e\u4e00\u4e2a\u51fa\u9519\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"host_function"),"\u8c03\u7528\uff0c\u56e0\u6b64\u53ef\u4ee5\u76f4\u63a5\u5b9a\u4f4d\u662f\u54ea\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"host_function"),"\u5bfc\u81f4\u7684\u5408\u7ea6\u6267\u884c\u5f02\u5e38\u3002")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"trap_reason"),"\uff1a\u6839\u636e",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u4e2d\u5bf9\u4e8e",(0,i.kt)("inlineCode",{parentName:"p"},"TrapReason"),"\u7684\u5b9a\u4e49\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"trap_reason"),"\u53ef\u4ee5\u5206\u4e3a2\u7c7b\uff1a"),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"Return")," & ",(0,i.kt)("inlineCode",{parentName:"li"},"Termination")," & ",(0,i.kt)("inlineCode",{parentName:"li"},"Restoration"),"\uff1a\u8868\u793a\u5408\u7ea6\u9000\u51fa\u662f",(0,i.kt)("inlineCode",{parentName:"li"},"pallet-contracts"),"\u7684\u8bbe\u8ba1\uff0c\u5e76\u975e\u5185\u90e8\u51fa\u73b0\u9519\u8bef\u3002\u8fd9\u4e00\u7c7bTrap\u8868\u793a\u5408\u7ea6\u6b63\u5e38\u6267\u884c\uff0c\u5e76\u975e\u9519\u8bef\u3002"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"SupervisorError"),"\uff1a\u8868\u793a\u5408\u7ea6\u8c03\u7528host_function\u7684\u6267\u884c\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u4e86\u9519\u8bef\u3002")),(0,i.kt)("p",{parentName:"li"},"\u56e0\u6b64\u5f53\u524deuropa\u7684\u65e5\u5fd7\u6253\u5370\u8bbe\u8ba1\u4e3a\u53ea\u8981\u51fa\u73b0",(0,i.kt)("inlineCode",{parentName:"p"},"trap_reason"),"\u5c31\u4f1a\u8bb0\u5f55\u4e0b\u6765\u3002\u800c\u53e6\u4e00\u65b9\u9762\uff0c\u5728\u5408\u7ea6\u7684\u6267\u884c\u8fc7\u7a0b\u4e2d\u5e76\u975e\u4e00\u5b9a\u4f1a\u51fa\u73b0",(0,i.kt)("inlineCode",{parentName:"p"},"trap_reason"),"\u3002\u7ed3\u5408",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u4ee5\u53ca",(0,i.kt)("inlineCode",{parentName:"p"},"ink!"),"\u7684\u8bbe\u8ba1\uff0c\u5b58\u5728\u5408\u7ea6\u6267\u884c\u6210\u529f\u6216\u8005\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"ink!"),"\u5c42\u4e2d\u6267\u884c\u5931\u8d25\u5747\u4e0d\u4ea7\u751f",(0,i.kt)("inlineCode",{parentName:"p"},"trap_reason"),"\u7684\u60c5\u51b5\u3002\u56e0\u6b64europa\u9664\u4e86\u8bb0\u5f55",(0,i.kt)("inlineCode",{parentName:"p"},"trap_reason"),"\uff0c\u8fd8",(0,i.kt)("strong",{parentName:"p"},"\u8bb0\u5f55\u4e86WASM\u6267\u884c\u5668\u6267\u884c\u540e\u8fd4\u56de\u7684\u7ed3\u679c\uff0c\u7528",(0,i.kt)("inlineCode",{parentName:"strong"},"sandbox_result_ok"),"\u8bb0\u5f55\u3002"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"sandbox_result_ok"),"\uff1a",(0,i.kt)("inlineCode",{parentName:"p"},"sandbox_result_ok"),"\u7684\u503c\u8868\u793a\u5408\u7ea6\u5728WASM\u6267\u884c\u5668\u6267\u884c\u540e\u7684\u7ed3\u679c\u3002\u8fd9\u4e2a\u503c\u672c\u53ef\u4ee5\u8bb0\u5f55\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"sandbox_result"),"\uff0c\u5305\u542b\u6b63\u786e\u548c\u9519\u8bef\u4e24\u79cd\u60c5\u51b5\u3002\u4f46\u662f\u7531\u4e8erust\u7684\u9650\u5236\uff0c\u4e14\u7ed3\u5408",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u7684\u4e1a\u52a1\u903b\u8f91\uff0c\u8fd9\u91cc\u53ea\u4fdd\u7559",(0,i.kt)("inlineCode",{parentName:"p"},"sandbox_result"),"\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"Ok"),"\u7684\u7ed3\u679c\u3002",(0,i.kt)("strong",{parentName:"p"},"\u5bf9\u4e8e\u65e5\u5fd7\u7684\u6253\u5370\uff0ceuropa\u8bbe\u8ba1\u4e3a\u53ea\u6709\u5f53trap_reason\u662f\u7b2c\u4e00\u79cd\u60c5\u51b5\u65f6\uff0c\u6253\u5370",(0,i.kt)("inlineCode",{parentName:"strong"},"sandbox_result_ok"),"\uff0c\u4f5c\u4e3a\u8f85\u52a9\u5224\u65ad\u5408\u7ea6\u6267\u884c\u7684\u4fe1\u606f\u3002")),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"sandbox_result_ok"),"\u662fWASM\u6267\u884c\u5668",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/substrate/blob/712085115cdef4a79a66747338c920d6ba4e479f/frame/contracts/src/wasm/mod.rs#L155-L156"},"\u8c03\u7528\u4e86",(0,i.kt)("inlineCode",{parentName:"a"},"invoke"),"\u540e\u7684\u7ed3\u679c"),"\uff0c\u5728\u7ecf\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"to_execution_result"),"\u7684\u5904\u7406\u540e\uff0c\u5982\u679c\u6ca1\u6709",(0,i.kt)("inlineCode",{parentName:"p"},"trap_reason"),"\u7684\u60c5\u51b5\u5206\u652f\u4e2d\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"Ok(..)"),"\u7684\u7ed3\u679c",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/substrate/blob/712085115cdef4a79a66747338c920d6ba4e479f/frame/contracts/src/wasm/runtime.rs#L366-L368"},"\u88ab\u4e22\u5f03\u4e86"),"\u3002\u4f46\u5b9e\u9645\u4e0a\u8fd9\u91cc\u5305\u542b\u4e24\u79cd\u60c5\u51b5\uff1a"),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"ink!"),"\u4e2d\u51fa\u73b0\u4e86\u9519\u8bef\uff1a\u6839\u636e",(0,i.kt)("inlineCode",{parentName:"li"},"ink!"),"\u7684\u5b9e\u73b0\uff0c\u5728\u8c03\u7528\u5408\u7ea6",(0,i.kt)("inlineCode",{parentName:"li"},"#[ink(message)]"),"\u548c",(0,i.kt)("inlineCode",{parentName:"li"},"#[ink(constructor)]"),"\u5305\u88c5\u7684\u51fd\u6570\u4e4b\u524d\uff0c\u9996\u5148\u9700\u8981\u5bf9\u8f93\u5165\u7684\u53c2\u6570\u8fdb\u884c\u89e3\u7801\u53ca\u5339\u914d",(0,i.kt)("inlineCode",{parentName:"li"},"selector"),"\u7684\u8fc7\u7a0b\u3002\u82e5\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u9519\u8bef\uff0c\u5408\u7ea6\u4f1a\u8fd4\u56de",(0,i.kt)("a",{parentName:"li",href:"https://github.com/paritytech/ink/blob/abd5cf14c0883cb2d5acf81f2277aeec330aa843/crates/lang/src/error.rs#L22"},"\u9519\u8bef\u7801",(0,i.kt)("inlineCode",{parentName:"a"},"DispatchError")),"\u3002\u4f46\u662f\u5bf9\u4e8eWASM\u6267\u884c\u5668\u800c\u8a00\u662f\u6b63\u5e38\u7684\u6267\u884c\u4e86WASM\u4ee3\u7801\uff0c\u56e0\u6b64\u4f1a\u8fd4\u56de\u7ed3\u679c\uff0c\u5305\u542b\u8fd9\u4e2a\u9519\u8bef\u7801\u3002",(0,i.kt)("strong",{parentName:"li"},"\u8fd9\u4e2a\u5408\u7ea6\u6267\u884c\u8fc7\u7a0b\u5c5e\u4e8e\u9519\u8bef\u60c5\u51b5\u3002")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"#[ink(message)]"),"\u7684\u8fd4\u56de\u503c\u5b9a\u4e49\u4e3a\u4e86",(0,i.kt)("inlineCode",{parentName:"li"},"()"),"\uff1a\u6839\u636e",(0,i.kt)("inlineCode",{parentName:"li"},"ink!"),"\u7684\u5b9e\u73b0\uff0c\u82e5\u8fd4\u56de\u503c\u7684\u7c7b\u578b\u662f",(0,i.kt)("inlineCode",{parentName:"li"},"()"),"\u5219\u4e0d\u4f1a\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"li"},"seal_reason"),"\uff0c\u56e0\u6b64\u4e0d\u4f1a\u542b\u6709",(0,i.kt)("inlineCode",{parentName:"li"},"trap_reason"),"\u3002",(0,i.kt)("strong",{parentName:"li"},"\u8fd9\u4e2a\u5408\u7ea6\u6267\u884c\u8fc7\u7a0b\u5c5e\u4e8e\u6b63\u786e\u60c5\u51b5\u3002"))),(0,i.kt)("p",{parentName:"li"},"\u7531\u4e8e",(0,i.kt)("inlineCode",{parentName:"p"},"ink!"),"\u53ea\u662f\u8fd0\u884c\u4e8e",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u7684\u4e00\u79cd\u5408\u7ea6\u5b9e\u73b0\uff0c\u5176\u4ed6\u7684\u5b9e\u73b0\u53ef\u80fd\u6709\u4e0d\u540c\u7684\u89c4\u5219\uff0c\u56e0\u6b64\u5f53\u524d",(0,i.kt)("inlineCode",{parentName:"p"},"sandbox_result_ok"),"\u53ea\u7528\u4e8e\u8f85\u52a9\u5224\u5b9a",(0,i.kt)("inlineCode",{parentName:"p"},"ink!"),"\u5408\u7ea6\u7684\u6267\u884c\u60c5\u51b5\uff0c\u503c\u4e3a",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/substrate/blob/712085115cdef4a79a66747338c920d6ba4e479f/primitives/wasm-interface/src/lib.rs#L462-L467"},(0,i.kt)("inlineCode",{parentName:"a"},"ReturnValue")),"\u3002\u5176\u4e2d\u82e5\u65e5\u5fd7\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"ReturnValue::Value(<num>)"),"\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"<num>"),"\u90e8\u5206\u4e0d\u4e3a0\u65f6\uff0c\u8868\u793a",(0,i.kt)("inlineCode",{parentName:"p"},"ink!"),"\u7684\u6267\u884c\u8fc7\u7a0b\u53ef\u80fd\u5b58\u5728\u9519\u8bef\uff0c\u53ef\u4ee5\u6839\u636e",(0,i.kt)("inlineCode",{parentName:"p"},"ink!"),"\u5bf9\u4e8e",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/ink/blob/abd5cf14c0883cb2d5acf81f2277aeec330aa843/crates/lang/src/error.rs#L66-L80"},(0,i.kt)("inlineCode",{parentName:"a"},"DispatchError"),"\u7684\u9519\u8bef\u7801"),"\u5224\u5b9a\u9519\u8bef\u3002")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"wasm_error"),"\uff1a\u8868\u793a\u7684\u662fWASM\u6267\u884c\u9519\u8bef\u65f6\u7684backtrace\u3002\u8fd9\u4e2a\u90e8\u5206\u53ea\u6709\u5f53",(0,i.kt)("inlineCode",{parentName:"p"},"ext_result"),"\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"failed"),"\u7684\u65f6\u5019\u624d\u4f1a\u6253\u5370\u3002"),(0,i.kt)("p",{parentName:"li"},"\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u7531\u4e8e\u6267\u884c",(0,i.kt)("inlineCode",{parentName:"p"},"transfer"),"\u4f1a\u89e6\u53d1",(0,i.kt)("inlineCode",{parentName:"p"},"panic"),"\uff0c\u56e0\u6b64\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u5bfc\u81f4\u9519\u8bef\u7684\u539f\u56e0\u662f",(0,i.kt)("inlineCode",{parentName:"p"},"WasmiExecution(Trap(Trap { kind: Unreachable }))"),"\uff0c\u8868\u793a\u8fd9\u6b21\u7684\u5931\u8d25\u662f\u7531\u4e8e\u6267\u884c\u5408\u7ea6\u7684\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"Unreacble"),"\u7684\u60c5\u51b5\u5bfc\u81f4\uff0c\u800c\u4e0b\u65b9\u7684backtrace\u4fe1\u606f\u4e5f",(0,i.kt)("strong",{parentName:"p"},"\u5341\u5206\u51c6\u786e\u7684\u63cf\u8ff0"),"\u4e86\u4e0a\u6587\u8ba8\u8bba\u8fc7\u7684\u5408\u7ea6\u5b8f\u5c55\u5f00\u540e\u9047\u5230\u9519\u8bef\u65f6\u7684\u51fd\u6570\u6267\u884c\u8c03\u7528\u6808\u3002\u4ecebacktrace\u4e2d\u53ef\u4ee5\u660e\u663e\u7684\u53d1\u73b0\u5982\u4e0b\u7684\u8c03\u7528\u8fc7\u7a0b\u3002"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-text"},"call -> dispatch_using_mode -> ... -> transfer -> panic \n")),(0,i.kt)("p",{parentName:"li"},"\u8fd9\u4e2a\u8fc7\u7a0b\u4e0e\u5408\u7ea6\u7684\u539f\u6587\u4fe1\u606f\u76f8\u7b26\u3002"))),(0,i.kt)("h4",{id:"\u6848\u4f8b2\uff1a\u5b9a\u4f4d\u91cd\u590d\u7684topic\u5bfc\u81f4\u7684contracttrap"},"\u6848\u4f8b2\uff1a\u5b9a\u4f4d\u91cd\u590d\u7684topic\u5bfc\u81f4\u7684",(0,i.kt)("inlineCode",{parentName:"h4"},"ContractTrap")),(0,i.kt)("p",null,"\u5728\u524d\u4e00\u6bb5\u65f6\u95f4\uff0c\u6211\u4eec\uff08Patract Labs\uff09\u7ed9",(0,i.kt)("inlineCode",{parentName:"p"},"ink!"),"\u6c47\u62a5\u8fc7\u4e00\u4e2abug\uff0c\u89c1issue:",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/ink/issues/589"},"\"When set '0' value in contracts event, may cause ",(0,i.kt)("inlineCode",{parentName:"a"},"Error::ContractTrapped"),' and panic in contract #589"'),"\u3002\u5728europa\u8fd8\u672a\u5f00\u53d1\u51fa\u76f8\u5173\u529f\u80fd\u524d\uff0c\u5b9a\u4f4d\u8fd9\u4e2a\u9519\u8bef\u5341\u5206\u56f0\u96be\uff0c\u5176\u4e2d\u611f\u8c22@athei",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/ink/issues/589#issuecomment-731571918"},"\u5b9a\u4f4d\u5230\u4e86\u9519\u8bef"),"\u3002\u8fd9\u91cc\u6211\u4eec\u91cd\u73b0\u8fd9\u4e2a\u9519\u8bef\uff0c\u5e76\u4f7f\u7528europa\u7684\u65e5\u5fd7\u6765\u5feb\u901f\u5206\u6790\u5b9a\u4f4d\u5230\u8fd9\u4e2abug\u51fa\u73b0\u7684\u5730\u65b9\uff1a"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u5c06",(0,i.kt)("inlineCode",{parentName:"p"},"ink!"),"\u5207\u6362\uff08checkout\uff09\u5230\u63d0\u4ea4",(0,i.kt)("inlineCode",{parentName:"p"},"8e8fe09565ca6d2fad7701d68ff13f12deda7eed")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cd ink\ngit checkout 8e8fe09565ca6d2fad7701d68ff13f12deda7eed -b tmp\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u8fdb\u5165",(0,i.kt)("inlineCode",{parentName:"p"},"ink/examples/erc20/lib.rs:L90"),"\u4e2d\u5c06",(0,i.kt)("inlineCode",{parentName:"p"},"Transfer"),"\u4e2d\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"value"),"\u6539\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"0_u128")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-rust"},"#[ink(constructor)]\npub fn new(initial_supply: Balance) -> Self {\n    //...\n    Self::env().emit_event(Transfer {\n        from: None,\n        to: Some(caller),\n        // change this from `initial_supply` to `0_u128`\n        value: 0_u128.into() // initial_supply,\n    });\n    instance\n}\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u6267\u884c",(0,i.kt)("inlineCode",{parentName:"p"},"cargo +nightly contract build --debug")," \u7f16\u8bd1\u5408\u7ea6")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u4f7f\u7528",(0,i.kt)("a",{parentName:"p",href:"https://redspot.patract.io/en/tutorial/"},"RedSpot"),"\u6216\u8005",(0,i.kt)("a",{parentName:"p",href:"https://polkadot.js.org/apps"},(0,i.kt)("inlineCode",{parentName:"a"},"Polkadot/Substrate Portal")),"\u5c06\u8fd9\u4e2a\u5408\u7ea6\u90e8\u7f72\u51fa\u53bb\uff08\u6ce8\u610f\u4e00\u5b9a\u8981\u4f7f\u7528erc20.src.wasm\u6587\u4ef6\uff09"))),(0,i.kt)("p",null,"\u5728\u90e8\u7f72\u9636\u6bb5\u5e94\u8be5\u4f1a\u9047\u5230",(0,i.kt)("inlineCode",{parentName:"p"},"DuplicateTopics"),"\uff08\u5728\u8fd9\u4e2a",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/substrate/pull/7762"},"\u9519\u8bef"),"\u4fee\u6b63\u4e4b\u524d\uff0c\u6c47\u62a5\u7684\u9519\u8bef\u662f",(0,i.kt)("inlineCode",{parentName:"p"},"ContractTrap"),"\uff09\uff0c\u800c\u5728europa\u7684\u65e5\u5fd7\u4e2d\u4f1a\u663e\u793a\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'1: NestedRuntime {\n    #...\n    env_trace: [\n        seal_input(Some(0xd183512b0)),\n        #...    \n        seal_deposit_event((Some([0x45726332303a3a5472616e736....]), None)),\n    ],\n    trap_reason: TrapReason::SupervisorError(DispatchError::Module { index: 5, error: 23, message: Some("DuplicateTopics") }),\n    wasm_error: Error::WasmiExecution(Trap(Trap { kind: Host(DummyHostError) }))\n        wasm backtrace: \n        |  ink_env::engine::on_chain::ext::deposit_event[1623]\n        |  ink_env::engine::on_chain::impls::<impl ink_env::backend::TypedEnvBackend for ink_env::engine::on_chain::EnvInstance>::emit_event[1564]\n        |  ink_env::api::emit_event::{{closure}}[1563]\n        |  <ink_env::engine::on_chain::EnvInstance as ink_env::engine::OnInstance>::on_instance[1562]\n        |  ink_env::api::emit_event[1561]\n        |  erc20::erc20::_::<impl ink_lang::events::EmitEvent<erc20::erc20::Erc20> for ink_lang::env_access::EnvAccess<<erc20::erc20::Erc20 as ink_lang::env_access::ContractEnv>::Env>>::emit_event[1685]\n# ...\n# ...\n        |  deploy[1691]\n        \u2570\u2500><unknown>[2385]\n    ,\n    nest: [],\n}\n')),(0,i.kt)("p",null,"\u7531\u4ee5\u4e0a\u65e5\u5fd7\u53ef\u4ee5\u770b\u5230:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"env_trace"),"\u7684\u6700\u540e\u4e00\u6761\u8bb0\u5f55\u662f",(0,i.kt)("inlineCode",{parentName:"li"},"seal_deposit_event"),"\u800c\u4e0d\u662f",(0,i.kt)("inlineCode",{parentName:"li"},"seal_return"),"\uff08\u5408\u7ea6\u6b63\u786e\u6267\u884c\u65f6\u6700\u540e\u4e00\u6761\u4e00\u5b9a\u662f",(0,i.kt)("inlineCode",{parentName:"li"},"seal_return"),"\uff09"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"seal_deposit_event"),"\u7684\u7b2c\u4e8c\u4e2a\u53c2\u6570\u662f",(0,i.kt)("inlineCode",{parentName:"li"},"None"),"\uff0c\u800c\u4e0d\u662f\u4e00\u4e2a\u5b58\u5728\u7684\u503c\uff0c\u56e0\u6b64\u8868\u660e",(0,i.kt)("inlineCode",{parentName:"li"},"seal_deposit_event")," \u8fd9\u4e2ahost_function\u6ca1\u6709\u6267\u884c\u5b8c\u6210\uff0c\u800c\u662f\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u5c31\u51fa\u73b0\u4e86\u9519\u8bef\uff08\u53ef\u4ee5\u770beuropa\u4f9d\u8d56\u7684forked\u7248\u672c\u7684",(0,i.kt)("inlineCode",{parentName:"li"},"pallet-contracts"),"\u6e90\u7801\u770b\u5230",(0,i.kt)("a",{parentName:"li",href:"https://github.com/patractlabs/substrate/blob/3624deb47cabe6f6cd44ec2c49c6ae5a29fd2198/frame/contracts/src/wasm/runtime.rs#L1399"},"\u76f8\u5e94\u7684\u5b9e\u73b0\u65b9\u5f0f"),"\uff09\u3002"),(0,i.kt)("li",{parentName:"ol"},"\u7ed3\u5408wasm backtrace\u7684\u9519\u8bef\u6808\u6211\u4eec\u53ef\u4ee5\u76f4\u89c2\u7684\u770b\u5230backtrace\u6700\u4e0a\u4e00\u5c42\u8c03\u7528\u6808\u4e3a",(0,i.kt)("inlineCode",{parentName:"li"},"deposit_event"),"\u3002")),(0,i.kt)("p",null,"\u56e0\u6b64\u7ed3\u5408\u4ee5\u4e0a\u4fe1\u606f\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u63a8\u6d4b\u51fa\u662f",(0,i.kt)("inlineCode",{parentName:"p"},"seal_deposit_event"),"\u8fd9\u4e2ahost_function\u5728\u6267\u884c\u7684\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u4e86\u5f02\u5e38\u3002\uff08\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u7684\u63d0\u4ea4",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/substrate/pull/7762"},"pull#7762"),"\u5408\u5e76\u524d\uff0c\u6211\u4eec\u8bb0\u5f55\u4e86host_function\u5185\u7684\u9519\u8bef\u4fe1\u606f\uff0c\u5408\u5e76\u540e\u6211\u4eec\u5229\u7528\u4e86",(0,i.kt)("inlineCode",{parentName:"p"},"trap_reason"),"\u7edf\u4e00\u7684\u9519\u8bef\u4fe1\u606f\u3002\uff09"),(0,i.kt)("h4",{id:"\u6848\u4f8b3\uff0c\u5f53\u94fe\u4f7f\u7528\u4e86type-balanceu64\u800c\u4e0d\u662ftype-balanceu128\u9020\u6210\u7684\u9519\u8bef\u3002"},"\u6848\u4f8b3\uff0c\u5f53\u94fe\u4f7f\u7528\u4e86",(0,i.kt)("inlineCode",{parentName:"h4"},"type Balance=u64"),"\u800c\u4e0d\u662f",(0,i.kt)("inlineCode",{parentName:"h4"},"type Balance=u128"),"\u9020\u6210\u7684\u9519\u8bef\u3002"),(0,i.kt)("p",null,"\u5982\u679c\u94fe\u4f7f\u7528\u4e86",(0,i.kt)("inlineCode",{parentName:"p"},"Balance=u64"),"\u7684\u5b9a\u4e49\uff0c\u800c\u5bf9\u4e8e",(0,i.kt)("inlineCode",{parentName:"p"},"ink!"),"\u800c\u8a00\u5e76\u4e0d\u77e5\u9053\u94fe\u5173\u4e8e",(0,i.kt)("inlineCode",{parentName:"p"},"Balance"),"\u7684\u5b9a\u4e49\uff0c\u9ed8\u8ba4\u5b9a\u4e49\u7684Balance\u662f",(0,i.kt)("inlineCode",{parentName:"p"},"u128"),"\u3002\u56e0\u6b64\u5f53\u4f7f\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"u128"),"\u5b9a\u4e49",(0,i.kt)("inlineCode",{parentName:"p"},"Balance"),"\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"ink!"),"\u4f5c\u4e3a\u4f9d\u8d56\u7f16\u8bd1\u51fa\u7684\u5408\u7ea6\uff0c\u8fd0\u884c\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"Balance"),"\u5b9a\u4e49\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"u64"),"\u7684\u94fe\u4e0a\u65f6\uff0c\u4f1a\u9020\u6210",(0,i.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),"\u6a21\u5757\u5411\u5408\u7ea6\u4f20\u503c\u7684\u65f6\u5019\uff0c\u5408\u7ea6\u5185\u90e8\u5c06",(0,i.kt)("inlineCode",{parentName:"p"},"u64"),"\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"value"),"\u5f53\u505a",(0,i.kt)("inlineCode",{parentName:"p"},"u128"),"\u89e3\u7801\u7684\u9519\u8bef\u3002"),(0,i.kt)("p",null,"\u4ee5erc20\u7684example\u5408\u7ea6\u4e3a\u4f8b\uff0c\u5c55\u5f00\u5408\u7ea6\u7684\u5b8f\u540e\uff0c\u53ef\u4ee5\u770b\u5230\uff1a"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"dispatch_using_mode"),"\u9636\u6bb5\u89e3\u7801",(0,i.kt)("inlineCode",{parentName:"li"},"input"),"\u51fa\u73b0\u9519\u8bef\u65f6\uff0c\u5408\u7ea6\u4ee5",(0,i.kt)("inlineCode",{parentName:"li"},"::ink_lang::DispatchError::CouldNotReadInput"),"\u8fd4\u56de\uff0c\u4f46\u662f",(0,i.kt)("inlineCode",{parentName:"li"},"pallet-contracts"),"\u7684\u6a21\u578b\u8bbe\u8ba1\u8ba4\u4e3aWASM\u7684\u5408\u7ea6\u6267\u884c\u6ca1\u6709\u5f02\u5e38\u3002"),(0,i.kt)("li",{parentName:"ul"},"\u800c\u5728",(0,i.kt)("inlineCode",{parentName:"li"},"call"),"\u7684\u8c03\u7528\u65f6\uff0c\u7531\u4e8e\u5728\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"li"},"dispatch_using_mode"),"\u4e4b\u524d\u9996\u5148\u4f1a\u68c0\u67e5",(0,i.kt)("inlineCode",{parentName:"li"},"deny_payment"),"\uff0c\u800c\u68c0\u67e5",(0,i.kt)("inlineCode",{parentName:"li"},"deny_payment"),"\u65f6\u82e5\u8fd4\u56deError\u5219\u76f4\u63a5",(0,i.kt)("inlineCode",{parentName:"li"},"panic"),"\u3002")),(0,i.kt)("p",null,"\u56e0\u6b64\u5bf9\u4e8e\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f1a\u51fa\u73b0\u90e8\u7f72\uff08",(0,i.kt)("inlineCode",{parentName:"p"},"Instantiate"),"\uff09ERC20\u7684\u5408\u7ea6\u6267\u884c\u6b63\u5e38\uff0c\u800c\u8c03\u7528ERC20\u7684\u4efb\u610f\u65b9\u6cd5\u4f8b\u5982",(0,i.kt)("inlineCode",{parentName:"p"},"transfer"),"\u7684\u65f6\u5019\u51fa\u73b0",(0,i.kt)("inlineCode",{parentName:"p"},"ContractTrap"),"\u3002"),(0,i.kt)("p",null,"\u5bf9\u4e8e\u8fd9\u4e24\u79cd\u60c5\u51b5\u6211\u4eec\u5206\u522b\u6765\u770b\uff1a"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"instantiate"),"\u9636\u6bb5\uff1a"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'1: NestedRuntime {\n    ext_result: [success] ExecError { error: DispatchError::Module {index:5, error:17, message: Some("ContractTrapped"), orign: ErrorOrigin::Caller }}\n#...\n    env_trace: [\n        seal_input(Some(0xd183512b008cb6611e0100000000000000000000)),\n        seal_caller(Some(0xd43593c715fdd31c61141abd04a99fd682)),\n        //...\n        seal_set_storage((Some(0x030000000100000...), Some(0x000000000000000...))),\n    ],\n    sandbox_result_ok: RuntimeValue::Value(7),\n    nest: [],\n}\n')),(0,i.kt)("p",{parentName:"li"},"\u4ee5\u4e0a\u65e5\u5fd7\u53ef\u4ee5\u770b\u5230"),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"env_trace"),"\u7684\u6700\u540e\u4e0d\u4ee5",(0,i.kt)("inlineCode",{parentName:"p"},"seal_return"),"\u7ed3\u5c3e\uff0c\u5219\u8868\u793a\u5408\u7ea6\u5b9e\u9645\u4e0a\u6ca1\u6709\u6b63\u5e38\u6267\u884c\u5b8c\u6210\u3002\u56e0\u4e3a\u4ece",(0,i.kt)("inlineCode",{parentName:"p"},"ink!"),"\u7684\u8bbe\u8ba1\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c\u5982\u679c\u6b63\u5e38\u8fdb\u5165\u5230",(0,i.kt)("inlineCode",{parentName:"p"},"#[ink(constructor)]"),"\u6216\u8005\u8fdb\u5165\u5230",(0,i.kt)("inlineCode",{parentName:"p"},"#[ink(message)]"),"\u5219\u8868\u9762\u4e00\u5b9a\u6267\u884c\u5230\u4e86",(0,i.kt)("inlineCode",{parentName:"p"},"::ink_lang::execute_message"),"\u4e2d\uff08",(0,i.kt)("inlineCode",{parentName:"p"},"::ink_lang::execute_message"),"\u4f1a\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"seal_return"),"\uff09\uff0c\u800c\u6ca1\u6709\u51fa\u73b0",(0,i.kt)("inlineCode",{parentName:"p"},"seal_return"),"\u4ee3\u8868\u6ca1\u6709\u6267\u884c\u5230",(0,i.kt)("inlineCode",{parentName:"p"},"execute"),"\u7684\u9636\u6bb5\u3002")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"sandbox_result_ok"),"\u8868\u793a\u6267\u884c\u7684\u8fd4\u56de\u503c\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"7"),"\uff0c\u67e5\u8be2",(0,i.kt)("inlineCode",{parentName:"p"},"ink!"),"\u5bf9\u4e8e",(0,i.kt)("inlineCode",{parentName:"p"},"DispatchError"),"\u7684\u5b9e\u73b0\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a\u9519\u8bef\u7801\u4ee3\u8868\u7740",(0,i.kt)("inlineCode",{parentName:"p"},"CouldNotReadInput")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-rust"},"DispatchError::CouldNotReadInput => Self(0x07),\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"\u6839\u636e\u5408\u7ea6\u5b8f\u5c55\u5f00\u7684\u4ee3\u7801\u53ef\u4ee5\u770b\u5230\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"dispatch_using_mode"),"\u51fd\u6570\u4e2d\uff0c\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"execute"),"\u4e4b\u524d\u4f1a\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"::ink_env::decode_input"),"\uff0c\u800c\u8fd9\u4e2a\u51fd\u6570\u5b58\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"return Error"),"\u7684\u60c5\u51b5\u3002\u56e0\u6b64\u53ef\u4ee5\u5408\u7406\u731c\u6d4b\u662f\u5728\u89e3\u6790",(0,i.kt)("inlineCode",{parentName:"p"},"input"),"\u7684\u65f6\u5019\u51fa\u73b0\u5f02\u5e38\u3002\u5728\u65e5\u5fd7\u4e2d\u8bb0\u5f55\u4e86\u8f93\u5165\u53c2\u6570",(0,i.kt)("inlineCode",{parentName:"p"},"args:0x008cb6611e0100000000000000000000"),"\uff0c\u89c2\u5bdf\u8fd9\u4e2a\u53c2\u6570\u53ef\u4ee5\u53d1\u73b0\u5176\u957f\u5ea6\u660e\u663e\u5c0f\u4e8e",(0,i.kt)("inlineCode",{parentName:"p"},"u128"),"\u7f16\u7801\u7684\u60c5\u51b5\u3002\u56e0\u6b64\u53ef\u4ee5\u6839\u636e",(0,i.kt)("inlineCode",{parentName:"p"},"args"),"\u548c",(0,i.kt)("inlineCode",{parentName:"p"},"env_trace"),"\u63a8\u6d4b\u51fa\u662f\u89e3\u7801",(0,i.kt)("inlineCode",{parentName:"p"},"input"),"\u7684\u65f6\u5019\u53d1\u751f\u4e86\u9519\u8bef\u3002"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-rust"},"// this part code is expanded by erc20 example.\n::ink_env::decode_input::<<Erc20 as ::ink_lang::ConstructorDispatcher>::Type>().map_err(|_| ::ink_lang::DispatchError::CouldNotReadInput)?\n")))),(0,i.kt)("p",{parentName:"li"},"\u6b64\u65f6\u5408\u7ea6\u5b9e\u4f8b\u5316\u6210\u529f\uff0c\u4f46\u662f\u6267\u884c\u5b9e\u4f8b\u5316\u7684\u6784\u9020\u51fd\u6570\u5b58\u5728\u3002\u56e0\u6b64\u5408\u7ea6\u5b58\u5728\u4e8e\u94fe\u4e0a\u4f46\u662f\u6ca1\u6709\u6b63\u5e38\u6267\u884c",(0,i.kt)("inlineCode",{parentName:"p"},"#[ink(constructor)]"),"\u7684\u8fc7\u7a0b\u3002")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"call"),"\u9636\u6bb5 \uff0c\u5982\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"transfer"),":"),(0,i.kt)("p",{parentName:"li"},"\u5bf9\u4ee5\u4e0a\u5b9e\u4f8b\u5316\u6210\u529f\u7684\u51fd\u6570\u8fdb\u884c\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"transfer"),"\uff0c\u4f1a\u51fa\u73b0",(0,i.kt)("inlineCode",{parentName:"p"},"ContractTrap"),"\uff0ceuropa\u7684\u65e5\u5fd7\u663e\u793a\u5982\u4e0b\uff1a"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'1: NestedRuntime {\n    ext_result: [failed] ExecError { error: DispatchError::Module {index:5, error:17, message: Some("ContractTrapped"), orign: ErrorOrigin::Caller }}\n# ...\n    env_trace: [\n        seal_value_transferred(Some(0x0000000000000000)),\n    ],\n    wasm_error: Error::WasmiExecution(Trap(Trap { kind: Unreachable }))\n        wasm backtrace: \n        |  core::panicking::panic_fmt.60[1743]\n        |  core::result::unwrap_failed[914]\n        |  core::result::Result<T,E>::expect[915]\n        |  ink_lang::dispatcher::deny_payment[1664]\n        |  call[1691]\n        \u2570\u2500><unknown>[2387]\n    ,\n    nest: [],\n}\n')),(0,i.kt)("p",{parentName:"li"},"\u9996\u5148\u6ce8\u610f\u5230",(0,i.kt)("inlineCode",{parentName:"p"},"env_trace"),"\u6700\u540e\u4e00\u4e2a\u8bb0\u5f55\u4f9d\u7136\u4e0d\u662f",(0,i.kt)("inlineCode",{parentName:"p"},"seal_return"),"\uff0c\u4e14",(0,i.kt)("inlineCode",{parentName:"p"},"wasm_error"),"\u7684\u9519\u8bef\u539f\u56e0\u662f",(0,i.kt)("inlineCode",{parentName:"p"},"WasmiExecution::Unreachable"),"\u3002\u56e0\u6b64\u53ef\u4ee5\u786e\u5b9a\u662f\u5408\u7ea6\u6267\u884c\u8fc7\u7a0b\u4e2d\u9047\u5230\u4e86",(0,i.kt)("inlineCode",{parentName:"p"},"panic"),"\u6216\u8005",(0,i.kt)("inlineCode",{parentName:"p"},"expect"),"\u3002"),(0,i.kt)("p",{parentName:"li"},"\u800c\u4ecewasm backtrace \u4e2d\u5219\u5341\u5206\u660e\u663e\u7684\u770b\u5230\u4e86\u5728\u6267\u884c\u8fc7\u7a0b\u4e3a"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"   call -> deny_payment -> expect\n")),(0,i.kt)("p",null,"\u800c\u6839\u636e\u5b8f\u5c55\u5f00\u7684\u4ee3\u7801\uff08",(0,i.kt)("inlineCode",{parentName:"p"},"cd ink/examples/erc20; cargo expand > tmp.rs"),"\uff09\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'#[no_mangle]\nfn call() -> u32 {\n    if true {\n     ::ink_lang::deny_payment::<<Erc20 as ::ink_lang::ContractEnv>::Env>()\n            .expect("caller transferred value even though all ink! message deny payments")\n    }\n    ::ink_lang::DispatchRetCode::from(\n        <Erc20 as ::ink_lang::DispatchUsingMode>::dispatch_using_mode(\n            ::ink_lang::DispatchMode::Call,\n        ),\n    )\n    .to_u32()\n}\n')),(0,i.kt)("p",null,"   \u56e0\u6b64\u53ef\u4ee5\u5224\u5b9a\u5408\u7ea6\u6267\u884c",(0,i.kt)("inlineCode",{parentName:"p"},"transfer"),"\u7684\u8fc7\u7a0b\u4e2d\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"deny_payment"),"\u8fd4\u56de\u4e86\u9519\u8bef\uff0c\u800c\u8fd9\u91cc\u5bf9\u9519\u8bef\u76f4\u63a5\u5904\u7406\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"expect"),"\u5bfc\u81f4\u4e86",(0,i.kt)("inlineCode",{parentName:"p"},"wasmi"),"\u6267\u884c\u7ed3\u679c\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"Unreachable"),"\u3002\u8ddf\u8e2a",(0,i.kt)("inlineCode",{parentName:"p"},"deny_payment"),"\u7684\u4ee3\u7801\u53ef\u4ee5\u53d1\u73b0\u662f\u8be5\u51fd\u6570\u8fd4\u56de\u4e86",(0,i.kt)("inlineCode",{parentName:"p"},"Error"),"\u5bfc\u81f4\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"expect")),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"\u6ce8\uff0c\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,i.kt)("p",{parentName:"blockquote"},"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"ink_lang"),"\u4e2d",(0,i.kt)("a",{parentName:"p",href:"https://github.com/paritytech/ink/blob/master/crates/lang/src/dispatcher.rs#L140-L150"},"https://github.com/paritytech/ink/blob/master/crates/lang/src/dispatcher.rs#L140-L150")),(0,i.kt)("pre",{parentName:"blockquote"},(0,i.kt)("code",{parentName:"pre",className:"language-rust"},'pub fn deny_payment<E>() -> Result<()>\nwhere\n    E: Environment,\n{\n    let transferred = ink_env::transferred_balance::<E>()\n        .expect("encountered error while querying transferred balance");\n    if transferred != <E as Environment>::Balance::from(0u32) {\n        return Err(DispatchError::PaidUnpayableMessage)\n    }\n    Ok(())\n}\n')),(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("strong",{parentName:"p"},"ink\u4e2d\u6b64\u5904\u7684",(0,i.kt)("inlineCode",{parentName:"strong"},"off_chain"),"\u90e8\u5206\u548c",(0,i.kt)("inlineCode",{parentName:"strong"},"on_chain"),"\u90e8\u5206\u4f1a\u51fa\u73b0\u5dee\u5f02"),"\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"off_chain"),"\u4f1a\u8ba4\u4e3a\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"ink_env::transferred_balance::<E>()"),"\u9636\u6bb5\u5c31\u8fd4\u56de\u9519\u8bef\uff0c\u4e8e\u662f\u5728\u6267\u884c",(0,i.kt)("inlineCode",{parentName:"p"},"transferred_balance"),"\u4e2d\u540e\u4f1a\u9047\u5230",(0,i.kt)("inlineCode",{parentName:"p"},"expect"),"\u5bfc\u81f4",(0,i.kt)("inlineCode",{parentName:"p"},"panic"),"\uff0c\u800c",(0,i.kt)("inlineCode",{parentName:"p"},"on_chain"),"\u90e8\u5206\u7531\u4e8e\u662f\u4ecewasm\u7684memory\u4e2d\u53d6\u503c\uff0c\u5219\u4f1a\u6b63\u5e38\u83b7\u53d6\u5230\u5bf9\u5e94u128\u957f\u5ea6\u7684\u5b57\u7b26\u5e76\u89e3\u7801\u5f97\u5230",(0,i.kt)("inlineCode",{parentName:"p"},"transferred"),"\uff0c\u53ea\u662f\u89e3\u7801\u7684\u7ed3\u679c\u4e0d\u4f1a\u7b26\u5408\u9884\u671f\uff0c\u5bfc\u81f4",(0,i.kt)("inlineCode",{parentName:"p"},"transferred!=0"),"\u8ba9",(0,i.kt)("inlineCode",{parentName:"p"},"deny_payment"),"\u8fd4\u56de\u4e86Error\uff0c\u800c\u5728\u5408\u7ea6\u7684\u5b8f\u5c55\u5f00\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"deny_payment"),"\u7684\u90e8\u5206\u624d\u89e6\u53d1",(0,i.kt)("inlineCode",{parentName:"p"},"expect")),(0,i.kt)("pre",{parentName:"blockquote"},(0,i.kt)("code",{parentName:"pre",className:"language-rust"},'if true {\n    ::ink_lang::deny_payment::<<Erc20 as ::ink_lang::ContractEnv>::Env>()\n        .expect("caller transferred value even though all ink! message deny payments")\n}\n')),(0,i.kt)("p",{parentName:"blockquote"},"\u56e0\u6b64\u5bf9\u4e8ewasm backtrace \u6765\u8bf4\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"expect"),"\u662f\u51fa\u73b0\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"call"),"\u4e2d\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"deny_payment"),"\u7684\u65f6\u5019\uff0c\u800c\u4e0d\u662f",(0,i.kt)("inlineCode",{parentName:"p"},"deny_payment"),"\u4e2d\u8c03\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"transferred_balance"),"\u7684\u65f6\u5019\u3002"),(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("strong",{parentName:"p"},"\u8fd9\u4e2a\u4f8b\u5b50\u4fa7\u9762\u8bf4\u660e",(0,i.kt)("inlineCode",{parentName:"strong"},"ink!"),"\u5f53\u524d\u5bf9\u4e8e",(0,i.kt)("inlineCode",{parentName:"strong"},"off_chain"),"\u4ee5\u53ca",(0,i.kt)("inlineCode",{parentName:"strong"},"on_chain"),"\u7684\u5904\u7406\u5e76\u4e0d\u662f\u5b8c\u5168\u5bf9\u5e94\u7684\uff0c\u53ef\u80fd\u5728\u4e00\u4e9b\u60c5\u51b5\u4e0b\u4f1a\u7ed9\u5408\u7ea6\u7684\u4f7f\u7528\u8005\u9020\u6210\u96be\u4ee5\u6392\u67e5\u7684\u9519\u8bef"))),(0,i.kt)("h2",{id:"what-we-have-implemented-for-v02"},"What we have implemented for v0.2"),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"Modify at ",(0,i.kt)("inlineCode",{parentName:"em"},"FRAME Contracts pallet")," level to provide more information.")),(0,i.kt)("p",null,"\u6d4b\u8bd5\u7528\u4f8b\u89c1\uff1a"))}k.isMDXComponent=!0}}]);