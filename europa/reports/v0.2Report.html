<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Europa v0.2 报告</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/substrate-contracts-book/favicon.ico">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta content="https://www.patract.io/social-preview.png" property="og:image">
    
    <link rel="preload" href="/substrate-contracts-book/assets/css/0.styles.7869a774.css" as="style"><link rel="preload" href="/substrate-contracts-book/assets/js/app.b3270eae.js" as="script"><link rel="preload" href="/substrate-contracts-book/assets/js/3.7c35afa4.js" as="script"><link rel="preload" href="/substrate-contracts-book/assets/js/1.293685b3.js" as="script"><link rel="preload" href="/substrate-contracts-book/assets/js/140.1bc025aa.js" as="script"><link rel="prefetch" href="/substrate-contracts-book/assets/js/10.f560e2ba.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/100.95451e75.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/101.1fdd1f03.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/102.3cfa4f1e.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/103.76f65bdf.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/104.f0d72cbc.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/105.112a1cd8.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/106.1587302e.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/107.658c4109.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/108.e3aee840.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/109.7d1d01d0.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/11.ff45929c.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/110.cc5d0673.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/111.5230de15.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/112.be290b70.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/113.e6e0ad48.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/114.3f65e1a2.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/115.f8fe8b7b.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/116.cb73d6de.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/117.e0e60626.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/118.a14d9fe0.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/119.1bc63761.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/12.7661745e.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/120.41587792.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/121.44b6595d.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/122.8e30372c.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/123.53813b86.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/124.02a91f13.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/125.90ab9a5d.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/126.770ccb60.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/127.bb37b007.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/128.0407add8.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/129.288a6f52.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/13.77735261.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/130.e2a72c48.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/131.5440dceb.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/132.4f126424.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/133.75bfcf2e.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/134.9e9d0921.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/135.324b5294.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/136.007179e8.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/137.4ec2ff40.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/138.649c3481.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/139.eed3baec.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/14.0d64657c.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/141.a9b85db3.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/142.0768749f.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/143.93f6b8c4.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/144.9d6912b9.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/145.c3cf0077.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/146.b726dd3a.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/147.b6f59662.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/148.d9951318.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/149.6243d82d.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/15.98e78daf.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/150.d498300a.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/151.3d58f099.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/152.085723d8.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/153.4f9e18ab.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/154.c8662863.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/155.df6801d9.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/156.46d6f734.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/157.e8092950.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/158.eb3a79bb.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/159.98cb2e5a.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/16.61021424.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/160.06748416.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/161.8494a5c9.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/162.0477f850.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/163.6cf93396.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/164.5cba28b4.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/165.13b50224.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/166.d6adf620.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/167.4a495566.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/168.c312f322.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/169.f37ba1c5.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/17.58bc9af7.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/170.b3fe4043.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/171.228202e7.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/172.72965f5a.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/173.7d24d201.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/174.7a99c279.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/175.906adcdd.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/176.54af4560.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/177.024eecb8.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/178.5f07b111.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/179.53a38f63.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/18.256db1ba.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/180.26ecf2c3.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/181.9a8b901d.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/182.2a7bf890.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/183.fefb1495.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/184.ebdea99c.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/185.3a32ea37.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/186.079185d8.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/187.bbc2ad09.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/188.20490eb3.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/189.9d80c9c5.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/19.0a0963f9.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/190.3fd647b5.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/191.c0a38f33.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/192.162e93ef.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/193.077b12e2.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/194.6e022708.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/195.43d1f100.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/196.51d8982f.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/197.67276d19.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/20.c67e51a2.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/21.72703fee.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/22.e7c6af88.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/23.bcf6fd6b.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/24.82bd5bb7.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/25.d7485964.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/26.d6ba03d4.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/27.59b07548.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/28.1c175f18.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/29.ed7481c9.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/30.548c38ca.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/31.868ea504.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/32.3b2de66a.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/33.9f45019d.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/34.ab7d0792.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/35.c6cb45a8.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/36.ecf0aae1.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/37.689dfb9d.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/38.f405b266.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/39.cfed4e29.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/4.e9bde0d3.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/40.808c28db.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/41.3403c3a3.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/42.73c3b656.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/43.4c43aac1.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/44.3584f9fc.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/45.cdebf294.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/46.654ba434.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/47.95c2825d.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/48.a400ea64.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/49.ac93bc37.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/5.271970b3.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/50.47b55d1a.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/51.06054c5e.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/52.3ce7dff4.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/53.6f5b2f0c.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/54.b3255e22.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/55.4943c2fe.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/56.7905359e.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/57.006b682e.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/58.b72084bb.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/59.e66054a1.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/6.1380e490.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/60.86ebaf5a.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/61.f4f61013.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/62.59762ee0.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/63.5ae468f9.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/64.232b4447.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/65.e77ea092.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/66.6c7580d3.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/67.0886e149.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/68.9d055d69.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/69.d8da1686.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/7.609a6697.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/70.75e3ce43.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/71.5be06d5f.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/72.c4d23bfc.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/73.5e924bea.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/74.3c7635ac.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/75.280dd380.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/76.80c841c4.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/77.40b985cc.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/78.6bde6f3a.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/79.ecc021f3.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/8.f877c3e5.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/80.fbbb0add.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/81.ee0758d6.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/82.eba646ec.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/83.c5dcad7d.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/84.b9a61f11.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/85.8227c486.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/86.2e717c4e.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/87.d48572e3.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/88.14b3ad70.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/89.777a3bb2.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/9.2035d6c9.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/90.24b6a32d.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/91.67113675.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/92.b5c253a8.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/93.2800c95e.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/94.65591368.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/95.16c6aac6.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/96.3d21803c.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/97.bcc392bb.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/98.51c3f093.js"><link rel="prefetch" href="/substrate-contracts-book/assets/js/99.942459e9.js">
    <link rel="stylesheet" href="/substrate-contracts-book/assets/css/0.styles.7869a774.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc></h3> <p class="description" data-v-4e82dffc data-v-4e82dffc></p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>patractlabs</span>
            
          <!---->
          2021
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/substrate-contracts-book/" class="home-link router-link-active"><img src="/substrate-contracts-book/logo.svg" alt="" class="logo"> <!----></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://patract.io" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-home"></i>
  主页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://blog.patract.io" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-blog"></i>
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/substrate-contracts-book/" class="nav-link"><i></i>
  Doc
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Languages
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/substrate-contracts-book/europa/reports/v0.2Report.html" aria-current="page" class="nav-link router-link-exact-active router-link-active"><i class="undefined"></i>
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/substrate-contracts-book/en/europa/reports/v0.2Report.html" class="nav-link"><i class="undefined"></i>
  English
</a></li></ul></div></div> <a href="https://github.com/patractlabs/substrate-contracts-book" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><!----> <h3 class="name" data-v-828910c6>
    patractlabs
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>188</h3> <h6 data-v-828910c6>文章</h6></div> <div data-v-828910c6><h3 data-v-828910c6>0</h3> <h6 data-v-828910c6>标签</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="https://patract.io" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-home"></i>
  主页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://blog.patract.io" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-blog"></i>
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/substrate-contracts-book/" class="nav-link"><i></i>
  Doc
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Languages
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/substrate-contracts-book/europa/reports/v0.2Report.html" aria-current="page" class="nav-link router-link-exact-active router-link-active"><i class="undefined"></i>
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/substrate-contracts-book/en/europa/reports/v0.2Report.html" class="nav-link"><i class="undefined"></i>
  English
</a></li></ul></div></div> <a href="https://github.com/patractlabs/substrate-contracts-book" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <ul class="sidebar-links"><li><a href="/substrate-contracts-book/" aria-current="page" class="sidebar-link">Substrate 合约书</a></li><li><section class="sidebar-group depth-0"><a href="/substrate-contracts-book/introduction" class="sidebar-heading clickable"><span>介绍</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/contracts/overview.html" class="sidebar-link">合约综述</a></li><li><a href="/substrate-contracts-book/contracts/model.html" class="sidebar-link">合约模型</a></li><li><a href="/substrate-contracts-book/contracts/language.html" class="sidebar-link">合约语言</a></li><li><a href="/substrate-contracts-book/contracts/wasm_first_step.html" class="sidebar-link">Wasm简要介绍</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/substrate-contracts-book/ink/introduction" class="sidebar-heading clickable"><span>ink!</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/ink/tutorial.html" class="sidebar-link">ink! tutorial</a></li><li><a href="/substrate-contracts-book/ink/framework.html" class="sidebar-link">ink! 框架</a></li><li><a href="/substrate-contracts-book/ink/edsl-basic.html" class="sidebar-link">ink! eDSL基础元素</a></li><li><a href="/substrate-contracts-book/ink/call-contracts.html" class="sidebar-link">ink! 跨合约调用</a></li><li><a href="/substrate-contracts-book/ink/ink-solidity.html" class="sidebar-link">ink! 与solidity的对比</a></li><li><a href="/substrate-contracts-book/ink/cargo-contract.html" class="sidebar-link">cargo-contract</a></li><li><a href="/substrate-contracts-book/ink/trap.html" class="sidebar-link">ink! 当前的坑</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/substrate-contracts-book/ask/introduction" class="sidebar-heading clickable"><span>ask!</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/ask/tutorial.html" class="sidebar-link">Ask!教程</a></li><li><a href="/substrate-contracts-book/ask/design.html" class="sidebar-link">设计</a></li><li><a href="/substrate-contracts-book/ask/basics.html" class="sidebar-link">基础</a></li><li><a href="/substrate-contracts-book/ask/decorators.html" class="sidebar-link">Ask! 装饰器</a></li><li><a href="/substrate-contracts-book/ask/storage-data-structure.html" class="sidebar-link">存储</a></li><li><a href="/substrate-contracts-book/ask/ask-cli.html" class="sidebar-link">Ask-cli</a></li><li><a href="/substrate-contracts-book/ask/ask-vs-ink.html" class="sidebar-link">Ask!和ink!的特性比较</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/substrate-contracts-book/ask/reports" class="sidebar-heading clickable"><span>Report</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/ask/reports/v0.1Report.html" class="sidebar-link">Ask! v0.1 报告</a></li><li><a href="/substrate-contracts-book/ask/reports/v0.2Report.html" class="sidebar-link">Ask! v0.2 报告</a></li></ul></section></li></ul></section></li><li><a href="/substrate-contracts-book/solang/introduction.html" class="sidebar-link">Solang</a></li><li><section class="sidebar-group depth-0"><a href="/substrate-contracts-book/redspot/introduction" class="sidebar-heading clickable"><span>Redspot</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/redspot/tutorial.html" class="sidebar-link">Redspot 教程</a></li><li><a href="/substrate-contracts-book/redspot/overview.html" class="sidebar-link">介绍</a></li><li><a href="/substrate-contracts-book/redspot/configuration.html" class="sidebar-link">配置信息</a></li><li><a href="/substrate-contracts-book/redspot/tasks.html" class="sidebar-link">Tasks</a></li><li><a href="/substrate-contracts-book/redspot/runtime-environment.html" class="sidebar-link">Runtime Environment</a></li><li><a href="/substrate-contracts-book/redspot/console.html" class="sidebar-link">控制台</a></li><li><a href="/substrate-contracts-book/redspot/q-and-a.html" class="sidebar-link">常见问题</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/substrate-contracts-book/redspot/plugin" class="sidebar-heading clickable"><span>Plugin</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/redspot/plugin/redspot-decimals.html" class="sidebar-link">@redspot_decimals插件</a></li><li><a href="/substrate-contracts-book/redspot/plugin/redspot-known-types.html" class="sidebar-link">@redspot_known-types插件</a></li><li><a href="/substrate-contracts-book/redspot/plugin/redspot-chai.html" class="sidebar-link">@redspot_chai插件</a></li><li><a href="/substrate-contracts-book/redspot/plugin/redspot-gas-reporter.html" class="sidebar-link">@redspot_gas-reporter 插件</a></li><li><a href="/substrate-contracts-book/redspot/plugin/redspot-patract.html" class="sidebar-link">@redspot_patract插件</a></li><li><a href="/substrate-contracts-book/redspot/plugin/redspot-explorer.html" class="sidebar-link">@redspot/explorer插件</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/substrate-contracts-book/redspot/reports" class="sidebar-heading clickable"><span>Report</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/redspot/reports/v0.1Report.html" class="sidebar-link">Redspot v0.1 报告</a></li><li><a href="/substrate-contracts-book/redspot/reports/v0.2Report.html" class="sidebar-link">Redspot v0.2 报告</a></li><li><a href="/substrate-contracts-book/redspot/reports/v0.3Report.html" class="sidebar-link">Redspot v0.3 报告</a></li><li><a href="/substrate-contracts-book/redspot/reports/v0.4Report.html" class="sidebar-link">Redspot v0.4 报告</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/substrate-contracts-book/europa/introduction" class="sidebar-heading clickable"><span>Europa</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/europa/tutorial.html" class="sidebar-link">Europa教程</a></li><li><a href="/substrate-contracts-book/europa/execution_info.html" class="sidebar-link">Europa 合约执行日志分析</a></li><li><a href="/substrate-contracts-book/europa/sample.html" class="sidebar-link">Europa 调试示例</a></li><li><a href="/substrate-contracts-book/europa/wasm_executor.html" class="sidebar-link">Europa Wasm executor</a></li><li><a href="/substrate-contracts-book/europa/wasm_backtrace.html" class="sidebar-link">Europa 的Wasm Backtrace</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/substrate-contracts-book/europa/reports" class="sidebar-heading clickable router-link-active open"><span>Report</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/europa/reports/v0.1Report.html" class="sidebar-link">Europa v0.1 报告</a></li><li><a href="/substrate-contracts-book/europa/reports/v0.2Report.html" aria-current="page" class="active sidebar-link">Europa v0.2 报告</a></li><li><a href="/substrate-contracts-book/europa/reports/v0.3Report.html" class="sidebar-link">Europa v0.3报告</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/substrate-contracts-book/zkmega/introduction" class="sidebar-heading clickable"><span>zkMega</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/zkmega/tutorial.html" class="sidebar-link">tutorial</a></li><li><a href="/substrate-contracts-book/zkmega/contract.html" class="sidebar-link">Contract</a></li><li><a href="/substrate-contracts-book/zkmega/example.html" class="sidebar-link">Example</a></li><li><a href="/substrate-contracts-book/zkmega/benchmark.html" class="sidebar-link">Benchmark</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/substrate-contracts-book/zkmega/reports" class="sidebar-heading clickable"><span>Report</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/zkmega/reports/v0.1Report.html" class="sidebar-link">zkMega v0.1 报告（Megaclite v0.1 报告）</a></li><li><a href="/substrate-contracts-book/zkmega/reports/v0.2Report.html" class="sidebar-link">zkMega v0.2 报告（Megaclite v0.2 报告）</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/substrate-contracts-book/himalia/introduction" class="sidebar-heading clickable"><span>Himalia</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/himalia/tutorial.html" class="sidebar-link">tutorial</a></li><li><a href="/substrate-contracts-book/himalia/go-patract.html" class="sidebar-link">go-patract</a></li><li><a href="/substrate-contracts-book/himalia/py-patract.html" class="sidebar-link">py-patract</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/substrate-contracts-book/himalia/reports" class="sidebar-heading clickable"><span>Report</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/himalia/reports/v0.1Report.html" class="sidebar-link">Patract Hub's treasury report for Himalia v0.1 &amp; v0.2(Contract SDKs)</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/substrate-contracts-book/metis/introduction" class="sidebar-heading clickable"><span>Metis</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/metis/tokens.html" class="sidebar-link">ERC20</a></li><li><a href="/substrate-contracts-book/metis/access-control.html" class="sidebar-link">Access Control</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/substrate-contracts-book/metis/reports" class="sidebar-heading clickable"><span>Report</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/metis/reports/M1Report.html" class="sidebar-link">Metis(ink!标准库)项目的提案征求意见稿</a></li></ul></section></li></ul></section></li><li><a href="/substrate-contracts-book/carpo/introduction.html" class="sidebar-link">Carpo</a></li><li><section class="sidebar-group depth-0"><a href="/substrate-contracts-book/elara/introduction" class="sidebar-heading clickable"><span>Elara</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/elara/tutorial.html" class="sidebar-link">Tutorial</a></li><li><a href="/substrate-contracts-book/elara/design.html" class="sidebar-link">设计简述</a></li><li><a href="/substrate-contracts-book/elara/API.html" class="sidebar-link">API 接入</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/substrate-contracts-book/elara/reports" class="sidebar-heading clickable"><span>Report</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/elara/reports/v0.1Report.html" class="sidebar-link">Elara v0.1 报告</a></li><li><a href="/substrate-contracts-book/elara/reports/v0.2Report.html" class="sidebar-link">Elara v0.2 报告</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/substrate-contracts-book/jupiter/introduction" class="sidebar-heading clickable"><span>Jupiter</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/jupiter/quickstart.html" class="sidebar-link">编译</a></li><li><a href="/substrate-contracts-book/jupiter/network.html" class="sidebar-link">Jupiter 网络</a></li><li><a href="/substrate-contracts-book/jupiter/contract.html" class="sidebar-link">合约</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/substrate-contracts-book/patra-store/introduction" class="sidebar-heading clickable"><span>PatraStore</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/substrate-contracts-book/patra-store/overview.html" class="sidebar-link">Overview</a></li><li><a href="/substrate-contracts-book/patra-store/getting-starter.html" class="sidebar-link">Getting started</a></li><li><a href="/substrate-contracts-book/patra-store/publish-dapps.html" class="sidebar-link">发布DApp</a></li></ul></section></li><li><a href="/substrate-contracts-book/patract/introduction.html" class="sidebar-link">Patract</a></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc></h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>patractlabs</span>
            
          <!---->
          2021
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">Europa v0.2 报告</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>patractlabs</span></i> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 id="europa-v0-2-报告"><a href="#europa-v0-2-报告" class="header-anchor">#</a> Europa v0.2 报告</h1> <p>Patract Hub's treasury report for Europa v0.2</p> <p>Patract Hub (https://patract.io) develops local open source toolkits and one-stop cloud smart IDE, committed to provide free development toolkits and infrastructure services for the entire smart contract ecosystem. Six weeks ago, we applied a <a href="https://polkadot.polkassembly.io/motion/48" target="_blank" rel="noopener noreferrer">treasury proposal<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for Europa v0.2 , and now we have finished the development (https://github.com/patractlabs/europa) . This repost shows what Europa v0.2 completion.</p> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>Europa is kind of another implementation for <a href="https://github.com/paritytech/substrate/tree/master/client" target="_blank" rel="noopener noreferrer">Substrate client<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> in our design. We know that the runtime of a blockchain is the business logic that defines its behavior, and the Substrate runtime need to run by an executor and environment. So that we design the executor and environment more like a &quot;sandbox&quot; to run a Substrate runtime.</p> <p>In v0.2, the primary target is to modify <code>FRAME Contracts pallet</code> in runtime to provide more detailed debugging information, including contract execution process information (in <code>FRAME Contracts</code> layer) and WASM execution information (in WASMI execution layer).</p> <h3 id="summary-of-europa-s-v0-2-plan"><a href="#summary-of-europa-s-v0-2-plan" class="header-anchor">#</a> Summary of Europa's v0.2 plan:</h3> <blockquote><ol><li><em>Modify at <code>FRAME Contracts pallet</code> level to provide more information.</em></li></ol></blockquote> <h3 id="how-to-verify-v0-2-github-source"><a href="#how-to-verify-v0-2-github-source" class="header-anchor">#</a> How to verify v0.2:  Github source</h3> <blockquote><ul><li>Construct incorrect contracts and execute logs printing to determine whether it meets expectations</li> <li>Display the call statistics of the <code>define_env!</code> interface during contract execution</li> <li>Execute the log printing function, provide formatted printing examples of different data, and judge whether it meets expectations</li> <li>Construct a contract that crashes under different conditions and record the log after execution. Then judge whether the backtrace information of the contract execution is completely printed, and check whether it matches the actual execution of the collapsed contract.</li></ul></blockquote> <p>后文统一称<code>FRAME Contracts pallet</code>为<code>pallet-contracts</code>。</p> <h2 id="design"><a href="#design" class="header-anchor">#</a> Design</h2> <p>在0.2中，对于合约模块的调试信息功能的提升分为三个部分的修改：</p> <ul><li><code>pallet-contracts</code>层的修改：在<code>pallet-contracts</code>的执行合约的过程中添加trace记录在合约层中的信息，并且记录合约的调用层级。另一方面完善了调用wasm执行的错误信息。</li> <li><code>wasmi</code>层的修改：给予<code>wasmi</code>提供了记录wasm执行中的backtrace功能，并且给<code>parity-wasm</code>，<code>pwasm-utils</code>，<code>cargo-contract</code>提供了支持在合约的wasm处理中包含name section的功能。</li> <li>合约日志功能：使用<code>ChainExtensions</code>的功能实现了合约中打印<code>log</code>日志的库。</li></ul> <p>当前在<code>pallet-contracts</code>中，在<code>wasmi</code>中执行出现错误以及wasmi执行过程中调用<code>pallet-contracts</code>的<a href="https://webassembly.github.io/spec/core/exec/runtime.html#function-instances" target="_blank" rel="noopener noreferrer">host_function<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>出现错误的时候，对外都表现为<code>ContractTrap</code>。这个情况对于开发者很难定位错误出现的原因，仅从这个信息无法分辨出出现问题的地方是合约自身，<code>ink!</code>，还是<code>pallet-contracts</code>。因此这个版本的europa提供的丰富的信息，能让开发者直接定位到出现问题的原因上。</p> <h3 id="pallet-contracts层"><a href="#pallet-contracts层" class="header-anchor">#</a> <code>pallet-contracts</code>层</h3> <p>europa认为在合约调试过程需要：</p> <ol><li>丰富错误信息：wasm记录整个执行过程中出现错误信息的情况，包含wasm执行器的错误以及host_function的错误。wasmi的backtrace信息会和这里的错误信息统一起来。</li> <li>调试过程中的执行情况：<code>pallet-contracts</code>的主要修改信息，以“合约栈”为记录合约调用合约的过程，以及当前这一层合约在执行过程中任何能辅助调试的信息，例如调用host_function的情况，selector，调用合约的参数等等。</li></ol> <p>因此针对这样的需求，europa做了如下设计与修改：</p> <h4 id="丰富错误信息"><a href="#丰富错误信息" class="header-anchor">#</a> 丰富错误信息</h4> <ol><li><p>wasm执行器层的错误：</p> <p>europa设计了自己的<code>ep-sandbox</code>替换了原本<code>pallet-contracts</code>使用的<code>sp-sandbox</code>，并修改<code>ep_sandbox::Error</code></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">patract_wasmi<span class="token punctuation">::</span></span><span class="token class-name">Error</span> <span class="token keyword">as</span> <span class="token class-name">WasmiError</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Error</span> <span class="token punctuation">{</span>
	<span class="token class-name">Module</span><span class="token punctuation">(</span><span class="token class-name">WasmiError</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token class-name">OutOfBounds</span><span class="token punctuation">,</span>
	<span class="token class-name">Execution</span><span class="token punctuation">,</span>
	<span class="token class-name">WasmiExecution</span><span class="token punctuation">(</span><span class="token class-name">WasmiError</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Module(WasmiError)</code>携带wasm层的原始错误信息，并且在 <code>frame/contracts/src/wasm/runtime.rs</code>中的 <code>to_execution_result</code>转换为 <code>String</code>抛出错误信息。</p> <p>europa自己的<code>ep-sandbox</code>只有<code>std</code>版本（因为europa已经移除了所有的WASM的部分，不需要<code>ep-sandbox</code>支持<code>no-std</code>），因此在将来，<strong><code>ep-sandbox</code>可以替换为不同的wasm执行器，以支持不同wasm执行器的运行测试及替换为支持debug的wasm执行器等特性。</strong></p> <p>当前<code>ep-sandbox</code>使用的是一个forked版本的<code>wasmi</code>作为执行器，因此其抛出的错误为<code>WasmiError</code>。对于<code>wasmi</code>的错误改动见下一个章节。</p></li> <li><p>host_function的错误</p> <p>host函数执行错误会引起Trap，并且会记录<code>TrapReason</code>。对数据结构不进行修改，只需要记录即可。</p></li></ol> <h4 id="调试过程中的执行情况"><a href="#调试过程中的执行情况" class="header-anchor">#</a> 调试过程中的执行情况</h4> <p>europa forked 版本的<code>pallet-contracts</code>设计了一个对象记录合约执行中任何可以帮助调试的信息：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">/// Record the contract execution context.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">NestedRuntime</span> <span class="token punctuation">{</span>
	<span class="token comment">/// Current depth</span>
    depth<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
	<span class="token comment">/// The current contract execute result</span>
	ext_result<span class="token punctuation">:</span> <span class="token class-name">ExecResult</span><span class="token punctuation">,</span>
	<span class="token comment">/// The value in sandbox successful result</span>
	sandbox_result_ok<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">ReturnValue</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
	<span class="token comment">/// Who call the current contract</span>
    caller<span class="token punctuation">:</span> <span class="token class-name">AccountId32</span><span class="token punctuation">,</span>
	<span class="token comment">/// The account of the current contract</span>
    self_account<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">AccountId32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
	<span class="token comment">/// The input selector</span>
    selector<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">HexVec</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
	<span class="token comment">/// The input arguments</span>
    args<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">HexVec</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
	<span class="token comment">/// The value in call or the endowment in instantiate</span>
    value<span class="token punctuation">:</span> <span class="token keyword">u128</span><span class="token punctuation">,</span>
	<span class="token comment">/// The gas limit when this contract is called</span>
    gas_limit<span class="token punctuation">:</span> <span class="token class-name">Gas</span><span class="token punctuation">,</span>
	<span class="token comment">/// The gas left when this contract return</span>
    gas_left<span class="token punctuation">:</span> <span class="token class-name">Gas</span><span class="token punctuation">,</span>
	<span class="token comment">/// The host function call stack</span>
    env_trace<span class="token punctuation">:</span> <span class="token class-name">EnvTraceList</span><span class="token punctuation">,</span>
	<span class="token comment">/// The error in wasm</span>
    wasm_error<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">WasmErrorWrapper</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
	<span class="token comment">/// The trap in host function execution</span>
    trap_reason<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">TrapReason</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
	<span class="token comment">/// Nested contract execution context</span>
    nest<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">NestedRuntime</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在<code>pallet-contracts</code>的模型中，合约调用合约是以“合约栈”的模型调用，因此<code>NestedRuntime</code>会跟踪整个合约栈的执行过程，并用<code>nest</code>这个属性保存一个<code>NestedRuntime</code>列表表示当前合约中调用过的其他合约。</p> <p>在<code>pallet-contracts</code>执行一个合约的过程中，europa以旁路的形态将执行过程中的相关信息记录在<code>NestedRuntime</code>这个结构体中，并在合约调用结束后将<code>NestedRuntime</code>以一定格式化的形式打印到日志中（将后文案例的展示）。合约的开发人员可以通过分析<code>NestedRuntime</code>打印的信息，得到此次合约执行过程中的各种详细信息，可以用于多种情况：</p> <ol><li>辅助定位错误出现的具体位置，包括以下情况：
<ol><li><code>pallet-contracts</code>层，</li> <li><code>ink!</code>层</li> <li>合约层中的具体位置</li> <li>在合约调用合约的情况下定位合约出现在哪一级合约中</li></ol></li> <li>分析此时合约执行过程中信息：
<ol><li>分析gas执行的消耗情况</li> <li>分析<code>get_storage</code>，<code>set_storage</code>调用的情况，帮助重构合约代码以及分析<code>rent</code>的需求情况</li> <li>根据<code>selector</code>，<code>args</code>和<code>value</code>分析定位第三方sdk组建交易参数是否合法。</li> <li>根据<code>nest</code>信息并结合<code>seal_call</code>信息分析合约调合约的执行路径。</li> <li>等等...</li></ol></li></ol> <p>在<code>pallet-contracts</code>模块中记录到<code>NestEdRuntime</code>中的过程是比较细粒度的，以<code>define_env!</code>中的<code>seal_call</code>为例：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">SealCall</span> <span class="token punctuation">{</span>
    callee<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">HexVec</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    gas<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    value<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">u128</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    input<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">HexVec</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    output<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">HexVec</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中的属性基本为<code>Option&lt;&gt;</code>，比如当调用合约前时会设置<code>input</code>为<code>Some</code>，调用合约正常后有返回值，则会设置<code>output</code>，如调用合约出现错误后，则<code>output</code>会保持<code>None</code>。因此若出现了<code>input</code>是<code>Some</code>而<code>output</code>为<code>None</code>的情况，则说明在合约调用合约的过程中，被调用的合约出现了问题。</p> <p>当前<code>NestedRuntime</code>的信息只在日志中打印，<strong>将来<code>NestedRuntime</code>将会做本地化存储并提供相应的rpc供外部访问获取</strong>。因此在将来第三方应用可以获取<code>NestedRuntime</code>做进一步的处理，例如在Redspot中可以设计一个插件根据<code>NestedRuntime</code>的信息生成一个合约调用合约的拓扑图，在web钱包界面可以生成可视化合约调用路径等等。</p> <h3 id="wasmi层"><a href="#wasmi层" class="header-anchor">#</a> <code>wasmi</code>层</h3> <p>我们fork了wasmi，并将这个forked版本的wasmi集成到了<code>ep-sandbox</code>中。而forked <code>pallet-contracts</code>可以通过<code>ep-sandbox</code>获取到forked <code>wasmi</code>的错误信息，包含<code>wasmi</code>的backtrace信息。</p> <p>如果需要让<code>wasmi</code>具备能够保留执行的backtrace的信息，需要具备以下几点：</p> <ol><li>WASM源文件中需要有&quot;name section&quot;段 （name section 的规范见 <a href="https://webassembly.github.io/spec/core/appendix/custom.html#name-section" target="_blank" rel="noopener noreferrer">“Name Section”<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</li> <li>在<code>pallet-contracts</code>检查合约的过程中保留“name section”信息且在处理过程后仍和wasm源文件具备对应关系。</li> <li><code>wasmi</code>的执行过程中需要把执行栈保留下来并附带函数的关键信息，同时&quot;name section&quot;需要被解析，且和<code>wasmi</code>执行栈保留的函数信息对应起来。</li></ol> <p>对于2的改动，涉及<code>cargo-build</code>，<code>parity-wasm</code>，而对于1，3的改动主要位于forked 的<code>wasmi</code>中，少部分涉及<code>pwasm-utils</code>。</p> <h4 id="_1-submitted-wasm-files-contains-debug-info-提交的wasm源文件中有-name-section-提供debug-info"><a href="#_1-submitted-wasm-files-contains-debug-info-提交的wasm源文件中有-name-section-提供debug-info" class="header-anchor">#</a> 1. Submitted WASM files contains debug info 提交的WASM源文件中有“name section”提供debug info</h4> <ul><li>PR: <a href="https://github.com/paritytech/cargo-contract/pull/131" target="_blank" rel="noopener noreferrer">paritytech/cargo-contract#131<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Source: <a href="https://github.com/patractlabs/cargo-contract" target="_blank" rel="noopener noreferrer">patractlabs/cargo-contract<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>Frist of all, we have to submit <strong>wasm files which contain the debug info</strong> that the on-chain side can parse and get the panic errors.</p> <p>Currently, <a href="https://github.com/patractlabs/cargo-contract" target="_blank" rel="noopener noreferrer">parity/cargo-contract<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> trims debug info while building contracts, we can get them back with the following steps.</p> <h5 id="_1-1-keep-name-section-from-striping"><a href="#_1-1-keep-name-section-from-striping" class="header-anchor">#</a> 1.1 Keep name section from striping</h5> <p>The name section has been striped at <a href="https://github.com/paritytech/cargo-contract/blob/71525f9ec5f21e6113a614c2fb4d1eb5e62ebf8b/src/cmd/build.rs#L247" target="_blank" rel="noopener noreferrer">cargo-contract/cmd/build.rs#L247<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h5 id="_1-2-keep-debug-info-from-wasm-opt"><a href="#_1-2-keep-debug-info-from-wasm-opt" class="header-anchor">#</a> 1.2 Keep debug info from <code>wasm-opt</code></h5> <p><code>cargo-contract</code> passes <code>debug_info: false</code> to <code>wasm-opt</code>, so the debug-info will be always optimized when we run <code>wasm-opt</code>, the code is here: <a href="https://github.com/paritytech/cargo-contract/blob/71525f9ec5f21e6113a614c2fb4d1eb5e62ebf8b/src/cmd/build.rs#L267" target="_blank" rel="noopener noreferrer">cargo-contract/cmd/build.rs#L267<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h5 id="_1-3-keep-debug-info-from-rustc"><a href="#_1-3-keep-debug-info-from-rustc" class="header-anchor">#</a> 1.3 Keep debug info from <code>rustc</code></h5> <p><code>cargo-contract</code> executes realease build by default, here we can enable debug build or modify the opt-level flag of <code>rustc</code> to keep debug infos at <a href="https://github.com/paritytech/cargo-contract/blob/71525f9ec5f21e6113a614c2fb4d1eb5e62ebf8b/src/cmd/build.rs#L137" target="_blank" rel="noopener noreferrer">cargo-contract/cmd/build.rs#L137<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h4 id="_2-save-debug-info-from-the-scraper-of-pallet-contracts"><a href="#_2-save-debug-info-from-the-scraper-of-pallet-contracts" class="header-anchor">#</a> 2. Save debug info from the scraper of <code>pallet-contracts</code></h4> <p>What happends to the <code>pallet-contracts</code> while we calling a contract?</p> <ul><li><strong>Get the WASM binary from storage</strong></li> <li><strong>Inject gas meter to the contract</strong></li> <li>Inject stack height to the contract</li> <li>Put the contract into <code>sp-sandbox</code> and execute it</li> <li>Get the result from <code>sp-sandbox</code> and return the result to us</li></ul> <h5 id="_2-1-store-name-section-while-building-wasm-module"><a href="#_2-1-store-name-section-while-building-wasm-module" class="header-anchor">#</a> 2.1 Store name section while building WASM module</h5> <ul><li>PR: https://github.com/paritytech/parity-wasm/pull/300</li></ul> <p><code>pallet-contracts</code> builds WASM modules from storage and drops custom sections by default, here we should get them back.</p> <h5 id="_2-2-update-function-indices-in-name-section-while-injecting-gas-meter"><a href="#_2-2-update-function-indices-in-name-section-while-injecting-gas-meter" class="header-anchor">#</a> 2.2 Update function indices in name section while injecting gas meter</h5> <ul><li>PR: <a href="https://github.com/paritytech/wasm-utils/pull/146" target="_blank" rel="noopener noreferrer">paritytech/wasm-utils#146<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Source: <a href="https://github.com/patractlabs/wasm-utils" target="_blank" rel="noopener noreferrer">patractlabs/wasm-utils#146<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p><code>pallet-contracts</code> reorders the indcies of functions in our WASM contracts after injecting gas memter to the WASM contracts at <a href="https://github.com/paritytech/wasm-utils/blob/d9432bafa9321f8e0e5b8a143f1ed858dbbbe272/src/gas/mod.rs#L467" target="_blank" rel="noopener noreferrer">paritytech/wasm-utils/gas/mod.rs#L467<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, this will mess up the function indecies in name section that we can not get the correct backtraces.</p> <h4 id="_3-impelment-wasm-backtrace-to-wasmi"><a href="#_3-impelment-wasm-backtrace-to-wasmi" class="header-anchor">#</a> 3. Impelment WASM backtrace to WASMI</h4> <ul><li>Source: <a href="https://github.com/patractlabs/wasmi" target="_blank" rel="noopener noreferrer">patractlabs/wasmi<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>Remember the last two steps in chapter 2, the core part of enabling WASM backtrace to pallet-contract is making <code>wasmi</code> support backtrace.</p> <p>The process of executing a function in the interpreter of wasmi is like:</p> <ul><li>Invoke the target function</li> <li>call and call and call over again
<ul><li>Panic if the process breaks.</li></ul></li></ul> <h5 id="_3-1-add-function-info-field-to-funcref"><a href="#_3-1-add-function-info-field-to-funcref" class="header-anchor">#</a> 3.1 Add function info field to <code>FuncRef</code></h5> <p><code>FuncRef</code> is the 'function' wasmi interpreter calling directly, so we need to embed the debug info into the <code>FuncRef</code> as the first time, source at <a href="https://github.com/patractlabs/wasmi/blob/v0.6.2/src/func.rs#L26" target="_blank" rel="noopener noreferrer">wasmi/func.rs#L26<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language- extra-class"><pre class="language-text"><code>//! patractlabs/wasmi/src/func.rs#L26
/// ...
pub struct FuncRef {
    /// ...
    /// Function name and index for debug
    info: Option&lt;(usize, String)&gt;,
}
</code></pre></div><h5 id="_3-2-set-function-info-using-name-section-while-parsing-wasm-modules"><a href="#_3-2-set-function-info-using-name-section-while-parsing-wasm-modules" class="header-anchor">#</a> 3.2 Set function info using name section while parsing WASM modules</h5> <p>We alread have the <code>info</code> field in <code>FuncRef</code>, now we need to fill this field using name setciton while parsing WASM modules, source at <a href="https://github.com/patractlabs/wasmi/blob/7a6feaea70f47aa6e62f097fb0d9a4ea0ce7d1fc/src/runner.rs#L1491" target="_blank" rel="noopener noreferrer">wasmi/module#L343<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language- extra-class"><pre class="language-text"><code>//! wasmi/src/module.rs#L343
// ...
if has_name_section {
     if let Some(name) = function_names.get((index + import_count) as u32) {
         func_instance = func_instance.set_info(index, name.to_string());
     } else {
         func_instance = func_instance.set_info(index, &quot;&lt;unknown&gt;&quot;.to_string());
     }
}
// ...
</code></pre></div><h5 id="_3-3-make-the-interpreter-support-trace"><a href="#_3-3-make-the-interpreter-support-trace" class="header-anchor">#</a> 3.3 Make the interpreter support <code>trace</code></h5> <p>However, we don't need to get infos of every functions but the panicked series in the stack of the interpreter, source at <a href="https://github.com/patractlabs/wasmi/blob/7a6feaea70f47aa6e62f097fb0d9a4ea0ce7d1fc/src/runner.rs#L1491" target="_blank" rel="noopener noreferrer">wasmi/runner.rs#L1491<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language- extra-class"><pre class="language-text"><code>//! wasmi/src/runner.rs#L1491
/// Get the functions of current the stack
pub fn trace(&amp;self) -&gt; Vec&lt;Option&lt;&amp;(usize, String)&gt;&gt; {
    self.buf.iter().map(|f| f.info()).collect::&lt;Vec&lt;_&gt;&gt;()
}
</code></pre></div><h5 id="_3-4-gather-debug-infos-when-program-breaks"><a href="#_3-4-gather-debug-infos-when-program-breaks" class="header-anchor">#</a> 3.4 Gather debug infos when program breaks</h5> <p>Just gather backtraces when we invoke function failed, source at <a href="https://github.com/patractlabs/wasmi/blob/7a6feaea70f47aa6e62f097fb0d9a4ea0ce7d1fc/src/func.rs#L170" target="_blank" rel="noopener noreferrer">wasmi/func.rs#L170<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language- extra-class"><pre class="language-text"><code>//! wasmi/src/func.rs#L170
// ...

let res = interpreter.start_execution(externals);
if let Err(trap) = res {
let mut stack = interpreter
    .trace()
    .iter()
    .map(|n| {
        if let Some(info) = n {
            format!(&quot;{:#}[{}]&quot;, rustc_demangle::demangle(&amp;info.1), info.0)
        } else {
            &quot;&lt;unknown&gt;&quot;.to_string()
        }
    })
    .collect::&lt;Vec&lt;_&gt;&gt;();

// Append the panicing trap
stack.append(&amp;mut trap.wasm_trace().clone());
stack.reverse();

// Embed this info into the trap
Err(trap.set_wasm_trace(stack))

// ...
</code></pre></div><h3 id="合约日志功能"><a href="#合约日志功能" class="header-anchor">#</a> 合约日志功能</h3> <p>在合约调试的过程中需要知道合约执行内部的执行情况以及中间数据，在当前缺乏debug 调试条件的情况下（例如使用gdb进行调试），通过日志打印是最方便的方式。正如在europa v0.2 proposal中提到的，当前<code>pallet-contracts</code>与<code>ink!</code>已经支持了<code>format!</code>+<code>seal_println</code>的方式格式化打印字符串，但是通过这种模式有2个缺陷：</p> <ol><li><code>seal_println</code>的所有打印在节点端为<code>target: runtime</code>且级别<code>DEBUG</code>的日志，但是但开发复杂合约的时候将会打印很多的日志，如果不能通过<code>target</code>以及日志级别来过滤时，那么开发的过程中将会充斥着无关信息的干扰。</li> <li>合约开发者在开发的过程中在需要的时候编写了<code>seal_println</code>，但是在合约发布的时候需要把<code>seal_println</code>全部删除。虽然合约开发者可以自己封装一个条件编译的函数来控制，但是若有工具库已经提供了这样的功能则更加方便。</li></ol> <p>因此europa提供了一个模仿rust的<code>log</code> crete的日志库<a href="https://github.com/patractlabs/ink-log" target="_blank" rel="noopener noreferrer"><code>ink-log</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来解决以上问题，其使用方式与rust中的<code>log</code>完全一致，减少了开发者的学习成本。</p> <p><code>ink-log</code>总体上通过<code>pallet-contracts</code>的<code>ChainExtension</code>实现，约定的的<code>function_id</code>为<code>0xfeffff00</code>，通过结构体<code>LoggerExt</code>在wasm的memory中传递消息。因此这个库分为以下两部分：</p> <ol><li><p><code>ink_log</code>： 在<code>ink-log/contracts</code>目录下，给合约的编写提供<code>info!</code>, <code>debug!</code>, <code>warn!</code>, <code>error!</code>, <code>trace!</code>这几个与rust 的<code>log</code>库一样的宏，且宏的调用方式也与<code>log</code>完全一致。这些宏是对ink端的<code>seal_chain_extensions</code>的包装实现，是<strong>给合约开发者使用的工具库</strong>。例如在合约的<code>Cargo.toml</code>引入了这个库后，可以使用如下方式打印日志：</p> <p>在<code>Cargo.toml</code>中:</p> <div class="language-cargo extra-class"><pre class="language-text"><code>[dependencies]
ink_log = { version = &quot;0.1&quot;, git = &quot;https://github.com/patractlabs/ink-log&quot;, default-features = false, features = [&quot;ink-log-chain-extensions&quot;] }

[features]
default = [&quot;std&quot;]
std = [
	# ...
	&quot;ink_log/std&quot;
]
</code></pre></div><p>在合约中则可以使用如下方式在节点中打印日志：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token namespace">ink_log<span class="token punctuation">::</span></span><span class="token macro property">info!</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span> <span class="token string">&quot;flipper-contract&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;latest value is: {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p><code>runtime_log</code>：在<code>ink-log/runtime</code>目录下，这个库是根据从<code>ChainExtensions</code>传递过来的<code>function_id</code>和<code>LoggerExt</code>结构体的内容，调用<code>frame_support</code>里的<code>debug</code>下的相应日志进行打印。是**给链的开发者准备的<code>ink_log</code>的实现库。**例如链的开发者可以在自己的<code>ChainExtensions</code>中使用：</p> <p>在<code>Cargo.toml</code>中：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token punctuation">[</span>dependencies<span class="token punctuation">]</span>
runtime_log <span class="token operator">=</span> <span class="token punctuation">{</span> version <span class="token operator">=</span> <span class="token string">&quot;0.1&quot;</span><span class="token punctuation">,</span> git <span class="token operator">=</span> <span class="token string">&quot;https://github.com/patractlabs/ink-log&quot;</span><span class="token punctuation">,</span> default<span class="token operator">-</span>features <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>

<span class="token punctuation">[</span>features<span class="token punctuation">]</span>
default <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;std&quot;</span><span class="token punctuation">]</span>
std <span class="token operator">=</span> <span class="token punctuation">[</span>
	# <span class="token punctuation">...</span>
	<span class="token string">&quot;runtime_log/std&quot;</span>
<span class="token punctuation">]</span>
</code></pre></div><p>在<code>ChainExtensions</code>的实现体中：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CustomExt</span><span class="token punctuation">;</span>
<span class="token keyword">impl</span> <span class="token class-name">ChainExtension</span> <span class="token keyword">for</span> <span class="token class-name">CustomExt</span> <span class="token punctuation">{</span>
	<span class="token keyword">fn</span> <span class="token function-definition function">call</span><span class="token operator">&lt;</span><span class="token class-name">E</span><span class="token punctuation">:</span> <span class="token class-name">Ext</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>func_id<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> env<span class="token punctuation">:</span> <span class="token class-name">Environment</span><span class="token operator">&lt;</span><span class="token class-name">E</span><span class="token punctuation">,</span> <span class="token class-name">InitState</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">RetVal</span><span class="token punctuation">,</span> <span class="token class-name">DispatchError</span><span class="token operator">&gt;</span>
	<span class="token keyword">where</span>
		<span class="token operator">&lt;</span><span class="token class-name">E</span><span class="token punctuation">::</span><span class="token class-name">T</span> <span class="token keyword">as</span> <span class="token class-name">SysConfig</span><span class="token operator">&gt;</span><span class="token punctuation">::</span><span class="token class-name">AccountId</span><span class="token punctuation">:</span> <span class="token class-name">UncheckedFrom</span><span class="token operator">&lt;&lt;</span><span class="token class-name">E</span><span class="token punctuation">::</span><span class="token class-name">T</span> <span class="token keyword">as</span> <span class="token class-name">SysConfig</span><span class="token operator">&gt;</span><span class="token punctuation">::</span><span class="token class-name">Hash</span><span class="token operator">&gt;</span> <span class="token operator">+</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span>
        <span class="token keyword">match</span> func_id <span class="token punctuation">{</span>
            <span class="token punctuation">...</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">/* other ChainExtension */</span> <span class="token punctuation">}</span>
            <span class="token number">0xfeffff00</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// TODO add other libs</span>
        		<span class="token namespace">runtime_log<span class="token punctuation">::</span></span><span class="token macro property">logger_ext!</span><span class="token punctuation">(</span>func_id<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span>
		        <span class="token comment">// or use</span>
                <span class="token comment">// LoggerExt::call::&lt;E&gt;(func_id, env)</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">RetVal</span><span class="token punctuation">::</span><span class="token class-name">Converging</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>	
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <p><strong><code>ink_log</code>与<code>runtime_log</code>相对应，因此若合约开发者需要使用<code>ink_log</code>的时候，需要注意调试合约对应的链需要实现了<code>runtime_log</code>。</strong></p> <p>另一方面合约开发者引入<code>ink_log</code>后，需要注意<code>features = [&quot;ink-log-chain-extensions&quot;]</code>，<code>ink_log</code>只有开启了这个feature才会调用<code>seal_chain_extensions</code>与链进行交互。若没有这个features则会使用<code>noop</code>跳过合约打印的过程。</p> <p>因此合约开发者可以通过features控制合约在调试环境和生产环境中打印日志，在调试环境中编译的合约开启<code>&quot;ink-log-chain-extensions&quot;</code>feature，而在生产环境编译的合约去掉这个feature。</p> <h2 id="what-europa-can-do-in-this-version"><a href="#what-europa-can-do-in-this-version" class="header-anchor">#</a> What Europa can do in this version</h2> <h3 id="build"><a href="#build" class="header-anchor">#</a> Build</h3> <p>对于合约的开发者而言，需要准备<code>europa</code>和<code>cargo-contract</code>工具。</p> <h4 id="europa"><a href="#europa" class="header-anchor">#</a> europa</h4> <p>The building process for this project is as same as <a href="https://github.com/paritytech/substrate/" target="_blank" rel="noopener noreferrer">Substrate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>When building finished, current executable file in <code>target</code> directory is named <code>europa</code>.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">git</span> clone --recurse-submodules https://github.com/patractlabs/europa.git
</code></pre></div><h4 id="cargo-contract"><a href="#cargo-contract" class="header-anchor">#</a> cargo-contract</h4> <p>若希望在europa的运行中看到WASM执行的backtrace，必须使用我们提供的<code>cargo-contract</code>版本。因为当前paritytech 仓库下 <a href="https://github.com/paritytech/cargo-contract" target="_blank" rel="noopener noreferrer">cargo-contract<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>编译合约时使用了最高级别的优化等级，且丢弃了WASM中的“name section”部分。上文提到若需要打印wasmi执行合约中的调用栈信息必须要求合约文件具备“name section”的部分，因此使用paritytech提供的<code>cargo-contract</code>不能满足要求。我们在自己的fork的仓库里完成的这个功能，而另一方面我们认为让WASM具备“name section”的功能或许不会只有europa需要，因此我们向源仓库提交了<a href="https://github.com/paritytech/cargo-contract/pull/131" target="_blank" rel="noopener noreferrer">pr#131[Enable debug info with flag in command build] <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>提供了这个功能。</p> <p>在这个pr未合并前，当前只能使用我们（Patract Labs）提供的<code>cargo-contract</code>版本：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>cargo <span class="token function">install</span> --git https://github.com/patractlabs/cargo-contract --branch cmd/debug --force
</code></pre></div><p>如果不希望这个版本的<code>cargo-contract</code>覆盖paritytech发布的版本，那么建议本地编译，并直接使用编译产物<code>cargo-contract</code>：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/patractlabs/cargo-contract --branch cmd/debug
<span class="token builtin class-name">cd</span> cargo-contract
cargo build --release
</code></pre></div><blockquote><p>注：执行<code>cargo-contract build</code>命令需要rust编译链的<code>default toolchain</code>为<code>nightly</code>，否则只能使用<code>cargo +nightly contract build</code>，但是使用<code>cargo</code>调用<code>cargo-contract</code>需要执行<code>cargo install</code>安装或者将编译产物覆盖到<code>~/.cargo/bin</code>目录下，不能和paritytech的<code>cargo-contract</code>共存</p></blockquote> <p>执行</p> <div class="language-bash extra-class"><pre class="language-bash"><code>cargo-contract build --help
<span class="token comment"># or</span>
cargo +nightly contract build --help
</code></pre></div><p>若能看到</p> <div class="language-bash extra-class"><pre class="language-bash"><code>FLAGS:
    -d, --debug      
            Emits debug info into wasm <span class="token function">file</span>
</code></pre></div><p>则表示正在使用Patract Labs提供的<code>cargo-contract</code>，若希望使用europa的过程中能看到WASM合约执行崩溃的backtrace，需要编译合约的时候加上<code>--debug</code>命令。</p> <p>使用<code>--debug</code>命令将会在原本编译合约的<code>target/ink</code>目录中，生成除了正常文件以外的另一个文件，以 <code>*.src.wasm</code>结尾。这个<code>*.src.wasm</code>文件就是含有&quot;name section&quot;部分的WASM合约文件。</p> <p><strong>若需要使用europa做测试，则部署到europa的合约需要使用这个<code>*.src.wasm</code>文件，而不是原本生成的<code>*.wasm</code>文件。</strong></p> <h3 id="example"><a href="#example" class="header-anchor">#</a> example</h3> <p>我们可以使用一个案例和其他已经遇到过的案例来验证europa定位问题的可靠性。</p> <p>在后文中启动europa的方式均使用</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ europa --tmp -lruntime<span class="token operator">=</span>debug
</code></pre></div><p>这种方式每次启动的 europa 都全新的数据。若想保留europa执行的数据，请参考europa 的<a href="https://github.com/patractlabs/europa" target="_blank" rel="noopener noreferrer">README<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>或者europa v0.1的<a href="https://polkadot.polkassembly.io/post/166" target="_blank" rel="noopener noreferrer">报告<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，可以获得更多的命令介绍。</p> <h4 id="案例1-简单案例"><a href="#案例1-简单案例" class="header-anchor">#</a> 案例1：简单案例</h4> <p>例如我们修改<a href="https://github.com/paritytech/ink" target="_blank" rel="noopener noreferrer">ink!<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>项目中的案例合约<code>ink/example/erc20</code>如下：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[ink(message)]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">transfer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> to<span class="token punctuation">:</span> <span class="token class-name">AccountId</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token class-name">Balance</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> from <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">env</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">caller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">transfer_from_to</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span> to<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由于合约编译成WASM后对应的是原文件将宏展开后的代码，因此若想要对比调用栈的错误，需要将原合约的宏展开：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>cargo <span class="token function">install</span> <span class="token function">expand</span>
<span class="token builtin class-name">cd</span> ink/example/erc20
cargo <span class="token function">expand</span> <span class="token operator">&gt;</span> tmp.rs
</code></pre></div><p>通过阅读<code>tmp.rs</code>文件后，我们可以知道WASM执行到<code>transfer</code>函数时需要经过：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>fn call<span class="token punctuation">(</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> u32 
-<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>Erc20 as ::ink_lang::DispatchUsingMode<span class="token operator">&gt;</span>::dispatch_using_mode<span class="token punctuation">(</span><span class="token punctuation">..</span>.<span class="token punctuation">)</span>
-<span class="token operator">&gt;</span> <span class="token operator">&lt;&lt;</span>Erc20 as ::ink_lang::ConstructorDispatcher<span class="token operator">&gt;</span>::Type as ::ink_lang::Execute<span class="token operator">&gt;</span>::execute<span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span>  <span class="token comment"># compile selector at here</span>
-<span class="token operator">&gt;</span> ::ink_lang::execute_message_mut
-<span class="token operator">&gt;</span> move <span class="token operator">|</span>state: <span class="token operator">&amp;</span>mut Erc20<span class="token operator">|</span> <span class="token punctuation">{</span> <span class="token punctuation">..</span>. <span class="token punctuation">}</span> <span class="token comment"># a closure</span>
-<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>__ink_Msg<span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 2644567034usize<span class="token punctuation">]</span><span class="token operator">&gt;</span> as ::ink_lang::MessageMut<span class="token operator">&gt;</span>::CALLABLE
-<span class="token operator">&gt;</span> transfer
</code></pre></div><p>因此若合约调用过程中遇到了<code>transfer</code>中的<code>panic</code>时，WASM的backtrace应该和这个相近。</p> <p>首先我们启动europa:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ europa --tmp -lruntime<span class="token operator">=</span>debug
</code></pre></div><p>然后我们部署这个erc20并调用transfer执行。</p> <p>我们可以使用<a href="https://polkadot.js.org/apps" target="_blank" rel="noopener noreferrer"><code>Polkadot/Substrate Portal</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>或者使用<a href="https://redspot.patract.io/en/tutorial/" target="_blank" rel="noopener noreferrer">RedSpot<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来验证这个过程。假设我们使用<code>RedSpot</code>来执行一次这个错误的ERC20合约的<code>transfer</code>调用，请注意在编译合约的过程中一定需要加上<code>--debug</code>子命令：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ npx redspot-new erc20
$ <span class="token builtin class-name">cd</span> erc20/contracts
<span class="token comment"># add panic in `transfer` function as abrove</span>
$ <span class="token function">vim</span> lib.rs 
<span class="token comment"># notice must add --debug when compile contract</span>
<span class="token comment"># due current cargo-contract is not paritytech, we need to copy compile product into `artifacts` directory. RedSpot would support europa and PatractLabs's cargo-contract in next version.</span>
$ cargo +nightly contract build --debug 
$ <span class="token function">mkdir</span> <span class="token punctuation">..</span>/artifacts
<span class="token comment"># notice must cp erc20.src.wasm, not erc20.wasm</span>
$ <span class="token function">cp</span> ./target/ink/erc20.src.wasm <span class="token punctuation">..</span>/artifacts  
<span class="token comment"># notice must rename metadata.json to erc20.json</span>
$ <span class="token function">cp</span> ./target/ink/metadata.json <span class="token punctuation">..</span>/artifacts/erc20.json 
$ <span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/
<span class="token comment"># enter redspot console, use `--no-compile` to deny recompile contract</span>
$ npx redspot console --no-compile  
<span class="token comment"># in redspot console</span>
Welcome to Node.js v12.16.1.Type <span class="token string">&quot;.help&quot;</span> <span class="token keyword">for</span> <span class="token function">more</span> information.
<span class="token operator">&gt;</span> 
<span class="token operator">&gt;</span> var factory <span class="token operator">=</span> await patract.getContractFactory<span class="token punctuation">(</span><span class="token string">'erc20'</span><span class="token punctuation">)</span>
<span class="token comment"># do following command could deploy the erc20 contract</span>
<span class="token operator">&gt;</span> var contract <span class="token operator">=</span> await factory.deployed<span class="token punctuation">(</span><span class="token string">'new'</span>, <span class="token string">'1000000'</span>, <span class="token punctuation">{</span>value: <span class="token number">20000000000</span>, salt:1<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># do a transfer call directly</span>
<span class="token operator">&gt;</span> await contract.transfer<span class="token punctuation">(</span><span class="token string">&quot;5GcTYx4dPTQfi4udKPvE4VKmbooV7zY6hNYVF9JXHJL4knNF&quot;</span>, <span class="token number">100</span><span class="token punctuation">)</span>
</code></pre></div><p>然后在europa的日志中，可以看到：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">1</span>: NestedRuntime <span class="token punctuation">{</span>
	ext_result: <span class="token punctuation">[</span>failed<span class="token punctuation">]</span> ExecError <span class="token punctuation">{</span> error: DispatchError::Module <span class="token punctuation">{</span>index:5, error:17, message: Some<span class="token punctuation">(</span><span class="token string">&quot;ContractTrapped&quot;</span><span class="token punctuation">)</span>, orign: ErrorOrigin::Caller <span class="token punctuation">}</span><span class="token punctuation">}</span>
    caller: d43593c715fdd31c61141abd04a99fd6822<span class="token punctuation">..</span>.<span class="token punctuation">(</span>5GrwvaEF<span class="token punctuation">..</span>.<span class="token punctuation">)</span>,
    self_account: b6484f58b7b939e93fff7dc10a654af7e<span class="token punctuation">..</span><span class="token punctuation">..</span> <span class="token punctuation">(</span>5GBi41bY<span class="token punctuation">..</span>.<span class="token punctuation">)</span>,
    selector: 0xfae3a09d,
    args: 0x1cbd2d43530a44705ad088af313e18f80b5<span class="token punctuation">..</span><span class="token punctuation">..</span>,
    value: <span class="token number">0</span>,
    gas_limit: <span class="token number">409568000000</span>,
    gas_left: <span class="token number">369902872067</span>,
    env_trace: <span class="token punctuation">[</span>
        seal_value_transferred<span class="token punctuation">(</span>Some<span class="token punctuation">(</span>0x00000000000000000000000000000000<span class="token punctuation">))</span>,
        seal_input<span class="token punctuation">(</span>Some<span class="token punctuation">(</span>0xfae3a09d1cbd<span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token punctuation">))</span>,
        seal_get_storage<span class="token variable"><span class="token punctuation">((</span>Some<span class="token punctuation">(</span><span class="token number">0x0100000000000</span>....<span class="token punctuation">)</span><span class="token punctuation">,</span> Some<span class="token punctuation">(</span><span class="token number">0x010000000100000001000000</span><span class="token punctuation">))</span></span><span class="token punctuation">)</span>,
        <span class="token comment"># ...</span>
        seal_caller<span class="token punctuation">(</span>Some<span class="token punctuation">(</span>0xd43593c715fdd31c61141abd<span class="token punctuation">..</span>.<span class="token punctuation">))</span>,
        seal_hash_blake256<span class="token variable"><span class="token punctuation">((</span>Some<span class="token punctuation">(</span><span class="token number">0x696e6b20686173</span>....<span class="token punctuation">)</span><span class="token punctuation">,</span> Some<span class="token punctuation">(</span><span class="token number">0x0873b31b7a3cf</span>....<span class="token punctuation">))</span></span><span class="token punctuation">)</span>,
      	<span class="token comment"># ...  </span>
        seal_deposit_event<span class="token variable"><span class="token punctuation">((</span>Some<span class="token punctuation">(</span>[<span class="token number">0x45726332303a</span>...<span class="token number">.00000000000</span>]<span class="token punctuation">)</span><span class="token punctuation">,</span> Some<span class="token punctuation">(</span><span class="token number">0x000</span>..<span class="token punctuation">))</span></span><span class="token punctuation">)</span>,
    <span class="token punctuation">]</span>,
	trap_reason: TrapReason::SupervisorError<span class="token punctuation">(</span>DispatchError::Module <span class="token punctuation">{</span> index: <span class="token number">5</span>, error: <span class="token number">17</span>, message: Some<span class="token punctuation">(</span><span class="token string">&quot;ContractTrapped&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>,
    wasm_error: Error::WasmiExecution<span class="token punctuation">(</span>Trap<span class="token punctuation">(</span>Trap <span class="token punctuation">{</span> kind: Unreachable <span class="token punctuation">}</span><span class="token punctuation">))</span>
        wasm backtrace: 
        <span class="token operator">|</span>  core::panicking::panic<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span>
        <span class="token operator">|</span>  erc20::erc20::_::<span class="token operator">&lt;</span>impl erc20::erc20::Erc2<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>::transfer<span class="token punctuation">[</span><span class="token number">1697</span><span class="token punctuation">]</span>
        <span class="token operator">|</span>  <span class="token operator">&lt;</span>erc20::erc20::_::__ink_Msg<span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token number">2644567034</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> as ink_lang::traits::MessageMut<span class="token operator">&gt;</span>::CALLABLE::<span class="token punctuation">{</span><span class="token punctuation">{</span>closure<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token number">611</span><span class="token punctuation">]</span>
        <span class="token operator">|</span>  core::ops::function::FnOnce::call_once<span class="token punctuation">[</span><span class="token number">610</span><span class="token punctuation">]</span>
        <span class="token operator">|</span>  <span class="token operator">&lt;</span>erc20::erc20::_::_::__ink_MessageDispatchEnum as ink_lang::dispatcher::Execute<span class="token operator">&gt;</span>::execute::<span class="token punctuation">{</span><span class="token punctuation">{</span>closure<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token number">1675</span><span class="token punctuation">]</span>
        <span class="token operator">|</span>  ink_lang::dispatcher::execute_message_mut<span class="token punctuation">[</span><span class="token number">1674</span><span class="token punctuation">]</span>
        <span class="token operator">|</span>  <span class="token operator">&lt;</span>erc20::erc20::_::_::__ink_MessageDispatchEnum as ink_lang::dispatcher::Execute<span class="token operator">&gt;</span>::execute<span class="token punctuation">[</span><span class="token number">1692</span><span class="token punctuation">]</span>
        <span class="token operator">|</span>  erc20::erc20::_::<span class="token operator">&lt;</span>impl ink_lang::contract::DispatchUsingMode <span class="token keyword">for</span> erc20::erc20::Erc2<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>::dispatch_using_mode<span class="token punctuation">[</span><span class="token number">1690</span><span class="token punctuation">]</span>
        <span class="token operator">|</span>  call<span class="token punctuation">[</span><span class="token number">1691</span><span class="token punctuation">]</span>
        ╰─<span class="token operator">&gt;</span><span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token number">2387</span><span class="token punctuation">]</span>
    ,
    nest: <span class="token punctuation">[</span><span class="token punctuation">]</span>,
<span class="token punctuation">}</span>
</code></pre></div><p>我们解释一下以上打印的信息：</p> <ol><li><p><code>ext_result</code>：表示这一次合约调用对外显示为执行成功或是失败：</p> <ol><li><code>[success]</code>：表示这次合约执行成功（<em>注意：合约执行成功不代表着合约自身的业务逻辑执行成功，可能在<code>ink!</code>中或者合约自身业务逻辑中存在错误的返回，如后文中的案例3。</em>）而<code>[success]</code>后面跟随的<code>ExecResultValue { flag:0, data: 0x...}</code>表示这次合约执行后的返回值。</li> <li><code>[failed]</code>：表示这次合约执行失败，<code>[failed]</code>后面跟随的<code>ExecError { .. }</code> 表示这次错误的原因。这个原因是链上记录到<code>event</code>里面的值，也就是<code>pallet-contracts</code>的<code>decl_error!</code>中定义的值。</li></ol></li> <li><p><code>1: NestedRuntime</code>&amp;<code>nest</code>：表示当前打印信息的这个合约信息位于合约调用栈的第一层，若当前合约调用了另一个合约，则会在<code>nest</code>字段的数组里出现<code>2： NestedRuntime</code>，<code>1: NestedRuntime</code>里的结构一致。其中<code>2</code>标示这个被调用的合约位于合约调用栈的第二层。在当前合约中跨合约调用了几个合约，那么在<code>nest</code>的数组中就会出现几个<code>NestedRuntime</code>。若在第二层合约中有其他的合约调用，则以此类推。</p> <p>例如如果有合约A，B，C，如果是如下情况：</p> <ol><li><p>A调用了B后，返回到A继续执行，然后又调用了合约C</p> <div class="language-text extra-class"><pre class="language-text"><code>|A|
| |-&gt;|B|
| |&lt;-
| |-&gt;|C|
| |&lt;-
</code></pre></div><p>那么就会产生类似如下的日志打印：</p> <div class="language-text extra-class"><pre class="language-text"><code>1: NestedRuntime {
 self_account: A,
 nest:[
     2: NestedRuntime {
         self_account: B,
         nest:[],
     },
     2: NestedRuntime {
         self_account: C,
         nest:[],
     }
 ]
}
</code></pre></div></li> <li><p>A调用了B后，B又调用了合约C，最后回到A中</p> <div class="language-text extra-class"><pre class="language-text"><code>|A|
| |-&gt;|B|
| |  | |-&gt;|C|
| |  | |&lt;-
| |&lt;-
</code></pre></div><p>那么就会产生类似如下的日志打印：</p> <div class="language-text extra-class"><pre class="language-text"><code>1: NestedRuntime {
 self_account: A,
 nest:[
     2: NestedRuntime {
         self_account: B,
         nest:[
         	3: NestedRuntime {
                self_account: C,
                nest:[],
            }
         ],
     }  
 ]
}
</code></pre></div></li></ol></li> <li><p><code>caller</code>：代表当前合约的调用者是谁。如果是合约调用合约的情况下，被调用的合约的这个值是上一级合约的地址。</p></li> <li><p><code>self_account</code>：代表当前合约自身的地址是多少。</p></li> <li><p><code>selector</code> &amp; <code>args</code>&amp;<code>value</code> ：代表调用当前合约的时候传入的<code>selector</code>和参数，<strong>这些信息可以快速定位调用合约方式是否正确</strong>。</p></li> <li><p><code>gas_limit</code> &amp; <code>gas_left</code>：表示当前调用合约的时候传入的<code>gas_limit</code>和<strong>执行完这一层</strong>后剩余的gas。这里注意<code>gas_left</code>指代的是执行完这一层合约时剩余的gas，因此<strong>在合约调用合约中，通过<code>gas_left</code>可以判断出每一层合约消耗的gas</strong>，而不是只能获取到整个合约执行执行后的消耗。</p></li> <li><p><code>env_trace</code>：表示当前这一层合约执行过程中，合约WASM执行每次调用host_function，就会在这里的数组里面添加一条记录。所有的host_function与<code>pallet-contracts</code>模块中的<a href="https://github.com/paritytech/substrate/blob/master/frame/contracts/src/wasm/runtime.rs#L610" target="_blank" rel="noopener noreferrer"><code>define_env!</code>中的定义<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>相对应，因此跟踪<code>env_trace</code>可以跟踪当前WASM合约执行过程中与<code>pallet-contracts</code>交互的过程。例如如果在<code>env_trace</code>中出现了:</p> <ol><li><p><code>seal_call</code>：代表当前合约中出现了合约调用合约的情况。按照<code>seal_call</code>出现在<code>env_trace</code>的顺序，可以和<code>nest</code>对应起来，推算出合约调用合约的前后状态。</p></li> <li><p><code>seal_get_storage</code>&amp;<code>seal_set_storage</code>：代表合约中出现了数据读写的情况。通过这两个接口，可以截获并统计当前合约执行过程中读写数据，而<strong>通过<code>seal_set_storage</code>统计出来的数据大小，也可以用来推测<code>rent</code>所需要的存储大小。</strong></p></li> <li><p><code>seal_deposit_event</code>：代表合约中出现了打印event的情况。这里可以分别截获每次event的内容，而不是最后得到一个统一的event。并且后文会通过一个例子表面通过europa可以快速定位<code>host_function</code>中出现bug的情况。</p></li></ol> <p>另一方面<code>env_trace</code>的统计是比较<strong>细粒度</strong>的，例如在<code>host_function</code>中会出现多个错误可能的情况，则出现错误时，会将错误之前的信息全部保留，因此可以定位到<code>host_function</code>执行中出现问题的地点。</p> <p>而且若<code>host_function</code>中出现错误导致合约结束执行时，<code>env_trace</code>记录到的是最后一个出错的<code>host_function</code>调用，因此可以直接定位是哪一个<code>host_function</code>导致的合约执行异常。</p></li> <li><p><code>trap_reason</code>：根据<code>pallet-contracts</code>中对于<code>TrapReason</code>的定义，<code>trap_reason</code>可以分为2类：</p> <ol><li><code>Return</code> &amp; <code>Termination</code> &amp; <code>Restoration</code>：表示合约退出是<code>pallet-contracts</code>的设计，并非内部出现错误。这一类Trap表示合约正常执行，并非错误。</li> <li><code>SupervisorError</code>：表示合约调用host_function的执行过程中出现了错误。</li></ol> <p>因此当前europa的日志打印设计为只要出现<code>trap_reason</code>就会记录下来。而另一方面，在合约的执行过程中并非一定会出现<code>trap_reason</code>。结合<code>pallet-contracts</code>以及<code>ink!</code>的设计，存在合约执行成功或者在<code>ink!</code>层中执行失败均不产生<code>trap_reason</code>的情况。因此europa除了记录<code>trap_reason</code>，还<strong>记录了WASM执行器执行后返回的结果，用<code>sandbox_result_ok</code>记录。</strong></p></li> <li><p><code>sandbox_result_ok</code>：<code>sandbox_result_ok</code>的值表示合约在WASM执行器执行后的结果。这个值本可以记录为<code>sandbox_result</code>，包含正确和错误两种情况。但是由于rust的限制，且结合<code>pallet-contracts</code>的业务逻辑，这里只保留<code>sandbox_result</code>为<code>Ok</code>的结果。<strong>对于日志的打印，europa设计为只有当trap_reason是第一种情况时，打印<code>sandbox_result_ok</code>，作为辅助判断合约执行的信息。</strong></p> <p><code>sandbox_result_ok</code>是WASM执行器<a href="https://github.com/paritytech/substrate/blob/712085115cdef4a79a66747338c920d6ba4e479f/frame/contracts/src/wasm/mod.rs#L155-L156" target="_blank" rel="noopener noreferrer">调用了<code>invoke</code>后的结果<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，在经过<code>to_execution_result</code>的处理后，如果没有<code>trap_reason</code>的情况分支中，<code>Ok(..)</code>的结果<a href="https://github.com/paritytech/substrate/blob/712085115cdef4a79a66747338c920d6ba4e479f/frame/contracts/src/wasm/runtime.rs#L366-L368" target="_blank" rel="noopener noreferrer">被丢弃了<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。但实际上这里包含两种情况：</p> <ol><li><code>ink!</code>中出现了错误：根据<code>ink!</code>的实现，在调用合约<code>#[ink(message)]</code>和<code>#[ink(constructor)]</code>包装的函数之前，首先需要对输入的参数进行解码及匹配<code>selector</code>的过程。若在这个过程中出现错误，合约会返回<a href="https://github.com/paritytech/ink/blob/abd5cf14c0883cb2d5acf81f2277aeec330aa843/crates/lang/src/error.rs#L22" target="_blank" rel="noopener noreferrer">错误码<code>DispatchError</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。但是对于WASM执行器而言是正常的执行了WASM代码，因此会返回结果，包含这个错误码。<strong>这个合约执行过程属于错误情况。</strong></li> <li><code>#[ink(message)]</code>的返回值定义为了<code>()</code>：根据<code>ink!</code>的实现，若返回值的类型是<code>()</code>则不会调用<code>seal_reason</code>，因此不会含有<code>trap_reason</code>。<strong>这个合约执行过程属于正确情况。</strong></li></ol> <p>由于<code>ink!</code>只是运行于<code>pallet-contracts</code>的一种合约实现，其他的实现可能有不同的规则，因此当前<code>sandbox_result_ok</code>只用于辅助判定<code>ink!</code>合约的执行情况，值为<a href="https://github.com/paritytech/substrate/blob/712085115cdef4a79a66747338c920d6ba4e479f/primitives/wasm-interface/src/lib.rs#L462-L467" target="_blank" rel="noopener noreferrer"><code>ReturnValue</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。其中若日志的<code>ReturnValue::Value(&lt;num&gt;)</code>的<code>&lt;num&gt;</code>部分不为0时，表示<code>ink!</code>的执行过程可能存在错误，可以根据<code>ink!</code>对于<a href="https://github.com/paritytech/ink/blob/abd5cf14c0883cb2d5acf81f2277aeec330aa843/crates/lang/src/error.rs#L66-L80" target="_blank" rel="noopener noreferrer"><code>DispatchError</code>的错误码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>判定错误。</p></li> <li><p><code>wasm_error</code>：表示的是WASM执行错误时的backtrace。这个部分只有当<code>ext_result</code>为<code>failed</code>的时候才会打印。</p></li></ol> <p>在上面的例子中，由于执行<code>transfer</code>会触发<code>panic</code>，因此可以看到这里导致错误的原因是<code>WasmiExecution(Trap(Trap { kind: Unreachable }))</code>，表示这次的失败是由于执行合约的过程中出现的<code>Unreacble</code>的情况导致，而下方的backtrace信息也<strong>十分准确的描述</strong>了上文讨论过的合约宏展开后遇到错误时的函数执行调用栈。从backtrace中可以明显的发现如下的调用过程。</p> <div class="language-text extra-class"><pre class="language-text"><code>call -&gt; dispatch_using_mode -&gt; ... -&gt; transfer -&gt; panic 
</code></pre></div><p>这个过程与合约的原文信息相符。</p> <h4 id="案例2-定位重复的topic导致的contracttrap"><a href="#案例2-定位重复的topic导致的contracttrap" class="header-anchor">#</a> 案例2：定位重复的topic导致的<code>ContractTrap</code></h4> <p>在前一段时间，我们（Patract Labs）给<code>ink!</code>汇报过一个bug，见issue:<a href="https://github.com/paritytech/ink/issues/589" target="_blank" rel="noopener noreferrer">&quot;When set '0' value in contracts event, may cause <code>Error::ContractTrapped</code> and panic in contract #589&quot;<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。在europa还未开发出相关功能前，定位这个错误十分困难，其中感谢@athei<a href="https://github.com/paritytech/ink/issues/589#issuecomment-731571918" target="_blank" rel="noopener noreferrer">定位到了错误<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。这里我们重现这个错误，并使用europa的日志来快速分析定位到这个bug出现的地方：</p> <ol><li><p>将<code>ink!</code>切换（checkout）到提交<code>8e8fe09565ca6d2fad7701d68ff13f12deda7eed</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> ink
<span class="token function">git</span> checkout 8e8fe09565ca6d2fad7701d68ff13f12deda7eed -b tmp
</code></pre></div></li> <li><p>进入<code>ink/examples/erc20/lib.rs:L90</code>中将<code>Transfer</code>中的<code>value</code>改为<code>0_u128</code></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[ink(constructor)]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>initial_supply<span class="token punctuation">:</span> <span class="token class-name">Balance</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
	<span class="token comment">//...</span>
    <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">env</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit_event</span><span class="token punctuation">(</span><span class="token class-name">Transfer</span> <span class="token punctuation">{</span>
        from<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        to<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// change this from `initial_supply` to `0_u128`</span>
        value<span class="token punctuation">:</span> 0_u128<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// initial_supply,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    instance
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>执行<code>cargo +nightly contract build --debug</code> 编译合约</p></li> <li><p>使用<a href="https://redspot.patract.io/en/tutorial/" target="_blank" rel="noopener noreferrer">RedSpot<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>或者<a href="https://polkadot.js.org/apps" target="_blank" rel="noopener noreferrer"><code>Polkadot/Substrate Portal</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>将这个合约部署出去（注意一定要使用erc20.src.wasm文件）</p></li></ol> <p>在部署阶段应该会遇到<code>DuplicateTopics</code>（在这个<a href="https://github.com/paritytech/substrate/pull/7762" target="_blank" rel="noopener noreferrer">错误<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>修正之前，汇报的错误是<code>ContractTrap</code>），而在europa的日志中会显示：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">1</span>: NestedRuntime <span class="token punctuation">{</span>
    <span class="token comment">#...</span>
    env_trace: <span class="token punctuation">[</span>
        seal_input<span class="token punctuation">(</span>Some<span class="token punctuation">(</span>0xd183512b0<span class="token punctuation">))</span>,
		<span class="token comment">#...    </span>
		seal_deposit_event<span class="token variable"><span class="token punctuation">((</span>Some<span class="token punctuation">(</span>[<span class="token number">0x45726332303a3a5472616e736</span>....]<span class="token punctuation">)</span><span class="token punctuation">,</span> None<span class="token punctuation">))</span></span>,
    <span class="token punctuation">]</span>,
    trap_reason: TrapReason::SupervisorError<span class="token punctuation">(</span>DispatchError::Module <span class="token punctuation">{</span> index: <span class="token number">5</span>, error: <span class="token number">23</span>, message: Some<span class="token punctuation">(</span><span class="token string">&quot;DuplicateTopics&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>,
    wasm_error: Error::WasmiExecution<span class="token punctuation">(</span>Trap<span class="token punctuation">(</span>Trap <span class="token punctuation">{</span> kind: Host<span class="token punctuation">(</span>DummyHostError<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">))</span>
    	wasm backtrace: 
    	<span class="token operator">|</span>  ink_env::engine::on_chain::ext::deposit_event<span class="token punctuation">[</span><span class="token number">1623</span><span class="token punctuation">]</span>
    	<span class="token operator">|</span>  ink_env::engine::on_chain::impls::<span class="token operator">&lt;</span>impl ink_env::backend::TypedEnvBackend <span class="token keyword">for</span> ink_env::engine::on_chain::EnvInstance<span class="token operator">&gt;</span>::emit_event<span class="token punctuation">[</span><span class="token number">1564</span><span class="token punctuation">]</span>
    	<span class="token operator">|</span>  ink_env::api::emit_event::<span class="token punctuation">{</span><span class="token punctuation">{</span>closure<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token number">1563</span><span class="token punctuation">]</span>
    	<span class="token operator">|</span>  <span class="token operator">&lt;</span>ink_env::engine::on_chain::EnvInstance as ink_env::engine::OnInstance<span class="token operator">&gt;</span>::on_instance<span class="token punctuation">[</span><span class="token number">1562</span><span class="token punctuation">]</span>
    	<span class="token operator">|</span>  ink_env::api::emit_event<span class="token punctuation">[</span><span class="token number">1561</span><span class="token punctuation">]</span>
    	<span class="token operator">|</span>  erc20::erc20::_::<span class="token operator">&lt;</span>impl ink_lang::events::EmitEvent<span class="token operator">&lt;</span>erc20::erc20::Erc2<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> <span class="token keyword">for</span> ink_lang::env_access::EnvAccess<span class="token operator">&lt;&lt;</span>erc20::erc20::Erc20 as ink_lang::env_access::ContractEnv<span class="token operator">&gt;</span>::Env<span class="token operator">&gt;&gt;</span>::emit_event<span class="token punctuation">[</span><span class="token number">1685</span><span class="token punctuation">]</span>
<span class="token comment"># ...</span>
<span class="token comment"># ...</span>
    	<span class="token operator">|</span>  deploy<span class="token punctuation">[</span><span class="token number">1691</span><span class="token punctuation">]</span>
    	╰─<span class="token operator">&gt;</span><span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token number">2385</span><span class="token punctuation">]</span>
    ,
    nest: <span class="token punctuation">[</span><span class="token punctuation">]</span>,
<span class="token punctuation">}</span>
</code></pre></div><p>由以上日志可以看到:</p> <ol><li><code>env_trace</code>的最后一条记录是<code>seal_deposit_event</code>而不是<code>seal_return</code>（合约正确执行时最后一条一定是<code>seal_return</code>）</li> <li><code>seal_deposit_event</code>的第二个参数是<code>None</code>，而不是一个存在的值，因此表明<code>seal_deposit_event</code> 这个host_function没有执行完成，而是在执行过程中就出现了错误（可以看europa依赖的forked版本的<code>pallet-contracts</code>源码看到<a href="https://github.com/patractlabs/substrate/blob/3624deb47cabe6f6cd44ec2c49c6ae5a29fd2198/frame/contracts/src/wasm/runtime.rs#L1399" target="_blank" rel="noopener noreferrer">相应的实现方式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li> <li>结合wasm backtrace的错误栈我们可以直观的看到backtrace最上一层调用栈为<code>deposit_event</code>。</li></ol> <p>因此结合以上信息，我们可以直接推测出是<code>seal_deposit_event</code>这个host_function在执行的过程中出现了异常。（在<code>pallet-contracts</code>的提交<a href="https://github.com/paritytech/substrate/pull/7762" target="_blank" rel="noopener noreferrer">pull#7762<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>合并前，我们记录了host_function内的错误信息，合并后我们利用了<code>trap_reason</code>统一的错误信息。）</p> <h4 id="案例3-当链使用了type-balance-u64而不是type-balance-u128造成的错误。"><a href="#案例3-当链使用了type-balance-u64而不是type-balance-u128造成的错误。" class="header-anchor">#</a> 案例3，当链使用了<code>type Balance=u64</code>而不是<code>type Balance=u128</code>造成的错误。</h4> <p>如果链使用了<code>Balance=u64</code>的定义，而对于<code>ink!</code>而言并不知道链关于<code>Balance</code>的定义，默认定义的Balance是<code>u128</code>。因此当使用<code>u128</code>定义<code>Balance</code>的<code>ink!</code>作为依赖编译出的合约，运行在<code>Balance</code>定义为<code>u64</code>的链上时，会造成<code>pallet-contracts</code>模块向合约传值的时候，合约内部将<code>u64</code>的<code>value</code>当做<code>u128</code>解码的错误。</p> <p>以erc20的example合约为例，展开合约的宏后，可以看到：</p> <ul><li><code>dispatch_using_mode</code>阶段解码<code>input</code>出现错误时，合约以<code>::ink_lang::DispatchError::CouldNotReadInput</code>返回，但是<code>pallet-contracts</code>的模型设计认为WASM的合约执行没有异常。</li> <li>而在<code>call</code>的调用时，由于在调用<code>dispatch_using_mode</code>之前首先会检查<code>deny_payment</code>，而检查<code>deny_payment</code>时若返回Error则直接<code>panic</code>。</li></ul> <p>因此对于这种情况下，会出现部署（<code>Instantiate</code>）ERC20的合约执行正常，而调用ERC20的任意方法例如<code>transfer</code>的时候出现<code>ContractTrap</code>。</p> <p>对于这两种情况我们分别来看：</p> <ol><li><p><code>instantiate</code>阶段：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">1</span>: NestedRuntime <span class="token punctuation">{</span>
	ext_result: <span class="token punctuation">[</span>success<span class="token punctuation">]</span> ExecError <span class="token punctuation">{</span> error: DispatchError::Module <span class="token punctuation">{</span>index:5, error:17, message: Some<span class="token punctuation">(</span><span class="token string">&quot;ContractTrapped&quot;</span><span class="token punctuation">)</span>, orign: ErrorOrigin::Caller <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment">#...</span>
    env_trace: <span class="token punctuation">[</span>
        seal_input<span class="token punctuation">(</span>Some<span class="token punctuation">(</span>0xd183512b008cb6611e0100000000000000000000<span class="token punctuation">))</span>,
        seal_caller<span class="token punctuation">(</span>Some<span class="token punctuation">(</span>0xd43593c715fdd31c61141abd04a99fd682<span class="token punctuation">))</span>,
        //<span class="token punctuation">..</span>.
        seal_set_storage<span class="token variable"><span class="token punctuation">((</span>Some<span class="token punctuation">(</span><span class="token number">0x030000000100000</span>...<span class="token punctuation">)</span><span class="token punctuation">,</span> Some<span class="token punctuation">(</span><span class="token number">0x000000000000000</span>...<span class="token punctuation">))</span></span><span class="token punctuation">)</span>,
    <span class="token punctuation">]</span>,
    sandbox_result_ok: RuntimeValue::Value<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>,
    nest: <span class="token punctuation">[</span><span class="token punctuation">]</span>,
<span class="token punctuation">}</span>
</code></pre></div><p>以上日志可以看到</p> <ol><li><p><code>env_trace</code>的最后不以<code>seal_return</code>结尾，则表示合约实际上没有正常执行完成。因为从<code>ink!</code>的设计中可以看到，如果正常进入到<code>#[ink(constructor)]</code>或者进入到<code>#[ink(message)]</code>则表面一定执行到了<code>::ink_lang::execute_message</code>中（<code>::ink_lang::execute_message</code>会调用<code>seal_return</code>），而没有出现<code>seal_return</code>代表没有执行到<code>execute</code>的阶段。</p></li> <li><p><code>sandbox_result_ok</code>表示执行的返回值为<code>7</code>，查询<code>ink!</code>对于<code>DispatchError</code>的实现可以看到这个错误码代表着<code>CouldNotReadInput</code></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token class-name">DispatchError</span><span class="token punctuation">::</span><span class="token class-name">CouldNotReadInput</span> <span class="token operator">=&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">(</span><span class="token number">0x07</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre></div></li> <li><p>根据合约宏展开的代码可以看到在<code>dispatch_using_mode</code>函数中，调用<code>execute</code>之前会调用<code>::ink_env::decode_input</code>，而这个函数存在<code>return Error</code>的情况。因此可以合理猜测是在解析<code>input</code>的时候出现异常。在日志中记录了输入参数<code>args:0x008cb6611e0100000000000000000000</code>，观察这个参数可以发现其长度明显小于<code>u128</code>编码的情况。因此可以根据<code>args</code>和<code>env_trace</code>推测出是解码<code>input</code>的时候发生了错误。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// this part code is expanded by erc20 example.</span>
<span class="token punctuation">::</span><span class="token namespace">ink_env<span class="token punctuation">::</span></span><span class="token function">decode_input</span><span class="token punctuation">::</span><span class="token operator">&lt;&lt;</span><span class="token class-name">Erc20</span> <span class="token keyword">as</span> <span class="token punctuation">::</span><span class="token namespace">ink_lang<span class="token punctuation">::</span></span><span class="token class-name">ConstructorDispatcher</span><span class="token operator">&gt;</span><span class="token punctuation">::</span><span class="token class-name">Type</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">::</span><span class="token namespace">ink_lang<span class="token punctuation">::</span></span><span class="token class-name">DispatchError</span><span class="token punctuation">::</span><span class="token class-name">CouldNotReadInput</span><span class="token punctuation">)</span><span class="token operator">?</span>
</code></pre></div></li></ol> <p>此时合约实例化成功，但是执行实例化的构造函数存在。因此合约存在于链上但是没有正常执行<code>#[ink(constructor)]</code>的过程。</p></li> <li><p><code>call</code>阶段 ，如调用<code>transfer</code>:</p> <p>对以上实例化成功的函数进行调用<code>transfer</code>，会出现<code>ContractTrap</code>，europa的日志显示如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">1</span>: NestedRuntime <span class="token punctuation">{</span>
	ext_result: <span class="token punctuation">[</span>failed<span class="token punctuation">]</span> ExecError <span class="token punctuation">{</span> error: DispatchError::Module <span class="token punctuation">{</span>index:5, error:17, message: Some<span class="token punctuation">(</span><span class="token string">&quot;ContractTrapped&quot;</span><span class="token punctuation">)</span>, orign: ErrorOrigin::Caller <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token comment"># ...</span>
    env_trace: <span class="token punctuation">[</span>
        seal_value_transferred<span class="token punctuation">(</span>Some<span class="token punctuation">(</span>0x0000000000000000<span class="token punctuation">))</span>,
    <span class="token punctuation">]</span>,
    wasm_error: Error::WasmiExecution<span class="token punctuation">(</span>Trap<span class="token punctuation">(</span>Trap <span class="token punctuation">{</span> kind: Unreachable <span class="token punctuation">}</span><span class="token punctuation">))</span>
    	wasm backtrace: 
    	<span class="token operator">|</span>  core::panicking::panic_fmt.60<span class="token punctuation">[</span><span class="token number">1743</span><span class="token punctuation">]</span>
    	<span class="token operator">|</span>  core::result::unwrap_failed<span class="token punctuation">[</span><span class="token number">914</span><span class="token punctuation">]</span>
    	<span class="token operator">|</span>  core::result::Result<span class="token operator">&lt;</span>T,E<span class="token operator">&gt;</span>::expect<span class="token punctuation">[</span><span class="token number">915</span><span class="token punctuation">]</span>
    	<span class="token operator">|</span>  ink_lang::dispatcher::deny_payment<span class="token punctuation">[</span><span class="token number">1664</span><span class="token punctuation">]</span>
    	<span class="token operator">|</span>  call<span class="token punctuation">[</span><span class="token number">1691</span><span class="token punctuation">]</span>
    	╰─<span class="token operator">&gt;</span><span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token number">2387</span><span class="token punctuation">]</span>
    ,
    nest: <span class="token punctuation">[</span><span class="token punctuation">]</span>,
<span class="token punctuation">}</span>
</code></pre></div><p>首先注意到<code>env_trace</code>最后一个记录依然不是<code>seal_return</code>，且<code>wasm_error</code>的错误原因是<code>WasmiExecution::Unreachable</code>。因此可以确定是合约执行过程中遇到了<code>panic</code>或者<code>expect</code>。</p> <p>而从wasm backtrace 中则十分明显的看到了在执行过程为</p></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>   call -<span class="token operator">&gt;</span> deny_payment -<span class="token operator">&gt;</span> <span class="token function">expect</span>
</code></pre></div><p>而根据宏展开的代码（<code>cd ink/examples/erc20; cargo expand &gt; tmp.rs</code>）我们可以看到：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#[no_mangle]</span>
fn call<span class="token punctuation">(</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> u32 <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token boolean">true</span> <span class="token punctuation">{</span>
     ::ink_lang::deny_payment::<span class="token operator">&lt;&lt;</span>Erc20 as ::ink_lang::ContractEnv<span class="token operator">&gt;</span>::Env<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    		.expect<span class="token punctuation">(</span><span class="token string">&quot;caller transferred value even though all ink! message deny payments&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    ::ink_lang::DispatchRetCode::from<span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>Erc20 as ::ink_lang::DispatchUsingMode<span class="token operator">&gt;</span>::dispatch_using_mode<span class="token punctuation">(</span>
            ::ink_lang::DispatchMode::Call,
        <span class="token punctuation">)</span>,
    <span class="token punctuation">)</span>
    .to_u32<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因此可以判定合约执行<code>transfer</code>的过程中在<code>deny_payment</code>返回了错误，而这里对错误直接处理为<code>expect</code>导致了<code>wasmi</code>执行结果为<code>Unreachable</code>。跟踪<code>deny_payment</code>的代码可以发现是该函数返回了<code>Error</code>导致的<code>expect</code></p> <blockquote><p>注，相关代码如下：</p> <p>在<code>ink_lang</code>中https://github.com/paritytech/ink/blob/master/crates/lang/src/dispatcher.rs#L140-L150</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">deny_payment</span><span class="token operator">&lt;</span><span class="token class-name">E</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>
<span class="token keyword">where</span>
    <span class="token class-name">E</span><span class="token punctuation">:</span> <span class="token class-name">Environment</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token keyword">let</span> transferred <span class="token operator">=</span> <span class="token namespace">ink_env<span class="token punctuation">::</span></span><span class="token function">transferred_balance</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">E</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;encountered error while querying transferred balance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> transferred <span class="token operator">!=</span> <span class="token operator">&lt;</span><span class="token class-name">E</span> <span class="token keyword">as</span> <span class="token class-name">Environment</span><span class="token operator">&gt;</span><span class="token punctuation">::</span><span class="token class-name">Balance</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">0u32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">DispatchError</span><span class="token punctuation">::</span><span class="token class-name">PaidUnpayableMessage</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>ink中此处的<code>off_chain</code>部分和<code>on_chain</code>部分会出现差异</strong>，<code>off_chain</code>会认为在<code>ink_env::transferred_balance::&lt;E&gt;()</code>阶段就返回错误，于是在执行<code>transferred_balance</code>中后会遇到<code>expect</code>导致<code>panic</code>，而<code>on_chain</code>部分由于是从wasm的memory中取值，则会正常获取到对应u128长度的字符并解码得到<code>transferred</code>，只是解码的结果不会符合预期，导致<code>transferred!=0</code>让<code>deny_payment</code>返回了Error，而在合约的宏展开调用<code>deny_payment</code>的部分才触发<code>expect</code></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">if</span> <span class="token boolean">true</span> <span class="token punctuation">{</span>
    <span class="token punctuation">::</span><span class="token namespace">ink_lang<span class="token punctuation">::</span></span><span class="token function">deny_payment</span><span class="token punctuation">::</span><span class="token operator">&lt;&lt;</span><span class="token class-name">Erc20</span> <span class="token keyword">as</span> <span class="token punctuation">::</span><span class="token namespace">ink_lang<span class="token punctuation">::</span></span><span class="token class-name">ContractEnv</span><span class="token operator">&gt;</span><span class="token punctuation">::</span><span class="token class-name">Env</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    	<span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;caller transferred value even though all ink! message deny payments&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因此对于wasm backtrace 来说，<code>expect</code>是出现在<code>call</code>中调用<code>deny_payment</code>的时候，而不是<code>deny_payment</code>中调用<code>transferred_balance</code>的时候。</p> <p><strong>这个例子侧面说明<code>ink!</code>当前对于<code>off_chain</code>以及<code>on_chain</code>的处理并不是完全对应的，可能在一些情况下会给合约的使用者造成难以排查的错误</strong></p></blockquote> <h2 id="what-we-have-implemented-for-v0-2"><a href="#what-we-have-implemented-for-v0-2" class="header-anchor">#</a> What we have implemented for v0.2</h2> <p><em>Modify at <code>FRAME Contracts pallet</code> level to provide more information.</em></p> <p>测试用例见：</p></div></section> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/patractlabs/substrate-contracts-book/edit/master/europa/reports/v0.2Report.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2021/7/30上午8:39:08</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/substrate-contracts-book/europa/reports/v0.1Report.html" class="prev">
            Europa v0.1 报告
          </a></span> <span class="next"><a href="/substrate-contracts-book/europa/reports/v0.3Report.html">
            Europa v0.3报告
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/substrate-contracts-book/europa/reports/v0.2Report.html#introduction" class="sidebar-link reco-side-introduction" data-v-70334359>Introduction</a></li><li class="level-3" data-v-70334359><a href="/substrate-contracts-book/europa/reports/v0.2Report.html#summary-of-europa-s-v0-2-plan" class="sidebar-link reco-side-summary-of-europa-s-v0-2-plan" data-v-70334359>Summary of Europa's v0.2 plan:</a></li><li class="level-3" data-v-70334359><a href="/substrate-contracts-book/europa/reports/v0.2Report.html#how-to-verify-v0-2-github-source" class="sidebar-link reco-side-how-to-verify-v0-2-github-source" data-v-70334359>How to verify v0.2:  Github source</a></li><li class="level-2" data-v-70334359><a href="/substrate-contracts-book/europa/reports/v0.2Report.html#design" class="sidebar-link reco-side-design" data-v-70334359>Design</a></li><li class="level-3" data-v-70334359><a href="/substrate-contracts-book/europa/reports/v0.2Report.html#pallet-contracts层" class="sidebar-link reco-side-pallet-contracts层" data-v-70334359>pallet-contracts层</a></li><li class="level-3" data-v-70334359><a href="/substrate-contracts-book/europa/reports/v0.2Report.html#wasmi层" class="sidebar-link reco-side-wasmi层" data-v-70334359>wasmi层</a></li><li class="level-3" data-v-70334359><a href="/substrate-contracts-book/europa/reports/v0.2Report.html#合约日志功能" class="sidebar-link reco-side-合约日志功能" data-v-70334359>合约日志功能</a></li><li class="level-2" data-v-70334359><a href="/substrate-contracts-book/europa/reports/v0.2Report.html#what-europa-can-do-in-this-version" class="sidebar-link reco-side-what-europa-can-do-in-this-version" data-v-70334359>What Europa can do in this version</a></li><li class="level-3" data-v-70334359><a href="/substrate-contracts-book/europa/reports/v0.2Report.html#build" class="sidebar-link reco-side-build" data-v-70334359>Build</a></li><li class="level-3" data-v-70334359><a href="/substrate-contracts-book/europa/reports/v0.2Report.html#example" class="sidebar-link reco-side-example" data-v-70334359>example</a></li><li class="level-2" data-v-70334359><a href="/substrate-contracts-book/europa/reports/v0.2Report.html#what-we-have-implemented-for-v0-2" class="sidebar-link reco-side-what-we-have-implemented-for-v0-2" data-v-70334359>What we have implemented for v0.2</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/substrate-contracts-book/assets/js/app.b3270eae.js" defer></script><script src="/substrate-contracts-book/assets/js/3.7c35afa4.js" defer></script><script src="/substrate-contracts-book/assets/js/1.293685b3.js" defer></script><script src="/substrate-contracts-book/assets/js/140.1bc025aa.js" defer></script>
  </body>
</html>
