<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<title data-react-helmet="true">Europa v0.2 报告 | Substrate Contracts Book</title><meta data-react-helmet="true" property="og:url" content="https://docs.patract.io/substrate-contracts-book/europa/reports/v0.2Report"><meta data-react-helmet="true" name="docusaurus_locale" content="zh"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Europa v0.2 报告 | Substrate Contracts Book"><meta data-react-helmet="true" name="description" content="Patract Hub&#x27;s treasury report for Europa v0.2"><meta data-react-helmet="true" property="og:description" content="Patract Hub&#x27;s treasury report for Europa v0.2"><link data-react-helmet="true" rel="shortcut icon" href="/substrate-contracts-book/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://docs.patract.io/substrate-contracts-book/europa/reports/v0.2Report"><link data-react-helmet="true" rel="alternate" href="https://docs.patract.io/substrate-contracts-book/europa/reports/v0.2Report" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://docs.patract.io/substrate-contracts-book/en/europa/reports/v0.2Report" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.patract.io/substrate-contracts-book/europa/reports/v0.2Report" hreflang="x-default"><link rel="stylesheet" href="/substrate-contracts-book/assets/css/styles.4aa6c65a.css">
<link rel="preload" href="/substrate-contracts-book/assets/js/runtime~main.3945a3a1.js" as="script">
<link rel="preload" href="/substrate-contracts-book/assets/js/main.ee6e64d2.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/substrate-contracts-book/"><img src="/substrate-contracts-book/img/logo.svg" alt="Substrate Contracts Book" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/substrate-contracts-book/img/logo.svg" alt="Substrate Contracts Book" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a href="https://www.patract.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>主页<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://blog.patract.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>博客<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/patractlabs/substrate-contracts-book" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>中文</span></span></a><ul class="dropdown__menu"><li><a href="/substrate-contracts-book/europa/reports/v0.2Report" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">中文</a></li><li><a href="/substrate-contracts-book/en/europa/reports/v0.2Report" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li></ul></div><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/substrate-contracts-book/">Summary</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#">介绍</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/contracts/introduction">Substrate 合约书</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/contracts/overview">合约综述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/contracts/model">合约模型</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/contracts/language">合约语言</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/contracts/wasm_first_step">Wasm简要介绍</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">ink!</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">ask!</a></li><li class="menu__list-item"><a class="menu__link" href="/substrate-contracts-book/solang/introduction">Solang</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Redspot</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Europa</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/introduction">introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/tutorial">Europa教程</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/execution_info">Europa 合约执行日志分析</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/sample">Europa 调试示例</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/wasm_executor">Europa Wasm executor</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/wasm_backtrace">Europa 的Wasm Backtrace</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Reports</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/reports">Europa议会提案报告</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/reports/v0.1Report">Europa v0.1 报告</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/substrate-contracts-book/europa/reports/v0.2Report">Europa v0.2 报告</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/reports/v0.3Report">Europa v0.3报告</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">zkMega</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Himalia</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Metis</a></li><li class="menu__list-item"><a class="menu__link" href="/substrate-contracts-book/carpo/introduction">Carpo</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Elara</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Jupiter</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">PatraStore</a></li><li class="menu__list-item"><a class="menu__link" href="/substrate-contracts-book/patract/introduction">Patract</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">Europa v0.2 报告</h1></header><p>Patract Hub&#x27;s treasury report for Europa v0.2</p><p>Patract Hub (<a href="https://patract.io" target="_blank" rel="noopener noreferrer">https://patract.io</a>) develops local open source toolkits and one-stop cloud smart IDE, committed to provide free development toolkits and infrastructure services for the entire smart contract ecosystem. Six weeks ago, we applied a <a href="https://polkadot.polkassembly.io/motion/48" target="_blank" rel="noopener noreferrer">treasury proposal</a> for Europa v0.2 , and now we have finished the development (<a href="https://github.com/patractlabs/europa" target="_blank" rel="noopener noreferrer">https://github.com/patractlabs/europa</a>) . This repost shows what Europa v0.2 completion.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h2><p>Europa is kind of another implementation for <a href="https://github.com/paritytech/substrate/tree/master/client" target="_blank" rel="noopener noreferrer">Substrate client</a> in our design. We know that the runtime of a blockchain is the business logic that defines its behavior, and the Substrate runtime need to run by an executor and environment. So that we design the executor and environment more like a &quot;sandbox&quot; to run a Substrate runtime.</p><p>In v0.2, the primary target is to modify <code>FRAME Contracts pallet</code> in runtime to provide more detailed debugging information, including contract execution process information (in <code>FRAME Contracts</code> layer) and WASM execution information (in WASMI execution layer).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="summary-of-europas-v02-plan"></a>Summary of Europa&#x27;s v0.2 plan:<a class="hash-link" href="#summary-of-europas-v02-plan" title="Direct link to heading">#</a></h3><blockquote><ol><li><em>Modify at <code>FRAME Contracts pallet</code> level to provide more information.</em></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="how-to-verify-v02--github-source"></a>How to verify v0.2:  Github source<a class="hash-link" href="#how-to-verify-v02--github-source" title="Direct link to heading">#</a></h3><ul><li>Construct incorrect contracts and execute logs printing to determine whether it meets expectations</li><li>Display the call statistics of the <code>define_env!</code> interface during contract execution</li><li>Execute the log printing function, provide formatted printing examples of different data, and judge whether it meets expectations</li><li>Construct a contract that crashes under different conditions and record the log after execution. Then judge whether the backtrace information of the contract execution is completely printed, and check whether it matches the actual execution of the collapsed contract.</li></ul></blockquote><p>后文统一称<code>FRAME Contracts pallet</code>为<code>pallet-contracts</code>。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="design"></a>Design<a class="hash-link" href="#design" title="Direct link to heading">#</a></h2><p>在0.2中，对于合约模块的调试信息功能的提升分为三个部分的修改：</p><ul><li><code>pallet-contracts</code>层的修改：在<code>pallet-contracts</code>的执行合约的过程中添加trace记录在合约层中的信息，并且记录合约的调用层级。另一方面完善了调用wasm执行的错误信息。</li><li><code>wasmi</code>层的修改：给予<code>wasmi</code>提供了记录wasm执行中的backtrace功能，并且给<code>parity-wasm</code>，<code>pwasm-utils</code>，<code>cargo-contract</code>提供了支持在合约的wasm处理中包含name section的功能。</li><li>合约日志功能：使用<code>ChainExtensions</code>的功能实现了合约中打印<code>log</code>日志的库。</li></ul><p>当前在<code>pallet-contracts</code>中，在<code>wasmi</code>中执行出现错误以及wasmi执行过程中调用<code>pallet-contracts</code>的<a href="https://webassembly.github.io/spec/core/exec/runtime.html#function-instances" target="_blank" rel="noopener noreferrer">host_function</a>出现错误的时候，对外都表现为<code>ContractTrap</code>。这个情况对于开发者很难定位错误出现的原因，仅从这个信息无法分辨出出现问题的地方是合约自身，<code>ink!</code>，还是<code>pallet-contracts</code>。因此这个版本的europa提供的丰富的信息，能让开发者直接定位到出现问题的原因上。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="pallet-contracts层"></a><code>pallet-contracts</code>层<a class="hash-link" href="#pallet-contracts层" title="Direct link to heading">#</a></h3><p>europa认为在合约调试过程需要：</p><ol><li>丰富错误信息：wasm记录整个执行过程中出现错误信息的情况，包含wasm执行器的错误以及host_function的错误。wasmi的backtrace信息会和这里的错误信息统一起来。</li><li>调试过程中的执行情况：<code>pallet-contracts</code>的主要修改信息，以“合约栈”为记录合约调用合约的过程，以及当前这一层合约在执行过程中任何能辅助调试的信息，例如调用host_function的情况，selector，调用合约的参数等等。</li></ol><p>因此针对这样的需求，europa做了如下设计与修改：</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="丰富错误信息"></a>丰富错误信息<a class="hash-link" href="#丰富错误信息" title="Direct link to heading">#</a></h4><ol><li><p>wasm执行器层的错误：</p><p>europa设计了自己的<code>ep-sandbox</code>替换了原本<code>pallet-contracts</code>使用的<code>sp-sandbox</code>，并修改<code>ep_sandbox::Error</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">use patract_wasmi::Error as WasmiError;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub enum Error {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Module(WasmiError),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    OutOfBounds,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Execution,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WasmiExecution(WasmiError),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>Module(WasmiError)</code>携带wasm层的原始错误信息，并且在 <code>frame/contracts/src/wasm/runtime.rs </code>中的 <code>to_execution_result</code>转换为 <code>String</code>抛出错误信息。</p><p>europa自己的<code>ep-sandbox</code>只有<code>std</code>版本（因为europa已经移除了所有的WASM的部分，不需要<code>ep-sandbox</code>支持<code>no-std</code>），因此在将来，<strong><code>ep-sandbox</code>可以替换为不同的wasm执行器，以支持不同wasm执行器的运行测试及替换为支持debug的wasm执行器等特性。</strong></p><p>当前<code>ep-sandbox</code>使用的是一个forked版本的<code>wasmi</code>作为执行器，因此其抛出的错误为<code>WasmiError</code>。对于<code>wasmi</code>的错误改动见下一个章节。</p></li><li><p>host_function的错误</p><p>host函数执行错误会引起Trap，并且会记录<code>TrapReason</code>。对数据结构不进行修改，只需要记录即可。</p></li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="调试过程中的执行情况"></a>调试过程中的执行情况<a class="hash-link" href="#调试过程中的执行情况" title="Direct link to heading">#</a></h4><p>europa forked 版本的<code>pallet-contracts</code>设计了一个对象记录合约执行中任何可以帮助调试的信息：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// Record the contract execution context.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct NestedRuntime {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Current depth</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    depth: usize,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The current contract execute result</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ext_result: ExecResult,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The value in sandbox successful result</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    sandbox_result_ok: Option&lt;ReturnValue&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Who call the current contract</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    caller: AccountId32,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The account of the current contract</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    self_account: Option&lt;AccountId32&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The input selector</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    selector: Option&lt;HexVec&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The input arguments</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    args: Option&lt;HexVec&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The value in call or the endowment in instantiate</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    value: u128,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The gas limit when this contract is called</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    gas_limit: Gas,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The gas left when this contract return</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    gas_left: Gas,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The host function call stack</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    env_trace: EnvTraceList,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The error in wasm</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    wasm_error: Option&lt;WasmErrorWrapper&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The trap in host function execution</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    trap_reason: Option&lt;TrapReason&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Nested contract execution context</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    nest: Vec&lt;NestedRuntime&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>在<code>pallet-contracts</code>的模型中，合约调用合约是以“合约栈”的模型调用，因此<code>NestedRuntime</code>会跟踪整个合约栈的执行过程，并用<code>nest</code>这个属性保存一个<code>NestedRuntime</code>列表表示当前合约中调用过的其他合约。</p><p>在<code>pallet-contracts</code>执行一个合约的过程中，europa以旁路的形态将执行过程中的相关信息记录在<code>NestedRuntime</code>这个结构体中，并在合约调用结束后将<code>NestedRuntime</code>以一定格式化的形式打印到日志中（将后文案例的展示）。合约的开发人员可以通过分析<code>NestedRuntime</code>打印的信息，得到此次合约执行过程中的各种详细信息，可以用于多种情况：</p><ol><li>辅助定位错误出现的具体位置，包括以下情况：<ol><li><code>pallet-contracts</code>层，</li><li><code>ink!</code>层</li><li>合约层中的具体位置</li><li>在合约调用合约的情况下定位合约出现在哪一级合约中</li></ol></li><li>分析此时合约执行过程中信息：<ol><li>分析gas执行的消耗情况</li><li>分析<code>get_storage</code>，<code>set_storage</code>调用的情况，帮助重构合约代码以及分析<code>rent</code>的需求情况</li><li>根据<code>selector</code>，<code>args</code>和<code>value</code>分析定位第三方sdk组建交易参数是否合法。</li><li>根据<code>nest</code>信息并结合<code>seal_call</code>信息分析合约调合约的执行路径。</li><li>等等...</li></ol></li></ol><p>在<code>pallet-contracts</code>模块中记录到<code>NestEdRuntime</code>中的过程是比较细粒度的，以<code>define_env!</code>中的<code>seal_call</code>为例：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct SealCall {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    callee: Option&lt;HexVec&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    gas: u64,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    value: Option&lt;u128&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    input: Option&lt;HexVec&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    output: Option&lt;HexVec&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>其中的属性基本为<code>Option&lt;&gt;</code>，比如当调用合约前时会设置<code>input</code>为<code>Some</code>，调用合约正常后有返回值，则会设置<code>output</code>，如调用合约出现错误后，则<code>output</code>会保持<code>None</code>。因此若出现了<code>input</code>是<code>Some</code>而<code>output</code>为<code>None</code>的情况，则说明在合约调用合约的过程中，被调用的合约出现了问题。</p><p>当前<code>NestedRuntime</code>的信息只在日志中打印，<strong>将来<code>NestedRuntime</code>将会做本地化存储并提供相应的rpc供外部访问获取</strong>。因此在将来第三方应用可以获取<code>NestedRuntime</code>做进一步的处理，例如在Redspot中可以设计一个插件根据<code>NestedRuntime</code>的信息生成一个合约调用合约的拓扑图，在web钱包界面可以生成可视化合约调用路径等等。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="wasmi层"></a><code>wasmi</code>层<a class="hash-link" href="#wasmi层" title="Direct link to heading">#</a></h3><p>我们fork了wasmi，并将这个forked版本的wasmi集成到了<code>ep-sandbox</code>中。而forked <code>pallet-contracts</code>可以通过<code>ep-sandbox</code>获取到forked <code>wasmi</code>的错误信息，包含<code>wasmi</code>的backtrace信息。</p><p>如果需要让<code>wasmi</code>具备能够保留执行的backtrace的信息，需要具备以下几点：</p><ol><li>WASM源文件中需要有&quot;name section&quot;段 （name section 的规范见 <a href="https://webassembly.github.io/spec/core/appendix/custom.html#name-section" target="_blank" rel="noopener noreferrer">“Name Section”</a>）</li><li>在<code>pallet-contracts</code>检查合约的过程中保留“name section”信息且在处理过程后仍和wasm源文件具备对应关系。</li><li><code>wasmi</code>的执行过程中需要把执行栈保留下来并附带函数的关键信息，同时&quot;name section&quot;需要被解析，且和<code>wasmi</code>执行栈保留的函数信息对应起来。</li></ol><p>对于2的改动，涉及<code>cargo-build</code>，<code>parity-wasm</code>，而对于1，3的改动主要位于forked 的<code>wasmi</code>中，少部分涉及<code>pwasm-utils</code>。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="1-submitted-wasm-files-contains-debug-info-提交的wasm源文件中有name-section提供debug-info"></a>1. Submitted WASM files contains debug info 提交的WASM源文件中有“name section”提供debug info<a class="hash-link" href="#1-submitted-wasm-files-contains-debug-info-提交的wasm源文件中有name-section提供debug-info" title="Direct link to heading">#</a></h4><ul><li>PR: <a href="https://github.com/paritytech/cargo-contract/pull/131" target="_blank" rel="noopener noreferrer">paritytech/cargo-contract#131</a></li><li>Source: <a href="https://github.com/patractlabs/cargo-contract" target="_blank" rel="noopener noreferrer">patractlabs/cargo-contract</a></li></ul><p>Frist of all, we have to submit <strong>wasm files which contain the debug info</strong> that the on-chain side can parse and get the panic errors.</p><p>Currently, <a href="https://github.com/patractlabs/cargo-contract" target="_blank" rel="noopener noreferrer">parity/cargo-contract</a> trims debug info while building contracts, we can get them back with the following steps.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="11-keep-name-section-from-striping"></a>1.1 Keep name section from striping<a class="hash-link" href="#11-keep-name-section-from-striping" title="Direct link to heading">#</a></h5><p>The name section has been striped at <a href="https://github.com/paritytech/cargo-contract/blob/71525f9ec5f21e6113a614c2fb4d1eb5e62ebf8b/src/cmd/build.rs#L247" target="_blank" rel="noopener noreferrer">cargo-contract/cmd/build.rs#L247</a>.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="12-keep-debug-info-from-wasm-opt"></a>1.2 Keep debug info from <code>wasm-opt</code><a class="hash-link" href="#12-keep-debug-info-from-wasm-opt" title="Direct link to heading">#</a></h5><p><code>cargo-contract</code> passes <code>debug_info: false</code> to <code>wasm-opt</code>, so the debug-info will be always optimized when we run <code>wasm-opt</code>, the code is here: <a href="https://github.com/paritytech/cargo-contract/blob/71525f9ec5f21e6113a614c2fb4d1eb5e62ebf8b/src/cmd/build.rs#L267" target="_blank" rel="noopener noreferrer">cargo-contract/cmd/build.rs#L267</a>.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="13-keep-debug-info-from-rustc"></a>1.3 Keep debug info from <code>rustc</code><a class="hash-link" href="#13-keep-debug-info-from-rustc" title="Direct link to heading">#</a></h5><p><code>cargo-contract</code> executes realease build by default, here we can enable debug build or modify the opt-level flag of <code>rustc</code> to keep debug infos at <a href="https://github.com/paritytech/cargo-contract/blob/71525f9ec5f21e6113a614c2fb4d1eb5e62ebf8b/src/cmd/build.rs#L137" target="_blank" rel="noopener noreferrer">cargo-contract/cmd/build.rs#L137</a>.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2-save-debug-info-from-the-scraper-of-pallet-contracts"></a>2. Save debug info from the scraper of <code>pallet-contracts</code><a class="hash-link" href="#2-save-debug-info-from-the-scraper-of-pallet-contracts" title="Direct link to heading">#</a></h4><p>What happends to the <code>pallet-contracts</code> while we calling a contract?</p><ul><li><strong>Get the WASM binary from storage</strong></li><li><strong>Inject gas meter to the contract</strong></li><li>Inject stack height to the contract</li><li>Put the contract into <code>sp-sandbox</code> and execute it</li><li>Get the result from <code>sp-sandbox</code> and return the result to us</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="21-store-name-section-while-building-wasm-module"></a>2.1 Store name section while building WASM module<a class="hash-link" href="#21-store-name-section-while-building-wasm-module" title="Direct link to heading">#</a></h5><ul><li>PR: <a href="https://github.com/paritytech/parity-wasm/pull/300" target="_blank" rel="noopener noreferrer">https://github.com/paritytech/parity-wasm/pull/300</a></li></ul><p><code>pallet-contracts</code> builds WASM modules from storage and drops custom sections by default, here we should get them back.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="22-update-function-indices-in-name-section-while-injecting-gas-meter"></a>2.2 Update function indices in name section while injecting gas meter<a class="hash-link" href="#22-update-function-indices-in-name-section-while-injecting-gas-meter" title="Direct link to heading">#</a></h5><ul><li>PR: <a href="https://github.com/paritytech/wasm-utils/pull/146" target="_blank" rel="noopener noreferrer">paritytech/wasm-utils#146</a></li><li>Source: <a href="https://github.com/patractlabs/wasm-utils" target="_blank" rel="noopener noreferrer">patractlabs/wasm-utils#146</a></li></ul><p><code>pallet-contracts</code> reorders the indcies of functions in our WASM contracts after injecting gas memter to the WASM contracts at <a href="https://github.com/paritytech/wasm-utils/blob/d9432bafa9321f8e0e5b8a143f1ed858dbbbe272/src/gas/mod.rs#L467" target="_blank" rel="noopener noreferrer">paritytech/wasm-utils/gas/mod.rs#L467</a>, this will mess up the function indecies in name section that we can not get the correct backtraces.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="3-impelment-wasm-backtrace-to-wasmi"></a>3. Impelment WASM backtrace to WASMI<a class="hash-link" href="#3-impelment-wasm-backtrace-to-wasmi" title="Direct link to heading">#</a></h4><ul><li>Source: <a href="https://github.com/patractlabs/wasmi" target="_blank" rel="noopener noreferrer">patractlabs/wasmi</a></li></ul><p>Remember the last two steps in chapter 2, the core part of enabling WASM backtrace to pallet-contract is making <code>wasmi</code> support backtrace.</p><p>The process of executing a function in the interpreter of wasmi is like:</p><ul><li>Invoke the target function</li><li>call and call and call over again<ul><li>Panic if the process breaks.</li></ul></li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="31-add-function-info-field-to-funcref"></a>3.1 Add function info field to <code>FuncRef</code><a class="hash-link" href="#31-add-function-info-field-to-funcref" title="Direct link to heading">#</a></h5><p><code>FuncRef</code> is the &#x27;function&#x27; wasmi interpreter calling directly, so we need to embed the debug info into the <code>FuncRef</code> as the first time, source at <a href="https://github.com/patractlabs/wasmi/blob/v0.6.2/src/func.rs#L26" target="_blank" rel="noopener noreferrer">wasmi/func.rs#L26</a>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">//! patractlabs/wasmi/src/func.rs#L26</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct FuncRef {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Function name and index for debug</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    info: Option&lt;(usize, String)&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="32-set-function-info-using-name-section-while-parsing-wasm-modules"></a>3.2 Set function info using name section while parsing WASM modules<a class="hash-link" href="#32-set-function-info-using-name-section-while-parsing-wasm-modules" title="Direct link to heading">#</a></h5><p>We alread have the <code>info</code> field in <code>FuncRef</code>, now we need to fill this field using name setciton while parsing WASM modules, source at <a href="https://github.com/patractlabs/wasmi/blob/7a6feaea70f47aa6e62f097fb0d9a4ea0ce7d1fc/src/runner.rs#L1491" target="_blank" rel="noopener noreferrer">wasmi/module#L343</a>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">//! wasmi/src/module.rs#L343</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if has_name_section {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     if let Some(name) = function_names.get((index + import_count) as u32) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         func_instance = func_instance.set_info(index, name.to_string());</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     } else {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         func_instance = func_instance.set_info(index, &quot;&lt;unknown&gt;&quot;.to_string());</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// ...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="33-make-the-interpreter-support-trace"></a>3.3 Make the interpreter support <code>trace</code><a class="hash-link" href="#33-make-the-interpreter-support-trace" title="Direct link to heading">#</a></h5><p>However, we don&#x27;t need to get infos of every functions but the panicked series in the stack of the interpreter, source at <a href="https://github.com/patractlabs/wasmi/blob/7a6feaea70f47aa6e62f097fb0d9a4ea0ce7d1fc/src/runner.rs#L1491" target="_blank" rel="noopener noreferrer">wasmi/runner.rs#L1491</a>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">//! wasmi/src/runner.rs#L1491</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// Get the functions of current the stack</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn trace(&amp;self) -&gt; Vec&lt;Option&lt;&amp;(usize, String)&gt;&gt; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    self.buf.iter().map(|f| f.info()).collect::&lt;Vec&lt;_&gt;&gt;()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="34-gather-debug-infos-when-program-breaks"></a>3.4 Gather debug infos when program breaks<a class="hash-link" href="#34-gather-debug-infos-when-program-breaks" title="Direct link to heading">#</a></h5><p>Just gather backtraces when we invoke function failed, source at <a href="https://github.com/patractlabs/wasmi/blob/7a6feaea70f47aa6e62f097fb0d9a4ea0ce7d1fc/src/func.rs#L170" target="_blank" rel="noopener noreferrer">wasmi/func.rs#L170</a>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">//! wasmi/src/func.rs#L170</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">let res = interpreter.start_execution(externals);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if let Err(trap) = res {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">let mut stack = interpreter</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    .trace()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    .iter()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    .map(|n| {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        if let Some(info) = n {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            format!(&quot;{:#}[{}]&quot;, rustc_demangle::demangle(&amp;info.1), info.0)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;&lt;unknown&gt;&quot;.to_string()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    })</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    .collect::&lt;Vec&lt;_&gt;&gt;();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Append the panicing trap</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">stack.append(&amp;mut trap.wasm_trace().clone());</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">stack.reverse();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Embed this info into the trap</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Err(trap.set_wasm_trace(stack))</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// ...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="合约日志功能"></a>合约日志功能<a class="hash-link" href="#合约日志功能" title="Direct link to heading">#</a></h3><p>在合约调试的过程中需要知道合约执行内部的执行情况以及中间数据，在当前缺乏debug 调试条件的情况下（例如使用gdb进行调试），通过日志打印是最方便的方式。正如在europa v0.2 proposal中提到的，当前<code>pallet-contracts</code>与<code>ink!</code>已经支持了<code>format!</code>+<code>seal_println</code>的方式格式化打印字符串，但是通过这种模式有2个缺陷：</p><ol><li><code>seal_println</code>的所有打印在节点端为<code>target: runtime</code>且级别<code>DEBUG</code>的日志，但是但开发复杂合约的时候将会打印很多的日志，如果不能通过<code>target</code>以及日志级别来过滤时，那么开发的过程中将会充斥着无关信息的干扰。</li><li>合约开发者在开发的过程中在需要的时候编写了<code>seal_println</code>，但是在合约发布的时候需要把<code>seal_println</code>全部删除。虽然合约开发者可以自己封装一个条件编译的函数来控制，但是若有工具库已经提供了这样的功能则更加方便。</li></ol><p>因此europa提供了一个模仿rust的<code>log</code> crete的日志库<a href="https://github.com/patractlabs/ink-log" target="_blank" rel="noopener noreferrer"><code>ink-log</code></a>来解决以上问题，其使用方式与rust中的<code>log</code>完全一致，减少了开发者的学习成本。</p><p><code>ink-log</code>总体上通过<code>pallet-contracts</code>的<code>ChainExtension</code>实现，约定的的<code>function_id</code>为<code>0xfeffff00</code>，通过结构体<code>LoggerExt</code>在wasm的memory中传递消息。因此这个库分为以下两部分：</p><ol><li><p><code>ink_log</code>： 在<code>ink-log/contracts</code>目录下，给合约的编写提供<code>info!</code>, <code>debug!</code>, <code>warn!</code>, <code>error!</code>, <code>trace!</code>这几个与rust 的<code>log</code>库一样的宏，且宏的调用方式也与<code>log</code>完全一致。这些宏是对ink端的<code>seal_chain_extensions</code>的包装实现，是<strong>给合约开发者使用的工具库</strong>。例如在合约的<code>Cargo.toml</code>引入了这个库后，可以使用如下方式打印日志：</p><p>在<code>Cargo.toml</code>中:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cargo"><pre tabindex="0" class="prism-code language-cargo codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[dependencies]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ink_log = { version = &quot;0.1&quot;, git = &quot;https://github.com/patractlabs/ink-log&quot;, default-features = false, features = [&quot;ink-log-chain-extensions&quot;] }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[features]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">default = [&quot;std&quot;]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">std = [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;ink_log/std&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>在合约中则可以使用如下方式在节点中打印日志：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">ink_log::info!(target: &quot;flipper-contract&quot;, &quot;latest value is: {}&quot;, self.value);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p><code>runtime_log</code>：在<code>ink-log/runtime</code>目录下，这个库是根据从<code>ChainExtensions</code>传递过来的<code>function_id</code>和<code>LoggerExt</code>结构体的内容，调用<code>frame_support</code>里的<code>debug</code>下的相应日志进行打印。是<strong>给链的开发者准备的<code>ink_log</code>的实现库。</strong>例如链的开发者可以在自己的<code>ChainExtensions</code>中使用：</p><p>在<code>Cargo.toml</code>中：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[dependencies]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">runtime_log = { version = &quot;0.1&quot;, git = &quot;https://github.com/patractlabs/ink-log&quot;, default-features = false }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[features]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">default = [&quot;std&quot;]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">std = [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;runtime_log/std&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>在<code>ChainExtensions</code>的实现体中：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct CustomExt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">impl ChainExtension for CustomExt {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    fn call&lt;E: Ext&gt;(func_id: u32, env: Environment&lt;E, InitState&gt;) -&gt; Result&lt;RetVal, DispatchError&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    where</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &lt;E::T as SysConfig&gt;::AccountId: UncheckedFrom&lt;&lt;E::T as SysConfig&gt;::Hash&gt; + AsRef&lt;[u8]&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        match func_id {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            ... =&gt; {/* other ChainExtension */ }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            0xfeffff00 =&gt; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                // TODO add other libs</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                runtime_log::logger_ext!(func_id, env);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                // or use</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                // LoggerExt::call::&lt;E&gt;(func_id, env)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                Ok(RetVal::Converging(0))</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }   </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ol><p><strong><code>ink_log</code>与<code>runtime_log</code>相对应，因此若合约开发者需要使用<code>ink_log</code>的时候，需要注意调试合约对应的链需要实现了<code>runtime_log</code>。</strong></p><p>另一方面合约开发者引入<code>ink_log</code>后，需要注意<code>features = [&quot;ink-log-chain-extensions&quot;]</code>，<code>ink_log</code>只有开启了这个feature才会调用<code>seal_chain_extensions</code>与链进行交互。若没有这个features则会使用<code>noop</code>跳过合约打印的过程。</p><p>因此合约开发者可以通过features控制合约在调试环境和生产环境中打印日志，在调试环境中编译的合约开启<code>&quot;ink-log-chain-extensions&quot;</code>feature，而在生产环境编译的合约去掉这个feature。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="what-europa-can-do-in-this-version"></a>What Europa can do in this version<a class="hash-link" href="#what-europa-can-do-in-this-version" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="build"></a>Build<a class="hash-link" href="#build" title="Direct link to heading">#</a></h3><p>对于合约的开发者而言，需要准备<code>europa</code>和<code>cargo-contract</code>工具。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="europa"></a>europa<a class="hash-link" href="#europa" title="Direct link to heading">#</a></h4><p>The building process for this project is as same as <a href="https://github.com/paritytech/substrate/" target="_blank" rel="noopener noreferrer">Substrate</a>.</p><p>When building finished, current executable file in <code>target</code> directory is named <code>europa</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> clone --recurse-submodules https://github.com/patractlabs/europa.git</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="cargo-contract"></a>cargo-contract<a class="hash-link" href="#cargo-contract" title="Direct link to heading">#</a></h4><p>若希望在europa的运行中看到WASM执行的backtrace，必须使用我们提供的<code>cargo-contract</code>版本。因为当前paritytech 仓库下 <a href="https://github.com/paritytech/cargo-contract" target="_blank" rel="noopener noreferrer">cargo-contract</a>编译合约时使用了最高级别的优化等级，且丢弃了WASM中的“name section”部分。上文提到若需要打印wasmi执行合约中的调用栈信息必须要求合约文件具备“name section”的部分，因此使用paritytech提供的<code>cargo-contract</code>不能满足要求。我们在自己的fork的仓库里完成的这个功能，而另一方面我们认为让WASM具备“name section”的功能或许不会只有europa需要，因此我们向源仓库提交了<a href="https://github.com/paritytech/cargo-contract/pull/131" target="_blank" rel="noopener noreferrer">pr#131[Enable debug info with flag in command build] </a>提供了这个功能。</p><p>在这个pr未合并前，当前只能使用我们（Patract Labs）提供的<code>cargo-contract</code>版本：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cargo </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> --git https://github.com/patractlabs/cargo-contract --branch cmd/debug --force</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>如果不希望这个版本的<code>cargo-contract</code>覆盖paritytech发布的版本，那么建议本地编译，并直接使用编译产物<code>cargo-contract</code>：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> clone https://github.com/patractlabs/cargo-contract --branch cmd/debug</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> cargo-contract</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cargo build --release</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><blockquote><p>注：执行<code>cargo-contract build </code>命令需要rust编译链的<code>default toolchain</code>为<code>nightly</code>，否则只能使用<code>cargo +nightly contract build</code>，但是使用<code>cargo</code>调用<code>cargo-contract</code>需要执行<code>cargo install</code>安装或者将编译产物覆盖到<code>~/.cargo/bin</code>目录下，不能和paritytech的<code>cargo-contract</code>共存</p></blockquote><p>执行</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cargo-contract build --help</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># or</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cargo +nightly contract build --help</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>若能看到</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">FLAGS:</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -d, --debug      </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Emits debug info into wasm </span><span class="token function" style="color:rgb(130, 170, 255)">file</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>则表示正在使用Patract Labs提供的<code>cargo-contract</code>，若希望使用europa的过程中能看到WASM合约执行崩溃的backtrace，需要编译合约的时候加上<code>--debug</code>命令。</p><p>使用<code>--debug</code>命令将会在原本编译合约的<code>target/ink</code>目录中，生成除了正常文件以外的另一个文件，以 <code>*.src.wasm</code>结尾。这个<code>*.src.wasm</code>文件就是含有&quot;name section&quot;部分的WASM合约文件。</p><p><strong>若需要使用europa做测试，则部署到europa的合约需要使用这个<code>*.src.wasm</code>文件，而不是原本生成的<code>*.wasm</code>文件。</strong></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="example"></a>example<a class="hash-link" href="#example" title="Direct link to heading">#</a></h3><p>我们可以使用一个案例和其他已经遇到过的案例来验证europa定位问题的可靠性。</p><p>在后文中启动europa的方式均使用</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ europa --tmp -lruntime</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">debug</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>这种方式每次启动的 europa 都全新的数据。若想保留europa执行的数据，请参考europa 的<a href="https://github.com/patractlabs/europa" target="_blank" rel="noopener noreferrer">README</a>或者europa v0.1的<a href="https://polkadot.polkassembly.io/post/166" target="_blank" rel="noopener noreferrer">报告</a>，可以获得更多的命令介绍。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="案例1：简单案例"></a>案例1：简单案例<a class="hash-link" href="#案例1：简单案例" title="Direct link to heading">#</a></h4><p>例如我们修改<a href="https://github.com/paritytech/ink" target="_blank" rel="noopener noreferrer">ink!</a>项目中的案例合约<code>ink/example/erc20</code>如下：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[ink(message)]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn transfer(&amp;mut self, to: AccountId, value: Balance) -&gt; Result&lt;()&gt; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let from = self.env().caller();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    self.transfer_from_to(from, to, value)?;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    panic!(&quot;123&quot;);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(())</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>由于合约编译成WASM后对应的是原文件将宏展开后的代码，因此若想要对比调用栈的错误，需要将原合约的宏展开：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cargo </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">expand</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> ink/example/erc20</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cargo </span><span class="token function" style="color:rgb(130, 170, 255)">expand</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> tmp.rs</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>通过阅读<code>tmp.rs</code>文件后，我们可以知道WASM执行到<code>transfer</code>函数时需要经过：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn call</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> -</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> u32 </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">Erc20 as ::ink_lang::DispatchUsingMode</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::dispatch_using_mode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;</span><span class="token plain">Erc20 as ::ink_lang::ConstructorDispatcher</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::Type as ::ink_lang::Execute</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::execute</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># compile selector at here</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> ::ink_lang::execute_message_mut</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> move </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">state: </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">mut Erc20</span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">. </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># a closure</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">__ink_Msg</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> 2644567034usize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> as ::ink_lang::MessageMut</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::CALLABLE</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> transfer</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>因此若合约调用过程中遇到了<code>transfer</code>中的<code>panic</code>时，WASM的backtrace应该和这个相近。</p><p>首先我们启动europa:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ europa --tmp -lruntime</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">debug</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>然后我们部署这个erc20并调用transfer执行。</p><p>我们可以使用<a href="https://polkadot.js.org/apps" target="_blank" rel="noopener noreferrer"><code>Polkadot/Substrate Portal</code></a>或者使用<a href="https://redspot.patract.io/en/tutorial/" target="_blank" rel="noopener noreferrer">RedSpot</a>来验证这个过程。假设我们使用<code>RedSpot</code>来执行一次这个错误的ERC20合约的<code>transfer</code>调用，请注意在编译合约的过程中一定需要加上<code>--debug</code>子命令：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ npx redspot-new erc20</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> erc20/contracts</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># add panic in `transfer` function as abrove</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token function" style="color:rgb(130, 170, 255)">vim</span><span class="token plain"> lib.rs </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># notice must add --debug when compile contract</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># due current cargo-contract is not paritytech, we need to copy compile product into `artifacts` directory. RedSpot would support europa and PatractLabs&#x27;s cargo-contract in next version.</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ cargo +nightly contract build --debug </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token function" style="color:rgb(130, 170, 255)">mkdir</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">/artifacts</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># notice must cp erc20.src.wasm, not erc20.wasm</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token function" style="color:rgb(130, 170, 255)">cp</span><span class="token plain"> ./target/ink/erc20.src.wasm </span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">/artifacts  </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># notice must rename metadata.json to erc20.json</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token function" style="color:rgb(130, 170, 255)">cp</span><span class="token plain"> ./target/ink/metadata.json </span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">/artifacts/erc20.json </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">/</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># enter redspot console, use `--no-compile` to deny recompile contract</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ npx redspot console --no-compile  </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># in redspot console</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Welcome to Node.js v12.16.1.Type </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;.help&quot;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">more</span><span class="token plain"> information.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> var factory </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> await patract.getContractFactory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;erc20&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># do following command could deploy the erc20 contract</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> var contract </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> await factory.deployed</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;new&#x27;</span><span class="token plain">, </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;1000000&#x27;</span><span class="token plain">, </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">value: </span><span class="token number" style="color:rgb(247, 140, 108)">20000000000</span><span class="token plain">, salt:1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># do a transfer call directly</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> await contract.transfer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;5GcTYx4dPTQfi4udKPvE4VKmbooV7zY6hNYVF9JXHJL4knNF&quot;</span><span class="token plain">, </span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>然后在europa的日志中，可以看到：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">: NestedRuntime </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ext_result: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">failed</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> ExecError </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> error: DispatchError::Module </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">index:5, error:17, message: Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ContractTrapped&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">, orign: ErrorOrigin::Caller </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    caller: d43593c715fdd31c61141abd04a99fd6822</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">5GrwvaEF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    self_account: b6484f58b7b939e93fff7dc10a654af7e</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">5GBi41bY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    selector: 0xfae3a09d,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    args: 0x1cbd2d43530a44705ad088af313e18f80b5</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    value: </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    gas_limit: </span><span class="token number" style="color:rgb(247, 140, 108)">409568000000</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    gas_left: </span><span class="token number" style="color:rgb(247, 140, 108)">369902872067</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    env_trace: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_value_transferred</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">0x00000000000000000000000000000000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_input</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">0xfae3a09d1cbd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_get_storage</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">((</span><span class="token variable" style="color:rgb(191, 199, 213)">Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x0100000000000</span><span class="token variable" style="color:rgb(191, 199, 213)">....</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token variable" style="color:rgb(191, 199, 213)"> Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x010000000100000001000000</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_caller</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">0xd43593c715fdd31c61141abd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_hash_blake256</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">((</span><span class="token variable" style="color:rgb(191, 199, 213)">Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x696e6b20686173</span><span class="token variable" style="color:rgb(191, 199, 213)">....</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token variable" style="color:rgb(191, 199, 213)"> Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x0873b31b7a3cf</span><span class="token variable" style="color:rgb(191, 199, 213)">....</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...  </span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_deposit_event</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">((</span><span class="token variable" style="color:rgb(191, 199, 213)">Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable" style="color:rgb(191, 199, 213)">[</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x45726332303a</span><span class="token variable" style="color:rgb(191, 199, 213)">...</span><span class="token variable number" style="color:rgb(247, 140, 108)">.00000000000</span><span class="token variable" style="color:rgb(191, 199, 213)">]</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token variable" style="color:rgb(191, 199, 213)"> Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x000</span><span class="token variable" style="color:rgb(191, 199, 213)">..</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    trap_reason: TrapReason::SupervisorError</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">DispatchError::Module </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> index: </span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token plain">, error: </span><span class="token number" style="color:rgb(247, 140, 108)">17</span><span class="token plain">, message: Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ContractTrapped&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    wasm_error: Error::WasmiExecution</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Trap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Trap </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> kind: Unreachable </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        wasm backtrace: </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  core::panicking::panic</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">28</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  erc20::erc20::_::</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">impl erc20::erc20::Erc2</span><span class="token operator file-descriptor important" style="color:rgb(137, 221, 255)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::transfer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1697</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">erc20::erc20::_::__ink_Msg</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2644567034</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> as ink_lang::traits::MessageMut</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::CALLABLE::</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">closure</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">611</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  core::ops::function::FnOnce::call_once</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">610</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">erc20::erc20::_::_::__ink_MessageDispatchEnum as ink_lang::dispatcher::Execute</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::execute::</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">closure</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1675</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  ink_lang::dispatcher::execute_message_mut</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1674</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">erc20::erc20::_::_::__ink_MessageDispatchEnum as ink_lang::dispatcher::Execute</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::execute</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1692</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  erc20::erc20::_::</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">impl ink_lang::contract::DispatchUsingMode </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> erc20::erc20::Erc2</span><span class="token operator file-descriptor important" style="color:rgb(137, 221, 255)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::dispatch_using_mode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1690</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  call</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1691</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        ╰─</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">unknown</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2387</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    nest: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>我们解释一下以上打印的信息：</p><ol><li><p><code>ext_result</code>：表示这一次合约调用对外显示为执行成功或是失败：</p><ol><li><code>[success]</code>：表示这次合约执行成功（<em>注意：合约执行成功不代表着合约自身的业务逻辑执行成功，可能在<code>ink!</code>中或者合约自身业务逻辑中存在错误的返回，如后文中的案例3。</em>）而<code>[success]</code>后面跟随的<code>ExecResultValue { flag:0, data: 0x...}</code>表示这次合约执行后的返回值。</li><li><code>[failed]</code>：表示这次合约执行失败，<code>[failed]</code>后面跟随的<code>ExecError { .. }</code> 表示这次错误的原因。这个原因是链上记录到<code>event</code>里面的值，也就是<code>pallet-contracts</code>的<code>decl_error!</code>中定义的值。</li></ol></li><li><p><code>1: NestedRuntime </code>&amp;<code>nest</code>：表示当前打印信息的这个合约信息位于合约调用栈的第一层，若当前合约调用了另一个合约，则会在<code>nest</code>字段的数组里出现<code>2： NestedRuntime</code>，<code>1: NestedRuntime </code>里的结构一致。其中<code>2</code>标示这个被调用的合约位于合约调用栈的第二层。在当前合约中跨合约调用了几个合约，那么在<code>nest</code>的数组中就会出现几个<code>NestedRuntime</code>。若在第二层合约中有其他的合约调用，则以此类推。</p><p>例如如果有合约A，B，C，如果是如下情况：</p><ol><li><p>A调用了B后，返回到A继续执行，然后又调用了合约C</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">|A|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| |-&gt;|B|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| |&lt;-</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| |-&gt;|C|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| |&lt;-</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>那么就会产生类似如下的日志打印：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">1: NestedRuntime {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> self_account: A,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> nest:[</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     2: NestedRuntime {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         self_account: B,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         nest:[],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     },</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     2: NestedRuntime {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         self_account: C,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         nest:[],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> ]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>A调用了B后，B又调用了合约C，最后回到A中</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">|A|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| |-&gt;|B|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| |  | |-&gt;|C|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| |  | |&lt;-</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| |&lt;-</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>那么就会产生类似如下的日志打印：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">1: NestedRuntime {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> self_account: A,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> nest:[</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     2: NestedRuntime {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         self_account: B,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         nest:[</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            3: NestedRuntime {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                self_account: C,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                nest:[],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         ],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     }  </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> ]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ol></li><li><p><code>caller</code>：代表当前合约的调用者是谁。如果是合约调用合约的情况下，被调用的合约的这个值是上一级合约的地址。</p></li><li><p><code>self_account</code>：代表当前合约自身的地址是多少。</p></li><li><p><code>selector</code> &amp; <code>args</code>&amp;<code>value</code> ：代表调用当前合约的时候传入的<code>selector</code>和参数，<strong>这些信息可以快速定位调用合约方式是否正确</strong>。</p></li><li><p><code>gas_limit</code> &amp; <code>gas_left</code>：表示当前调用合约的时候传入的<code>gas_limit</code>和<strong>执行完这一层</strong>后剩余的gas。这里注意<code>gas_left</code>指代的是执行完这一层合约时剩余的gas，因此<strong>在合约调用合约中，通过<code>gas_left</code>可以判断出每一层合约消耗的gas</strong>，而不是只能获取到整个合约执行执行后的消耗。</p></li><li><p><code>env_trace</code>：表示当前这一层合约执行过程中，合约WASM执行每次调用host_function，就会在这里的数组里面添加一条记录。所有的host_function与<code>pallet-contracts</code>模块中的<a href="https://github.com/paritytech/substrate/blob/master/frame/contracts/src/wasm/runtime.rs#L610" target="_blank" rel="noopener noreferrer"><code>define_env!</code>中的定义</a>相对应，因此跟踪<code>env_trace</code>可以跟踪当前WASM合约执行过程中与<code>pallet-contracts</code>交互的过程。例如如果在<code>env_trace</code>中出现了:</p><ol><li><p><code>seal_call</code>：代表当前合约中出现了合约调用合约的情况。按照<code>seal_call</code>出现在<code>env_trace</code>的顺序，可以和<code>nest</code>对应起来，推算出合约调用合约的前后状态。</p></li><li><p><code>seal_get_storage</code>&amp;<code>seal_set_storage</code>：代表合约中出现了数据读写的情况。通过这两个接口，可以截获并统计当前合约执行过程中读写数据，而<strong>通过<code>seal_set_storage</code>统计出来的数据大小，也可以用来推测<code>rent</code>所需要的存储大小。</strong></p></li><li><p><code>seal_deposit_event</code>：代表合约中出现了打印event的情况。这里可以分别截获每次event的内容，而不是最后得到一个统一的event。并且后文会通过一个例子表面通过europa可以快速定位<code>host_function</code>中出现bug的情况。</p></li></ol><p>另一方面<code>env_trace</code>的统计是比较<strong>细粒度</strong>的，例如在<code>host_function</code>中会出现多个错误可能的情况，则出现错误时，会将错误之前的信息全部保留，因此可以定位到<code>host_function</code>执行中出现问题的地点。</p><p>而且若<code>host_function</code>中出现错误导致合约结束执行时，<code>env_trace</code>记录到的是最后一个出错的<code>host_function</code>调用，因此可以直接定位是哪一个<code>host_function</code>导致的合约执行异常。</p></li><li><p><code>trap_reason</code>：根据<code>pallet-contracts</code>中对于<code>TrapReason</code>的定义，<code>trap_reason</code>可以分为2类：</p><ol><li><code>Return</code> &amp; <code>Termination</code> &amp; <code>Restoration</code>：表示合约退出是<code>pallet-contracts</code>的设计，并非内部出现错误。这一类Trap表示合约正常执行，并非错误。</li><li><code>SupervisorError</code>：表示合约调用host_function的执行过程中出现了错误。</li></ol><p>因此当前europa的日志打印设计为只要出现<code>trap_reason</code>就会记录下来。而另一方面，在合约的执行过程中并非一定会出现<code>trap_reason</code>。结合<code>pallet-contracts</code>以及<code>ink!</code>的设计，存在合约执行成功或者在<code>ink!</code>层中执行失败均不产生<code>trap_reason</code>的情况。因此europa除了记录<code>trap_reason</code>，还<strong>记录了WASM执行器执行后返回的结果，用<code>sandbox_result_ok</code>记录。</strong></p></li><li><p><code>sandbox_result_ok</code>：<code>sandbox_result_ok</code>的值表示合约在WASM执行器执行后的结果。这个值本可以记录为<code>sandbox_result</code>，包含正确和错误两种情况。但是由于rust的限制，且结合<code>pallet-contracts</code>的业务逻辑，这里只保留<code>sandbox_result</code>为<code>Ok</code>的结果。<strong>对于日志的打印，europa设计为只有当trap_reason是第一种情况时，打印<code>sandbox_result_ok</code>，作为辅助判断合约执行的信息。</strong></p><p><code>sandbox_result_ok</code>是WASM执行器<a href="https://github.com/paritytech/substrate/blob/712085115cdef4a79a66747338c920d6ba4e479f/frame/contracts/src/wasm/mod.rs#L155-L156" target="_blank" rel="noopener noreferrer">调用了<code>invoke</code>后的结果</a>，在经过<code>to_execution_result</code>的处理后，如果没有<code>trap_reason</code>的情况分支中，<code>Ok(..)</code>的结果<a href="https://github.com/paritytech/substrate/blob/712085115cdef4a79a66747338c920d6ba4e479f/frame/contracts/src/wasm/runtime.rs#L366-L368" target="_blank" rel="noopener noreferrer">被丢弃了</a>。但实际上这里包含两种情况：</p><ol><li><code>ink!</code>中出现了错误：根据<code>ink!</code>的实现，在调用合约<code>#[ink(message)]</code>和<code>#[ink(constructor)]</code>包装的函数之前，首先需要对输入的参数进行解码及匹配<code>selector</code>的过程。若在这个过程中出现错误，合约会返回<a href="https://github.com/paritytech/ink/blob/abd5cf14c0883cb2d5acf81f2277aeec330aa843/crates/lang/src/error.rs#L22" target="_blank" rel="noopener noreferrer">错误码<code>DispatchError</code></a>。但是对于WASM执行器而言是正常的执行了WASM代码，因此会返回结果，包含这个错误码。<strong>这个合约执行过程属于错误情况。</strong></li><li><code>#[ink(message)]</code>的返回值定义为了<code>()</code>：根据<code>ink!</code>的实现，若返回值的类型是<code>()</code>则不会调用<code>seal_reason</code>，因此不会含有<code>trap_reason</code>。<strong>这个合约执行过程属于正确情况。</strong></li></ol><p>由于<code>ink!</code>只是运行于<code>pallet-contracts</code>的一种合约实现，其他的实现可能有不同的规则，因此当前<code>sandbox_result_ok</code>只用于辅助判定<code>ink!</code>合约的执行情况，值为<a href="https://github.com/paritytech/substrate/blob/712085115cdef4a79a66747338c920d6ba4e479f/primitives/wasm-interface/src/lib.rs#L462-L467" target="_blank" rel="noopener noreferrer"><code>ReturnValue</code></a>。其中若日志的<code>ReturnValue::Value(&lt;num&gt;)</code>的<code>&lt;num&gt;</code>部分不为0时，表示<code>ink!</code>的执行过程可能存在错误，可以根据<code>ink!</code>对于<a href="https://github.com/paritytech/ink/blob/abd5cf14c0883cb2d5acf81f2277aeec330aa843/crates/lang/src/error.rs#L66-L80" target="_blank" rel="noopener noreferrer"><code>DispatchError</code>的错误码</a>判定错误。</p></li><li><p><code>wasm_error</code>：表示的是WASM执行错误时的backtrace。这个部分只有当<code>ext_result</code>为<code>failed</code>的时候才会打印。</p><p>在上面的例子中，由于执行<code>transfer</code>会触发<code>panic</code>，因此可以看到这里导致错误的原因是<code>WasmiExecution(Trap(Trap { kind: Unreachable }))</code>，表示这次的失败是由于执行合约的过程中出现的<code>Unreacble</code>的情况导致，而下方的backtrace信息也<strong>十分准确的描述</strong>了上文讨论过的合约宏展开后遇到错误时的函数执行调用栈。从backtrace中可以明显的发现如下的调用过程。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">call -&gt; dispatch_using_mode -&gt; ... -&gt; transfer -&gt; panic </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>这个过程与合约的原文信息相符。</p></li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="案例2：定位重复的topic导致的contracttrap"></a>案例2：定位重复的topic导致的<code>ContractTrap</code><a class="hash-link" href="#案例2：定位重复的topic导致的contracttrap" title="Direct link to heading">#</a></h4><p>在前一段时间，我们（Patract Labs）给<code>ink!</code>汇报过一个bug，见issue:<a href="https://github.com/paritytech/ink/issues/589" target="_blank" rel="noopener noreferrer">&quot;When set &#x27;0&#x27; value in contracts event, may cause <code>Error::ContractTrapped</code> and panic in contract #589&quot;</a>。在europa还未开发出相关功能前，定位这个错误十分困难，其中感谢@athei<a href="https://github.com/paritytech/ink/issues/589#issuecomment-731571918" target="_blank" rel="noopener noreferrer">定位到了错误</a>。这里我们重现这个错误，并使用europa的日志来快速分析定位到这个bug出现的地方：</p><ol><li><p>将<code>ink!</code>切换（checkout）到提交<code>8e8fe09565ca6d2fad7701d68ff13f12deda7eed</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> ink</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> checkout 8e8fe09565ca6d2fad7701d68ff13f12deda7eed -b tmp</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>进入<code>ink/examples/erc20/lib.rs:L90</code>中将<code>Transfer</code>中的<code>value</code>改为<code>0_u128</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[ink(constructor)]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn new(initial_supply: Balance) -&gt; Self {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    //...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Self::env().emit_event(Transfer {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        from: None,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        to: Some(caller),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // change this from `initial_supply` to `0_u128`</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        value: 0_u128.into() // initial_supply,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    instance</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>执行<code>cargo +nightly contract build --debug</code> 编译合约</p></li><li><p>使用<a href="https://redspot.patract.io/en/tutorial/" target="_blank" rel="noopener noreferrer">RedSpot</a>或者<a href="https://polkadot.js.org/apps" target="_blank" rel="noopener noreferrer"><code>Polkadot/Substrate Portal</code></a>将这个合约部署出去（注意一定要使用erc20.src.wasm文件）</p></li></ol><p>在部署阶段应该会遇到<code>DuplicateTopics</code>（在这个<a href="https://github.com/paritytech/substrate/pull/7762" target="_blank" rel="noopener noreferrer">错误</a>修正之前，汇报的错误是<code>ContractTrap</code>），而在europa的日志中会显示：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">: NestedRuntime </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#...</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    env_trace: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_input</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">0xd183512b0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#...    </span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_deposit_event</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">((</span><span class="token variable" style="color:rgb(191, 199, 213)">Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable" style="color:rgb(191, 199, 213)">[</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x45726332303a3a5472616e736</span><span class="token variable" style="color:rgb(191, 199, 213)">....]</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token variable" style="color:rgb(191, 199, 213)"> None</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    trap_reason: TrapReason::SupervisorError</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">DispatchError::Module </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> index: </span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token plain">, error: </span><span class="token number" style="color:rgb(247, 140, 108)">23</span><span class="token plain">, message: Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;DuplicateTopics&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    wasm_error: Error::WasmiExecution</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Trap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Trap </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> kind: Host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">DummyHostError</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        wasm backtrace: </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  ink_env::engine::on_chain::ext::deposit_event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1623</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  ink_env::engine::on_chain::impls::</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">impl ink_env::backend::TypedEnvBackend </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> ink_env::engine::on_chain::EnvInstance</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::emit_event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1564</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  ink_env::api::emit_event::</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">closure</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1563</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">ink_env::engine::on_chain::EnvInstance as ink_env::engine::OnInstance</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::on_instance</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1562</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  ink_env::api::emit_event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1561</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  erc20::erc20::_::</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">impl ink_lang::events::EmitEvent</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">erc20::erc20::Erc2</span><span class="token operator file-descriptor important" style="color:rgb(137, 221, 255)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> ink_lang::env_access::EnvAccess</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;</span><span class="token plain">erc20::erc20::Erc20 as ink_lang::env_access::ContractEnv</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::Env</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;&gt;</span><span class="token plain">::emit_event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1685</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  deploy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1691</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        ╰─</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">unknown</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2385</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    nest: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>由以上日志可以看到:</p><ol><li><code>env_trace</code>的最后一条记录是<code>seal_deposit_event</code>而不是<code>seal_return</code>（合约正确执行时最后一条一定是<code>seal_return</code>）</li><li><code>seal_deposit_event</code>的第二个参数是<code>None</code>，而不是一个存在的值，因此表明<code>seal_deposit_event</code> 这个host_function没有执行完成，而是在执行过程中就出现了错误（可以看europa依赖的forked版本的<code>pallet-contracts</code>源码看到<a href="https://github.com/patractlabs/substrate/blob/3624deb47cabe6f6cd44ec2c49c6ae5a29fd2198/frame/contracts/src/wasm/runtime.rs#L1399" target="_blank" rel="noopener noreferrer">相应的实现方式</a>）。</li><li>结合wasm backtrace的错误栈我们可以直观的看到backtrace最上一层调用栈为<code>deposit_event</code>。</li></ol><p>因此结合以上信息，我们可以直接推测出是<code>seal_deposit_event</code>这个host_function在执行的过程中出现了异常。（在<code>pallet-contracts</code>的提交<a href="https://github.com/paritytech/substrate/pull/7762" target="_blank" rel="noopener noreferrer">pull#7762</a>合并前，我们记录了host_function内的错误信息，合并后我们利用了<code>trap_reason</code>统一的错误信息。）</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="案例3，当链使用了type-balanceu64而不是type-balanceu128造成的错误。"></a>案例3，当链使用了<code>type Balance=u64</code>而不是<code>type Balance=u128</code>造成的错误。<a class="hash-link" href="#案例3，当链使用了type-balanceu64而不是type-balanceu128造成的错误。" title="Direct link to heading">#</a></h4><p>如果链使用了<code>Balance=u64</code>的定义，而对于<code>ink!</code>而言并不知道链关于<code>Balance</code>的定义，默认定义的Balance是<code>u128</code>。因此当使用<code>u128</code>定义<code>Balance</code>的<code>ink!</code>作为依赖编译出的合约，运行在<code>Balance</code>定义为<code>u64</code>的链上时，会造成<code>pallet-contracts</code>模块向合约传值的时候，合约内部将<code>u64</code>的<code>value</code>当做<code>u128</code>解码的错误。</p><p>以erc20的example合约为例，展开合约的宏后，可以看到：</p><ul><li><code>dispatch_using_mode</code>阶段解码<code>input</code>出现错误时，合约以<code>::ink_lang::DispatchError::CouldNotReadInput</code>返回，但是<code>pallet-contracts</code>的模型设计认为WASM的合约执行没有异常。</li><li>而在<code>call</code>的调用时，由于在调用<code>dispatch_using_mode</code>之前首先会检查<code>deny_payment</code>，而检查<code>deny_payment</code>时若返回Error则直接<code>panic</code>。</li></ul><p>因此对于这种情况下，会出现部署（<code>Instantiate</code>）ERC20的合约执行正常，而调用ERC20的任意方法例如<code>transfer</code>的时候出现<code>ContractTrap</code>。</p><p>对于这两种情况我们分别来看：</p><ol><li><p><code>instantiate</code>阶段：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">: NestedRuntime </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ext_result: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">success</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> ExecError </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> error: DispatchError::Module </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">index:5, error:17, message: Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ContractTrapped&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">, orign: ErrorOrigin::Caller </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#...</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    env_trace: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_input</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">0xd183512b008cb6611e0100000000000000000000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_caller</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">0xd43593c715fdd31c61141abd04a99fd682</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        //</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_set_storage</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">((</span><span class="token variable" style="color:rgb(191, 199, 213)">Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x030000000100000</span><span class="token variable" style="color:rgb(191, 199, 213)">...</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token variable" style="color:rgb(191, 199, 213)"> Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x000000000000000</span><span class="token variable" style="color:rgb(191, 199, 213)">...</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    sandbox_result_ok: RuntimeValue::Value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">7</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    nest: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>以上日志可以看到</p><ol><li><p><code>env_trace</code>的最后不以<code>seal_return</code>结尾，则表示合约实际上没有正常执行完成。因为从<code>ink!</code>的设计中可以看到，如果正常进入到<code>#[ink(constructor)]</code>或者进入到<code>#[ink(message)]</code>则表面一定执行到了<code>::ink_lang::execute_message</code>中（<code>::ink_lang::execute_message</code>会调用<code>seal_return</code>），而没有出现<code>seal_return</code>代表没有执行到<code>execute</code>的阶段。</p></li><li><p><code>sandbox_result_ok</code>表示执行的返回值为<code>7</code>，查询<code>ink!</code>对于<code>DispatchError</code>的实现可以看到这个错误码代表着<code>CouldNotReadInput</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">DispatchError::CouldNotReadInput =&gt; Self(0x07),</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>根据合约宏展开的代码可以看到在<code>dispatch_using_mode</code>函数中，调用<code>execute</code>之前会调用<code>::ink_env::decode_input</code>，而这个函数存在<code>return Error</code>的情况。因此可以合理猜测是在解析<code>input</code>的时候出现异常。在日志中记录了输入参数<code>args:0x008cb6611e0100000000000000000000</code>，观察这个参数可以发现其长度明显小于<code>u128</code>编码的情况。因此可以根据<code>args</code>和<code>env_trace</code>推测出是解码<code>input</code>的时候发生了错误。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// this part code is expanded by erc20 example.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">::ink_env::decode_input::&lt;&lt;Erc20 as ::ink_lang::ConstructorDispatcher&gt;::Type&gt;().map_err(|_| ::ink_lang::DispatchError::CouldNotReadInput)?</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ol><p>此时合约实例化成功，但是执行实例化的构造函数存在。因此合约存在于链上但是没有正常执行<code>#[ink(constructor)]</code>的过程。</p></li><li><p><code>call</code>阶段 ，如调用<code>transfer</code>:</p><p>对以上实例化成功的函数进行调用<code>transfer</code>，会出现<code>ContractTrap</code>，europa的日志显示如下：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">: NestedRuntime </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ext_result: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">failed</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> ExecError </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> error: DispatchError::Module </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">index:5, error:17, message: Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ContractTrapped&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">, orign: ErrorOrigin::Caller </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    env_trace: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_value_transferred</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">0x0000000000000000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    wasm_error: Error::WasmiExecution</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Trap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Trap </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> kind: Unreachable </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        wasm backtrace: </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  core::panicking::panic_fmt.60</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1743</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  core::result::unwrap_failed</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">914</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  core::result::Result</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">T,E</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::expect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">915</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  ink_lang::dispatcher::deny_payment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1664</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  call</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1691</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        ╰─</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">unknown</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2387</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    nest: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>首先注意到<code>env_trace</code>最后一个记录依然不是<code>seal_return</code>，且<code>wasm_error</code>的错误原因是<code>WasmiExecution::Unreachable</code>。因此可以确定是合约执行过程中遇到了<code>panic</code>或者<code>expect</code>。</p><p>而从wasm backtrace 中则十分明显的看到了在执行过程为</p></li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">   call -</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> deny_payment -</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">expect</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>而根据宏展开的代码（<code>cd ink/examples/erc20; cargo expand &gt; tmp.rs</code>）我们可以看到：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#[no_mangle]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn call</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> -</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> u32 </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     ::ink_lang::deny_payment::</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;</span><span class="token plain">Erc20 as ::ink_lang::ContractEnv</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::Env</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .expect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;caller transferred value even though all ink! message deny payments&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ::ink_lang::DispatchRetCode::from</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">Erc20 as ::ink_lang::DispatchUsingMode</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::dispatch_using_mode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            ::ink_lang::DispatchMode::Call,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    .to_u32</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>   因此可以判定合约执行<code>transfer</code>的过程中在<code>deny_payment</code>返回了错误，而这里对错误直接处理为<code>expect</code>导致了<code>wasmi</code>执行结果为<code>Unreachable</code>。跟踪<code>deny_payment</code>的代码可以发现是该函数返回了<code>Error</code>导致的<code>expect</code></p><blockquote><p>注，相关代码如下：</p><p>在<code>ink_lang</code>中<a href="https://github.com/paritytech/ink/blob/master/crates/lang/src/dispatcher.rs#L140-L150" target="_blank" rel="noopener noreferrer">https://github.com/paritytech/ink/blob/master/crates/lang/src/dispatcher.rs#L140-L150</a></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn deny_payment&lt;E&gt;() -&gt; Result&lt;()&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">where</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    E: Environment,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let transferred = ink_env::transferred_balance::&lt;E&gt;()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .expect(&quot;encountered error while querying transferred balance&quot;);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if transferred != &lt;E as Environment&gt;::Balance::from(0u32) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return Err(DispatchError::PaidUnpayableMessage)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(())</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>ink中此处的<code>off_chain</code>部分和<code>on_chain</code>部分会出现差异</strong>，<code>off_chain</code>会认为在<code>ink_env::transferred_balance::&lt;E&gt;()</code>阶段就返回错误，于是在执行<code>transferred_balance</code>中后会遇到<code>expect</code>导致<code>panic</code>，而<code>on_chain</code>部分由于是从wasm的memory中取值，则会正常获取到对应u128长度的字符并解码得到<code>transferred</code>，只是解码的结果不会符合预期，导致<code>transferred!=0</code>让<code>deny_payment</code>返回了Error，而在合约的宏展开调用<code>deny_payment</code>的部分才触发<code>expect</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">if true {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ::ink_lang::deny_payment::&lt;&lt;Erc20 as ::ink_lang::ContractEnv&gt;::Env&gt;()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .expect(&quot;caller transferred value even though all ink! message deny payments&quot;)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>因此对于wasm backtrace 来说，<code>expect</code>是出现在<code>call</code>中调用<code>deny_payment</code>的时候，而不是<code>deny_payment</code>中调用<code>transferred_balance</code>的时候。</p><p><strong>这个例子侧面说明<code>ink!</code>当前对于<code>off_chain</code>以及<code>on_chain</code>的处理并不是完全对应的，可能在一些情况下会给合约的使用者造成难以排查的错误</strong></p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="what-we-have-implemented-for-v02"></a>What we have implemented for v0.2<a class="hash-link" href="#what-we-have-implemented-for-v02" title="Direct link to heading">#</a></h2><p><em>Modify at <code>FRAME Contracts pallet</code> level to provide more information.</em></p><p>测试用例见：</p></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/patractlabs/substrate-contracts-book/docs/europa/reports/v0.2Report.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/substrate-contracts-book/europa/reports/v0.1Report"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Europa v0.1 报告</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/substrate-contracts-book/europa/reports/v0.3Report"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Europa v0.3报告 »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link">Introduction</a><ul><li><a href="#summary-of-europas-v02-plan" class="table-of-contents__link">Summary of Europa&#39;s v0.2 plan:</a></li></ul></li><li><a href="#design" class="table-of-contents__link">Design</a><ul><li><a href="#pallet-contracts层" class="table-of-contents__link"><code>pallet-contracts</code>层</a></li><li><a href="#wasmi层" class="table-of-contents__link"><code>wasmi</code>层</a></li><li><a href="#合约日志功能" class="table-of-contents__link">合约日志功能</a></li></ul></li><li><a href="#what-europa-can-do-in-this-version" class="table-of-contents__link">What Europa can do in this version</a><ul><li><a href="#build" class="table-of-contents__link">Build</a></li><li><a href="#example" class="table-of-contents__link">example</a></li></ul></li><li><a href="#what-we-have-implemented-for-v02" class="table-of-contents__link">What we have implemented for v0.2</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/substrate-contracts-book/assets/js/runtime~main.3945a3a1.js"></script>
<script src="/substrate-contracts-book/assets/js/main.ee6e64d2.js"></script>
</body>
</html>