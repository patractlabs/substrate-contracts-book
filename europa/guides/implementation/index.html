<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<title data-react-helmet="true">Contract Pallet Implementation | Substrate Contracts Book</title><meta data-react-helmet="true" property="og:url" content="https://docs.patract.io/substrate-contracts-book/europa/guides/implementation"><meta data-react-helmet="true" name="docusaurus_locale" content="zh"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Contract Pallet Implementation | Substrate Contracts Book"><meta data-react-helmet="true" name="description" content="On pallet contracts layer"><meta data-react-helmet="true" property="og:description" content="On pallet contracts layer"><link data-react-helmet="true" rel="shortcut icon" href="/substrate-contracts-book/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://docs.patract.io/substrate-contracts-book/europa/guides/implementation"><link data-react-helmet="true" rel="alternate" href="https://docs.patract.io/substrate-contracts-book/europa/guides/implementation" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://docs.patract.io/substrate-contracts-book/en/europa/guides/implementation" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.patract.io/substrate-contracts-book/europa/guides/implementation" hreflang="x-default"><link rel="stylesheet" href="/substrate-contracts-book/assets/css/styles.4aa6c65a.css">
<link rel="preload" href="/substrate-contracts-book/assets/js/runtime~main.807c3882.js" as="script">
<link rel="preload" href="/substrate-contracts-book/assets/js/main.9139033a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/substrate-contracts-book/"><img src="/substrate-contracts-book/img/logo.svg" alt="Substrate Contracts Book" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/substrate-contracts-book/img/logo.svg" alt="Substrate Contracts Book" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a href="https://www.patract.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>主页<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://blog.patract.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>博客<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/patractlabs/substrate-contracts-book" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>中文</span></span></a><ul class="dropdown__menu"><li><a href="/substrate-contracts-book/europa/guides/implementation" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">中文</a></li><li><a href="/substrate-contracts-book/en/europa/guides/implementation" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li></ul></div><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/substrate-contracts-book/">Summary</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#">介绍</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/contracts/introduction">Substrate 合约书</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/contracts/overview">合约综述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/contracts/model">合约模型</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/contracts/language">合约语言</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/contracts/wasm_first_step">Wasm简要介绍</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">ink!</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">ask!</a></li><li class="menu__list-item"><a class="menu__link" href="/substrate-contracts-book/solang/introduction">Solang</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Redspot</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Europa</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Get Started</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/intro/overview">Europa Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/intro/europa-ui">Europa UI</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/intro/europa-cli">Europa CLI</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Guides</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/guides/architecture">Architeture</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/substrate-contracts-book/europa/guides/implementation">Contract Pallet Implementation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/guides/custom-rpcs">Custom RPCs and commands</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/guides/contract-log">Europa contract execution log</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/guides/backtrace">Europa&#x27;s Wasm Backtrace</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/guides/debug-example">Europa debugging example</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/guides/wasm-executor">Europa Wasm executor</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Chain Extensions</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/extensions/custom-chain-extensions">Custom ChainExtensions</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Reports</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">zkMega</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Himalia</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Metis</a></li><li class="menu__list-item"><a class="menu__link" href="/substrate-contracts-book/carpo/introduction">Carpo</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Elara</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Jupiter</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">PatraStore</a></li><li class="menu__list-item"><a class="menu__link" href="/substrate-contracts-book/patract/introduction">Patract</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">Contract Pallet Implementation</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="on-pallet-contracts-layer"></a>On <code>pallet contracts</code> layer<a class="hash-link" href="#on-pallet-contracts-layer" title="Direct link to heading">#</a></h2><p>During the contract debugging process, Europa believes that developers need:</p><ol><li>Rich error information: Wasm records the error information during the entire execution process, including Wasm executor errors and host_function errors.</li><li>Execution in the debugging process: The main modification information of <code>pallet contracts</code>, the &quot;contract stack&quot; is used to record the process of contract calling contract, and any information that can assist debugging during the execution of this layer of contract, such as the situation of calling the host_function, selector, and calling contract parameters, etc.</li></ol><p>Europa made the following modifications:</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="error-on-the-wasm-executor-layer："></a>Error on the wasm executor layer：<a class="hash-link" href="#error-on-the-wasm-executor-layer：" title="Direct link to heading">#</a></h3><p>Europa designed our own <code>ep-sandbox</code> to replace the original <code>sp-sandbox</code> used by <code>pallet contracts</code>, and modified <code>ep_sandbox::Error</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub enum Error {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   Module,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   OutOfBounds,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   Execution,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   /// Wasm inner trap</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   Trap(imp::Trap),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>Trap(imp::Trap)</code> carries backtrace information of the Wasm layer, it can help developers to get the detailed information for execution stack.</p><p>Europa&#x27;s own <code>ep-sandbox</code> only has the <code>std</code> version (because Europa has removed all Wasm parts, there is no need for <code>ep-sandbox</code> to support <code>no-std</code>), so in the future, <strong><code>ep-sandbox</code> can be replaced with different wasm executors to support running tests of different wasm executors, and replaced with wasm executors that support debugging and other features. </strong></p><p>Currently <code>ep-sandbox</code> uses a forked version of <code>wasmi</code> as the executor, so the error it throws is <code>WasmiError</code>. See the next chapter for errors in<code>wasmi</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="error-of-host_functions"></a>Error of host_functions:<a class="hash-link" href="#error-of-host_functions" title="Direct link to heading">#</a></h3><p>The host function execution error will cause Trap, and will record <code>TrapReason</code>. No modification to the data structure, just record.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="execution-during-debugging"></a>Execution during debugging<a class="hash-link" href="#execution-during-debugging" title="Direct link to heading">#</a></h3><p>The Europa forked version of <code>pallet-contracts</code> has designed an object to record any information that can help debugging during contract execution:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// Record the contract execution context.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct NestedRuntime {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Current depth</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    depth: usize,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The current contract execute result</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ext_result: ExecResult,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The value in sandbox successful result</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    sandbox_result_ok: Option&lt;ReturnValue&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Who call the current contract</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    caller: AccountId32,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The account of the current contract</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    self_account: Option&lt;AccountId32&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The input selector</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    selector: Option&lt;HexVec&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The input arguments</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    args: Option&lt;HexVec&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The value in call or the endowment in instantiate</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    value: u128,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The gas limit when this contract is called</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    gas_limit: Gas,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The gas left when this contract return</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    gas_left: Gas,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The host function call stack</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    env_trace: EnvTraceList,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The error in wasm</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    wasm_error: Option&lt;WasmErrorWrapper&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The trap in host function execution</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    trap_reason: Option&lt;TrapReason&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Nested contract execution context</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    nest: Vec&lt;NestedRuntime&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In the model of <code>pallet contracts</code>, a contract calling another contract is in the &quot;contract stack&quot; model, so <code>NestedRuntime</code> will track the execution process of the entire contract stack, and use the property of <code>nest</code> to store a list of <code>NestedRuntime</code> to represent other contracts the the contract called.</p><p>In the process of executing a contract by <code>pallet contracts</code>, Europa records the relevant information in the execution process in the structure of <code>NestedRuntime</code> in the form of a bypass, and will print the <code>NestedRuntime</code> to the log (show the case later) in a certain format after the contract call ends. Contract developers can analyze the information printed by <code>NestedRuntime</code> to obtain various detailed information during the execution of the contract, which can be used in various situations:</p><ol><li>help to locate where the error occurs, including the following situations:<ol><li><code>pallet contracts</code> layer</li><li><code>ink!</code> layer</li><li>The specific position in the contract layer</li><li>Locate which level of the contract is when a contract calling another contract</li></ol></li><li>Analyze the information during the execution of the contract at this timing:<ol><li>Analyze the consumption of gas execution</li><li>Analyze the call of <code>get_storage</code> and <code>set_storage</code>, help reconstruct the contract code and analyze the demand of <code>rent</code></li><li>According to <code>selector</code>, <code>args</code> and <code>value</code>, analyze and locate whether the transaction parameters of the third-party SDK are legal.</li><li>Analyze the execution path of the contract and adjust the contract based on the <code>nest</code> information and combined with the <code>seal_call</code> information.</li><li>etc.</li></ol></li></ol><p>The process of recording <code>pallet contracts</code> executing contract to <code>NestEdRuntime</code> is relatively fine-grained.
The process of logging the information of the execution contract of <code>pallet contracts</code> to <code>NestEdRuntime</code> is relatively fine-grained. Take <code>seal_call</code> in <code>define_env!</code> as an example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct SealCall {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    callee: Option&lt;HexVec&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    gas: u64,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    value: Option&lt;u128&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    input: Option&lt;HexVec&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    output: Option&lt;HexVec&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The attributes are basically <code>Option&lt;&gt;</code>. For example, before calling the contract, the <code>input</code> will be set to <code>Some</code>, and the return value will be set after the calling contract is normal. If there is an error in the calling contract, then <code>output</code> will remain <code>None</code>. Therefore, if <code>input</code> is <code>Some</code> and <code>output</code> is <code>None</code>, it means that there is a problem with the called contract during the process of calling the contract.</p><p>The current information of <code>NestedRuntime</code> is only printed in the log. <strong>In the future, <code>NestedRuntime</code> will be stored locally and provide corresponding RPC for external access</strong>. Therefore, in the future, third-party applications can obtain <code>NestedRuntime</code> for further processing. For example, in our <code>Redspot</code>, a plug-in can be designed to generate a contract call another contract topology based on the information of <code>NestedRuntime</code>, and a visual contract call path can be generated on the web wallet interface, etc.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="on-wasmtime-layer"></a>On <code>wasmtime</code> Layer<a class="hash-link" href="#on-wasmtime-layer" title="Direct link to heading">#</a></h2><p>Currently, europa use wasmtime for execution. And wasmtime support to record the backtrace. europa collects them and record in local.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="contract-log-functions"></a>Contract Log functions<a class="hash-link" href="#contract-log-functions" title="Direct link to heading">#</a></h2><p>In the process of contract debugging, you need to know the internal execution of the contract and the intermediate data. Currently, due to lack of debugging conditions (such as using gdb for debugging), log printing is the most convenient way. As mentioned in the Europa v0.2 proposal, the current <code>pallet contracts</code> and <code>ink!</code> already support <code>format!</code>+<code>seal_println</code> to format and print strings, but this mode has two defects :</p><ol><li>All the logs of <code>seal_println</code> printed on the node side are <code>target: runtime</code> and level <code>DEBUG</code>, but when developing complex contracts, a lot of logs will be printed. If you cannot filter by <code>target</code> and log level, then the development process will be full of interference from irrelevant information.</li><li>The contract developer wrote <code>seal_println</code> when needed during the development process, but all <code>seal_println</code> must be deleted when the contract is released. Although the contract developer can encapsulate a conditionally compiled function to control it, it is more convenient if a tool library already provides such a function.</li></ol><p>Therefore, Europa provides a log library <a href="https://github.com/patractlabs/ink-log" target="_blank" rel="noopener noreferrer">patractlabs/ink-log</a> that mimics Rust&#x27;s <code>log</code> crete to solve the above problems. Its usage is the same as that of Rust. <code>log</code> is completely consistent, which reduces the learning cost of developers.</p><p>The <code>ink-log</code> is generally implemented by the <code>ChainExtension</code> of <code>pallet contracts</code>, the agreed <code>function_id</code> is <code>0xfeffff00</code>, and the message is transmitted in the wasm memory through the structure <code>LoggerExt</code>. Therefore this library is divided into the following two parts:</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ink_log"></a><code>ink_log</code>:<a class="hash-link" href="#ink_log" title="Direct link to heading">#</a></h3><p>In the <code>ink-log/contracts</code> directory, provide <code>info!</code>, <code>debug!</code>, <code>warn!</code>, <code>error!</code>, <code>trace!</code>, same as Rust&#x27;s <code>log</code> library in the same macro, and the call method of the macro is also the same. These macros are packaged implementations of <code>seal_chain_extensions</code> on the ink! side, and are <strong>tool library for contract developers</strong>. For example, after this library is introduced in the contract <code>Cargo.toml</code>, the log can be printed as follows:</p><p>In <code>Cargo.toml</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cargo"><pre tabindex="0" class="prism-code language-cargo codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[dependencies]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ink_log = { version = &quot;0.1&quot;, git = &quot;https://github.com/patractlabs/ink-log&quot;, default-features = false, features = [&quot;ink-log-chain-extensions&quot;] }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[features]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">default = [&quot;std&quot;]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">std = [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> # ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> &quot;ink_log/std&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In the contract, you can use the following methods to print logs in the node:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">ink_log::info!(target: &quot;flipper-contract&quot;, &quot;latest value is: {}&quot;, self.value);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="runtime_log"></a><code>runtime_log</code>:<a class="hash-link" href="#runtime_log" title="Direct link to heading">#</a></h3><p>In the <code>ink-log/runtime</code> directory, this library is based on the contents of the <code>function_id</code> and <code>LoggerExt</code> structures passed from <code>ChainExtensions</code> to call the corresponding logs under <code>debug</code> in <code>frame_support</code> to print. It is an implementation library of <code>ink_log</code> prepared for developers of the chain. **For example, chain developers can use it in their own <code>ChainExtensions</code>:</p><p>In <code>Cargo.toml</code>：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[dependencies]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">runtime_log = { version = &quot;0.1&quot;, git = &quot;https://github.com/patractlabs/ink-log&quot;, default-features = false }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[features]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">default = [&quot;std&quot;]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">std = [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> # ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> &quot;runtime_log/std&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In <code>ChainExtensions</code>&#x27;s implementation：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct CustomExt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">impl ChainExtension for CustomExt {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> fn call&lt;E: Ext&gt;(func_id: u32, env: Environment&lt;E, InitState&gt;) -&gt; Result&lt;RetVal, DispatchError&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> where</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     &lt;E::T as SysConfig&gt;::AccountId: UncheckedFrom&lt;&lt;E::T as SysConfig&gt;::Hash&gt; + AsRef&lt;[u8]&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        match func_id {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            ... =&gt; {/* other ChainExtension */ }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            0xfeffff00 =&gt; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                // TODO add other libs</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">             runtime_log::logger_ext!(func_id, env);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">             // or use</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                // LoggerExt::call::&lt;E&gt;(func_id, env)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                Ok(RetVal::Converging(0))</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }`europa_forwardToHeight`</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }   </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong><code>ink_log</code> corresponds to <code>runtime_log</code>, so if contract developers need to use <code>ink_log</code>, they need to pay attention to the chain corresponding to the debugging contract that needs to implement <code>runtime_log</code>. </strong></p><p>On the other hand, after contract developers introduce <code>ink_log</code>, they need to pay attention to <code>features = [&quot;ink-log-chain-extensions&quot;]</code>, <code>ink_log</code> will call <code>seal_chain_extensions</code> to interact with the chain only when this feature is enabled. Without this feature, <code>noop</code> will be used to skip the process of contract printing.</p><p>Therefore, contract developers can control the contract to print logs in the debugging environment and the production environment through features. The contract compiled in the debugging environment opens the <code>&quot;ink-log-chain-extensions&quot;</code> feature, and the contract compiled in the production environment removes this feature.</p><p>For detailed usage examples, please check <a href="/substrate-contracts-book/europa/extensions/custom-chain-extensions">Custom ChainExtensions</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/patractlabs/substrate-contracts-book/docs/europa/guides/implementation.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/substrate-contracts-book/europa/guides/architecture"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Architeture</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/substrate-contracts-book/europa/guides/custom-rpcs"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Custom RPCs and commands »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#on-pallet-contracts-layer" class="table-of-contents__link">On <code>pallet contracts</code> layer</a><ul><li><a href="#error-on-the-wasm-executor-layer：" class="table-of-contents__link">Error on the wasm executor layer：</a></li><li><a href="#error-of-host_functions" class="table-of-contents__link">Error of host_functions:</a></li><li><a href="#execution-during-debugging" class="table-of-contents__link">Execution during debugging</a></li></ul></li><li><a href="#on-wasmtime-layer" class="table-of-contents__link">On <code>wasmtime</code> Layer</a></li><li><a href="#contract-log-functions" class="table-of-contents__link">Contract Log functions</a><ul><li><a href="#ink_log" class="table-of-contents__link"><code>ink_log</code>:</a></li><li><a href="#runtime_log" class="table-of-contents__link"><code>runtime_log</code>:</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/substrate-contracts-book/assets/js/runtime~main.807c3882.js"></script>
<script src="/substrate-contracts-book/assets/js/main.9139033a.js"></script>
</body>
</html>