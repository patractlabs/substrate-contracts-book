<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<title data-react-helmet="true">ink! eDSL basic elements | Substrate Contracts Book</title><meta data-react-helmet="true" property="og:url" content="https://docs.patract.io/substrate-contracts-book/en/ink/edsl-basic"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="ink! eDSL basic elements | Substrate Contracts Book"><meta data-react-helmet="true" name="description" content="The elements of ink! eDSL design are actually relatively similar to those of Solidity, because the contract model structure of Contracts Pallet and the contract model of EVM are relatively similar."><meta data-react-helmet="true" property="og:description" content="The elements of ink! eDSL design are actually relatively similar to those of Solidity, because the contract model structure of Contracts Pallet and the contract model of EVM are relatively similar."><link data-react-helmet="true" rel="shortcut icon" href="/substrate-contracts-book/en/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://docs.patract.io/substrate-contracts-book/en/ink/edsl-basic"><link data-react-helmet="true" rel="alternate" href="https://docs.patract.io/substrate-contracts-book/ink/edsl-basic" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://docs.patract.io/substrate-contracts-book/en/ink/edsl-basic" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.patract.io/substrate-contracts-book/ink/edsl-basic" hreflang="x-default"><link rel="stylesheet" href="/substrate-contracts-book/en/assets/css/styles.4aa6c65a.css">
<link rel="preload" href="/substrate-contracts-book/en/assets/js/runtime~main.e349a06c.js" as="script">
<link rel="preload" href="/substrate-contracts-book/en/assets/js/main.d83d00f6.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/substrate-contracts-book/en/"><img src="/substrate-contracts-book/en/img/logo.svg" alt="Substrate Contracts Book" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/substrate-contracts-book/en/img/logo.svg" alt="Substrate Contracts Book" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">My Site</b></a><a href="https://www.patract.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Home<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://blog.patract.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/patractlabs/substrate-contracts-book" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/substrate-contracts-book/ink/edsl-basic" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">中文</a></li><li><a href="/substrate-contracts-book/en/ink/edsl-basic" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li></ul></div><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/substrate-contracts-book/en/">Summary</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#">Introduction</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/en/contracts/introduction">Substrate contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/en/contracts/overview">Contract overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/en/contracts/model">Contract model</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/en/contracts/language">Contract language</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/en/contracts/wasm_first_step">Brief introduction of Wasm</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">ink!</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/en/ink/introduction">ink</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/en/ink/tutorial">ink! tutorial</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/en/ink/framework">ink! Framework</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/substrate-contracts-book/en/ink/edsl-basic">ink! eDSL basic elements</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/en/ink/call-contracts">Cross-call for ink!</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/en/ink/ink-solidity">Compare ink! and solidity</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/en/ink/cargo-contract">cargo-contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/en/ink/trap">Current problem for ink!</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">ask!</a></li><li class="menu__list-item"><a class="menu__link" href="/substrate-contracts-book/en/solang/introduction">Solang</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Redspot</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Europa</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">zkMega</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Himalia</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Metis</a></li><li class="menu__list-item"><a class="menu__link" href="/substrate-contracts-book/en/carpo/introduction">Carpo</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Elara</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Jupiter</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">PatraStore</a></li><li class="menu__list-item"><a class="menu__link" href="/substrate-contracts-book/en/patract/introduction">Patract</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">ink! eDSL basic elements</h1></header><p>The elements of ink! eDSL design are actually relatively similar to those of Solidity, because the contract model structure of Contracts Pallet and the contract model of EVM are relatively similar.</p><p>Therefore, the design of ink! can find a lot of shadows similar to Solidity (the same applies to the Runtime design of Substrate). When describing the ink characteristics later, I will try to compare with the characteristics of Solidity, which is convenient for readers to understand.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="elements-of-edsl"></a>Elements of eDSL<a class="hash-link" href="#elements-of-edsl" title="Direct link to heading">#</a></h2><p>From the example provided by ink! documentation or ink!, the code shows that ink! also proposes the following three basic elements on the Contracts Pallet model:</p><ul><li><code>constructor</code>/<code>message</code></li><li><code>storage</code></li><li><code>event</code></li></ul><p>However, due to the design relationship of the Rust process macro, you can see that ink! First requires a contract to be under a <code>mod</code>, and add the <code>#[ink::contract]</code> macro to this <code>mod</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust,ignore"><pre tabindex="0" class="prism-code language-rust,ignore codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[ink::contract]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mod erc20 {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In this way, it is equivalent to telling ink! What is in this mod is to be processed according to the eDSL of ink.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="inkcontract"></a><code>#[ink::contract]</code><a class="hash-link" href="#inkcontract" title="Direct link to heading">#</a></h3><p>Therefore, when you encounter the macro <code>#[ink::contract]</code>, it appears that this is the &quot;contract part&quot; identified by ink!. Therefore, we can see that many imports of <code>use xxx</code> will be placed under the scope of <code>mod</code> in <code>#[ink::contract]</code>.</p><p>And the current ink! design is that, under a <code>crate</code> package, only one <code>#[ink::contract]</code> can appear, so it means that ink! thinks that the dimension of a contract is based on rust&#x27;s <code>crate</code>, that is If in the same <code>crate</code>, whether in the same file (for example, under <code>lib.rs</code>) or in different files, more than two are defined by <code>#[ink::contract]</code> The <code>mod</code>, for example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust,ignore"><pre tabindex="0" class="prism-code language-rust,ignore codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[ink::contract]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mod erc20 {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[ink::contract]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mod another_define {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Analogous to solidity:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly solidity,ignore"><pre tabindex="0" class="prism-code language-solidity,ignore codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// a.sol defines multiple `contract` in the same file</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">contract A {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">contract B {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Then in the compilation of ink!, this situation will be considered illegal.</p><p>Of course, as opposed to this, as long as there is only one <code>mod</code> modified by <code>#[ink::contract]</code> in the current <code>crate</code>, other <code>mod</code>s should be used normally, so the contract modified by ink! <code>crate</code> can still do a good job of code isolation, enhance readability and maintainability<strong>. This ability is important for </strong>maintaining large and complex contracts**, such as:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust,ignore"><pre tabindex="0" class="prism-code language-rust,ignore codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[ink::contract]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mod erc20 {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    use crete::another_define::*;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mod another_define {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>For example, the following example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust,ignore"><pre tabindex="0" class="prism-code language-rust,ignore codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">mod fxck {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    use crate::erc20::Erc20;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    use ::ink_lang::Env; // Note that `ink_lang::Env` needs to be introduced here</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    impl Erc20 {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        pub fn tmp(&amp;self) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            self.env().caller(); // </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[ink::contract]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mod erc20 {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #[ink(storage)]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub struct Erc20 {...}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    impl Erc20 {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        #[ink(constructor)]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        pub fn new(initial_supply: Balance) -&gt; Self {...}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        #[ink(message)]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        pub fn transfer(&amp;mut self, initial_supply: Balance) -&gt; Self {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            self.tmp(); // call methods defined in other `mod`</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This model can achieve some code isolation that cannot be done under Solidity, and enhance maintainability. (Because Solidity&#x27;s library can only be used for pure function calculations)</p><p>In summary, under the ink! system:</p><ul><li>A contract is in a <code>crate</code> unit, and only one <code>#[ink::contract]</code> definition can appear in a <code>crate</code>;</li><li><code>#[ink::contract]</code> modified <code>mod</code> represents the content of the contract, and also represents <strong>the basic elements of the contract must be defined under this <code>mod</code></strong>;</li><li>All parts other than <code>mod</code> modified by <code>#[ink::contract]</code> (other <code>mod</code>, functions, types) follow the rules of rust, and good code isolation can be done to improve maintainability;</li><li>In practice, the <code>mod</code> modified by <code>#[ink::contract]</code> can be used as the entry point of the contract, and the implemented logic can be distributed to other <code>mod</code>s.</li></ul><p>The following uses &quot;contract mod&quot; to indicate a <code>mod</code> modified by <code>#[ink::contract]</code></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="storage"></a><code>storage</code><a class="hash-link" href="#storage" title="Direct link to heading">#</a></h3><p>In the contract mod, a structure must be defined, and this structure is modified by <code>#[ink(storage)]</code>, indicating that the storage of the contract is defined.</p><p>At the same time, this structure definition modified by <code>#[ink(storage)]</code> is also regarded as an operable contract entity<strong>, so all contract-related resources, types, and operations will be </strong> and this structure The body is bound together**. When the contract calls the contract, the type of the called contract is also represented by this structure.</p><p>Therefore, this structure can be understood as a contract entity.</p><blockquote><p>Although the part that modifies <code>mod</code> is the contract, because <code>mod</code> can only represent the scope in rust, so for practical use, use the structure modified by <code>#[ink(storage)]</code> to indicate that it can be operated Contract entity.</p><p>In this context, the <code>mod</code> modified by <code>#[ink::contract]</code> can be understood as the concept of &quot;opening the contract domain&quot;, while the <code>stuct</code> modified by <code>#[ink(storage)]</code> It is a contract under this contract domain.</p></blockquote><p>Here, the concept of storage defined by ink! is consistent with the concept of “storage” defined in Solidity, which means that the attributes defined here are the final state written to the <strong>chain</strong>. The purpose of writing all contract logic is to modify the state defined here.</p><p>However, because the current ink! uses a structure to carry the contract state, all the states of the current contract can only be defined in this structure. When the contract is designed to be relatively large and complicated, the maintainability here will decrease.</p><p>An example of defining storage is as follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust,ignore"><pre tabindex="0" class="prism-code language-rust,ignore codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[ink(storage)]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct Erc20 {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Total token supply.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    total_supply: Lazy&lt;Balance&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Mapping from owner to number of owned token.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    balances: StorageHashMap&lt;AccountId, Balance&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Mapping of the token amount which an account is allowed to withdraw</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// from another account.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    allowances: StorageHashMap&lt;(AccountId, AccountId), Balance&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Structures modified by <code>#[ink(storage)]</code> are collectively referred to as contract structures in the following text.</p><p>Here are a few features that need to be paid special attention to:</p><ol><li><p>The type of the attribute defined in the contract structure must be a type that has implemented <code>SpreadLayout</code> (or more accurately, a type that implements <code>PackedLayout</code>, because <code>PackedLayout</code> is inherited from the definition of <code>SpreadLayout</code>):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust,ignore"><pre tabindex="0" class="prism-code language-rust,ignore codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// Types that can be stored to and loaded from the contract storage.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub trait SpreadLayout {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><blockquote><p>The reason why only the type that implements this trait can be used here is very simple, because storage is different from the general type, it must contain the information of the &quot;chain&quot; in it, so the contract implementation of different chains must have a part for processing The storage (that is, state) allocation problem in the contract.</p><p>For example, during the compilation process of Solidity, the key of the state is actually assigned according to the upper and lower order defined by the storage in the contract. If the <code>SpredLayout</code> or <code>PackedLayout</code> type has been implemented here, there will be an approximate process for state allocation.</p></blockquote><p>Ink! has done basic implementations for general types, but <strong>for collection types (<code>Vec</code>, <code>HashMap</code>, etc.), because the state of the contract needs to hook the process of reading and writing</strong>, it cannot be implemented for collection types This <code>trait</code>. Therefore, in ink!, all the commonly used collection types in the standard library have been re-implemented, and the attribute types of the structure modified by <code>#[ink(storage)]</code> must be used if the collection type is used. The collection type provided by ink!**.</p><blockquote><p>Since Solidity is relatively rudimentary, the storage map defined by Solidity cannot be traversed. (Caused by a defect in the Solidity design)</p><p>ink! has done a lot of things when designing this piece, so the collection types <code>Vec</code>, <code>BTreeMap</code>, <code>HashMap</code> and so on provided by ink! are all <strong>traversable</strong>. Compared with the functions that Solidity can achieve, it is a considerable improvement.</p></blockquote></li><li><p>Even based on the above design, the nested collection type is still difficult to implement (because the state structure of Substrate uses the k/v model). Therefore, in the design, we can only try to avoid nested collection types. If you must nest the collection type, you need to flatten the nesting level, merge the second-level key and the first-level key together, and use tuples instead (equivalent to <code>double_map</code> in Substrate Runtime)</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly Solidity,ignore"><pre tabindex="0" class="prism-code language-Solidity,ignore codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// solidity</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">contract A {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    mapping (uint =&gt; mapping (uint =&gt; uint))</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The similar code in ink! should be:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust,ignore"><pre tabindex="0" class="prism-code language-rust,ignore codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[ink(storage)]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct Erc20 {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // Note that the key here uses the tuple `(AccountId, AccountId)`</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    allowances: StorageHashMap&lt;(AccountId, AccountId), Balance&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>A model of <code>Lazy</code> is provided in storage, which allows developers to use <code>Lazy</code> to wrap a type so that the state data can be loaded when it is used:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust,ignore"><pre tabindex="0" class="prism-code language-rust,ignore codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// A lazy storage entity.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">///</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// This loads its value from storage upon first use.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">///</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// # Note</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">///</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// Use this if the storage field doesn&#x27;t need to be loaded in some or most cases.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[derive(Debug)]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct Lazy&lt;T&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">where</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    T: SpreadLayout,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    cell: LazyCell&lt;T&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>How to use:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust,ignore"><pre tabindex="0" class="prism-code language-rust,ignore codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[ink(storage)]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct Erc20 {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Total token supply.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    total_supply: Lazy&lt;Balance&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="constructormessage"></a><code>constructor</code>/<code>message</code><a class="hash-link" href="#constructormessage" title="Direct link to heading">#</a></h3><p><code>constructor</code>/<code>message</code> is the entry function that triggers the contract state change. In other words, <code>constructor</code>/<code>message</code> is the state transition function of the contract state.</p><p><code>constructor</code>/<code>message</code> can only modify the methods of the contract structure**, and cannot be used to modify the methods of other structures or other pure functions.</p><p>In the contract mod, there is at least one method for the contract structure modified by <code>constructor</code> and <code>message</code>. If there are less than one respectively, it will cause compilation error.</p><p>among them:</p><ul><li><p><code>constructor</code> corresponds to the constructor in the Solidity contract. When the contract is deployed (in Contracts Pallet currently represents the process of doing <code>instantiate</code> from the uploaded contract code), a call to the corresponding constructor will be triggered.</p><blockquote><p>It needs to be emphasized here that the call of the constructor and the instantiation of the contract are two conceptual things. This process is <strong>not atomic</strong> in the coordination process of ink! and Contracts Pallet. Therefore, the constructor may not be called, but the contract address will be generated, and the contract instance for which the constructor has not been called can be called normally.</p><p>A typical example is the wrong code parameter passed in when calling <code>instantiate</code>.</p></blockquote></li><li><p><code>message</code> corresponds to the call methods such as <code>public</code>/<code>external</code> in the Solidity contract. Due to the characteristics of Rust&#x27;s mutable/immutable methods, <code>message</code> uses the <strong> feature to indicate whether this method will modify the state of the contract</strong>.</p><p>  So if the method of <code>message</code> modification is</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust,ignore"><pre tabindex="0" class="prism-code language-rust,ignore codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Note that the first parameter of the method is `&amp;self`</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[ink(message)]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn total_supply(&amp;self) -&gt; Balance {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    *self.total_supply</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>  It means that the call of this method will not modify the state (controlled by the rust syntax), which is consistent with Ethereum. This type of method is mostly used for rpc calls to return the storage of a contract or return some storage-based calculation results.</p><p>  If the modification is</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust,ignore"><pre tabindex="0" class="prism-code language-rust,ignore codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Note that the first parameter of the method is `&amp;mut self`</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn transfer(&amp;mut self, to: AccountId, value: Balance) -&gt; Result&lt;()&gt; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let from = self.env().caller();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    self.transfer_from_to(from, to, value)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>  It means that the call of this method will modify the state, so if this method is called and executed in the form of a packaged transaction call, it will trigger a state change. If it is called by rpc, it means that the simulation has been executed once.</p><p>  At the same time, metadata.json (corresponding to the ABI of Solidity) will be generated after the contract is compiled. In this metadata, there will be a <code>mutates</code> field for the message part to indicate whether the method is variable.</p></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="messages-selector"></a>message&#x27;s <code>selector</code><a class="hash-link" href="#messages-selector" title="Direct link to heading">#</a></h4><p>For the generation of the ABI of the contract method, Solidity uses the method name plus the parameter type as a function signature to piece together into a string and then make a hash to take the first 4 bytes.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">call = &quot;func_name(param1_type,param2_type,...)&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">bytes4(keccak256(call), a, b)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In ink!, this concept that allows contracts to distinguish call trigger points is called <code>selector</code>.</p><p>Since rust does not support function overloading, a relatively simple design is adopted in ink!, which directly hashes the string of the function name and takes the first 4 bytes:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">call = &quot;func_name&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">blake2_512(call)[0..4]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><blockquote><p>The author believes that this design has caused problems with other contract language designs. Because rust does not support overloading, it does not mean that other languages ​​do not support overloading. After Solang compiles Solidity to Wasm, if it wants to be compatible with ink!&#x27;s metadata, problems will arise when calling each other.</p></blockquote><p>On the other hand, <code>selector</code> can also run the contract developer&#x27;s own definition</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust,json"><pre tabindex="0" class="prism-code language-rust,json codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[ink(message, selector = &quot;0xCAFEBABE&quot;)]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn was_it_ten(&amp;self) -&gt; bool {...}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="message-of-payable"></a>message of <code>payable</code><a class="hash-link" href="#message-of-payable" title="Direct link to heading">#</a></h4><p>There is a <code>payable</code> modifier for the method in Solidity, which is used to indicate that the method can accept a certain amount of money.</p><p>Therefore, <code>payable</code> is also provided in ink! to indicate whether it is possible to transfer a certain amount of <strong>local currency</strong> while calling this method. In the current design of ink!, if a non-payable message is called with an amount at the same time, the calling process will be regarded as an error.</p><p>By default, <code>paybale</code> is considered to be <code>false</code>, and it is <code>true</code> only when the contract developer specifies <code>payable</code>.</p><p>The case for specifying a message to be callable is:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust,json"><pre tabindex="0" class="prism-code language-rust,json codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[ink(message, playable)]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn was_it_ten(&amp;self) -&gt; bool {...}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>On the other hand, in metadata, there will be a <code>payable</code> field for the message part to indicate whether this method requires payment.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="event"></a><code>event</code><a class="hash-link" href="#event" title="Direct link to heading">#</a></h3><p>The concept of event is not necessary in the state machine model. However, because <strong>blockchain is an asynchronous system</strong>, after sending a transaction to trigger a state change, the result of the change cannot be immediately known, and it can only rely on monitoring an element to determine the execution result. <code>event</code> is an element designed at the stage of Solidity, and this design is also inherited from Substrate Runtime and ink!.</p><blockquote><p>I don&#x27;t think event is a good design. In theory, there are other better ways, or variants of event. Event will cause abuse by developers to a certain extent.</p></blockquote><p>The <code>event</code> of ink! in Contracts Pallet finally prints the event defined by the contract to the event of the chain through the <code>host function</code>.</p><p>The event design of ink! is nothing special compared to Solidity, but because it is a contract running in Wasm, the event of the printing contract needs to interact with the chain through the host function, so the calling method needs to be passed through. env()` to call.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust,ignore"><pre tabindex="0" class="prism-code language-rust,ignore codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Self::env().emit_event(...);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// or use</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">self.env().emit_event(...);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/patractlabs/substrate-contracts-book/edit/master/docs/ink/edsl-basic.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/substrate-contracts-book/en/ink/framework"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« ink! Framework</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/substrate-contracts-book/en/ink/call-contracts"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Cross-call for ink! »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#elements-of-edsl" class="table-of-contents__link">Elements of eDSL</a><ul><li><a href="#inkcontract" class="table-of-contents__link"><code>#[ink::contract]</code></a></li><li><a href="#storage" class="table-of-contents__link"><code>storage</code></a></li><li><a href="#constructormessage" class="table-of-contents__link"><code>constructor</code>/<code>message</code></a></li><li><a href="#event" class="table-of-contents__link"><code>event</code></a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/substrate-contracts-book/en/assets/js/runtime~main.e349a06c.js"></script>
<script src="/substrate-contracts-book/en/assets/js/main.d83d00f6.js"></script>
</body>
</html>