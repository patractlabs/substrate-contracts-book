<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<title data-react-helmet="true">Europa v0.2 æŠ¥å‘Š | Substrate Contracts Book</title><meta data-react-helmet="true" property="og:url" content="https://docs.patract.io/substrate-contracts-book/europa/reports/v0.2Report"><meta data-react-helmet="true" name="docusaurus_locale" content="zh"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Europa v0.2 æŠ¥å‘Š | Substrate Contracts Book"><meta data-react-helmet="true" name="description" content="Patract Hub&#x27;s treasury report for Europa v0.2"><meta data-react-helmet="true" property="og:description" content="Patract Hub&#x27;s treasury report for Europa v0.2"><link data-react-helmet="true" rel="shortcut icon" href="/substrate-contracts-book/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://docs.patract.io/substrate-contracts-book/europa/reports/v0.2Report"><link data-react-helmet="true" rel="alternate" href="https://docs.patract.io/substrate-contracts-book/europa/reports/v0.2Report" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://docs.patract.io/substrate-contracts-book/en/europa/reports/v0.2Report" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.patract.io/substrate-contracts-book/europa/reports/v0.2Report" hreflang="x-default"><link rel="stylesheet" href="/substrate-contracts-book/assets/css/styles.4aa6c65a.css">
<link rel="preload" href="/substrate-contracts-book/assets/js/runtime~main.3945a3a1.js" as="script">
<link rel="preload" href="/substrate-contracts-book/assets/js/main.ee6e64d2.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/substrate-contracts-book/"><img src="/substrate-contracts-book/img/logo.svg" alt="Substrate Contracts Book" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/substrate-contracts-book/img/logo.svg" alt="Substrate Contracts Book" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a href="https://www.patract.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>ä¸»é¡µ<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://blog.patract.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>åšå®¢<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/patractlabs/substrate-contracts-book" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>ä¸­æ–‡</span></span></a><ul class="dropdown__menu"><li><a href="/substrate-contracts-book/europa/reports/v0.2Report" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">ä¸­æ–‡</a></li><li><a href="/substrate-contracts-book/en/europa/reports/v0.2Report" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li></ul></div><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/substrate-contracts-book/">Summary</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#">ä»‹ç»</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/contracts/introduction">Substrate åˆçº¦ä¹¦</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/contracts/overview">åˆçº¦ç»¼è¿°</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/contracts/model">åˆçº¦æ¨¡å‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/contracts/language">åˆçº¦è¯­è¨€</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/contracts/wasm_first_step">Wasmç®€è¦ä»‹ç»</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">ink!</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">ask!</a></li><li class="menu__list-item"><a class="menu__link" href="/substrate-contracts-book/solang/introduction">Solang</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Redspot</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Europa</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/introduction">introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/tutorial">Europaæ•™ç¨‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/execution_info">Europa åˆçº¦æ‰§è¡Œæ—¥å¿—åˆ†æ</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/sample">Europa è°ƒè¯•ç¤ºä¾‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/wasm_executor">Europa Wasm executor</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/wasm_backtrace">Europa çš„Wasm Backtrace</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Reports</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/reports">Europaè®®ä¼šææ¡ˆæŠ¥å‘Š</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/reports/v0.1Report">Europa v0.1 æŠ¥å‘Š</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/substrate-contracts-book/europa/reports/v0.2Report">Europa v0.2 æŠ¥å‘Š</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-contracts-book/europa/reports/v0.3Report">Europa v0.3æŠ¥å‘Š</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">zkMega</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Himalia</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Metis</a></li><li class="menu__list-item"><a class="menu__link" href="/substrate-contracts-book/carpo/introduction">Carpo</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Elara</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Jupiter</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">PatraStore</a></li><li class="menu__list-item"><a class="menu__link" href="/substrate-contracts-book/patract/introduction">Patract</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">Europa v0.2 æŠ¥å‘Š</h1></header><p>Patract Hub&#x27;s treasury report for Europa v0.2</p><p>Patract Hub (<a href="https://patract.io" target="_blank" rel="noopener noreferrer">https://patract.io</a>) develops local open source toolkits and one-stop cloud smart IDE, committed to provide free development toolkits and infrastructure services for the entire smart contract ecosystem. Six weeks ago, we applied a <a href="https://polkadot.polkassembly.io/motion/48" target="_blank" rel="noopener noreferrer">treasury proposal</a> for Europa v0.2 , and now we have finished the development (<a href="https://github.com/patractlabs/europa" target="_blank" rel="noopener noreferrer">https://github.com/patractlabs/europa</a>) . This repost shows what Europa v0.2 completion.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h2><p>Europa is kind of another implementation for <a href="https://github.com/paritytech/substrate/tree/master/client" target="_blank" rel="noopener noreferrer">Substrate client</a> in our design. We know that the runtime of a blockchain is the business logic that defines its behavior, and the Substrate runtime need to run by an executor and environment. So that we design the executor and environment more like a &quot;sandbox&quot; to run a Substrate runtime.</p><p>In v0.2, the primary target is to modify <code>FRAME Contracts pallet</code> in runtime to provide more detailed debugging information, including contract execution process information (in <code>FRAME Contracts</code> layer) and WASM execution information (in WASMI execution layer).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="summary-of-europas-v02-plan"></a>Summary of Europa&#x27;s v0.2 plan:<a class="hash-link" href="#summary-of-europas-v02-plan" title="Direct link to heading">#</a></h3><blockquote><ol><li><em>Modify at <code>FRAME Contracts pallet</code> level to provide more information.</em></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="how-to-verify-v02--github-source"></a>How to verify v0.2:  Github source<a class="hash-link" href="#how-to-verify-v02--github-source" title="Direct link to heading">#</a></h3><ul><li>Construct incorrect contracts and execute logs printing to determine whether it meets expectations</li><li>Display the call statistics of the <code>define_env!</code> interface during contract execution</li><li>Execute the log printing function, provide formatted printing examples of different data, and judge whether it meets expectations</li><li>Construct a contract that crashes under different conditions and record the log after execution. Then judge whether the backtrace information of the contract execution is completely printed, and check whether it matches the actual execution of the collapsed contract.</li></ul></blockquote><p>åæ–‡ç»Ÿä¸€ç§°<code>FRAME Contracts pallet</code>ä¸º<code>pallet-contracts</code>ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="design"></a>Design<a class="hash-link" href="#design" title="Direct link to heading">#</a></h2><p>åœ¨0.2ä¸­ï¼Œå¯¹äºåˆçº¦æ¨¡å—çš„è°ƒè¯•ä¿¡æ¯åŠŸèƒ½çš„æå‡åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†çš„ä¿®æ”¹ï¼š</p><ul><li><code>pallet-contracts</code>å±‚çš„ä¿®æ”¹ï¼šåœ¨<code>pallet-contracts</code>çš„æ‰§è¡Œåˆçº¦çš„è¿‡ç¨‹ä¸­æ·»åŠ traceè®°å½•åœ¨åˆçº¦å±‚ä¸­çš„ä¿¡æ¯ï¼Œå¹¶ä¸”è®°å½•åˆçº¦çš„è°ƒç”¨å±‚çº§ã€‚å¦ä¸€æ–¹é¢å®Œå–„äº†è°ƒç”¨wasmæ‰§è¡Œçš„é”™è¯¯ä¿¡æ¯ã€‚</li><li><code>wasmi</code>å±‚çš„ä¿®æ”¹ï¼šç»™äºˆ<code>wasmi</code>æä¾›äº†è®°å½•wasmæ‰§è¡Œä¸­çš„backtraceåŠŸèƒ½ï¼Œå¹¶ä¸”ç»™<code>parity-wasm</code>ï¼Œ<code>pwasm-utils</code>ï¼Œ<code>cargo-contract</code>æä¾›äº†æ”¯æŒåœ¨åˆçº¦çš„wasmå¤„ç†ä¸­åŒ…å«name sectionçš„åŠŸèƒ½ã€‚</li><li>åˆçº¦æ—¥å¿—åŠŸèƒ½ï¼šä½¿ç”¨<code>ChainExtensions</code>çš„åŠŸèƒ½å®ç°äº†åˆçº¦ä¸­æ‰“å°<code>log</code>æ—¥å¿—çš„åº“ã€‚</li></ul><p>å½“å‰åœ¨<code>pallet-contracts</code>ä¸­ï¼Œåœ¨<code>wasmi</code>ä¸­æ‰§è¡Œå‡ºç°é”™è¯¯ä»¥åŠwasmiæ‰§è¡Œè¿‡ç¨‹ä¸­è°ƒç”¨<code>pallet-contracts</code>çš„<a href="https://webassembly.github.io/spec/core/exec/runtime.html#function-instances" target="_blank" rel="noopener noreferrer">host_function</a>å‡ºç°é”™è¯¯çš„æ—¶å€™ï¼Œå¯¹å¤–éƒ½è¡¨ç°ä¸º<code>ContractTrap</code>ã€‚è¿™ä¸ªæƒ…å†µå¯¹äºå¼€å‘è€…å¾ˆéš¾å®šä½é”™è¯¯å‡ºç°çš„åŸå› ï¼Œä»…ä»è¿™ä¸ªä¿¡æ¯æ— æ³•åˆ†è¾¨å‡ºå‡ºç°é—®é¢˜çš„åœ°æ–¹æ˜¯åˆçº¦è‡ªèº«ï¼Œ<code>ink!</code>ï¼Œè¿˜æ˜¯<code>pallet-contracts</code>ã€‚å› æ­¤è¿™ä¸ªç‰ˆæœ¬çš„europaæä¾›çš„ä¸°å¯Œçš„ä¿¡æ¯ï¼Œèƒ½è®©å¼€å‘è€…ç›´æ¥å®šä½åˆ°å‡ºç°é—®é¢˜çš„åŸå› ä¸Šã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="pallet-contractså±‚"></a><code>pallet-contracts</code>å±‚<a class="hash-link" href="#pallet-contractså±‚" title="Direct link to heading">#</a></h3><p>europaè®¤ä¸ºåœ¨åˆçº¦è°ƒè¯•è¿‡ç¨‹éœ€è¦ï¼š</p><ol><li>ä¸°å¯Œé”™è¯¯ä¿¡æ¯ï¼šwasmè®°å½•æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ä¿¡æ¯çš„æƒ…å†µï¼ŒåŒ…å«wasmæ‰§è¡Œå™¨çš„é”™è¯¯ä»¥åŠhost_functionçš„é”™è¯¯ã€‚wasmiçš„backtraceä¿¡æ¯ä¼šå’Œè¿™é‡Œçš„é”™è¯¯ä¿¡æ¯ç»Ÿä¸€èµ·æ¥ã€‚</li><li>è°ƒè¯•è¿‡ç¨‹ä¸­çš„æ‰§è¡Œæƒ…å†µï¼š<code>pallet-contracts</code>çš„ä¸»è¦ä¿®æ”¹ä¿¡æ¯ï¼Œä»¥â€œåˆçº¦æ ˆâ€ä¸ºè®°å½•åˆçº¦è°ƒç”¨åˆçº¦çš„è¿‡ç¨‹ï¼Œä»¥åŠå½“å‰è¿™ä¸€å±‚åˆçº¦åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä»»ä½•èƒ½è¾…åŠ©è°ƒè¯•çš„ä¿¡æ¯ï¼Œä¾‹å¦‚è°ƒç”¨host_functionçš„æƒ…å†µï¼Œselectorï¼Œè°ƒç”¨åˆçº¦çš„å‚æ•°ç­‰ç­‰ã€‚</li></ol><p>å› æ­¤é’ˆå¯¹è¿™æ ·çš„éœ€æ±‚ï¼Œeuropaåšäº†å¦‚ä¸‹è®¾è®¡ä¸ä¿®æ”¹ï¼š</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ä¸°å¯Œé”™è¯¯ä¿¡æ¯"></a>ä¸°å¯Œé”™è¯¯ä¿¡æ¯<a class="hash-link" href="#ä¸°å¯Œé”™è¯¯ä¿¡æ¯" title="Direct link to heading">#</a></h4><ol><li><p>wasmæ‰§è¡Œå™¨å±‚çš„é”™è¯¯ï¼š</p><p>europaè®¾è®¡äº†è‡ªå·±çš„<code>ep-sandbox</code>æ›¿æ¢äº†åŸæœ¬<code>pallet-contracts</code>ä½¿ç”¨çš„<code>sp-sandbox</code>ï¼Œå¹¶ä¿®æ”¹<code>ep_sandbox::Error</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">use patract_wasmi::Error as WasmiError;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub enum Error {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Module(WasmiError),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    OutOfBounds,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Execution,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WasmiExecution(WasmiError),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>Module(WasmiError)</code>æºå¸¦wasmå±‚çš„åŸå§‹é”™è¯¯ä¿¡æ¯ï¼Œå¹¶ä¸”åœ¨ <code>frame/contracts/src/wasm/runtime.rs </code>ä¸­çš„ <code>to_execution_result</code>è½¬æ¢ä¸º <code>String</code>æŠ›å‡ºé”™è¯¯ä¿¡æ¯ã€‚</p><p>europaè‡ªå·±çš„<code>ep-sandbox</code>åªæœ‰<code>std</code>ç‰ˆæœ¬ï¼ˆå› ä¸ºeuropaå·²ç»ç§»é™¤äº†æ‰€æœ‰çš„WASMçš„éƒ¨åˆ†ï¼Œä¸éœ€è¦<code>ep-sandbox</code>æ”¯æŒ<code>no-std</code>ï¼‰ï¼Œå› æ­¤åœ¨å°†æ¥ï¼Œ<strong><code>ep-sandbox</code>å¯ä»¥æ›¿æ¢ä¸ºä¸åŒçš„wasmæ‰§è¡Œå™¨ï¼Œä»¥æ”¯æŒä¸åŒwasmæ‰§è¡Œå™¨çš„è¿è¡Œæµ‹è¯•åŠæ›¿æ¢ä¸ºæ”¯æŒdebugçš„wasmæ‰§è¡Œå™¨ç­‰ç‰¹æ€§ã€‚</strong></p><p>å½“å‰<code>ep-sandbox</code>ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªforkedç‰ˆæœ¬çš„<code>wasmi</code>ä½œä¸ºæ‰§è¡Œå™¨ï¼Œå› æ­¤å…¶æŠ›å‡ºçš„é”™è¯¯ä¸º<code>WasmiError</code>ã€‚å¯¹äº<code>wasmi</code>çš„é”™è¯¯æ”¹åŠ¨è§ä¸‹ä¸€ä¸ªç« èŠ‚ã€‚</p></li><li><p>host_functionçš„é”™è¯¯</p><p>hostå‡½æ•°æ‰§è¡Œé”™è¯¯ä¼šå¼•èµ·Trapï¼Œå¹¶ä¸”ä¼šè®°å½•<code>TrapReason</code>ã€‚å¯¹æ•°æ®ç»“æ„ä¸è¿›è¡Œä¿®æ”¹ï¼Œåªéœ€è¦è®°å½•å³å¯ã€‚</p></li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="è°ƒè¯•è¿‡ç¨‹ä¸­çš„æ‰§è¡Œæƒ…å†µ"></a>è°ƒè¯•è¿‡ç¨‹ä¸­çš„æ‰§è¡Œæƒ…å†µ<a class="hash-link" href="#è°ƒè¯•è¿‡ç¨‹ä¸­çš„æ‰§è¡Œæƒ…å†µ" title="Direct link to heading">#</a></h4><p>europa forked ç‰ˆæœ¬çš„<code>pallet-contracts</code>è®¾è®¡äº†ä¸€ä¸ªå¯¹è±¡è®°å½•åˆçº¦æ‰§è¡Œä¸­ä»»ä½•å¯ä»¥å¸®åŠ©è°ƒè¯•çš„ä¿¡æ¯ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// Record the contract execution context.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct NestedRuntime {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Current depth</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    depth: usize,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The current contract execute result</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ext_result: ExecResult,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The value in sandbox successful result</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    sandbox_result_ok: Option&lt;ReturnValue&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Who call the current contract</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    caller: AccountId32,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The account of the current contract</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    self_account: Option&lt;AccountId32&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The input selector</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    selector: Option&lt;HexVec&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The input arguments</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    args: Option&lt;HexVec&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The value in call or the endowment in instantiate</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    value: u128,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The gas limit when this contract is called</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    gas_limit: Gas,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The gas left when this contract return</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    gas_left: Gas,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The host function call stack</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    env_trace: EnvTraceList,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The error in wasm</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    wasm_error: Option&lt;WasmErrorWrapper&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The trap in host function execution</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    trap_reason: Option&lt;TrapReason&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Nested contract execution context</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    nest: Vec&lt;NestedRuntime&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>åœ¨<code>pallet-contracts</code>çš„æ¨¡å‹ä¸­ï¼Œåˆçº¦è°ƒç”¨åˆçº¦æ˜¯ä»¥â€œåˆçº¦æ ˆâ€çš„æ¨¡å‹è°ƒç”¨ï¼Œå› æ­¤<code>NestedRuntime</code>ä¼šè·Ÿè¸ªæ•´ä¸ªåˆçº¦æ ˆçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå¹¶ç”¨<code>nest</code>è¿™ä¸ªå±æ€§ä¿å­˜ä¸€ä¸ª<code>NestedRuntime</code>åˆ—è¡¨è¡¨ç¤ºå½“å‰åˆçº¦ä¸­è°ƒç”¨è¿‡çš„å…¶ä»–åˆçº¦ã€‚</p><p>åœ¨<code>pallet-contracts</code>æ‰§è¡Œä¸€ä¸ªåˆçº¦çš„è¿‡ç¨‹ä¸­ï¼Œeuropaä»¥æ—è·¯çš„å½¢æ€å°†æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ç›¸å…³ä¿¡æ¯è®°å½•åœ¨<code>NestedRuntime</code>è¿™ä¸ªç»“æ„ä½“ä¸­ï¼Œå¹¶åœ¨åˆçº¦è°ƒç”¨ç»“æŸåå°†<code>NestedRuntime</code>ä»¥ä¸€å®šæ ¼å¼åŒ–çš„å½¢å¼æ‰“å°åˆ°æ—¥å¿—ä¸­ï¼ˆå°†åæ–‡æ¡ˆä¾‹çš„å±•ç¤ºï¼‰ã€‚åˆçº¦çš„å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡åˆ†æ<code>NestedRuntime</code>æ‰“å°çš„ä¿¡æ¯ï¼Œå¾—åˆ°æ­¤æ¬¡åˆçº¦æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å„ç§è¯¦ç»†ä¿¡æ¯ï¼Œå¯ä»¥ç”¨äºå¤šç§æƒ…å†µï¼š</p><ol><li>è¾…åŠ©å®šä½é”™è¯¯å‡ºç°çš„å…·ä½“ä½ç½®ï¼ŒåŒ…æ‹¬ä»¥ä¸‹æƒ…å†µï¼š<ol><li><code>pallet-contracts</code>å±‚ï¼Œ</li><li><code>ink!</code>å±‚</li><li>åˆçº¦å±‚ä¸­çš„å…·ä½“ä½ç½®</li><li>åœ¨åˆçº¦è°ƒç”¨åˆçº¦çš„æƒ…å†µä¸‹å®šä½åˆçº¦å‡ºç°åœ¨å“ªä¸€çº§åˆçº¦ä¸­</li></ol></li><li>åˆ†ææ­¤æ—¶åˆçº¦æ‰§è¡Œè¿‡ç¨‹ä¸­ä¿¡æ¯ï¼š<ol><li>åˆ†ægasæ‰§è¡Œçš„æ¶ˆè€—æƒ…å†µ</li><li>åˆ†æ<code>get_storage</code>ï¼Œ<code>set_storage</code>è°ƒç”¨çš„æƒ…å†µï¼Œå¸®åŠ©é‡æ„åˆçº¦ä»£ç ä»¥åŠåˆ†æ<code>rent</code>çš„éœ€æ±‚æƒ…å†µ</li><li>æ ¹æ®<code>selector</code>ï¼Œ<code>args</code>å’Œ<code>value</code>åˆ†æå®šä½ç¬¬ä¸‰æ–¹sdkç»„å»ºäº¤æ˜“å‚æ•°æ˜¯å¦åˆæ³•ã€‚</li><li>æ ¹æ®<code>nest</code>ä¿¡æ¯å¹¶ç»“åˆ<code>seal_call</code>ä¿¡æ¯åˆ†æåˆçº¦è°ƒåˆçº¦çš„æ‰§è¡Œè·¯å¾„ã€‚</li><li>ç­‰ç­‰...</li></ol></li></ol><p>åœ¨<code>pallet-contracts</code>æ¨¡å—ä¸­è®°å½•åˆ°<code>NestEdRuntime</code>ä¸­çš„è¿‡ç¨‹æ˜¯æ¯”è¾ƒç»†ç²’åº¦çš„ï¼Œä»¥<code>define_env!</code>ä¸­çš„<code>seal_call</code>ä¸ºä¾‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct SealCall {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    callee: Option&lt;HexVec&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    gas: u64,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    value: Option&lt;u128&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    input: Option&lt;HexVec&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    output: Option&lt;HexVec&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å…¶ä¸­çš„å±æ€§åŸºæœ¬ä¸º<code>Option&lt;&gt;</code>ï¼Œæ¯”å¦‚å½“è°ƒç”¨åˆçº¦å‰æ—¶ä¼šè®¾ç½®<code>input</code>ä¸º<code>Some</code>ï¼Œè°ƒç”¨åˆçº¦æ­£å¸¸åæœ‰è¿”å›å€¼ï¼Œåˆ™ä¼šè®¾ç½®<code>output</code>ï¼Œå¦‚è°ƒç”¨åˆçº¦å‡ºç°é”™è¯¯åï¼Œåˆ™<code>output</code>ä¼šä¿æŒ<code>None</code>ã€‚å› æ­¤è‹¥å‡ºç°äº†<code>input</code>æ˜¯<code>Some</code>è€Œ<code>output</code>ä¸º<code>None</code>çš„æƒ…å†µï¼Œåˆ™è¯´æ˜åœ¨åˆçº¦è°ƒç”¨åˆçº¦çš„è¿‡ç¨‹ä¸­ï¼Œè¢«è°ƒç”¨çš„åˆçº¦å‡ºç°äº†é—®é¢˜ã€‚</p><p>å½“å‰<code>NestedRuntime</code>çš„ä¿¡æ¯åªåœ¨æ—¥å¿—ä¸­æ‰“å°ï¼Œ<strong>å°†æ¥<code>NestedRuntime</code>å°†ä¼šåšæœ¬åœ°åŒ–å­˜å‚¨å¹¶æä¾›ç›¸åº”çš„rpcä¾›å¤–éƒ¨è®¿é—®è·å–</strong>ã€‚å› æ­¤åœ¨å°†æ¥ç¬¬ä¸‰æ–¹åº”ç”¨å¯ä»¥è·å–<code>NestedRuntime</code>åšè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œä¾‹å¦‚åœ¨Redspotä¸­å¯ä»¥è®¾è®¡ä¸€ä¸ªæ’ä»¶æ ¹æ®<code>NestedRuntime</code>çš„ä¿¡æ¯ç”Ÿæˆä¸€ä¸ªåˆçº¦è°ƒç”¨åˆçº¦çš„æ‹“æ‰‘å›¾ï¼Œåœ¨webé’±åŒ…ç•Œé¢å¯ä»¥ç”Ÿæˆå¯è§†åŒ–åˆçº¦è°ƒç”¨è·¯å¾„ç­‰ç­‰ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="wasmiå±‚"></a><code>wasmi</code>å±‚<a class="hash-link" href="#wasmiå±‚" title="Direct link to heading">#</a></h3><p>æˆ‘ä»¬forkäº†wasmiï¼Œå¹¶å°†è¿™ä¸ªforkedç‰ˆæœ¬çš„wasmié›†æˆåˆ°äº†<code>ep-sandbox</code>ä¸­ã€‚è€Œforked <code>pallet-contracts</code>å¯ä»¥é€šè¿‡<code>ep-sandbox</code>è·å–åˆ°forked <code>wasmi</code>çš„é”™è¯¯ä¿¡æ¯ï¼ŒåŒ…å«<code>wasmi</code>çš„backtraceä¿¡æ¯ã€‚</p><p>å¦‚æœéœ€è¦è®©<code>wasmi</code>å…·å¤‡èƒ½å¤Ÿä¿ç•™æ‰§è¡Œçš„backtraceçš„ä¿¡æ¯ï¼Œéœ€è¦å…·å¤‡ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li>WASMæºæ–‡ä»¶ä¸­éœ€è¦æœ‰&quot;name section&quot;æ®µ ï¼ˆname section çš„è§„èŒƒè§ <a href="https://webassembly.github.io/spec/core/appendix/custom.html#name-section" target="_blank" rel="noopener noreferrer">â€œName Sectionâ€</a>ï¼‰</li><li>åœ¨<code>pallet-contracts</code>æ£€æŸ¥åˆçº¦çš„è¿‡ç¨‹ä¸­ä¿ç•™â€œname sectionâ€ä¿¡æ¯ä¸”åœ¨å¤„ç†è¿‡ç¨‹åä»å’Œwasmæºæ–‡ä»¶å…·å¤‡å¯¹åº”å…³ç³»ã€‚</li><li><code>wasmi</code>çš„æ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦æŠŠæ‰§è¡Œæ ˆä¿ç•™ä¸‹æ¥å¹¶é™„å¸¦å‡½æ•°çš„å…³é”®ä¿¡æ¯ï¼ŒåŒæ—¶&quot;name section&quot;éœ€è¦è¢«è§£æï¼Œä¸”å’Œ<code>wasmi</code>æ‰§è¡Œæ ˆä¿ç•™çš„å‡½æ•°ä¿¡æ¯å¯¹åº”èµ·æ¥ã€‚</li></ol><p>å¯¹äº2çš„æ”¹åŠ¨ï¼Œæ¶‰åŠ<code>cargo-build</code>ï¼Œ<code>parity-wasm</code>ï¼Œè€Œå¯¹äº1ï¼Œ3çš„æ”¹åŠ¨ä¸»è¦ä½äºforked çš„<code>wasmi</code>ä¸­ï¼Œå°‘éƒ¨åˆ†æ¶‰åŠ<code>pwasm-utils</code>ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="1-submitted-wasm-files-contains-debug-info-æäº¤çš„wasmæºæ–‡ä»¶ä¸­æœ‰name-sectionæä¾›debug-info"></a>1. Submitted WASM files contains debug info æäº¤çš„WASMæºæ–‡ä»¶ä¸­æœ‰â€œname sectionâ€æä¾›debug info<a class="hash-link" href="#1-submitted-wasm-files-contains-debug-info-æäº¤çš„wasmæºæ–‡ä»¶ä¸­æœ‰name-sectionæä¾›debug-info" title="Direct link to heading">#</a></h4><ul><li>PR: <a href="https://github.com/paritytech/cargo-contract/pull/131" target="_blank" rel="noopener noreferrer">paritytech/cargo-contract#131</a></li><li>Source: <a href="https://github.com/patractlabs/cargo-contract" target="_blank" rel="noopener noreferrer">patractlabs/cargo-contract</a></li></ul><p>Frist of all, we have to submit <strong>wasm files which contain the debug info</strong> that the on-chain side can parse and get the panic errors.</p><p>Currently, <a href="https://github.com/patractlabs/cargo-contract" target="_blank" rel="noopener noreferrer">parity/cargo-contract</a> trims debug info while building contracts, we can get them back with the following steps.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="11-keep-name-section-from-striping"></a>1.1 Keep name section from striping<a class="hash-link" href="#11-keep-name-section-from-striping" title="Direct link to heading">#</a></h5><p>The name section has been striped at <a href="https://github.com/paritytech/cargo-contract/blob/71525f9ec5f21e6113a614c2fb4d1eb5e62ebf8b/src/cmd/build.rs#L247" target="_blank" rel="noopener noreferrer">cargo-contract/cmd/build.rs#L247</a>.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="12-keep-debug-info-from-wasm-opt"></a>1.2 Keep debug info from <code>wasm-opt</code><a class="hash-link" href="#12-keep-debug-info-from-wasm-opt" title="Direct link to heading">#</a></h5><p><code>cargo-contract</code> passes <code>debug_info: false</code> to <code>wasm-opt</code>, so the debug-info will be always optimized when we run <code>wasm-opt</code>, the code is here: <a href="https://github.com/paritytech/cargo-contract/blob/71525f9ec5f21e6113a614c2fb4d1eb5e62ebf8b/src/cmd/build.rs#L267" target="_blank" rel="noopener noreferrer">cargo-contract/cmd/build.rs#L267</a>.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="13-keep-debug-info-from-rustc"></a>1.3 Keep debug info from <code>rustc</code><a class="hash-link" href="#13-keep-debug-info-from-rustc" title="Direct link to heading">#</a></h5><p><code>cargo-contract</code> executes realease build by default, here we can enable debug build or modify the opt-level flag of <code>rustc</code> to keep debug infos at <a href="https://github.com/paritytech/cargo-contract/blob/71525f9ec5f21e6113a614c2fb4d1eb5e62ebf8b/src/cmd/build.rs#L137" target="_blank" rel="noopener noreferrer">cargo-contract/cmd/build.rs#L137</a>.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2-save-debug-info-from-the-scraper-of-pallet-contracts"></a>2. Save debug info from the scraper of <code>pallet-contracts</code><a class="hash-link" href="#2-save-debug-info-from-the-scraper-of-pallet-contracts" title="Direct link to heading">#</a></h4><p>What happends to the <code>pallet-contracts</code> while we calling a contract?</p><ul><li><strong>Get the WASM binary from storage</strong></li><li><strong>Inject gas meter to the contract</strong></li><li>Inject stack height to the contract</li><li>Put the contract into <code>sp-sandbox</code> and execute it</li><li>Get the result from <code>sp-sandbox</code> and return the result to us</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="21-store-name-section-while-building-wasm-module"></a>2.1 Store name section while building WASM module<a class="hash-link" href="#21-store-name-section-while-building-wasm-module" title="Direct link to heading">#</a></h5><ul><li>PR: <a href="https://github.com/paritytech/parity-wasm/pull/300" target="_blank" rel="noopener noreferrer">https://github.com/paritytech/parity-wasm/pull/300</a></li></ul><p><code>pallet-contracts</code> builds WASM modules from storage and drops custom sections by default, here we should get them back.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="22-update-function-indices-in-name-section-while-injecting-gas-meter"></a>2.2 Update function indices in name section while injecting gas meter<a class="hash-link" href="#22-update-function-indices-in-name-section-while-injecting-gas-meter" title="Direct link to heading">#</a></h5><ul><li>PR: <a href="https://github.com/paritytech/wasm-utils/pull/146" target="_blank" rel="noopener noreferrer">paritytech/wasm-utils#146</a></li><li>Source: <a href="https://github.com/patractlabs/wasm-utils" target="_blank" rel="noopener noreferrer">patractlabs/wasm-utils#146</a></li></ul><p><code>pallet-contracts</code> reorders the indcies of functions in our WASM contracts after injecting gas memter to the WASM contracts at <a href="https://github.com/paritytech/wasm-utils/blob/d9432bafa9321f8e0e5b8a143f1ed858dbbbe272/src/gas/mod.rs#L467" target="_blank" rel="noopener noreferrer">paritytech/wasm-utils/gas/mod.rs#L467</a>, this will mess up the function indecies in name section that we can not get the correct backtraces.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="3-impelment-wasm-backtrace-to-wasmi"></a>3. Impelment WASM backtrace to WASMI<a class="hash-link" href="#3-impelment-wasm-backtrace-to-wasmi" title="Direct link to heading">#</a></h4><ul><li>Source: <a href="https://github.com/patractlabs/wasmi" target="_blank" rel="noopener noreferrer">patractlabs/wasmi</a></li></ul><p>Remember the last two steps in chapter 2, the core part of enabling WASM backtrace to pallet-contract is making <code>wasmi</code> support backtrace.</p><p>The process of executing a function in the interpreter of wasmi is like:</p><ul><li>Invoke the target function</li><li>call and call and call over again<ul><li>Panic if the process breaks.</li></ul></li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="31-add-function-info-field-to-funcref"></a>3.1 Add function info field to <code>FuncRef</code><a class="hash-link" href="#31-add-function-info-field-to-funcref" title="Direct link to heading">#</a></h5><p><code>FuncRef</code> is the &#x27;function&#x27; wasmi interpreter calling directly, so we need to embed the debug info into the <code>FuncRef</code> as the first time, source at <a href="https://github.com/patractlabs/wasmi/blob/v0.6.2/src/func.rs#L26" target="_blank" rel="noopener noreferrer">wasmi/func.rs#L26</a>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">//! patractlabs/wasmi/src/func.rs#L26</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct FuncRef {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Function name and index for debug</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    info: Option&lt;(usize, String)&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="32-set-function-info-using-name-section-while-parsing-wasm-modules"></a>3.2 Set function info using name section while parsing WASM modules<a class="hash-link" href="#32-set-function-info-using-name-section-while-parsing-wasm-modules" title="Direct link to heading">#</a></h5><p>We alread have the <code>info</code> field in <code>FuncRef</code>, now we need to fill this field using name setciton while parsing WASM modules, source at <a href="https://github.com/patractlabs/wasmi/blob/7a6feaea70f47aa6e62f097fb0d9a4ea0ce7d1fc/src/runner.rs#L1491" target="_blank" rel="noopener noreferrer">wasmi/module#L343</a>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">//! wasmi/src/module.rs#L343</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if has_name_section {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     if let Some(name) = function_names.get((index + import_count) as u32) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         func_instance = func_instance.set_info(index, name.to_string());</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     } else {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         func_instance = func_instance.set_info(index, &quot;&lt;unknown&gt;&quot;.to_string());</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// ...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="33-make-the-interpreter-support-trace"></a>3.3 Make the interpreter support <code>trace</code><a class="hash-link" href="#33-make-the-interpreter-support-trace" title="Direct link to heading">#</a></h5><p>However, we don&#x27;t need to get infos of every functions but the panicked series in the stack of the interpreter, source at <a href="https://github.com/patractlabs/wasmi/blob/7a6feaea70f47aa6e62f097fb0d9a4ea0ce7d1fc/src/runner.rs#L1491" target="_blank" rel="noopener noreferrer">wasmi/runner.rs#L1491</a>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">//! wasmi/src/runner.rs#L1491</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/// Get the functions of current the stack</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn trace(&amp;self) -&gt; Vec&lt;Option&lt;&amp;(usize, String)&gt;&gt; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    self.buf.iter().map(|f| f.info()).collect::&lt;Vec&lt;_&gt;&gt;()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="34-gather-debug-infos-when-program-breaks"></a>3.4 Gather debug infos when program breaks<a class="hash-link" href="#34-gather-debug-infos-when-program-breaks" title="Direct link to heading">#</a></h5><p>Just gather backtraces when we invoke function failed, source at <a href="https://github.com/patractlabs/wasmi/blob/7a6feaea70f47aa6e62f097fb0d9a4ea0ce7d1fc/src/func.rs#L170" target="_blank" rel="noopener noreferrer">wasmi/func.rs#L170</a>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">//! wasmi/src/func.rs#L170</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">let res = interpreter.start_execution(externals);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if let Err(trap) = res {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">let mut stack = interpreter</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    .trace()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    .iter()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    .map(|n| {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        if let Some(info) = n {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            format!(&quot;{:#}[{}]&quot;, rustc_demangle::demangle(&amp;info.1), info.0)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;&lt;unknown&gt;&quot;.to_string()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    })</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    .collect::&lt;Vec&lt;_&gt;&gt;();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Append the panicing trap</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">stack.append(&amp;mut trap.wasm_trace().clone());</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">stack.reverse();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Embed this info into the trap</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Err(trap.set_wasm_trace(stack))</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// ...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="åˆçº¦æ—¥å¿—åŠŸèƒ½"></a>åˆçº¦æ—¥å¿—åŠŸèƒ½<a class="hash-link" href="#åˆçº¦æ—¥å¿—åŠŸèƒ½" title="Direct link to heading">#</a></h3><p>åœ¨åˆçº¦è°ƒè¯•çš„è¿‡ç¨‹ä¸­éœ€è¦çŸ¥é“åˆçº¦æ‰§è¡Œå†…éƒ¨çš„æ‰§è¡Œæƒ…å†µä»¥åŠä¸­é—´æ•°æ®ï¼Œåœ¨å½“å‰ç¼ºä¹debug è°ƒè¯•æ¡ä»¶çš„æƒ…å†µä¸‹ï¼ˆä¾‹å¦‚ä½¿ç”¨gdbè¿›è¡Œè°ƒè¯•ï¼‰ï¼Œé€šè¿‡æ—¥å¿—æ‰“å°æ˜¯æœ€æ–¹ä¾¿çš„æ–¹å¼ã€‚æ­£å¦‚åœ¨europa v0.2 proposalä¸­æåˆ°çš„ï¼Œå½“å‰<code>pallet-contracts</code>ä¸<code>ink!</code>å·²ç»æ”¯æŒäº†<code>format!</code>+<code>seal_println</code>çš„æ–¹å¼æ ¼å¼åŒ–æ‰“å°å­—ç¬¦ä¸²ï¼Œä½†æ˜¯é€šè¿‡è¿™ç§æ¨¡å¼æœ‰2ä¸ªç¼ºé™·ï¼š</p><ol><li><code>seal_println</code>çš„æ‰€æœ‰æ‰“å°åœ¨èŠ‚ç‚¹ç«¯ä¸º<code>target: runtime</code>ä¸”çº§åˆ«<code>DEBUG</code>çš„æ—¥å¿—ï¼Œä½†æ˜¯ä½†å¼€å‘å¤æ‚åˆçº¦çš„æ—¶å€™å°†ä¼šæ‰“å°å¾ˆå¤šçš„æ—¥å¿—ï¼Œå¦‚æœä¸èƒ½é€šè¿‡<code>target</code>ä»¥åŠæ—¥å¿—çº§åˆ«æ¥è¿‡æ»¤æ—¶ï¼Œé‚£ä¹ˆå¼€å‘çš„è¿‡ç¨‹ä¸­å°†ä¼šå……æ–¥ç€æ— å…³ä¿¡æ¯çš„å¹²æ‰°ã€‚</li><li>åˆçº¦å¼€å‘è€…åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­åœ¨éœ€è¦çš„æ—¶å€™ç¼–å†™äº†<code>seal_println</code>ï¼Œä½†æ˜¯åœ¨åˆçº¦å‘å¸ƒçš„æ—¶å€™éœ€è¦æŠŠ<code>seal_println</code>å…¨éƒ¨åˆ é™¤ã€‚è™½ç„¶åˆçº¦å¼€å‘è€…å¯ä»¥è‡ªå·±å°è£…ä¸€ä¸ªæ¡ä»¶ç¼–è¯‘çš„å‡½æ•°æ¥æ§åˆ¶ï¼Œä½†æ˜¯è‹¥æœ‰å·¥å…·åº“å·²ç»æä¾›äº†è¿™æ ·çš„åŠŸèƒ½åˆ™æ›´åŠ æ–¹ä¾¿ã€‚</li></ol><p>å› æ­¤europaæä¾›äº†ä¸€ä¸ªæ¨¡ä»¿rustçš„<code>log</code> creteçš„æ—¥å¿—åº“<a href="https://github.com/patractlabs/ink-log" target="_blank" rel="noopener noreferrer"><code>ink-log</code></a>æ¥è§£å†³ä»¥ä¸Šé—®é¢˜ï¼Œå…¶ä½¿ç”¨æ–¹å¼ä¸rustä¸­çš„<code>log</code>å®Œå…¨ä¸€è‡´ï¼Œå‡å°‘äº†å¼€å‘è€…çš„å­¦ä¹ æˆæœ¬ã€‚</p><p><code>ink-log</code>æ€»ä½“ä¸Šé€šè¿‡<code>pallet-contracts</code>çš„<code>ChainExtension</code>å®ç°ï¼Œçº¦å®šçš„çš„<code>function_id</code>ä¸º<code>0xfeffff00</code>ï¼Œé€šè¿‡ç»“æ„ä½“<code>LoggerExt</code>åœ¨wasmçš„memoryä¸­ä¼ é€’æ¶ˆæ¯ã€‚å› æ­¤è¿™ä¸ªåº“åˆ†ä¸ºä»¥ä¸‹ä¸¤éƒ¨åˆ†ï¼š</p><ol><li><p><code>ink_log</code>ï¼š åœ¨<code>ink-log/contracts</code>ç›®å½•ä¸‹ï¼Œç»™åˆçº¦çš„ç¼–å†™æä¾›<code>info!</code>, <code>debug!</code>, <code>warn!</code>, <code>error!</code>, <code>trace!</code>è¿™å‡ ä¸ªä¸rust çš„<code>log</code>åº“ä¸€æ ·çš„å®ï¼Œä¸”å®çš„è°ƒç”¨æ–¹å¼ä¹Ÿä¸<code>log</code>å®Œå…¨ä¸€è‡´ã€‚è¿™äº›å®æ˜¯å¯¹inkç«¯çš„<code>seal_chain_extensions</code>çš„åŒ…è£…å®ç°ï¼Œæ˜¯<strong>ç»™åˆçº¦å¼€å‘è€…ä½¿ç”¨çš„å·¥å…·åº“</strong>ã€‚ä¾‹å¦‚åœ¨åˆçº¦çš„<code>Cargo.toml</code>å¼•å…¥äº†è¿™ä¸ªåº“åï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼æ‰“å°æ—¥å¿—ï¼š</p><p>åœ¨<code>Cargo.toml</code>ä¸­:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cargo"><pre tabindex="0" class="prism-code language-cargo codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[dependencies]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ink_log = { version = &quot;0.1&quot;, git = &quot;https://github.com/patractlabs/ink-log&quot;, default-features = false, features = [&quot;ink-log-chain-extensions&quot;] }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[features]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">default = [&quot;std&quot;]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">std = [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;ink_log/std&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>åœ¨åˆçº¦ä¸­åˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼åœ¨èŠ‚ç‚¹ä¸­æ‰“å°æ—¥å¿—ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">ink_log::info!(target: &quot;flipper-contract&quot;, &quot;latest value is: {}&quot;, self.value);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p><code>runtime_log</code>ï¼šåœ¨<code>ink-log/runtime</code>ç›®å½•ä¸‹ï¼Œè¿™ä¸ªåº“æ˜¯æ ¹æ®ä»<code>ChainExtensions</code>ä¼ é€’è¿‡æ¥çš„<code>function_id</code>å’Œ<code>LoggerExt</code>ç»“æ„ä½“çš„å†…å®¹ï¼Œè°ƒç”¨<code>frame_support</code>é‡Œçš„<code>debug</code>ä¸‹çš„ç›¸åº”æ—¥å¿—è¿›è¡Œæ‰“å°ã€‚æ˜¯<strong>ç»™é“¾çš„å¼€å‘è€…å‡†å¤‡çš„<code>ink_log</code>çš„å®ç°åº“ã€‚</strong>ä¾‹å¦‚é“¾çš„å¼€å‘è€…å¯ä»¥åœ¨è‡ªå·±çš„<code>ChainExtensions</code>ä¸­ä½¿ç”¨ï¼š</p><p>åœ¨<code>Cargo.toml</code>ä¸­ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[dependencies]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">runtime_log = { version = &quot;0.1&quot;, git = &quot;https://github.com/patractlabs/ink-log&quot;, default-features = false }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[features]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">default = [&quot;std&quot;]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">std = [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # ...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;runtime_log/std&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>åœ¨<code>ChainExtensions</code>çš„å®ç°ä½“ä¸­ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct CustomExt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">impl ChainExtension for CustomExt {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    fn call&lt;E: Ext&gt;(func_id: u32, env: Environment&lt;E, InitState&gt;) -&gt; Result&lt;RetVal, DispatchError&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    where</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &lt;E::T as SysConfig&gt;::AccountId: UncheckedFrom&lt;&lt;E::T as SysConfig&gt;::Hash&gt; + AsRef&lt;[u8]&gt;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        match func_id {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            ... =&gt; {/* other ChainExtension */ }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            0xfeffff00 =&gt; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                // TODO add other libs</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                runtime_log::logger_ext!(func_id, env);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                // or use</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                // LoggerExt::call::&lt;E&gt;(func_id, env)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                Ok(RetVal::Converging(0))</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }   </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ol><p><strong><code>ink_log</code>ä¸<code>runtime_log</code>ç›¸å¯¹åº”ï¼Œå› æ­¤è‹¥åˆçº¦å¼€å‘è€…éœ€è¦ä½¿ç”¨<code>ink_log</code>çš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„è°ƒè¯•åˆçº¦å¯¹åº”çš„é“¾éœ€è¦å®ç°äº†<code>runtime_log</code>ã€‚</strong></p><p>å¦ä¸€æ–¹é¢åˆçº¦å¼€å‘è€…å¼•å…¥<code>ink_log</code>åï¼Œéœ€è¦æ³¨æ„<code>features = [&quot;ink-log-chain-extensions&quot;]</code>ï¼Œ<code>ink_log</code>åªæœ‰å¼€å¯äº†è¿™ä¸ªfeatureæ‰ä¼šè°ƒç”¨<code>seal_chain_extensions</code>ä¸é“¾è¿›è¡Œäº¤äº’ã€‚è‹¥æ²¡æœ‰è¿™ä¸ªfeaturesåˆ™ä¼šä½¿ç”¨<code>noop</code>è·³è¿‡åˆçº¦æ‰“å°çš„è¿‡ç¨‹ã€‚</p><p>å› æ­¤åˆçº¦å¼€å‘è€…å¯ä»¥é€šè¿‡featuresæ§åˆ¶åˆçº¦åœ¨è°ƒè¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒä¸­æ‰“å°æ—¥å¿—ï¼Œåœ¨è°ƒè¯•ç¯å¢ƒä¸­ç¼–è¯‘çš„åˆçº¦å¼€å¯<code>&quot;ink-log-chain-extensions&quot;</code>featureï¼Œè€Œåœ¨ç”Ÿäº§ç¯å¢ƒç¼–è¯‘çš„åˆçº¦å»æ‰è¿™ä¸ªfeatureã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="what-europa-can-do-in-this-version"></a>What Europa can do in this version<a class="hash-link" href="#what-europa-can-do-in-this-version" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="build"></a>Build<a class="hash-link" href="#build" title="Direct link to heading">#</a></h3><p>å¯¹äºåˆçº¦çš„å¼€å‘è€…è€Œè¨€ï¼Œéœ€è¦å‡†å¤‡<code>europa</code>å’Œ<code>cargo-contract</code>å·¥å…·ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="europa"></a>europa<a class="hash-link" href="#europa" title="Direct link to heading">#</a></h4><p>The building process for this project is as same as <a href="https://github.com/paritytech/substrate/" target="_blank" rel="noopener noreferrer">Substrate</a>.</p><p>When building finished, current executable file in <code>target</code> directory is named <code>europa</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> clone --recurse-submodules https://github.com/patractlabs/europa.git</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="cargo-contract"></a>cargo-contract<a class="hash-link" href="#cargo-contract" title="Direct link to heading">#</a></h4><p>è‹¥å¸Œæœ›åœ¨europaçš„è¿è¡Œä¸­çœ‹åˆ°WASMæ‰§è¡Œçš„backtraceï¼Œå¿…é¡»ä½¿ç”¨æˆ‘ä»¬æä¾›çš„<code>cargo-contract</code>ç‰ˆæœ¬ã€‚å› ä¸ºå½“å‰paritytech ä»“åº“ä¸‹ <a href="https://github.com/paritytech/cargo-contract" target="_blank" rel="noopener noreferrer">cargo-contract</a>ç¼–è¯‘åˆçº¦æ—¶ä½¿ç”¨äº†æœ€é«˜çº§åˆ«çš„ä¼˜åŒ–ç­‰çº§ï¼Œä¸”ä¸¢å¼ƒäº†WASMä¸­çš„â€œname sectionâ€éƒ¨åˆ†ã€‚ä¸Šæ–‡æåˆ°è‹¥éœ€è¦æ‰“å°wasmiæ‰§è¡Œåˆçº¦ä¸­çš„è°ƒç”¨æ ˆä¿¡æ¯å¿…é¡»è¦æ±‚åˆçº¦æ–‡ä»¶å…·å¤‡â€œname sectionâ€çš„éƒ¨åˆ†ï¼Œå› æ­¤ä½¿ç”¨paritytechæä¾›çš„<code>cargo-contract</code>ä¸èƒ½æ»¡è¶³è¦æ±‚ã€‚æˆ‘ä»¬åœ¨è‡ªå·±çš„forkçš„ä»“åº“é‡Œå®Œæˆçš„è¿™ä¸ªåŠŸèƒ½ï¼Œè€Œå¦ä¸€æ–¹é¢æˆ‘ä»¬è®¤ä¸ºè®©WASMå…·å¤‡â€œname sectionâ€çš„åŠŸèƒ½æˆ–è®¸ä¸ä¼šåªæœ‰europaéœ€è¦ï¼Œå› æ­¤æˆ‘ä»¬å‘æºä»“åº“æäº¤äº†<a href="https://github.com/paritytech/cargo-contract/pull/131" target="_blank" rel="noopener noreferrer">pr#131[Enable debug info with flag in command build] </a>æä¾›äº†è¿™ä¸ªåŠŸèƒ½ã€‚</p><p>åœ¨è¿™ä¸ªpræœªåˆå¹¶å‰ï¼Œå½“å‰åªèƒ½ä½¿ç”¨æˆ‘ä»¬ï¼ˆPatract Labsï¼‰æä¾›çš„<code>cargo-contract</code>ç‰ˆæœ¬ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cargo </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> --git https://github.com/patractlabs/cargo-contract --branch cmd/debug --force</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å¦‚æœä¸å¸Œæœ›è¿™ä¸ªç‰ˆæœ¬çš„<code>cargo-contract</code>è¦†ç›–paritytechå‘å¸ƒçš„ç‰ˆæœ¬ï¼Œé‚£ä¹ˆå»ºè®®æœ¬åœ°ç¼–è¯‘ï¼Œå¹¶ç›´æ¥ä½¿ç”¨ç¼–è¯‘äº§ç‰©<code>cargo-contract</code>ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> clone https://github.com/patractlabs/cargo-contract --branch cmd/debug</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> cargo-contract</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cargo build --release</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><blockquote><p>æ³¨ï¼šæ‰§è¡Œ<code>cargo-contract build </code>å‘½ä»¤éœ€è¦rustç¼–è¯‘é“¾çš„<code>default toolchain</code>ä¸º<code>nightly</code>ï¼Œå¦åˆ™åªèƒ½ä½¿ç”¨<code>cargo +nightly contract build</code>ï¼Œä½†æ˜¯ä½¿ç”¨<code>cargo</code>è°ƒç”¨<code>cargo-contract</code>éœ€è¦æ‰§è¡Œ<code>cargo install</code>å®‰è£…æˆ–è€…å°†ç¼–è¯‘äº§ç‰©è¦†ç›–åˆ°<code>~/.cargo/bin</code>ç›®å½•ä¸‹ï¼Œä¸èƒ½å’Œparitytechçš„<code>cargo-contract</code>å…±å­˜</p></blockquote><p>æ‰§è¡Œ</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cargo-contract build --help</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># or</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cargo +nightly contract build --help</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è‹¥èƒ½çœ‹åˆ°</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">FLAGS:</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -d, --debug      </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Emits debug info into wasm </span><span class="token function" style="color:rgb(130, 170, 255)">file</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>åˆ™è¡¨ç¤ºæ­£åœ¨ä½¿ç”¨Patract Labsæä¾›çš„<code>cargo-contract</code>ï¼Œè‹¥å¸Œæœ›ä½¿ç”¨europaçš„è¿‡ç¨‹ä¸­èƒ½çœ‹åˆ°WASMåˆçº¦æ‰§è¡Œå´©æºƒçš„backtraceï¼Œéœ€è¦ç¼–è¯‘åˆçº¦çš„æ—¶å€™åŠ ä¸Š<code>--debug</code>å‘½ä»¤ã€‚</p><p>ä½¿ç”¨<code>--debug</code>å‘½ä»¤å°†ä¼šåœ¨åŸæœ¬ç¼–è¯‘åˆçº¦çš„<code>target/ink</code>ç›®å½•ä¸­ï¼Œç”Ÿæˆé™¤äº†æ­£å¸¸æ–‡ä»¶ä»¥å¤–çš„å¦ä¸€ä¸ªæ–‡ä»¶ï¼Œä»¥ <code>*.src.wasm</code>ç»“å°¾ã€‚è¿™ä¸ª<code>*.src.wasm</code>æ–‡ä»¶å°±æ˜¯å«æœ‰&quot;name section&quot;éƒ¨åˆ†çš„WASMåˆçº¦æ–‡ä»¶ã€‚</p><p><strong>è‹¥éœ€è¦ä½¿ç”¨europaåšæµ‹è¯•ï¼Œåˆ™éƒ¨ç½²åˆ°europaçš„åˆçº¦éœ€è¦ä½¿ç”¨è¿™ä¸ª<code>*.src.wasm</code>æ–‡ä»¶ï¼Œè€Œä¸æ˜¯åŸæœ¬ç”Ÿæˆçš„<code>*.wasm</code>æ–‡ä»¶ã€‚</strong></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="example"></a>example<a class="hash-link" href="#example" title="Direct link to heading">#</a></h3><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ¡ˆä¾‹å’Œå…¶ä»–å·²ç»é‡åˆ°è¿‡çš„æ¡ˆä¾‹æ¥éªŒè¯europaå®šä½é—®é¢˜çš„å¯é æ€§ã€‚</p><p>åœ¨åæ–‡ä¸­å¯åŠ¨europaçš„æ–¹å¼å‡ä½¿ç”¨</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ europa --tmp -lruntime</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">debug</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿™ç§æ–¹å¼æ¯æ¬¡å¯åŠ¨çš„ europa éƒ½å…¨æ–°çš„æ•°æ®ã€‚è‹¥æƒ³ä¿ç•™europaæ‰§è¡Œçš„æ•°æ®ï¼Œè¯·å‚è€ƒeuropa çš„<a href="https://github.com/patractlabs/europa" target="_blank" rel="noopener noreferrer">README</a>æˆ–è€…europa v0.1çš„<a href="https://polkadot.polkassembly.io/post/166" target="_blank" rel="noopener noreferrer">æŠ¥å‘Š</a>ï¼Œå¯ä»¥è·å¾—æ›´å¤šçš„å‘½ä»¤ä»‹ç»ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="æ¡ˆä¾‹1ï¼šç®€å•æ¡ˆä¾‹"></a>æ¡ˆä¾‹1ï¼šç®€å•æ¡ˆä¾‹<a class="hash-link" href="#æ¡ˆä¾‹1ï¼šç®€å•æ¡ˆä¾‹" title="Direct link to heading">#</a></h4><p>ä¾‹å¦‚æˆ‘ä»¬ä¿®æ”¹<a href="https://github.com/paritytech/ink" target="_blank" rel="noopener noreferrer">ink!</a>é¡¹ç›®ä¸­çš„æ¡ˆä¾‹åˆçº¦<code>ink/example/erc20</code>å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[ink(message)]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn transfer(&amp;mut self, to: AccountId, value: Balance) -&gt; Result&lt;()&gt; {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let from = self.env().caller();</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    self.transfer_from_to(from, to, value)?;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    panic!(&quot;123&quot;);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(())</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ç”±äºåˆçº¦ç¼–è¯‘æˆWASMåå¯¹åº”çš„æ˜¯åŸæ–‡ä»¶å°†å®å±•å¼€åçš„ä»£ç ï¼Œå› æ­¤è‹¥æƒ³è¦å¯¹æ¯”è°ƒç”¨æ ˆçš„é”™è¯¯ï¼Œéœ€è¦å°†åŸåˆçº¦çš„å®å±•å¼€ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cargo </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">expand</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> ink/example/erc20</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cargo </span><span class="token function" style="color:rgb(130, 170, 255)">expand</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> tmp.rs</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>é€šè¿‡é˜…è¯»<code>tmp.rs</code>æ–‡ä»¶åï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“WASMæ‰§è¡Œåˆ°<code>transfer</code>å‡½æ•°æ—¶éœ€è¦ç»è¿‡ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn call</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> -</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> u32 </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">Erc20 as ::ink_lang::DispatchUsingMode</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::dispatch_using_mode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;</span><span class="token plain">Erc20 as ::ink_lang::ConstructorDispatcher</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::Type as ::ink_lang::Execute</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::execute</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># compile selector at here</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> ::ink_lang::execute_message_mut</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> move </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">state: </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">mut Erc20</span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">. </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># a closure</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">__ink_Msg</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> 2644567034usize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> as ::ink_lang::MessageMut</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::CALLABLE</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> transfer</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å› æ­¤è‹¥åˆçº¦è°ƒç”¨è¿‡ç¨‹ä¸­é‡åˆ°äº†<code>transfer</code>ä¸­çš„<code>panic</code>æ—¶ï¼ŒWASMçš„backtraceåº”è¯¥å’Œè¿™ä¸ªç›¸è¿‘ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬å¯åŠ¨europa:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ europa --tmp -lruntime</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">debug</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ç„¶åæˆ‘ä»¬éƒ¨ç½²è¿™ä¸ªerc20å¹¶è°ƒç”¨transferæ‰§è¡Œã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<a href="https://polkadot.js.org/apps" target="_blank" rel="noopener noreferrer"><code>Polkadot/Substrate Portal</code></a>æˆ–è€…ä½¿ç”¨<a href="https://redspot.patract.io/en/tutorial/" target="_blank" rel="noopener noreferrer">RedSpot</a>æ¥éªŒè¯è¿™ä¸ªè¿‡ç¨‹ã€‚å‡è®¾æˆ‘ä»¬ä½¿ç”¨<code>RedSpot</code>æ¥æ‰§è¡Œä¸€æ¬¡è¿™ä¸ªé”™è¯¯çš„ERC20åˆçº¦çš„<code>transfer</code>è°ƒç”¨ï¼Œè¯·æ³¨æ„åœ¨ç¼–è¯‘åˆçº¦çš„è¿‡ç¨‹ä¸­ä¸€å®šéœ€è¦åŠ ä¸Š<code>--debug</code>å­å‘½ä»¤ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ npx redspot-new erc20</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> erc20/contracts</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># add panic in `transfer` function as abrove</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token function" style="color:rgb(130, 170, 255)">vim</span><span class="token plain"> lib.rs </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># notice must add --debug when compile contract</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># due current cargo-contract is not paritytech, we need to copy compile product into `artifacts` directory. RedSpot would support europa and PatractLabs&#x27;s cargo-contract in next version.</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ cargo +nightly contract build --debug </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token function" style="color:rgb(130, 170, 255)">mkdir</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">/artifacts</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># notice must cp erc20.src.wasm, not erc20.wasm</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token function" style="color:rgb(130, 170, 255)">cp</span><span class="token plain"> ./target/ink/erc20.src.wasm </span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">/artifacts  </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># notice must rename metadata.json to erc20.json</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token function" style="color:rgb(130, 170, 255)">cp</span><span class="token plain"> ./target/ink/metadata.json </span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">/artifacts/erc20.json </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">/</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># enter redspot console, use `--no-compile` to deny recompile contract</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ npx redspot console --no-compile  </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># in redspot console</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Welcome to Node.js v12.16.1.Type </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;.help&quot;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">more</span><span class="token plain"> information.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> var factory </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> await patract.getContractFactory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;erc20&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># do following command could deploy the erc20 contract</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> var contract </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> await factory.deployed</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;new&#x27;</span><span class="token plain">, </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;1000000&#x27;</span><span class="token plain">, </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">value: </span><span class="token number" style="color:rgb(247, 140, 108)">20000000000</span><span class="token plain">, salt:1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># do a transfer call directly</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> await contract.transfer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;5GcTYx4dPTQfi4udKPvE4VKmbooV7zY6hNYVF9JXHJL4knNF&quot;</span><span class="token plain">, </span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ç„¶ååœ¨europaçš„æ—¥å¿—ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">: NestedRuntime </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ext_result: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">failed</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> ExecError </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> error: DispatchError::Module </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">index:5, error:17, message: Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ContractTrapped&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">, orign: ErrorOrigin::Caller </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    caller: d43593c715fdd31c61141abd04a99fd6822</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">5GrwvaEF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    self_account: b6484f58b7b939e93fff7dc10a654af7e</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">5GBi41bY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    selector: 0xfae3a09d,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    args: 0x1cbd2d43530a44705ad088af313e18f80b5</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    value: </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    gas_limit: </span><span class="token number" style="color:rgb(247, 140, 108)">409568000000</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    gas_left: </span><span class="token number" style="color:rgb(247, 140, 108)">369902872067</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    env_trace: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_value_transferred</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">0x00000000000000000000000000000000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_input</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">0xfae3a09d1cbd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_get_storage</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">((</span><span class="token variable" style="color:rgb(191, 199, 213)">Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x0100000000000</span><span class="token variable" style="color:rgb(191, 199, 213)">....</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token variable" style="color:rgb(191, 199, 213)"> Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x010000000100000001000000</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_caller</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">0xd43593c715fdd31c61141abd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_hash_blake256</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">((</span><span class="token variable" style="color:rgb(191, 199, 213)">Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x696e6b20686173</span><span class="token variable" style="color:rgb(191, 199, 213)">....</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token variable" style="color:rgb(191, 199, 213)"> Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x0873b31b7a3cf</span><span class="token variable" style="color:rgb(191, 199, 213)">....</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...  </span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_deposit_event</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">((</span><span class="token variable" style="color:rgb(191, 199, 213)">Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable" style="color:rgb(191, 199, 213)">[</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x45726332303a</span><span class="token variable" style="color:rgb(191, 199, 213)">...</span><span class="token variable number" style="color:rgb(247, 140, 108)">.00000000000</span><span class="token variable" style="color:rgb(191, 199, 213)">]</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token variable" style="color:rgb(191, 199, 213)"> Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x000</span><span class="token variable" style="color:rgb(191, 199, 213)">..</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    trap_reason: TrapReason::SupervisorError</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">DispatchError::Module </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> index: </span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token plain">, error: </span><span class="token number" style="color:rgb(247, 140, 108)">17</span><span class="token plain">, message: Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ContractTrapped&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    wasm_error: Error::WasmiExecution</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Trap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Trap </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> kind: Unreachable </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        wasm backtrace: </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  core::panicking::panic</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">28</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  erc20::erc20::_::</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">impl erc20::erc20::Erc2</span><span class="token operator file-descriptor important" style="color:rgb(137, 221, 255)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::transfer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1697</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">erc20::erc20::_::__ink_Msg</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2644567034</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> as ink_lang::traits::MessageMut</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::CALLABLE::</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">closure</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">611</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  core::ops::function::FnOnce::call_once</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">610</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">erc20::erc20::_::_::__ink_MessageDispatchEnum as ink_lang::dispatcher::Execute</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::execute::</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">closure</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1675</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  ink_lang::dispatcher::execute_message_mut</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1674</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">erc20::erc20::_::_::__ink_MessageDispatchEnum as ink_lang::dispatcher::Execute</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::execute</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1692</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  erc20::erc20::_::</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">impl ink_lang::contract::DispatchUsingMode </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> erc20::erc20::Erc2</span><span class="token operator file-descriptor important" style="color:rgb(137, 221, 255)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::dispatch_using_mode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1690</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  call</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1691</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        â•°â”€</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">unknown</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2387</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    nest: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>æˆ‘ä»¬è§£é‡Šä¸€ä¸‹ä»¥ä¸Šæ‰“å°çš„ä¿¡æ¯ï¼š</p><ol><li><p><code>ext_result</code>ï¼šè¡¨ç¤ºè¿™ä¸€æ¬¡åˆçº¦è°ƒç”¨å¯¹å¤–æ˜¾ç¤ºä¸ºæ‰§è¡ŒæˆåŠŸæˆ–æ˜¯å¤±è´¥ï¼š</p><ol><li><code>[success]</code>ï¼šè¡¨ç¤ºè¿™æ¬¡åˆçº¦æ‰§è¡ŒæˆåŠŸï¼ˆ<em>æ³¨æ„ï¼šåˆçº¦æ‰§è¡ŒæˆåŠŸä¸ä»£è¡¨ç€åˆçº¦è‡ªèº«çš„ä¸šåŠ¡é€»è¾‘æ‰§è¡ŒæˆåŠŸï¼Œå¯èƒ½åœ¨<code>ink!</code>ä¸­æˆ–è€…åˆçº¦è‡ªèº«ä¸šåŠ¡é€»è¾‘ä¸­å­˜åœ¨é”™è¯¯çš„è¿”å›ï¼Œå¦‚åæ–‡ä¸­çš„æ¡ˆä¾‹3ã€‚</em>ï¼‰è€Œ<code>[success]</code>åé¢è·Ÿéšçš„<code>ExecResultValue { flag:0, data: 0x...}</code>è¡¨ç¤ºè¿™æ¬¡åˆçº¦æ‰§è¡Œåçš„è¿”å›å€¼ã€‚</li><li><code>[failed]</code>ï¼šè¡¨ç¤ºè¿™æ¬¡åˆçº¦æ‰§è¡Œå¤±è´¥ï¼Œ<code>[failed]</code>åé¢è·Ÿéšçš„<code>ExecError { .. }</code> è¡¨ç¤ºè¿™æ¬¡é”™è¯¯çš„åŸå› ã€‚è¿™ä¸ªåŸå› æ˜¯é“¾ä¸Šè®°å½•åˆ°<code>event</code>é‡Œé¢çš„å€¼ï¼Œä¹Ÿå°±æ˜¯<code>pallet-contracts</code>çš„<code>decl_error!</code>ä¸­å®šä¹‰çš„å€¼ã€‚</li></ol></li><li><p><code>1: NestedRuntime </code>&amp;<code>nest</code>ï¼šè¡¨ç¤ºå½“å‰æ‰“å°ä¿¡æ¯çš„è¿™ä¸ªåˆçº¦ä¿¡æ¯ä½äºåˆçº¦è°ƒç”¨æ ˆçš„ç¬¬ä¸€å±‚ï¼Œè‹¥å½“å‰åˆçº¦è°ƒç”¨äº†å¦ä¸€ä¸ªåˆçº¦ï¼Œåˆ™ä¼šåœ¨<code>nest</code>å­—æ®µçš„æ•°ç»„é‡Œå‡ºç°<code>2ï¼š NestedRuntime</code>ï¼Œ<code>1: NestedRuntime </code>é‡Œçš„ç»“æ„ä¸€è‡´ã€‚å…¶ä¸­<code>2</code>æ ‡ç¤ºè¿™ä¸ªè¢«è°ƒç”¨çš„åˆçº¦ä½äºåˆçº¦è°ƒç”¨æ ˆçš„ç¬¬äºŒå±‚ã€‚åœ¨å½“å‰åˆçº¦ä¸­è·¨åˆçº¦è°ƒç”¨äº†å‡ ä¸ªåˆçº¦ï¼Œé‚£ä¹ˆåœ¨<code>nest</code>çš„æ•°ç»„ä¸­å°±ä¼šå‡ºç°å‡ ä¸ª<code>NestedRuntime</code>ã€‚è‹¥åœ¨ç¬¬äºŒå±‚åˆçº¦ä¸­æœ‰å…¶ä»–çš„åˆçº¦è°ƒç”¨ï¼Œåˆ™ä»¥æ­¤ç±»æ¨ã€‚</p><p>ä¾‹å¦‚å¦‚æœæœ‰åˆçº¦Aï¼ŒBï¼ŒCï¼Œå¦‚æœæ˜¯å¦‚ä¸‹æƒ…å†µï¼š</p><ol><li><p>Aè°ƒç”¨äº†Båï¼Œè¿”å›åˆ°Aç»§ç»­æ‰§è¡Œï¼Œç„¶ååˆè°ƒç”¨äº†åˆçº¦C</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">|A|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| |-&gt;|B|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| |&lt;-</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| |-&gt;|C|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| |&lt;-</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>é‚£ä¹ˆå°±ä¼šäº§ç”Ÿç±»ä¼¼å¦‚ä¸‹çš„æ—¥å¿—æ‰“å°ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">1: NestedRuntime {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> self_account: A,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> nest:[</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     2: NestedRuntime {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         self_account: B,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         nest:[],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     },</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     2: NestedRuntime {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         self_account: C,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         nest:[],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> ]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Aè°ƒç”¨äº†Båï¼ŒBåˆè°ƒç”¨äº†åˆçº¦Cï¼Œæœ€åå›åˆ°Aä¸­</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">|A|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| |-&gt;|B|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| |  | |-&gt;|C|</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| |  | |&lt;-</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">| |&lt;-</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>é‚£ä¹ˆå°±ä¼šäº§ç”Ÿç±»ä¼¼å¦‚ä¸‹çš„æ—¥å¿—æ‰“å°ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">1: NestedRuntime {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> self_account: A,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> nest:[</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     2: NestedRuntime {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         self_account: B,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         nest:[</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            3: NestedRuntime {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                self_account: C,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                nest:[],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         ],</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     }  </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> ]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ol></li><li><p><code>caller</code>ï¼šä»£è¡¨å½“å‰åˆçº¦çš„è°ƒç”¨è€…æ˜¯è°ã€‚å¦‚æœæ˜¯åˆçº¦è°ƒç”¨åˆçº¦çš„æƒ…å†µä¸‹ï¼Œè¢«è°ƒç”¨çš„åˆçº¦çš„è¿™ä¸ªå€¼æ˜¯ä¸Šä¸€çº§åˆçº¦çš„åœ°å€ã€‚</p></li><li><p><code>self_account</code>ï¼šä»£è¡¨å½“å‰åˆçº¦è‡ªèº«çš„åœ°å€æ˜¯å¤šå°‘ã€‚</p></li><li><p><code>selector</code> &amp; <code>args</code>&amp;<code>value</code> ï¼šä»£è¡¨è°ƒç”¨å½“å‰åˆçº¦çš„æ—¶å€™ä¼ å…¥çš„<code>selector</code>å’Œå‚æ•°ï¼Œ<strong>è¿™äº›ä¿¡æ¯å¯ä»¥å¿«é€Ÿå®šä½è°ƒç”¨åˆçº¦æ–¹å¼æ˜¯å¦æ­£ç¡®</strong>ã€‚</p></li><li><p><code>gas_limit</code> &amp; <code>gas_left</code>ï¼šè¡¨ç¤ºå½“å‰è°ƒç”¨åˆçº¦çš„æ—¶å€™ä¼ å…¥çš„<code>gas_limit</code>å’Œ<strong>æ‰§è¡Œå®Œè¿™ä¸€å±‚</strong>åå‰©ä½™çš„gasã€‚è¿™é‡Œæ³¨æ„<code>gas_left</code>æŒ‡ä»£çš„æ˜¯æ‰§è¡Œå®Œè¿™ä¸€å±‚åˆçº¦æ—¶å‰©ä½™çš„gasï¼Œå› æ­¤<strong>åœ¨åˆçº¦è°ƒç”¨åˆçº¦ä¸­ï¼Œé€šè¿‡<code>gas_left</code>å¯ä»¥åˆ¤æ–­å‡ºæ¯ä¸€å±‚åˆçº¦æ¶ˆè€—çš„gas</strong>ï¼Œè€Œä¸æ˜¯åªèƒ½è·å–åˆ°æ•´ä¸ªåˆçº¦æ‰§è¡Œæ‰§è¡Œåçš„æ¶ˆè€—ã€‚</p></li><li><p><code>env_trace</code>ï¼šè¡¨ç¤ºå½“å‰è¿™ä¸€å±‚åˆçº¦æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œåˆçº¦WASMæ‰§è¡Œæ¯æ¬¡è°ƒç”¨host_functionï¼Œå°±ä¼šåœ¨è¿™é‡Œçš„æ•°ç»„é‡Œé¢æ·»åŠ ä¸€æ¡è®°å½•ã€‚æ‰€æœ‰çš„host_functionä¸<code>pallet-contracts</code>æ¨¡å—ä¸­çš„<a href="https://github.com/paritytech/substrate/blob/master/frame/contracts/src/wasm/runtime.rs#L610" target="_blank" rel="noopener noreferrer"><code>define_env!</code>ä¸­çš„å®šä¹‰</a>ç›¸å¯¹åº”ï¼Œå› æ­¤è·Ÿè¸ª<code>env_trace</code>å¯ä»¥è·Ÿè¸ªå½“å‰WASMåˆçº¦æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸<code>pallet-contracts</code>äº¤äº’çš„è¿‡ç¨‹ã€‚ä¾‹å¦‚å¦‚æœåœ¨<code>env_trace</code>ä¸­å‡ºç°äº†:</p><ol><li><p><code>seal_call</code>ï¼šä»£è¡¨å½“å‰åˆçº¦ä¸­å‡ºç°äº†åˆçº¦è°ƒç”¨åˆçº¦çš„æƒ…å†µã€‚æŒ‰ç…§<code>seal_call</code>å‡ºç°åœ¨<code>env_trace</code>çš„é¡ºåºï¼Œå¯ä»¥å’Œ<code>nest</code>å¯¹åº”èµ·æ¥ï¼Œæ¨ç®—å‡ºåˆçº¦è°ƒç”¨åˆçº¦çš„å‰åçŠ¶æ€ã€‚</p></li><li><p><code>seal_get_storage</code>&amp;<code>seal_set_storage</code>ï¼šä»£è¡¨åˆçº¦ä¸­å‡ºç°äº†æ•°æ®è¯»å†™çš„æƒ…å†µã€‚é€šè¿‡è¿™ä¸¤ä¸ªæ¥å£ï¼Œå¯ä»¥æˆªè·å¹¶ç»Ÿè®¡å½“å‰åˆçº¦æ‰§è¡Œè¿‡ç¨‹ä¸­è¯»å†™æ•°æ®ï¼Œè€Œ<strong>é€šè¿‡<code>seal_set_storage</code>ç»Ÿè®¡å‡ºæ¥çš„æ•°æ®å¤§å°ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ¨æµ‹<code>rent</code>æ‰€éœ€è¦çš„å­˜å‚¨å¤§å°ã€‚</strong></p></li><li><p><code>seal_deposit_event</code>ï¼šä»£è¡¨åˆçº¦ä¸­å‡ºç°äº†æ‰“å°eventçš„æƒ…å†µã€‚è¿™é‡Œå¯ä»¥åˆ†åˆ«æˆªè·æ¯æ¬¡eventçš„å†…å®¹ï¼Œè€Œä¸æ˜¯æœ€åå¾—åˆ°ä¸€ä¸ªç»Ÿä¸€çš„eventã€‚å¹¶ä¸”åæ–‡ä¼šé€šè¿‡ä¸€ä¸ªä¾‹å­è¡¨é¢é€šè¿‡europaå¯ä»¥å¿«é€Ÿå®šä½<code>host_function</code>ä¸­å‡ºç°bugçš„æƒ…å†µã€‚</p></li></ol><p>å¦ä¸€æ–¹é¢<code>env_trace</code>çš„ç»Ÿè®¡æ˜¯æ¯”è¾ƒ<strong>ç»†ç²’åº¦</strong>çš„ï¼Œä¾‹å¦‚åœ¨<code>host_function</code>ä¸­ä¼šå‡ºç°å¤šä¸ªé”™è¯¯å¯èƒ½çš„æƒ…å†µï¼Œåˆ™å‡ºç°é”™è¯¯æ—¶ï¼Œä¼šå°†é”™è¯¯ä¹‹å‰çš„ä¿¡æ¯å…¨éƒ¨ä¿ç•™ï¼Œå› æ­¤å¯ä»¥å®šä½åˆ°<code>host_function</code>æ‰§è¡Œä¸­å‡ºç°é—®é¢˜çš„åœ°ç‚¹ã€‚</p><p>è€Œä¸”è‹¥<code>host_function</code>ä¸­å‡ºç°é”™è¯¯å¯¼è‡´åˆçº¦ç»“æŸæ‰§è¡Œæ—¶ï¼Œ<code>env_trace</code>è®°å½•åˆ°çš„æ˜¯æœ€åä¸€ä¸ªå‡ºé”™çš„<code>host_function</code>è°ƒç”¨ï¼Œå› æ­¤å¯ä»¥ç›´æ¥å®šä½æ˜¯å“ªä¸€ä¸ª<code>host_function</code>å¯¼è‡´çš„åˆçº¦æ‰§è¡Œå¼‚å¸¸ã€‚</p></li><li><p><code>trap_reason</code>ï¼šæ ¹æ®<code>pallet-contracts</code>ä¸­å¯¹äº<code>TrapReason</code>çš„å®šä¹‰ï¼Œ<code>trap_reason</code>å¯ä»¥åˆ†ä¸º2ç±»ï¼š</p><ol><li><code>Return</code> &amp; <code>Termination</code> &amp; <code>Restoration</code>ï¼šè¡¨ç¤ºåˆçº¦é€€å‡ºæ˜¯<code>pallet-contracts</code>çš„è®¾è®¡ï¼Œå¹¶éå†…éƒ¨å‡ºç°é”™è¯¯ã€‚è¿™ä¸€ç±»Trapè¡¨ç¤ºåˆçº¦æ­£å¸¸æ‰§è¡Œï¼Œå¹¶éé”™è¯¯ã€‚</li><li><code>SupervisorError</code>ï¼šè¡¨ç¤ºåˆçº¦è°ƒç”¨host_functionçš„æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°äº†é”™è¯¯ã€‚</li></ol><p>å› æ­¤å½“å‰europaçš„æ—¥å¿—æ‰“å°è®¾è®¡ä¸ºåªè¦å‡ºç°<code>trap_reason</code>å°±ä¼šè®°å½•ä¸‹æ¥ã€‚è€Œå¦ä¸€æ–¹é¢ï¼Œåœ¨åˆçº¦çš„æ‰§è¡Œè¿‡ç¨‹ä¸­å¹¶éä¸€å®šä¼šå‡ºç°<code>trap_reason</code>ã€‚ç»“åˆ<code>pallet-contracts</code>ä»¥åŠ<code>ink!</code>çš„è®¾è®¡ï¼Œå­˜åœ¨åˆçº¦æ‰§è¡ŒæˆåŠŸæˆ–è€…åœ¨<code>ink!</code>å±‚ä¸­æ‰§è¡Œå¤±è´¥å‡ä¸äº§ç”Ÿ<code>trap_reason</code>çš„æƒ…å†µã€‚å› æ­¤europaé™¤äº†è®°å½•<code>trap_reason</code>ï¼Œè¿˜<strong>è®°å½•äº†WASMæ‰§è¡Œå™¨æ‰§è¡Œåè¿”å›çš„ç»“æœï¼Œç”¨<code>sandbox_result_ok</code>è®°å½•ã€‚</strong></p></li><li><p><code>sandbox_result_ok</code>ï¼š<code>sandbox_result_ok</code>çš„å€¼è¡¨ç¤ºåˆçº¦åœ¨WASMæ‰§è¡Œå™¨æ‰§è¡Œåçš„ç»“æœã€‚è¿™ä¸ªå€¼æœ¬å¯ä»¥è®°å½•ä¸º<code>sandbox_result</code>ï¼ŒåŒ…å«æ­£ç¡®å’Œé”™è¯¯ä¸¤ç§æƒ…å†µã€‚ä½†æ˜¯ç”±äºrustçš„é™åˆ¶ï¼Œä¸”ç»“åˆ<code>pallet-contracts</code>çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¿™é‡Œåªä¿ç•™<code>sandbox_result</code>ä¸º<code>Ok</code>çš„ç»“æœã€‚<strong>å¯¹äºæ—¥å¿—çš„æ‰“å°ï¼Œeuropaè®¾è®¡ä¸ºåªæœ‰å½“trap_reasonæ˜¯ç¬¬ä¸€ç§æƒ…å†µæ—¶ï¼Œæ‰“å°<code>sandbox_result_ok</code>ï¼Œä½œä¸ºè¾…åŠ©åˆ¤æ–­åˆçº¦æ‰§è¡Œçš„ä¿¡æ¯ã€‚</strong></p><p><code>sandbox_result_ok</code>æ˜¯WASMæ‰§è¡Œå™¨<a href="https://github.com/paritytech/substrate/blob/712085115cdef4a79a66747338c920d6ba4e479f/frame/contracts/src/wasm/mod.rs#L155-L156" target="_blank" rel="noopener noreferrer">è°ƒç”¨äº†<code>invoke</code>åçš„ç»“æœ</a>ï¼Œåœ¨ç»è¿‡<code>to_execution_result</code>çš„å¤„ç†åï¼Œå¦‚æœæ²¡æœ‰<code>trap_reason</code>çš„æƒ…å†µåˆ†æ”¯ä¸­ï¼Œ<code>Ok(..)</code>çš„ç»“æœ<a href="https://github.com/paritytech/substrate/blob/712085115cdef4a79a66747338c920d6ba4e479f/frame/contracts/src/wasm/runtime.rs#L366-L368" target="_blank" rel="noopener noreferrer">è¢«ä¸¢å¼ƒäº†</a>ã€‚ä½†å®é™…ä¸Šè¿™é‡ŒåŒ…å«ä¸¤ç§æƒ…å†µï¼š</p><ol><li><code>ink!</code>ä¸­å‡ºç°äº†é”™è¯¯ï¼šæ ¹æ®<code>ink!</code>çš„å®ç°ï¼Œåœ¨è°ƒç”¨åˆçº¦<code>#[ink(message)]</code>å’Œ<code>#[ink(constructor)]</code>åŒ…è£…çš„å‡½æ•°ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦å¯¹è¾“å…¥çš„å‚æ•°è¿›è¡Œè§£ç åŠåŒ¹é…<code>selector</code>çš„è¿‡ç¨‹ã€‚è‹¥åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œåˆçº¦ä¼šè¿”å›<a href="https://github.com/paritytech/ink/blob/abd5cf14c0883cb2d5acf81f2277aeec330aa843/crates/lang/src/error.rs#L22" target="_blank" rel="noopener noreferrer">é”™è¯¯ç <code>DispatchError</code></a>ã€‚ä½†æ˜¯å¯¹äºWASMæ‰§è¡Œå™¨è€Œè¨€æ˜¯æ­£å¸¸çš„æ‰§è¡Œäº†WASMä»£ç ï¼Œå› æ­¤ä¼šè¿”å›ç»“æœï¼ŒåŒ…å«è¿™ä¸ªé”™è¯¯ç ã€‚<strong>è¿™ä¸ªåˆçº¦æ‰§è¡Œè¿‡ç¨‹å±äºé”™è¯¯æƒ…å†µã€‚</strong></li><li><code>#[ink(message)]</code>çš„è¿”å›å€¼å®šä¹‰ä¸ºäº†<code>()</code>ï¼šæ ¹æ®<code>ink!</code>çš„å®ç°ï¼Œè‹¥è¿”å›å€¼çš„ç±»å‹æ˜¯<code>()</code>åˆ™ä¸ä¼šè°ƒç”¨<code>seal_reason</code>ï¼Œå› æ­¤ä¸ä¼šå«æœ‰<code>trap_reason</code>ã€‚<strong>è¿™ä¸ªåˆçº¦æ‰§è¡Œè¿‡ç¨‹å±äºæ­£ç¡®æƒ…å†µã€‚</strong></li></ol><p>ç”±äº<code>ink!</code>åªæ˜¯è¿è¡Œäº<code>pallet-contracts</code>çš„ä¸€ç§åˆçº¦å®ç°ï¼Œå…¶ä»–çš„å®ç°å¯èƒ½æœ‰ä¸åŒçš„è§„åˆ™ï¼Œå› æ­¤å½“å‰<code>sandbox_result_ok</code>åªç”¨äºè¾…åŠ©åˆ¤å®š<code>ink!</code>åˆçº¦çš„æ‰§è¡Œæƒ…å†µï¼Œå€¼ä¸º<a href="https://github.com/paritytech/substrate/blob/712085115cdef4a79a66747338c920d6ba4e479f/primitives/wasm-interface/src/lib.rs#L462-L467" target="_blank" rel="noopener noreferrer"><code>ReturnValue</code></a>ã€‚å…¶ä¸­è‹¥æ—¥å¿—çš„<code>ReturnValue::Value(&lt;num&gt;)</code>çš„<code>&lt;num&gt;</code>éƒ¨åˆ†ä¸ä¸º0æ—¶ï¼Œè¡¨ç¤º<code>ink!</code>çš„æ‰§è¡Œè¿‡ç¨‹å¯èƒ½å­˜åœ¨é”™è¯¯ï¼Œå¯ä»¥æ ¹æ®<code>ink!</code>å¯¹äº<a href="https://github.com/paritytech/ink/blob/abd5cf14c0883cb2d5acf81f2277aeec330aa843/crates/lang/src/error.rs#L66-L80" target="_blank" rel="noopener noreferrer"><code>DispatchError</code>çš„é”™è¯¯ç </a>åˆ¤å®šé”™è¯¯ã€‚</p></li><li><p><code>wasm_error</code>ï¼šè¡¨ç¤ºçš„æ˜¯WASMæ‰§è¡Œé”™è¯¯æ—¶çš„backtraceã€‚è¿™ä¸ªéƒ¨åˆ†åªæœ‰å½“<code>ext_result</code>ä¸º<code>failed</code>çš„æ—¶å€™æ‰ä¼šæ‰“å°ã€‚</p><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œç”±äºæ‰§è¡Œ<code>transfer</code>ä¼šè§¦å‘<code>panic</code>ï¼Œå› æ­¤å¯ä»¥çœ‹åˆ°è¿™é‡Œå¯¼è‡´é”™è¯¯çš„åŸå› æ˜¯<code>WasmiExecution(Trap(Trap { kind: Unreachable }))</code>ï¼Œè¡¨ç¤ºè¿™æ¬¡çš„å¤±è´¥æ˜¯ç”±äºæ‰§è¡Œåˆçº¦çš„è¿‡ç¨‹ä¸­å‡ºç°çš„<code>Unreacble</code>çš„æƒ…å†µå¯¼è‡´ï¼Œè€Œä¸‹æ–¹çš„backtraceä¿¡æ¯ä¹Ÿ<strong>ååˆ†å‡†ç¡®çš„æè¿°</strong>äº†ä¸Šæ–‡è®¨è®ºè¿‡çš„åˆçº¦å®å±•å¼€åé‡åˆ°é”™è¯¯æ—¶çš„å‡½æ•°æ‰§è¡Œè°ƒç”¨æ ˆã€‚ä»backtraceä¸­å¯ä»¥æ˜æ˜¾çš„å‘ç°å¦‚ä¸‹çš„è°ƒç”¨è¿‡ç¨‹ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">call -&gt; dispatch_using_mode -&gt; ... -&gt; transfer -&gt; panic </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿™ä¸ªè¿‡ç¨‹ä¸åˆçº¦çš„åŸæ–‡ä¿¡æ¯ç›¸ç¬¦ã€‚</p></li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="æ¡ˆä¾‹2ï¼šå®šä½é‡å¤çš„topicå¯¼è‡´çš„contracttrap"></a>æ¡ˆä¾‹2ï¼šå®šä½é‡å¤çš„topicå¯¼è‡´çš„<code>ContractTrap</code><a class="hash-link" href="#æ¡ˆä¾‹2ï¼šå®šä½é‡å¤çš„topicå¯¼è‡´çš„contracttrap" title="Direct link to heading">#</a></h4><p>åœ¨å‰ä¸€æ®µæ—¶é—´ï¼Œæˆ‘ä»¬ï¼ˆPatract Labsï¼‰ç»™<code>ink!</code>æ±‡æŠ¥è¿‡ä¸€ä¸ªbugï¼Œè§issue:<a href="https://github.com/paritytech/ink/issues/589" target="_blank" rel="noopener noreferrer">&quot;When set &#x27;0&#x27; value in contracts event, may cause <code>Error::ContractTrapped</code> and panic in contract #589&quot;</a>ã€‚åœ¨europaè¿˜æœªå¼€å‘å‡ºç›¸å…³åŠŸèƒ½å‰ï¼Œå®šä½è¿™ä¸ªé”™è¯¯ååˆ†å›°éš¾ï¼Œå…¶ä¸­æ„Ÿè°¢@athei<a href="https://github.com/paritytech/ink/issues/589#issuecomment-731571918" target="_blank" rel="noopener noreferrer">å®šä½åˆ°äº†é”™è¯¯</a>ã€‚è¿™é‡Œæˆ‘ä»¬é‡ç°è¿™ä¸ªé”™è¯¯ï¼Œå¹¶ä½¿ç”¨europaçš„æ—¥å¿—æ¥å¿«é€Ÿåˆ†æå®šä½åˆ°è¿™ä¸ªbugå‡ºç°çš„åœ°æ–¹ï¼š</p><ol><li><p>å°†<code>ink!</code>åˆ‡æ¢ï¼ˆcheckoutï¼‰åˆ°æäº¤<code>8e8fe09565ca6d2fad7701d68ff13f12deda7eed</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> ink</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> checkout 8e8fe09565ca6d2fad7701d68ff13f12deda7eed -b tmp</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>è¿›å…¥<code>ink/examples/erc20/lib.rs:L90</code>ä¸­å°†<code>Transfer</code>ä¸­çš„<code>value</code>æ”¹ä¸º<code>0_u128</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[ink(constructor)]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn new(initial_supply: Balance) -&gt; Self {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    //...</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Self::env().emit_event(Transfer {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        from: None,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        to: Some(caller),</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // change this from `initial_supply` to `0_u128`</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        value: 0_u128.into() // initial_supply,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    instance</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>æ‰§è¡Œ<code>cargo +nightly contract build --debug</code> ç¼–è¯‘åˆçº¦</p></li><li><p>ä½¿ç”¨<a href="https://redspot.patract.io/en/tutorial/" target="_blank" rel="noopener noreferrer">RedSpot</a>æˆ–è€…<a href="https://polkadot.js.org/apps" target="_blank" rel="noopener noreferrer"><code>Polkadot/Substrate Portal</code></a>å°†è¿™ä¸ªåˆçº¦éƒ¨ç½²å‡ºå»ï¼ˆæ³¨æ„ä¸€å®šè¦ä½¿ç”¨erc20.src.wasmæ–‡ä»¶ï¼‰</p></li></ol><p>åœ¨éƒ¨ç½²é˜¶æ®µåº”è¯¥ä¼šé‡åˆ°<code>DuplicateTopics</code>ï¼ˆåœ¨è¿™ä¸ª<a href="https://github.com/paritytech/substrate/pull/7762" target="_blank" rel="noopener noreferrer">é”™è¯¯</a>ä¿®æ­£ä¹‹å‰ï¼Œæ±‡æŠ¥çš„é”™è¯¯æ˜¯<code>ContractTrap</code>ï¼‰ï¼Œè€Œåœ¨europaçš„æ—¥å¿—ä¸­ä¼šæ˜¾ç¤ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">: NestedRuntime </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#...</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    env_trace: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_input</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">0xd183512b0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#...    </span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_deposit_event</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">((</span><span class="token variable" style="color:rgb(191, 199, 213)">Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable" style="color:rgb(191, 199, 213)">[</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x45726332303a3a5472616e736</span><span class="token variable" style="color:rgb(191, 199, 213)">....]</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token variable" style="color:rgb(191, 199, 213)"> None</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    trap_reason: TrapReason::SupervisorError</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">DispatchError::Module </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> index: </span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token plain">, error: </span><span class="token number" style="color:rgb(247, 140, 108)">23</span><span class="token plain">, message: Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;DuplicateTopics&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    wasm_error: Error::WasmiExecution</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Trap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Trap </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> kind: Host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">DummyHostError</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        wasm backtrace: </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  ink_env::engine::on_chain::ext::deposit_event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1623</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  ink_env::engine::on_chain::impls::</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">impl ink_env::backend::TypedEnvBackend </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> ink_env::engine::on_chain::EnvInstance</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::emit_event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1564</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  ink_env::api::emit_event::</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">closure</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1563</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">ink_env::engine::on_chain::EnvInstance as ink_env::engine::OnInstance</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::on_instance</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1562</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  ink_env::api::emit_event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1561</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  erc20::erc20::_::</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">impl ink_lang::events::EmitEvent</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">erc20::erc20::Erc2</span><span class="token operator file-descriptor important" style="color:rgb(137, 221, 255)">0</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> ink_lang::env_access::EnvAccess</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;</span><span class="token plain">erc20::erc20::Erc20 as ink_lang::env_access::ContractEnv</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::Env</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;&gt;</span><span class="token plain">::emit_event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1685</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  deploy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1691</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        â•°â”€</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">unknown</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2385</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    nest: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ç”±ä»¥ä¸Šæ—¥å¿—å¯ä»¥çœ‹åˆ°:</p><ol><li><code>env_trace</code>çš„æœ€åä¸€æ¡è®°å½•æ˜¯<code>seal_deposit_event</code>è€Œä¸æ˜¯<code>seal_return</code>ï¼ˆåˆçº¦æ­£ç¡®æ‰§è¡Œæ—¶æœ€åä¸€æ¡ä¸€å®šæ˜¯<code>seal_return</code>ï¼‰</li><li><code>seal_deposit_event</code>çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯<code>None</code>ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå­˜åœ¨çš„å€¼ï¼Œå› æ­¤è¡¨æ˜<code>seal_deposit_event</code> è¿™ä¸ªhost_functionæ²¡æœ‰æ‰§è¡Œå®Œæˆï¼Œè€Œæ˜¯åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å°±å‡ºç°äº†é”™è¯¯ï¼ˆå¯ä»¥çœ‹europaä¾èµ–çš„forkedç‰ˆæœ¬çš„<code>pallet-contracts</code>æºç çœ‹åˆ°<a href="https://github.com/patractlabs/substrate/blob/3624deb47cabe6f6cd44ec2c49c6ae5a29fd2198/frame/contracts/src/wasm/runtime.rs#L1399" target="_blank" rel="noopener noreferrer">ç›¸åº”çš„å®ç°æ–¹å¼</a>ï¼‰ã€‚</li><li>ç»“åˆwasm backtraceçš„é”™è¯¯æ ˆæˆ‘ä»¬å¯ä»¥ç›´è§‚çš„çœ‹åˆ°backtraceæœ€ä¸Šä¸€å±‚è°ƒç”¨æ ˆä¸º<code>deposit_event</code>ã€‚</li></ol><p>å› æ­¤ç»“åˆä»¥ä¸Šä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ¨æµ‹å‡ºæ˜¯<code>seal_deposit_event</code>è¿™ä¸ªhost_functionåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å‡ºç°äº†å¼‚å¸¸ã€‚ï¼ˆåœ¨<code>pallet-contracts</code>çš„æäº¤<a href="https://github.com/paritytech/substrate/pull/7762" target="_blank" rel="noopener noreferrer">pull#7762</a>åˆå¹¶å‰ï¼Œæˆ‘ä»¬è®°å½•äº†host_functionå†…çš„é”™è¯¯ä¿¡æ¯ï¼Œåˆå¹¶åæˆ‘ä»¬åˆ©ç”¨äº†<code>trap_reason</code>ç»Ÿä¸€çš„é”™è¯¯ä¿¡æ¯ã€‚ï¼‰</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="æ¡ˆä¾‹3ï¼Œå½“é“¾ä½¿ç”¨äº†type-balanceu64è€Œä¸æ˜¯type-balanceu128é€ æˆçš„é”™è¯¯ã€‚"></a>æ¡ˆä¾‹3ï¼Œå½“é“¾ä½¿ç”¨äº†<code>type Balance=u64</code>è€Œä¸æ˜¯<code>type Balance=u128</code>é€ æˆçš„é”™è¯¯ã€‚<a class="hash-link" href="#æ¡ˆä¾‹3ï¼Œå½“é“¾ä½¿ç”¨äº†type-balanceu64è€Œä¸æ˜¯type-balanceu128é€ æˆçš„é”™è¯¯ã€‚" title="Direct link to heading">#</a></h4><p>å¦‚æœé“¾ä½¿ç”¨äº†<code>Balance=u64</code>çš„å®šä¹‰ï¼Œè€Œå¯¹äº<code>ink!</code>è€Œè¨€å¹¶ä¸çŸ¥é“é“¾å…³äº<code>Balance</code>çš„å®šä¹‰ï¼Œé»˜è®¤å®šä¹‰çš„Balanceæ˜¯<code>u128</code>ã€‚å› æ­¤å½“ä½¿ç”¨<code>u128</code>å®šä¹‰<code>Balance</code>çš„<code>ink!</code>ä½œä¸ºä¾èµ–ç¼–è¯‘å‡ºçš„åˆçº¦ï¼Œè¿è¡Œåœ¨<code>Balance</code>å®šä¹‰ä¸º<code>u64</code>çš„é“¾ä¸Šæ—¶ï¼Œä¼šé€ æˆ<code>pallet-contracts</code>æ¨¡å—å‘åˆçº¦ä¼ å€¼çš„æ—¶å€™ï¼Œåˆçº¦å†…éƒ¨å°†<code>u64</code>çš„<code>value</code>å½“åš<code>u128</code>è§£ç çš„é”™è¯¯ã€‚</p><p>ä»¥erc20çš„exampleåˆçº¦ä¸ºä¾‹ï¼Œå±•å¼€åˆçº¦çš„å®åï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p><ul><li><code>dispatch_using_mode</code>é˜¶æ®µè§£ç <code>input</code>å‡ºç°é”™è¯¯æ—¶ï¼Œåˆçº¦ä»¥<code>::ink_lang::DispatchError::CouldNotReadInput</code>è¿”å›ï¼Œä½†æ˜¯<code>pallet-contracts</code>çš„æ¨¡å‹è®¾è®¡è®¤ä¸ºWASMçš„åˆçº¦æ‰§è¡Œæ²¡æœ‰å¼‚å¸¸ã€‚</li><li>è€Œåœ¨<code>call</code>çš„è°ƒç”¨æ—¶ï¼Œç”±äºåœ¨è°ƒç”¨<code>dispatch_using_mode</code>ä¹‹å‰é¦–å…ˆä¼šæ£€æŸ¥<code>deny_payment</code>ï¼Œè€Œæ£€æŸ¥<code>deny_payment</code>æ—¶è‹¥è¿”å›Erroråˆ™ç›´æ¥<code>panic</code>ã€‚</li></ul><p>å› æ­¤å¯¹äºè¿™ç§æƒ…å†µä¸‹ï¼Œä¼šå‡ºç°éƒ¨ç½²ï¼ˆ<code>Instantiate</code>ï¼‰ERC20çš„åˆçº¦æ‰§è¡Œæ­£å¸¸ï¼Œè€Œè°ƒç”¨ERC20çš„ä»»æ„æ–¹æ³•ä¾‹å¦‚<code>transfer</code>çš„æ—¶å€™å‡ºç°<code>ContractTrap</code>ã€‚</p><p>å¯¹äºè¿™ä¸¤ç§æƒ…å†µæˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ï¼š</p><ol><li><p><code>instantiate</code>é˜¶æ®µï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">: NestedRuntime </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ext_result: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">success</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> ExecError </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> error: DispatchError::Module </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">index:5, error:17, message: Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ContractTrapped&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">, orign: ErrorOrigin::Caller </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#...</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    env_trace: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_input</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">0xd183512b008cb6611e0100000000000000000000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_caller</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">0xd43593c715fdd31c61141abd04a99fd682</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        //</span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_set_storage</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">((</span><span class="token variable" style="color:rgb(191, 199, 213)">Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x030000000100000</span><span class="token variable" style="color:rgb(191, 199, 213)">...</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token variable" style="color:rgb(191, 199, 213)"> Some</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable number" style="color:rgb(247, 140, 108)">0x000000000000000</span><span class="token variable" style="color:rgb(191, 199, 213)">...</span><span class="token variable punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    sandbox_result_ok: RuntimeValue::Value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">7</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    nest: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ä»¥ä¸Šæ—¥å¿—å¯ä»¥çœ‹åˆ°</p><ol><li><p><code>env_trace</code>çš„æœ€åä¸ä»¥<code>seal_return</code>ç»“å°¾ï¼Œåˆ™è¡¨ç¤ºåˆçº¦å®é™…ä¸Šæ²¡æœ‰æ­£å¸¸æ‰§è¡Œå®Œæˆã€‚å› ä¸ºä»<code>ink!</code>çš„è®¾è®¡ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ­£å¸¸è¿›å…¥åˆ°<code>#[ink(constructor)]</code>æˆ–è€…è¿›å…¥åˆ°<code>#[ink(message)]</code>åˆ™è¡¨é¢ä¸€å®šæ‰§è¡Œåˆ°äº†<code>::ink_lang::execute_message</code>ä¸­ï¼ˆ<code>::ink_lang::execute_message</code>ä¼šè°ƒç”¨<code>seal_return</code>ï¼‰ï¼Œè€Œæ²¡æœ‰å‡ºç°<code>seal_return</code>ä»£è¡¨æ²¡æœ‰æ‰§è¡Œåˆ°<code>execute</code>çš„é˜¶æ®µã€‚</p></li><li><p><code>sandbox_result_ok</code>è¡¨ç¤ºæ‰§è¡Œçš„è¿”å›å€¼ä¸º<code>7</code>ï¼ŒæŸ¥è¯¢<code>ink!</code>å¯¹äº<code>DispatchError</code>çš„å®ç°å¯ä»¥çœ‹åˆ°è¿™ä¸ªé”™è¯¯ç ä»£è¡¨ç€<code>CouldNotReadInput</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">DispatchError::CouldNotReadInput =&gt; Self(0x07),</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>æ ¹æ®åˆçº¦å®å±•å¼€çš„ä»£ç å¯ä»¥çœ‹åˆ°åœ¨<code>dispatch_using_mode</code>å‡½æ•°ä¸­ï¼Œè°ƒç”¨<code>execute</code>ä¹‹å‰ä¼šè°ƒç”¨<code>::ink_env::decode_input</code>ï¼Œè€Œè¿™ä¸ªå‡½æ•°å­˜åœ¨<code>return Error</code>çš„æƒ…å†µã€‚å› æ­¤å¯ä»¥åˆç†çŒœæµ‹æ˜¯åœ¨è§£æ<code>input</code>çš„æ—¶å€™å‡ºç°å¼‚å¸¸ã€‚åœ¨æ—¥å¿—ä¸­è®°å½•äº†è¾“å…¥å‚æ•°<code>args:0x008cb6611e0100000000000000000000</code>ï¼Œè§‚å¯Ÿè¿™ä¸ªå‚æ•°å¯ä»¥å‘ç°å…¶é•¿åº¦æ˜æ˜¾å°äº<code>u128</code>ç¼–ç çš„æƒ…å†µã€‚å› æ­¤å¯ä»¥æ ¹æ®<code>args</code>å’Œ<code>env_trace</code>æ¨æµ‹å‡ºæ˜¯è§£ç <code>input</code>çš„æ—¶å€™å‘ç”Ÿäº†é”™è¯¯ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// this part code is expanded by erc20 example.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">::ink_env::decode_input::&lt;&lt;Erc20 as ::ink_lang::ConstructorDispatcher&gt;::Type&gt;().map_err(|_| ::ink_lang::DispatchError::CouldNotReadInput)?</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ol><p>æ­¤æ—¶åˆçº¦å®ä¾‹åŒ–æˆåŠŸï¼Œä½†æ˜¯æ‰§è¡Œå®ä¾‹åŒ–çš„æ„é€ å‡½æ•°å­˜åœ¨ã€‚å› æ­¤åˆçº¦å­˜åœ¨äºé“¾ä¸Šä½†æ˜¯æ²¡æœ‰æ­£å¸¸æ‰§è¡Œ<code>#[ink(constructor)]</code>çš„è¿‡ç¨‹ã€‚</p></li><li><p><code>call</code>é˜¶æ®µ ï¼Œå¦‚è°ƒç”¨<code>transfer</code>:</p><p>å¯¹ä»¥ä¸Šå®ä¾‹åŒ–æˆåŠŸçš„å‡½æ•°è¿›è¡Œè°ƒç”¨<code>transfer</code>ï¼Œä¼šå‡ºç°<code>ContractTrap</code>ï¼Œeuropaçš„æ—¥å¿—æ˜¾ç¤ºå¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">: NestedRuntime </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ext_result: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">failed</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> ExecError </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> error: DispatchError::Module </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">index:5, error:17, message: Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ContractTrapped&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">, orign: ErrorOrigin::Caller </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    env_trace: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        seal_value_transferred</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Some</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">0x0000000000000000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    wasm_error: Error::WasmiExecution</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Trap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">Trap </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> kind: Unreachable </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">))</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        wasm backtrace: </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  core::panicking::panic_fmt.60</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1743</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  core::result::unwrap_failed</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">914</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  core::result::Result</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">T,E</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::expect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">915</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  ink_lang::dispatcher::deny_payment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1664</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">  call</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1691</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        â•°â”€</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">unknown</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2387</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    nest: </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>é¦–å…ˆæ³¨æ„åˆ°<code>env_trace</code>æœ€åä¸€ä¸ªè®°å½•ä¾ç„¶ä¸æ˜¯<code>seal_return</code>ï¼Œä¸”<code>wasm_error</code>çš„é”™è¯¯åŸå› æ˜¯<code>WasmiExecution::Unreachable</code>ã€‚å› æ­¤å¯ä»¥ç¡®å®šæ˜¯åˆçº¦æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†<code>panic</code>æˆ–è€…<code>expect</code>ã€‚</p><p>è€Œä»wasm backtrace ä¸­åˆ™ååˆ†æ˜æ˜¾çš„çœ‹åˆ°äº†åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸º</p></li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">   call -</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> deny_payment -</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">expect</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è€Œæ ¹æ®å®å±•å¼€çš„ä»£ç ï¼ˆ<code>cd ink/examples/erc20; cargo expand &gt; tmp.rs</code>ï¼‰æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#[no_mangle]</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn call</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> -</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> u32 </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     ::ink_lang::deny_payment::</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;</span><span class="token plain">Erc20 as ::ink_lang::ContractEnv</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::Env</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .expect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;caller transferred value even though all ink! message deny payments&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ::ink_lang::DispatchRetCode::from</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">Erc20 as ::ink_lang::DispatchUsingMode</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">::dispatch_using_mode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            ::ink_lang::DispatchMode::Call,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    .to_u32</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>   å› æ­¤å¯ä»¥åˆ¤å®šåˆçº¦æ‰§è¡Œ<code>transfer</code>çš„è¿‡ç¨‹ä¸­åœ¨<code>deny_payment</code>è¿”å›äº†é”™è¯¯ï¼Œè€Œè¿™é‡Œå¯¹é”™è¯¯ç›´æ¥å¤„ç†ä¸º<code>expect</code>å¯¼è‡´äº†<code>wasmi</code>æ‰§è¡Œç»“æœä¸º<code>Unreachable</code>ã€‚è·Ÿè¸ª<code>deny_payment</code>çš„ä»£ç å¯ä»¥å‘ç°æ˜¯è¯¥å‡½æ•°è¿”å›äº†<code>Error</code>å¯¼è‡´çš„<code>expect</code></p><blockquote><p>æ³¨ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><p>åœ¨<code>ink_lang</code>ä¸­<a href="https://github.com/paritytech/ink/blob/master/crates/lang/src/dispatcher.rs#L140-L150" target="_blank" rel="noopener noreferrer">https://github.com/paritytech/ink/blob/master/crates/lang/src/dispatcher.rs#L140-L150</a></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn deny_payment&lt;E&gt;() -&gt; Result&lt;()&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">where</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    E: Environment,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let transferred = ink_env::transferred_balance::&lt;E&gt;()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .expect(&quot;encountered error while querying transferred balance&quot;);</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if transferred != &lt;E as Environment&gt;::Balance::from(0u32) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return Err(DispatchError::PaidUnpayableMessage)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(())</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>inkä¸­æ­¤å¤„çš„<code>off_chain</code>éƒ¨åˆ†å’Œ<code>on_chain</code>éƒ¨åˆ†ä¼šå‡ºç°å·®å¼‚</strong>ï¼Œ<code>off_chain</code>ä¼šè®¤ä¸ºåœ¨<code>ink_env::transferred_balance::&lt;E&gt;()</code>é˜¶æ®µå°±è¿”å›é”™è¯¯ï¼Œäºæ˜¯åœ¨æ‰§è¡Œ<code>transferred_balance</code>ä¸­åä¼šé‡åˆ°<code>expect</code>å¯¼è‡´<code>panic</code>ï¼Œè€Œ<code>on_chain</code>éƒ¨åˆ†ç”±äºæ˜¯ä»wasmçš„memoryä¸­å–å€¼ï¼Œåˆ™ä¼šæ­£å¸¸è·å–åˆ°å¯¹åº”u128é•¿åº¦çš„å­—ç¬¦å¹¶è§£ç å¾—åˆ°<code>transferred</code>ï¼Œåªæ˜¯è§£ç çš„ç»“æœä¸ä¼šç¬¦åˆé¢„æœŸï¼Œå¯¼è‡´<code>transferred!=0</code>è®©<code>deny_payment</code>è¿”å›äº†Errorï¼Œè€Œåœ¨åˆçº¦çš„å®å±•å¼€è°ƒç”¨<code>deny_payment</code>çš„éƒ¨åˆ†æ‰è§¦å‘<code>expect</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">if true {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ::ink_lang::deny_payment::&lt;&lt;Erc20 as ::ink_lang::ContractEnv&gt;::Env&gt;()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .expect(&quot;caller transferred value even though all ink! message deny payments&quot;)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>å› æ­¤å¯¹äºwasm backtrace æ¥è¯´ï¼Œ<code>expect</code>æ˜¯å‡ºç°åœ¨<code>call</code>ä¸­è°ƒç”¨<code>deny_payment</code>çš„æ—¶å€™ï¼Œè€Œä¸æ˜¯<code>deny_payment</code>ä¸­è°ƒç”¨<code>transferred_balance</code>çš„æ—¶å€™ã€‚</p><p><strong>è¿™ä¸ªä¾‹å­ä¾§é¢è¯´æ˜<code>ink!</code>å½“å‰å¯¹äº<code>off_chain</code>ä»¥åŠ<code>on_chain</code>çš„å¤„ç†å¹¶ä¸æ˜¯å®Œå…¨å¯¹åº”çš„ï¼Œå¯èƒ½åœ¨ä¸€äº›æƒ…å†µä¸‹ä¼šç»™åˆçº¦çš„ä½¿ç”¨è€…é€ æˆéš¾ä»¥æ’æŸ¥çš„é”™è¯¯</strong></p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="what-we-have-implemented-for-v02"></a>What we have implemented for v0.2<a class="hash-link" href="#what-we-have-implemented-for-v02" title="Direct link to heading">#</a></h2><p><em>Modify at <code>FRAME Contracts pallet</code> level to provide more information.</em></p><p>æµ‹è¯•ç”¨ä¾‹è§ï¼š</p></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/patractlabs/substrate-contracts-book/docs/europa/reports/v0.2Report.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/substrate-contracts-book/europa/reports/v0.1Report"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Europa v0.1 æŠ¥å‘Š</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/substrate-contracts-book/europa/reports/v0.3Report"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Europa v0.3æŠ¥å‘Š Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link">Introduction</a><ul><li><a href="#summary-of-europas-v02-plan" class="table-of-contents__link">Summary of Europa&#39;s v0.2 plan:</a></li></ul></li><li><a href="#design" class="table-of-contents__link">Design</a><ul><li><a href="#pallet-contractså±‚" class="table-of-contents__link"><code>pallet-contracts</code>å±‚</a></li><li><a href="#wasmiå±‚" class="table-of-contents__link"><code>wasmi</code>å±‚</a></li><li><a href="#åˆçº¦æ—¥å¿—åŠŸèƒ½" class="table-of-contents__link">åˆçº¦æ—¥å¿—åŠŸèƒ½</a></li></ul></li><li><a href="#what-europa-can-do-in-this-version" class="table-of-contents__link">What Europa can do in this version</a><ul><li><a href="#build" class="table-of-contents__link">Build</a></li><li><a href="#example" class="table-of-contents__link">example</a></li></ul></li><li><a href="#what-we-have-implemented-for-v02" class="table-of-contents__link">What we have implemented for v0.2</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/substrate-contracts-book/assets/js/runtime~main.3945a3a1.js"></script>
<script src="/substrate-contracts-book/assets/js/main.ee6e64d2.js"></script>
</body>
</html>